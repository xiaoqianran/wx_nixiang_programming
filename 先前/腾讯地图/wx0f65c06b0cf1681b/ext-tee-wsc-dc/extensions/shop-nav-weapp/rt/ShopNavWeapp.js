var r=require("~/r");r("WBiS",Object.assign({},require("~/v.js").modules,require("~/c.js").modules,{WBiS:function(e,t,a){a.r(t);var r=a("Fcif"),i=a("eijD"),s=a("a1Mm"),n=a("SVbq"),o=a("/duV"),c=a("taYb"),d=a("f9/1"),l=a("w2Y9"),h=a.n(l),u=a("9DLJ"),b=a("US/N"),g={},p=(a("WMGV"),a("AGZf")),v=a("xih6");function f(e){return Object(v.a)().some(t=>e.startsWith(t))}function T(){var e=getCurrentPages()||[];return f("/"+(e[e.length-1]||{}).route)}var m=a("9ZMt"),O=getApp();function C(e){void 0===e&&(e={}),wx.redirectTo(e)}var I=a("PKOW"),j={[I.c[I.b.CART].TRANS]:{subRoutes:[I.c[I.b.CART].NEW,I.c[I.b.CART].OLD]},[u.e.TRANS]:{subRoutes:[u.e.TEE,u.e.EXT,u.e.OLD]},[u.g.TRANS]:{subRoutes:[u.g.TEE,u.g.EXT,u.g.OLD]},[u.f.TRANS]:{subRoutes:[u.f.TEE,u.f.EXT,u.f.OLD]},[u.d.TRANS]:{subRoutes:[u.d.TEE,u.d.EXT,u.d.OLD]},[u.a.OLD]:{subRoutes:[u.a.OLD,u.a.NEW]},[u.l.TRANS]:{subRoutes:[u.l.PAGE]}};function S(e){var t=e;if(!j[t])for(var a=Object.keys(j),r=0;r<a.length;r++){var{subRoutes:i}=j[a[r]];if(i&&i.length)for(var s=0;s<i.length;s++)if(e===i[s]){t=a[r];break}if(t!==e)break}return t}var y=a("DXKY"),x=a("tmLU"),w=a("U0uK"),A=a("Sipi"),P=a("YeA1"),k=a("4jn8"),N=a("xRet"),{dmc:R}=Object(P.a)(),D=getApp(),E=Object(w.a)().kdtId,L={},_=(e,t)=>{L[e]=t,Object(d.setEnterCacheConfig)("tabbarNavCacheMap",e,t)},K={},M={},q=e=>/^http/.test(e),W={props:{isNewIphone:Boolean,onlyColorText:Boolean,activePath:String,forceShow:Boolean,nativeSelectedIndex:Number,cloudConfig:{type:Object,default:()=>({})}},data:()=>({navList:[],navStyleMap:u.i,selectedColor:"",color:"",navStyle:1,customBackground:"",deviceType:D.deviceType||"",isTabPage:!1,cacheKdtId:"",selectedIndex:0,brandNavStyle:1,notCoexist:!1}),computed:{isCart(){var{selectedIndex:e}=this,t=this.navList[e]||{};if(!t)return!1;var{pagePath:a=""}=t;return Object(I.d)(a.split("?")[0],I.b.CART)},classes(){var{navStyle:e,deviceType:t}=this,a="tab-bar";return[a,a+(3===e?"-float":"-legacy"),t]},brandStyle(){return" background: "+this.customBackground},commonStyle(){var e=this.customBackground||"#fcfcfc";return this.navStyle===u.i.MAIN_ICON||this.navStyle===u.i.XUAN_FU||this.navStyle===u.i.DEFAULT&&1===this.brandNavStyle?" background:"+e:""},rudderStyle(){return this.navStyle===u.i.MAIN_ICON_STYLE_TWO?"border: 0px;bottom: 19px":" "}},watch:{nativeSelectedIndex(e){setTimeout(()=>{this.selectedIndex=e},0)},navStyle(e){3===e&&this.ctx&&(this.ctx.data.navHeight=this.deviceType?56:66)}},created(){this.weappNavInit()},methods:{changeTheme(e){var t=this;return Object(i.a)(function*(){var{color_mode:a,color:i,selected_color:s,custom_background:n}=D.getNavConfig(),o=a===u.b.SHOP,c=yield D.getShopTheme(),d={color:o?u.c.UNACTIVATED:i,selectedColor:o?c.colors["main-bg"]:s,customBackground:n},l=L[e];_(e,Object(r.a)({},l,d)),t.getCacheMap(e)})()},chainStoreAction(){var e=this;return Object(i.a)(function*(){if(D.forceUseHqTabbar())return yield e.changeTheme(Object(o.e)()),!0})()},weappNavInit(){var e=this;return Object(i.a)(function*(){var t=D.getKdtId()||E;e.initEvents(),(yield e.chainStoreAction())||(L[t]?e.getCacheMap(t):e.initNavData(t))})()},initEvents(){y.a.off("shop:theme:resolved",this.kdtIdChange.bind(this)),y.a.on("shop:theme:resolved",this.kdtIdChange.bind(this))},kdtIdChange(){var e=this;return Object(i.a)(function*(){var t=+D.getKdtId();if(e.data.cacheKdtId!==t){if(e.cacheKdtId=t,yield e.chainStoreAction())return;if(L[t])return void e.getCacheMap(t);e.initNavData(t)}})()},navCommonClick(e){this.wxSwitchTab(e)},spliceKdtIdAndKey:(e,t)=>Object(n.z)()&&!Object(d.getEnterCacheConfig)("hqHomeToOtherHome")?""+Object(o.e)()+e:""+(t||D.getKdtId()||E)+e,getCurrentPage(){var e=getCurrentPages()||[];return e[e.length-1]||{}},getCacheMap(e){var t=this.getCurrentPage();if(!D.forceUseHqTabbar()&&t.options&&t.options.showcaseTplfromRoute)this.initNavData(e);else{var a=S(t.route),i=K[this.spliceKdtIdAndKey(a)]||{isTabPage:!1,selectedIndex:this.nativeSelectedIndex||""},s=Object(r.a)({},L[e],i);M[e]&&(D.globalData.tabbarOriginList=M[e]),Object.assign(this.data,s),setTimeout(()=>{this.setSelectedIndex(t,i.selectedIndex)},0)}},initNavData(e,t){void 0===t&&(t={});var{count:a=1,refresh:i=!1}=t;((e,t)=>(g[e]&&!t||(g[e]=Object(b.default)({path:"/wscshop/weapp/custom_nav.json",data:{kdt_id:e,useOmniChannel:!0}})),g[e]))(e,i).then(t=>{var a=t.data||{},{list:i,colorMode:s=u.b.CUSTOM,navStyle:n=1,color:d,selectedColor:l,customBackground:h,brandNavStyle:b=1,notCoexist:g}=a,p=2!==n&&g;this.brandNavStyle=b;var v=i;D.trigger(N.b,v);var f=this.processNavList(v,e),T=Object(r.a)({},f,{navStyle:n,notCoexist:p});M[e]=v,D.globalData.tabbarPageList=(null==f?void 0:f.navList)||[],D.globalData.tabbarOriginList=v,D.isChainStoreSync&&+e===Object(o.e)()&&(D.globalData.tabbarHqOriginList=c.a.toSnakeCase(v)),-1===T.selectedIndex&&(T.selectedIndex=this.data.selectedIndex),D.getShopTheme().then(t=>{var a=D.getShopInfoSync(),i=s===u.b.SHOP,n={color:i?u.c.UNACTIVATED:d,selectedColor:i?t.colors["main-bg"]:l,customBackground:h};i&&delete T.selectedIndex,_(e,Object(r.a)({},T,n,{isDecorateFollowHq:a.isDecorateFollowHq})),Object.assign(this.data,L[e])})}).catch(()=>{a>3||this.initNavData(e,{count:a+1,refresh:!0})})},processNavList(e,t){var a,i=!1,n=-1,o=this.getCurrentPage();if(o.options&&o.options.showcaseTplfromRoute){var c=decodeURIComponent(o.options.showcaseTplfromRoute);a=S(c)}else a=S(o.route);var d=e.map((e,o)=>{var c=Object(r.a)({},e),{iconPath:d,selectedIconPath:l,customPage:h,pagePath:b}=c;q(d)&&(c.iconPath=Object(s.a)(d,"!80x80.jpg")),q(l)&&(c.selectedIconPath=Object(s.a)(l,"!80x80.jpg"));var g=function(e){var{customPage:t,pagePath:a}=e,r=getApp(),{isRetailApp:i}=r.globalData,s=t||a.startsWith("pages/home")||a.startsWith("pages/common/webview-page")||i&&"pages-retail/usercenter/dashboard-v2/index"===a?a:a.replace(/^pages(-|\/)/,"packages/");return u.j.test(s)&&(i&&s===u.k.WSC&&(s=u.k.RETAIL),i||s!==u.k.RETAIL||(s=u.k.WSC)),s}({customPage:h,pagePath:b}),p="";g&&(g.startsWith("pages/home/tab")||g.startsWith("pages/home/dashboard"))&&(p=this.spliceKdtIdAndKey(g.replace(/^pages(-|\/)/,"packages/"),t)),c.pagePath="/"+g+"?navIndex="+o,g===a&&(i=!0,n=o);var v=this.spliceKdtIdAndKey(g,t);return K[v]||(K[v]={isTabPage:!0,selectedIndex:o}),p&&!K[p]&&(K[p]={isTabPage:!0,selectedIndex:o}),c});return{isTabPage:i,selectedIndex:n,navList:d}},setSelectedIndex(e,t){var{navIndex:a}=e.options||{};isNaN(+a)&&isNaN(+t)||(this.selectedIndex=+(a||t))},jumpToMp(e){1==+e.use_short_link?wx.navigateToMiniProgram({shortLink:e.short_link,fail(){Object(p.a)("跳转其他小程序失败,可联系商家处理")}}):wx.navigateToMiniProgram({appId:e.other_weapp_appid,path:e.other_weapp_link,fail(){Object(p.a)("跳转其他小程序失败,可联系商家处理")}})},wxSwitchTab(e){var t,a=this.navList[e],{extraData:i,pagePath:s}=a,n=e,{tabbarOriginList:o}=D.globalData,c=s.split("?")[0];if(Object(I.d)(c,I.b.CART))return this.switchToCart(s);if(function(e){return"/packages/retail-shelf/shelf/index"===e}(c))this.switchToRS(o,n);else{var d=o.find((e,t)=>t===n);if("chat"!==(null==d||null==(t=d.linkInfo)?void 0:t.linkType)){if(i&&"2"===i.link_type)return this.jumpToMp(i);var l={};"feature"===(null==d?void 0:d.attachedId)&&null!=d&&d.alias&&(l.alias=d.alias),Object(k.b)(o,{tabBarIndex:n,query:Object(r.a)({navIndex:n},l),fail:()=>{this.switchTab(e)}})}}},switchTab(e){var t=this.navList[e],{active:a,extra:r,pagePath:i}=t;if(!a){!function(e){var{path:t}=e;O.logger&&O.logger.log({et:"click",ei:"custom_tab_bar_before_navigate",en:"自定义导航点击跳转",params:{kdt_id:O.getKdtId(),version:O.getVersion(),navigateUrl:t}})}({path:i}),this.setRetailGlobalData(i);var s=getCurrentPages()||[],n=i.split("?")[0],o=u.h[n];if(o){var c=h.a.getAll(i),d=s.length>1?"reLaunch":"redirectTo";R[d](o,c)}else{if(s.length>1)return(getCurrentPages()||[]).some(e=>{var{route:t}=e;return Object(v.a)().indexOf("/"+t)>-1})?f(i)?R.switchTab(i):C({url:i}):wx.reLaunch({url:i});Object(I.d)(n,I.b.CART)?this.switchToCart(i):r&&"2"===r.link_type?this.jumpToMp(r):f(i)?R.switchTab(i):T()?function(e){void 0===e&&(e={}),(getCurrentPages()||[]).length>=10?this.redirect(e):wx.navigateTo(e)}({url:i}):C({url:i})}}},switchToCart(e){var t=e.split("?")[0],a={store_id:D.getOfflineId()||0,supportReviveGroup:!0,supportCombo:!0};a.excludedComboSubType=JSON.stringify([""]),Object(x.c)({navigatePath:t,navigateCb:t=>{var a=getApp().globalData.isRetailApp&&!Object(n.z)()?200:0;setTimeout(()=>{Object(I.f)({url:e,type:T()?I.a.NAVIGATE:I.a.REDIRECT,pageType:I.b.CART,query:{prefetchKey:t}})},a)},prefetchCb:()=>Object(n.z)()?Promise.reject("进总部不走预请求"):new Promise((e,t)=>{Object(b.default)({data:a,path:"/wsctrade/cartGoodstList.json",method:"GET"}).then(t=>{e(t)}).catch(e=>{t(e)})})});var r="trade-cart-addon-prefetchkey_"+Date.now();Object(A.d)("trade-cart-addon-prefetchkey",r),Object(x.a)({prefetchKey:r,prefetchCb:()=>Object(n.z)()?Promise.reject("进总部不走预请求"):D.request({path:"/wsctrade/cart/getCouponAddOnInfo.json",method:"GET",data:{kdt_id:D.getKdtId()||0,store_id:D.getOfflineId()||0},withCredentials:!0})})},setRetailGlobalData(e){var t=e.match(/mode=(\d*)/);t&&t[1]&&(D.globalData.shelfParams={mode:t[1]})},switchToRS(e,t){var{pagePath:a,extra:i}=e[t];return y.a.trigger("retail-shelf:switch-tab",Object(r.a)({},i,{switchType:"tab-click"})),Object(k.b)(e,{path:a,query:i,fail:()=>{this.switchTab(t)}})}},ud:!0};t.default=m.default.component(W)}}));
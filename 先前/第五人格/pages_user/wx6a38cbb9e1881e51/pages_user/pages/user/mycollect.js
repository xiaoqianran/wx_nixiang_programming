var t=require("../../../@babel/runtime/helpers/defineProperty"),a=require("../../../@babel/runtime/helpers/objectSpread2"),e=getApp(),i=require("./config.js"),s="https://nie.res.netease.com/id5/m/zt/20201215094138/data";Page({data:{imgUrl:e.globalData.imgUrl,apiUrl:e.globalData.apiUrl,wxToken:e.globalData.wxToken,user:[],gameId:"",skinList:[],frameList:[],entourageList:[],additionsList:[],_canvasw:0,_canvasH:0,showCanvas:!1,caImg:[{url:s+"/precious/p1ex.jpg",w:750,h:1795,t:0,l:0},{url:"",w:136,h:136,t:76,l:293},{w:164,h:152,t:62,l:280},{url:"",w:86,h:86,t:474,l:73},{url:"",w:144,h:144,t:445,l:44},{w:651,h:370,t:-154,l:0},{url:s+"/precious/tt1.png",w:503,h:118,t:0,l:126,unus:!0},{url:s+"/precious/allrole.png",w:100,h:86,t:1120,l:230,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/skin3.png",w:160,h:240,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/skin4.png",w:160,h:240,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sc4.png",w:140,h:140,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sc3.png",w:140,h:140,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/pet3.png",w:140,h:140,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/pet2.png",w:140,h:140,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/pet1.png",w:140,h:140,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/user/inner_bg2.png",w:140,h:140,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sk_bz1.png",w:120,h:120,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sk_bz2.png",w:120,h:120,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sk_bz3.png",w:120,h:120,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sk_bz4.png",w:120,h:120,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sk_bz5.png",w:120,h:120,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sk_bz6.png",w:120,h:120,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sk_bz7.png",w:120,h:120,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sk_bz8.png",w:120,h:120,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sk_bz9.png",w:120,h:120,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sk_bz10.png",w:120,h:120,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sk_bz1.png",w:120,h:120,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sk_bz12.png",w:120,h:120,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sk_bz13.png",w:120,h:120,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sk_bz1.png",w:120,h:120,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sk_bz15.png",w:120,h:120,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sc5.png",w:140,h:140,unus:!0},{w:120,h:120},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sk_bz18.png",w:120,h:120,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sk_bz19.png",w:120,h:120},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sk_bz20.png",w:120,h:120,unus:!0},{url:s+"/precious/li.png",w:188,h:410,t:655,l:375,unus:!0},{url:s+"/precious/ic2.png",w:145,h:62,t:641,l:375,unus:!0},{url:s+"/precious/ic1.png",w:56,h:56,t:645,l:423,unus:!0},{url:s+"/precious/icon/1.png",w:44,h:44,t:1168,l:93},{url:s+"/precious/icon/2.png",w:44,h:44,t:1168,l:416},{url:s+"/precious/icon/3.png",w:44,h:44,t:1246,l:93},{url:s+"/precious/icon/4.png",w:44,h:44,t:1246,l:416},{url:s+"/precious/icon/5.png",w:44,h:44,t:1322,l:93},{url:s+"/precious/icon/6.png",w:44,h:44,t:1322,l:416},{url:s+"/precious/icon/7.png",w:44,h:44,t:1399,l:93},{url:s+"/precious/icon/8.png",w:44,h:44,t:1399,l:416},{url:s+"/precious/p_t.png",w:733,h:100,t:0,l:8,unus:!0},{url:s+"/precious/p_c.jpg",w:733,h:0,t:0,l:8,unus:!0},{url:s+"/precious/p_b.png",w:733,h:100,t:0,l:8,unus:!0},{url:s+"/precious/bg2.jpg",w:750,h:0,t:0,l:0,unus:!0},{url:s+"/precious/ic9.png",w:215,h:65,t:0,l:0,unus:!0},{url:s+"/precious/p1_p.png",w:702,h:443,t:1102,l:42,unus:!0},{url:s+"/icon.png",w:105,h:105,t:0,l:627,unus:!0},{url:s+"/greed/sk_bz21.png",w:120,h:120,unus:!0},{url:s+"/greed/sk_bz22.png",w:120,h:120,unus:!0},{url:s+"/greed/sk_bz23.png",w:120,h:120,unus:!0},{url:s+"/greed/sk_bz24.png",w:120,h:120,unus:!0},{url:s+"/greed/sk_bz28.png",w:120,h:120,unus:!0},{url:s+"/greed/sk_bz29.png",w:120,h:120,unus:!0},{url:s+"/greed/sk_bz30.png",w:120,h:120,unus:!0},{url:s+"/greed/sk_bz31.png",w:120,h:120,unus:!0},{url:s+"/greed/sk_bz32.png",w:120,h:120,unus:!0},{url:s+"/greed/sk_bz33.png",w:120,h:120,unus:!0},{url:s+"/greed/sk_bz34.png",w:120,h:120,unus:!0},{url:s+"/greed/sk_bz35.png",w:120,h:120,unus:!0},{url:s+"/greed/sk_bz36.png",w:120,h:120,unus:!0},{url:s+"/greed/sk_bz37.png",w:120,h:120,unus:!0},{url:s+"/greed/sk_bz38.png",w:120,h:120,unus:!0}],bjMapList:i.bjMapList,caReadyImg:[],promiseList:[],promiseList2:[],promiseList3:[],promiseList4:[],promiseList5:[],imgbuilded:!1,bindPopShow:!1,userInfo:{},hasUserInfo:!1,skinListByCamp:[],skinListByCampChoose:["全部时装","监管者","求生者"],skinListTemporaryByCamp:[],byCampIndex:0,skinListByQuality:[],skinListByQualityChoose:["全部时装","虚妄杰作","稀世时装","奇珍时装"],skinListTemporaryByQuality:[],byQualityIndex:0,skinListByDiscontinuedSign:[],skinListByDiscontinuedSignChoose:[{list:"",name:"全部时装",sign:-1}],skinListTemporaryByDiscontinuedSign:[],byDiscontinuedSignIndex:0,allChoose:!0,skinChooseShow:!1,size:4,scrollTop:0,pageMetaScrollTop:0,itemHeight:250,cardArray:[{name:"稀有度分类",idlist:[2,3,4]},{name:"阵营分类",idlist:[0,1]},{name:"系列分类",idlist:[10,11,12,13,14,15,16,17,18,19,20,22,23,25,28,30,31,32,33,34,35,36,37,38]}],cardIndex:0,loaded:0,timeEights:!1,messageTipGif:!1,messageTipGifUrl:"".concat(e.globalData.imgUrl,"/vsrecord/message_subscription-wechat.gif")},onLoad:function(t){var a=this;this.setData({gameId:null,wxToken:e.globalData.wxToken}),this.data.wxToken?this.getData():e.initOkCallback=function(t){a.setData({wxToken:e.globalData.wxToken}),a.getData()},wx.reportEvent("collect_tobuild",{})},createNewImg:function(){var t=this,a=750,e=1e3,i=0,s=25,n=!1,r=this.data.caImg,o=t.data.bulidLess,d=t.data.additionsList,l=t.data.entourageList,c=(t.data.frameList,[]);if(0==t.data.cardIndex?c=t.data.skinListByQuality:1==t.data.cardIndex?c=t.data.skinListByCamp:2==t.data.cardIndex&&(c=t.data.skinListByDiscontinuedSign),o){var u=[],g=[],h=[];0==t.data.cardIndex?u=[{name:"虚妄杰作",list:[]},{name:"稀世时装",list:[]},{name:"奇珍时装",list:[]}]:1==t.data.cardIndex?u=[{name:"监管者",list:[]},{name:"求生者",list:[]}]:2==t.data.cardIndex&&(u=[{name:"限定",list:[],sign:1},{name:"伊藤润二",list:[],sign:2},{name:"女神异闻录",list:[],sign:3},{name:"公益系列",list:[],sign:4},{name:"剪刀手爱德华",list:[],sign:5},{name:"深渊1-3",list:[],sign:6},{name:"演绎之星",list:[],sign:7},{name:"推理之径限定",list:[],sign:8},{name:"弹丸论破",list:[],sign:9},{name:"柯南",list:[],sign:10},{name:"深渊4",list:[],sign:12},{name:"约定的梦幻岛",list:[],sign:13},{name:"溯洄",list:[],sign:15},{name:"COA5",list:[],sign:18},{name:"LINE FRIENDS",list:[],sign:19},{name:"B.Duck",list:[],sign:20},{name:"COA冠军",list:[],sign:21},{name:"时光代理人",list:[],sign:22},{name:"熊猫系列",list:[],sign:23},{name:"文豪野犬",list:[],sign:24},{name:"COA6",list:[],sign:28},{name:"镰田光司",list:[],sign:29},{name:"演绎之星—宁芙奖",list:[],sign:30},{name:"肯德基系列",list:[],sign:31},{name:"Angels of Death",list:[],sign:32},{name:"中国航天系列",list:[],sign:33},{name:"xxxHOLiC",list:[],sign:34},{name:"三丽鸥大明星",list:[],sign:35},{name:"COA7",list:[],sign:36},{name:"非人哉",list:[],sign:37},{name:"小小梦魇",list:[],sign:38},{name:"普通",list:[],sign:0}]),c.forEach((function(t,a){t.list.forEach((function(t,e){5!=t.quality&&6!=t.quality||u[a].list.push(t)}))})),c=u,d.forEach((function(t,a){5==t.quality&&g.push(t)})),d=g,l.forEach((function(t,a){4==t.quality&&h.push(t)})),l=h}var m=0;c.forEach((function(t,a){""!=t.list&&(m=250*Math.ceil(t.list.length/(4*(n?2:1)))+m+110)}));var p=1800,f=p+m,y=Math.ceil(d.length/5),w=f+200+136,k=w+144*y,I=Math.ceil(l.length/5),x=k+200+136,T=x+144*I,L=0,S=T,D=S+144*L;e=D+350,console.log(e),e>12e3&&(a=1500,i=375,n=!0,s=40,m=0,c.forEach((function(t,a){""!=t.list&&(m=250*Math.ceil(t.list.length/(4*(n?2:1)))+m+110)})),f=(p=1800)+m,y=Math.ceil(d.length/10),k=(w=f+200+136)+144*y,I=Math.ceil(l.length/10),e=(D=(S=T=(x=k+200+136)+144*I)+144*(L=0))+350),t.setData({_canvasw:a,_canvasH:e}),setTimeout((function(){var o=wx.createCanvasContext("mycanvas");r.forEach((function(t,e){0==e&&(t.w=a),!t.unus&&t.endUrl&&o.drawImage(t.endUrl,0!=e?t.l+i:t.l,t.t,t.w,t.h),0==e&&o.drawImage(r[52].endUrl,r[52].l+i,r[52].t,r[52].w,r[52].h)})),o.drawImage(r[36].endUrl,r[36].l-r[36].w/2+i,r[36].t,r[36].w,r[36].h),o.drawImage(r[36].endUrl,r[36].l-326+i,r[36].t,r[36].w,r[36].h),o.drawImage(r[36].endUrl,r[36].l+141+i,r[36].t,r[36].w,r[36].h),o.drawImage(r[37].endUrl,r[37].l-r[37].w/2+i,r[37].t,r[37].w,r[37].h),o.drawImage(r[37].endUrl,r[37].l-304+i,r[37].t,r[37].w,r[37].h),o.drawImage(r[37].endUrl,r[37].l+163+i,r[37].t,r[37].w,r[37].h),o.drawImage(r[38].endUrl,r[38].l+i,r[38].t,r[38].w,r[38].h),o.drawImage(r[38].endUrl,r[38].l-230+i,r[38].t,r[38].w,r[38].h),o.drawImage(r[38].endUrl,r[38].l+236+i,r[38].t,r[38].w,r[38].h),o.setFontSize(26),o.setFillStyle("#2e1010"),o.setTextAlign("center"),o.fillText("时装",142+i,676),o.fillText("随身物品",375+i,676),o.fillText("随从",612+i,676),o.setFontSize(20),o.setFillStyle("#c8c6bf"),o.fillText(t.data.user.skin?t.data.user.skin:0,222+i,678),o.fillText(t.data.user.carry?t.data.user.carry:0,451+i,678),o.fillText(t.data.user.pet?t.data.user.pet:0,688+i,678),o.setFontSize(20),o.setFillStyle("#2e1010"),o.setTextAlign("left"),o.fillText("稀世",86+i,964),o.fillText("稀世",318+i,964),o.fillText("稀世",552+i,964),o.fillText("奇珍",86+i,998),o.fillText("奇珍",318+i,998),o.fillText("奇珍",552+i,998),o.fillText("独特",86+i,1032),o.fillText("独特",318+i,1032),o.fillText("独特",552+i,1032),o.setTextAlign("center"),o.fillText(t.data.user.skin_quality5,180+i,964),o.fillText(t.data.user.carry_quality5,412+i,964),o.fillText(t.data.user.pet_quality5,646+i,964),o.fillText(t.data.user.skin_quality4,180+i,998),o.fillText(t.data.user.carry_quality4,412+i,998),o.fillText(t.data.user.pet_quality4,646+i,998),o.fillText(t.data.user.skin_quality3,180+i,1032),o.fillText(t.data.user.carry_quality3,412+i,1032),o.fillText(t.data.user.pet_quality3,646+i,1032),o.setFontSize(24),o.setTextAlign("left"),o.fillText("角色数",157+i,1199),o.fillText("头像",157+i,1276),o.fillText("等待动作",157+i,1353),o.fillText("追击音乐",157+i,1430),o.fillText("涂鸦",478+i,1199),o.fillText("头像框",478+i,1276),o.fillText("个性动作",478+i,1353),o.fillText("归宿分",478+i,1430),o.setFontSize(24),o.setTextAlign("center"),o.fillText(t.data.user.hero,318+i,1200),o.fillText(t.data.user.portrait,318+i,1277),o.fillText(t.data.user.wait_act,318+i,1354),o.fillText(t.data.user.music,318+i,1431),o.fillText(t.data.user.graffiti,640+i,1200),o.fillText(t.data.user.frame,640+i,1277),o.fillText(t.data.user.per_act,640+i,1354),o.fillText(t.data.user.home_score,640+i,1431),t.data.user.hero==t.data.user.allHero&&o.drawImage(r[7].endUrl,r[7].l+i,r[7].t,r[7].w,r[7].h),o.setTextAlign("left"),o.fillText(t.data.user.role_name,188+i,514),o.setFontSize(20),o.fillText("ID:"+t.data.gameId,188+i+24*t.data.user.role_name.length+10,514),o.fillText(t.data.dayDesc,188+i,556),o.drawImage(r[50].endUrl,0,p-60,a,e-1700),o.drawImage(r[47].endUrl,r[47].l+(n?16:0),p-100,n?2*r[47].w:r[47].w,r[47].h),o.drawImage(r[48].endUrl,r[48].l+(n?16:0),p,n?2*r[47].w:r[47].w,m),o.drawImage(r[49].endUrl,r[49].l+(n?16:0),f,n?2*r[47].w:r[47].w,r[49].h),o.drawImage(r[6].endUrl,r[6].l+i,p-170,r[6].w,r[6].h),o.setFontSize(34),o.setTextAlign("center"),o.setFillStyle("#2e1010"),o.fillText("角色时装展示区",375+i,p-94);var u=[s,s+180,s+360,s+540,s+720,s+900,s+1080,s+1260],g=0;c.forEach((function(a,e){if(""!=a.list&&(o.drawImage(r[51].endUrl,s,p+g+30,r[51].w,r[51].h),o.setFontSize(28),o.setFillStyle("#2e1010"),o.fillText(a.name,s+r[51].w/2,p+g+64),a.list.forEach((function(a,e){var i,s=e%(4*(n?2:1)),d=parseInt(e/(4*(n?2:1))),l=p+250*d+g+110;6==a.quality?(t.data.skinList[a.faIndex].endUrl&&o.drawImage(t.data.skinList[a.faIndex].endUrl,u[s],l,r[9].w,r[9].h),o.setFontSize(18),o.setFillStyle("#000"),o.fillText(a.useName,u[s]+80,l+200)):5==a.quality?(o.drawImage(r[9].endUrl,u[s],l,r[9].w,r[9].h),o.setFontSize(20),o.setFillStyle("#dbb775"),o.fillText(a.useName,u[s]+80,l+210)):(o.drawImage(r[8].endUrl,u[s],l,r[8].w,r[8].h),o.setFontSize(20),o.setFillStyle("#0b090a"),o.fillText(a.useName,u[s]+80,l+210)),t.data.skinList[a.faIndex].endUrl&&6!=a.quality&&o.drawImage(t.data.skinList[a.faIndex].endUrl,u[s],l,r[9].w,r[9].h);var c=t.data.bjMapList[parseInt(a.discontinuedSignInt)]||null;c&&null!==(i=r[c])&&void 0!==i&&i.endUrl&&o.drawImage(r[c].endUrl,u[s]+80,l-18,r[c].w,r[c].h)})),g=250*Math.ceil(a.list.length/(4*(n?2:1)))+g+110),0==e){var d,l=70+i,c=710,h=t.data.skinList[0];6==h.quality?(h.endUrl&&o.drawImage(h.endUrl,l,c,144,216),o.setFontSize(18),o.setFillStyle("#000"),o.fillText(h.useName,l+72,892)):5==h.quality?(o.drawImage(r[9].endUrl,l,c,144,216),o.setFontSize(20),o.setFillStyle("#dbb775"),o.fillText(h.useName,l+72,902)):(o.drawImage(r[8].endUrl,l,c,144,216),o.setFontSize(20),o.setFillStyle("#0b090a"),o.fillText(h.useName,l+72,902)),h.endUrl&&6!=h.quality&&o.drawImage(h.endUrl,l,c,144,216);var m=t.data.bjMapList[parseInt(h.discontinuedSignInt)]||null;m&&null!==(d=r[m])&&void 0!==d&&d.endUrl&&o.drawImage(r[m].endUrl,l+80,692,r[m].w,r[m].h)}})),o.drawImage(r[47].endUrl,r[47].l+(n?16:0),w-100,n?2*r[47].w:r[47].w,r[47].h),o.drawImage(r[48].endUrl,r[48].l+(n?16:0),w,n?2*r[47].w:r[47].w,144*y),o.drawImage(r[49].endUrl,r[49].l+(n?16:0),k,n?2*r[47].w:r[47].w,r[49].h),o.drawImage(r[6].endUrl,r[6].l+i,w-170,r[6].w,r[6].h),o.setFontSize(34),o.setTextAlign("center"),o.setFillStyle("#2e1010"),o.fillText("随身物品展示区",375+i,w-94);var h=[s,s+140,s+280,s+420,s+560,s+700,s+840,s+980,s+1120,s+1260];d.forEach((function(a,e){var s,d=e%(5*(n?2:1)),l=parseInt(e/(5*(n?2:1)));5==a.quality?o.drawImage(r[10].endUrl,h[d],w+144*l,r[10].w,r[10].h):6==a.quality?o.drawImage(r[31].endUrl,h[d],w+144*l,r[10].w,r[10].h):o.drawImage(r[11].endUrl,h[d],w+144*l,r[10].w,r[10].h),a.endUrl&&o.drawImage(a.endUrl,h[d]+20,w+144*l+20,100,100);var c=t.data.bjMapList[parseInt(a.discontinuedSignInt)]||null;if(c&&null!==(s=r[c])&&void 0!==s&&s.endUrl&&o.drawImage(r[c].endUrl,h[d]+70,w+144*l+3,90,90),0==e){var u,g=305+i;5==a.quality?o.drawImage(r[10].endUrl,g,740,r[10].w,r[10].h):6==a.quality?o.drawImage(r[31].endUrl,g,740,r[10].w,r[10].h):o.drawImage(r[11].endUrl,g,740,r[10].w,r[10].h),o.drawImage(a.endUrl,g+20,760,100,100);var m=t.data.bjMapList[parseInt(a.discontinuedSignInt)]||null;m&&null!==(u=r[m])&&void 0!==u&&u.endUrl&&o.drawImage(r[m].endUrl,g+70,743,90,90)}})),o.drawImage(r[47].endUrl,r[47].l+(n?16:0),x-100,n?2*r[47].w:r[47].w,r[47].h),o.drawImage(r[48].endUrl,r[48].l+(n?16:0),x,n?2*r[47].w:r[47].w,144*I),o.drawImage(r[49].endUrl,r[49].l+(n?16:0),T,n?2*r[47].w:r[47].w,r[49].h),o.drawImage(r[6].endUrl,r[6].l+i,x-170,r[6].w,r[6].h),o.fillText("随从展示区",375+i,x-94);var L=[s,s+140,s+280,s+420,s+560,s+700,s+840,s+980,s+1120,s+1260];l.forEach((function(t,a){var e=a%(5*(n?2:1)),s=parseInt(a/(5*(n?2:1)));if(4==t.quality?o.drawImage(r[12].endUrl,L[e],x+144*s,r[14].w,r[14].h):3==t.quality?o.drawImage(r[13].endUrl,L[e],x+144*s,r[14].w,r[14].h):o.drawImage(r[14].endUrl,L[e],x+144*s,r[14].w,r[14].h),t.endUrl&&o.drawImage(t.endUrl,L[e]+20,x+144*s+20,100,100),0==a){var d=540+i;4==t.quality?o.drawImage(r[12].endUrl,d,740,r[14].w,r[14].h):3==t.quality?o.drawImage(r[13].endUrl,d,740,r[14].w,r[14].h):o.drawImage(r[14].endUrl,d,740,r[14].w,r[14].h),t.endUrl&&o.drawImage(t.endUrl,d+20,760,100,100)}})),o.setFillStyle("#fff"),o.fillRect(0,e-190,a,190),o.setFontSize("26"),o.setTextAlign("left"),o.setFillStyle("#000000"),o.fillText("查战绩，就上网易第五人格",212+i,e-129),o.setFontSize("20"),o.setTextAlign("left"),o.setFillStyle("#695f53"),o.fillText("扫描二维码，绑定角色即可查看战绩和",212+i,e-77),o.fillText("定制专属图鉴",212+i,e-47),o.drawImage(r[53].endUrl,r[53].l+i,e-148,r[53].w,r[53].h),t.data.canvasQrcode&&o.drawImage(t.data.canvasQrcode,15+i,e-175,160,160),o.draw(!0,(function(){setTimeout((function(){!function i(){wx.canvasToTempFilePath({canvasId:"mycanvas",fileType:"jpg",quality:.6,y:440,destWidth:a,destHeight:e-440,success:function(i){var s=i.tempFilePath;wx.hideLoading(),wx.showModal({title:"提示",content:"将生成的海报保存到手机相册，可以发送给微信好友或分享到朋友圈",success:function(t){wx.showToast({title:"长按屏幕可保存生成的图鉴",icon:"none",duration:3e3})}}),t.setData({loadImagePath:s,imgbuilded:!1}),o.clearRect(0,0,a,e)},fail:function(t){console.log(t),setTimeout((function(){i()}),1e3)}})}()}),2e3)}))}),200)},saveImg:function(){wx.saveImageToPhotosAlbum({filePath:this.data.loadImagePath,success:function(t){wx.showToast({title:"已保存到相册",icon:"success",duration:3e3})}})},saveCode:function(){var t=this;wx.saveImageToPhotosAlbum({filePath:t.data.loadImagePath,success:function(a){wx.showToast({title:"已保存到相册",icon:"success",duration:3e3}),t.canvasHide()},fail:function(t){console.log("err",t),"saveImageToPhotosAlbum:fail:auth denied"!==t.errMsg&&"saveImageToPhotosAlbum:fail auth deny"!==t.errMsg&&"saveImageToPhotosAlbum:fail authorize no response"!==t.errMsg||wx.showModal({title:"提示",content:"需要您授权保存相册",showCancel:!1,success:function(t){wx.openSetting({success:function(t){t.authSetting["scope.writePhotosAlbum"]?wx.showModal({title:"提示",content:"获取权限成功,再次长按图片即可保存",showCancel:!1}):wx.showModal({title:"提示",content:"获取权限失败，将无法保存到相册哦~",showCancel:!1})},fail:function(t){console.log("failData",t)},complete:function(t){console.log("finishData",t)}})}})}})},getData:function(){this.data.loaded=0,this.setData({isLoading:!0}),wx.showLoading({title:"加载中"}),this.getGameUserInfo(),this.getQrcode()},getGameUserInfo:function(){var t=this;wx.request({url:this.data.apiUrl+"/w/epro/wechatuser/mine/userinfo",data:{wxToken:t.data.wxToken},header:{wxToken:t.data.wxToken},success:function(a){var i=a.data.data,s={};-10000301!=a.data.code?(null!=i.userAvatarUrl||null!=i.wxName?(s.avatarUrl=a.data.data.userAvatarUrl,s.nickName=a.data.data.wxName,t.setData({userInfo:s})):t.setData({userInfo:null}),"该账号暂未绑定游戏角色！"==a.data.msg||null==a.data.data.idvId?(t.setData({isLoading:!1}),wx.hideLoading()):200==a.data.code?(t.setData({gameId:a.data.data.idvId}),wx.getStorage({key:"tipsShow_mycollect_220223",success:function(t){},fail:function(a){var e=wx.createSelectorQuery().in(t);e.selectViewport().scrollOffset(),e.select("#imglist").boundingClientRect(),e.exec((function(t){var a=t[0].scrollTop+t[1].top-80;wx.pageScrollTo({scrollTop:a,duration:300})})),wx.setStorage({key:"tipsShow_mycollect_220223",data:!0}),t.setData({showTips:!0})}}),t.getUser(),t.getStartDay()):wx.showToast({title:a.data.msg,icon:"none",duration:2e3})):t.data.onLogin||(t.data.onLogin=!0,e.getLogin(),e.initOkCallback=function(a){t.setData({wxToken:a}),t.getData(),e.initOkCallback=null,setTimeout((function(){t.data.onLogin=!1}),3e3)})}})},getWxCode:function(){var t=this;t.data.promiseList=new Promise((function(a,e){var i=0,s=t.data.caImg.length;!function e(){if(s>i){var n=t.data.caImg[i];n.url?wx.getImageInfo({src:n.url,success:function(t){n.endUrl=t.path,i++,e()},fail:function(t){console.log("错误-res",t,n,i),i++,e()}}):(i++,e())}else s==i&&(console.log("1加载完了"),a())}()}))},myevent:function(t){this.setData({bindPopShow:t.detail.bindPopShow})},itemClick:function(t){},bindCol:function(t){this.setData({gameId:t.detail.gameId,loadImagePath:"",imgbuilded:!1,promiseList:[],promiseList2:[],promiseList3:[],promiseList4:[],promiseList5:[]}),this.getData()},getUser:function(){var t=this;wx.getStorageSync("10001"+e.globalData.userInfo.idvId+"_playerstatis");function i(e){var i=a({},e);i.headimg=t.data.imgUrl+"/greed"+(-1!=i.use_portrait?i.use_portrait_path:"/face_common/fs_0005.png"),i.headcover=t.data.imgUrl+"/greed"+(-1!=i.use_frame?i.user_frame_path:"/face_cover/fc_0001.png"),t.setData({user:i,skinList:[],frameList:[],entourageList:[],additionsList:[]}),t.data.caImg[3].url=i.headimg,t.data.caImg[4].url=i.headcover,t.getWxCode(),t.getSkin(i.skin_list),t.getAdditions(i.carry_list),t.getEntourage(i.pet_list),t.getFrame(i.frame_list)}e.globalData.userPlayerStatis?(console.log("已经有了"),i(e.globalData.userPlayerStatis)):(e.userPlayerStatisOver=function(t){console.log("还没有这个, 现在有了",t),i(t)},e.getPlayerStatis())},getSkin:function(t){var a=this;t=t.replace("[","").replace("]",""),wx.request({url:this.data.apiUrl+"/w/epro/baseInfo/skin",method:"POST",header:{"Content-Type":"application/x-www-form-urlencoded"},data:{idList:t,wxToken:e.globalData.wxToken,camp:"",quality:"",discontinuedSign:""},success:function(t){if(200==t.data.code&&t.data.data){t.data.data.forEach((function(t,a){t.useName=t.name,delete t.createBy,delete t.createByPart,delete t.currPermission,delete t.currPermissionOffice,delete t.createTime,delete t.id,delete t.updateTime,delete t.currPermission,delete t.primaryNo,delete t.remarks,delete t.isNewRecord,delete t.discontinuedSign,delete t.roleId}));var i=a.moveDiscontinuedToQualityFirst(t.data.data);Promise.all([a.data.promiseList]).then((function(t){a.data.promiseList2=new Promise((function(t,e){var s=0,n=i.length;console.log(2),a.data.onTest||function e(){if(n>s){var r=i[s];wx.getImageInfo({src:a.data.imgUrl+"/greed"+r.iconPath,success:function(t){r.endUrl=t.path,s++,e()},fail:function(t){console.log("错误-res",t,r,s),s++,e()}})}else n==s&&(console.log("2加载完了"),t())}()}))})),a.data.skinListByCamp=[{name:"监管者",list:[]},{name:"求生者",list:[]}],a.data.skinListByQuality=[{name:"虚妄杰作",list:[]},{name:"稀世时装",list:[]},{name:"奇珍时装",list:[]}],a.data.skinListByDiscontinuedSign=[{name:"限定",list:[],sign:1},{name:"伊藤润二",list:[],sign:2},{name:"女神异闻录",list:[],sign:3},{name:"公益系列",list:[],sign:4},{name:"剪刀手爱德华",list:[],sign:5},{name:"深渊1-3",list:[],sign:6},{name:"演绎之星",list:[],sign:7},{name:"推理之径限定",list:[],sign:8},{name:"弹丸论破",list:[],sign:9},{name:"柯南",list:[],sign:10},{name:"深渊4",list:[],sign:12},{name:"约定的梦幻岛",list:[],sign:13},{name:"溯洄",list:[],sign:15},{name:"COA5",list:[],sign:18},{name:"LINE FRIENDS",list:[],sign:19},{name:"B.Duck",list:[],sign:20},{name:"COA冠军",list:[],sign:21},{name:"时光代理人",list:[],sign:22},{name:"熊猫系列",list:[],sign:23},{name:"文豪野犬",list:[],sign:24},{name:"COA6",list:[],sign:28},{name:"镰田光司",list:[],sign:29},{name:"演绎之星—宁芙奖",list:[],sign:30},{name:"肯德基系列",list:[],sign:31},{name:"Angels of Death",list:[],sign:32},{name:"中国航天系列",list:[],sign:33},{name:"xxxHOLiC",list:[],sign:34},{name:"三丽鸥大明星",list:[],sign:35},{name:"COA7",list:[],sign:36},{name:"非人哉",list:[],sign:37},{name:"小小梦魇",list:[],sign:38},{name:"普通",list:[],sign:0}],wx.request({url:a.data.apiUrl+"/w/epro/baseInfo/get",header:{wxToken:e.globalData.wxToken},success:function(t){if(t.data.data){var e=JSON.parse(t.data.data);console.log("存储的数据",e);var s=e.skinListTemporaryByQuality,n=a.data.skinListByQuality,r=e.skinListTemporaryByCamp,o=a.data.skinListByCamp,d=e.skinListTemporaryByDiscontinuedSign,l=a.data.skinListByDiscontinuedSign;a.data.skinListTemporaryByQuality=JSON.parse(JSON.stringify(a.data.skinListByQuality)),a.data.skinListTemporaryByDiscontinuedSign=JSON.parse(JSON.stringify(a.data.skinListByDiscontinuedSign)),a.data.skinListTemporaryByCamp=JSON.parse(JSON.stringify(a.data.skinListByCamp)),i.forEach((function(t,e){t.isChange=!1,t.dragId=t.wyId,t.faIndex=e,t.choose=!1,s.forEach((function(a,e){a.list.forEach((function(a,e){a.d==t.wyId&&(t.choose=!!a.c)}))})),6==t.quality?a.data.skinListTemporaryByQuality[0].list.push(JSON.parse(JSON.stringify(t))):5==t.quality?a.data.skinListTemporaryByQuality[1].list.push(JSON.parse(JSON.stringify(t))):4==t.quality&&a.data.skinListTemporaryByQuality[2].list.push(JSON.parse(JSON.stringify(t))),t.choose=!1,r.forEach((function(a,e){a.list.forEach((function(a,e){a.d==t.wyId&&(t.choose=!!a.c)}))})),1==t.camp?a.data.skinListTemporaryByCamp[0].list.push(JSON.parse(JSON.stringify(t))):2==t.camp&&a.data.skinListTemporaryByCamp[1].list.push(JSON.parse(JSON.stringify(t))),t.choose=!1,d.forEach((function(a,e){a.list.forEach((function(a,e){a.d==t.wyId&&(t.choose=!!a.c)}))})),a.data.skinListTemporaryByDiscontinuedSign.forEach((function(a,e){t.discontinuedSignInt==a.sign&&a.list.push(t)}))})),s.forEach((function(t,e){t.list=t.list.sort(a.compare("n")),t.list.forEach((function(t,a){t.c&&i.forEach((function(a,i){a.wyId==t.d&&n[e].list.push(a)}))}))})),r.forEach((function(t,a){t.list.forEach((function(t,e){t.c&&i.forEach((function(e,i){e.wyId==t.d&&o[a].list.push(e)}))}))}));for(var c=0;c<l.length;c++)for(var u=0;u<l.length;u++)if(27==d[u].sign&&"COA6"==d[u].name&&(d[u].sign=28),null==d[u]||l[u].sign!=d[u].sign){d.splice(u,0,l[u]),console.log(u);break}d.forEach((function(t,a){t.list.forEach((function(e,s){e.c&&i.forEach((function(i,s){i.wyId==e.d&&(t.sign==i.discontinuedSignInt?l[a].list.push(i):i.choose=!1)}))}))})),console.log("数据1",d),console.log("数据2",l),a.data.skinListTemporaryByDiscontinuedSign.forEach((function(t,e){if(""!=t.list){var i=JSON.parse(JSON.stringify(t));i.list="",a.data.skinListByDiscontinuedSignChoose.push(i)}})),a.setData({skinListByQuality:JSON.parse(JSON.stringify(n)),skinListTemporaryByQuality:JSON.parse(JSON.stringify(a.data.skinListTemporaryByQuality)),skinListByDiscontinuedSign:JSON.parse(JSON.stringify(l)),skinListTemporaryByDiscontinuedSign:JSON.parse(JSON.stringify(a.data.skinListTemporaryByDiscontinuedSign)),skinListByDiscontinuedSignChoose:a.data.skinListByDiscontinuedSignChoose,skinListByCamp:JSON.parse(JSON.stringify(o)),skinListTemporaryByCamp:JSON.parse(JSON.stringify(a.data.skinListTemporaryByCamp))}),a.drag0=a.selectComponent("#drag0"),a.drag1=a.selectComponent("#drag1"),a.drag2=a.selectComponent("#drag2"),a.drag3=a.selectComponent("#drag3"),a.drag4=a.selectComponent("#drag4"),a.data.skinListTemporaryByDiscontinuedSign.forEach((function(t,e){""!=t.list&&(a["drag"+(t.sign+10)]=a.selectComponent("#drag"+(t.sign+10)))})),a.drag0.init(),a.drag1.init()}else i.forEach((function(t,e){t.choose=!0,t.isChange=!1,t.dragId=t.wyId,t.faIndex=e,6==t.quality?a.data.skinListByQuality[0].list.push(t):5==t.quality?a.data.skinListByQuality[1].list.push(t):4==t.quality&&a.data.skinListByQuality[2].list.push(t),1==t.camp?a.data.skinListByCamp[0].list.push(t):2==t.camp&&a.data.skinListByCamp[1].list.push(t),a.data.skinListByDiscontinuedSign.forEach((function(a,e){t.discontinuedSignInt==a.sign&&a.list.push(t)}))})),a.data.skinListByDiscontinuedSign.forEach((function(t,e){if(""!=t.list){var i=JSON.parse(JSON.stringify(t));i.list="",a.data.skinListByDiscontinuedSignChoose.push(i)}})),a.setData({skinListByQuality:JSON.parse(JSON.stringify(a.data.skinListByQuality)),skinListTemporaryByQuality:JSON.parse(JSON.stringify(a.data.skinListByQuality)),skinListByDiscontinuedSign:JSON.parse(JSON.stringify(a.data.skinListByDiscontinuedSign)),skinListTemporaryByDiscontinuedSign:JSON.parse(JSON.stringify(a.data.skinListByDiscontinuedSign)),skinListByDiscontinuedSignChoose:a.data.skinListByDiscontinuedSignChoose,skinListByCamp:JSON.parse(JSON.stringify(a.data.skinListByCamp)),skinListTemporaryByCamp:JSON.parse(JSON.stringify(a.data.skinListByCamp))}),a.drag0=a.selectComponent("#drag0"),a.drag1=a.selectComponent("#drag1"),a.drag2=a.selectComponent("#drag2"),a.drag3=a.selectComponent("#drag3"),a.drag4=a.selectComponent("#drag4"),a.data.skinListByDiscontinuedSign.forEach((function(t,e){""!=t.list&&(a["drag"+(t.sign+10)]=a.selectComponent("#drag"+(t.sign+10)))})),a.drag0.init(),a.drag1.init()}}),a.setData({skinList:i}),a.data.loaded++,a.canShowIndex()}else a.data.loaded++,a.canShowIndex()}})},getSkinWithSq:function(t,a,i,s,n){t=t.replace("[","").replace("]",""),wx.request({url:this.data.apiUrl+"/w/epro/baseInfo/skin",method:"POST",header:{"Content-Type":"application/x-www-form-urlencoded"},data:{idList:t,wxToken:e.globalData.wxToken,camp:a,quality:i,discontinuedSign:s},success:function(t){n(t),console.log("皮肤：",t.data)}})},changeSkinType:function(t){var a="";if(0==this.data.cardIndex?a=this.data.skinListTemporaryByQuality:1==this.data.cardIndex?a=this.data.skinListTemporaryByCamp:2==this.data.cardIndex&&(a=this.data.skinListTemporaryByDiscontinuedSign),0==t.detail.value)a.forEach((function(t,a){t.hide=!1}));else if(2==this.data.cardIndex){var e=this.data.skinListByDiscontinuedSignChoose[t.detail.value].sign;a.forEach((function(t,a){e==t.sign?t.hide=!1:t.hide=!0}))}else a.forEach((function(a,e){e==t.detail.value-1?a.hide=!1:a.hide=!0}));0==this.data.cardIndex?this.setData({skinListTemporaryByQuality:this.data.skinListTemporaryByQuality,byQualityIndex:t.detail.value}):1==this.data.cardIndex?this.setData({skinListTemporaryByCamp:this.data.skinListTemporaryByCamp,byCampIndex:t.detail.value}):2==this.data.cardIndex&&this.setData({skinListTemporaryByDiscontinuedSign:this.data.skinListTemporaryByDiscontinuedSign,byDiscontinuedSignIndex:t.detail.value})},tapAllChoose:function(){var t="";0==this.data.cardIndex?t=this.data.skinListTemporaryByQuality:1==this.data.cardIndex?t=this.data.skinListTemporaryByCamp:2==this.data.cardIndex&&(t=this.data.skinListTemporaryByDiscontinuedSign),this.data.allChoose?this.data.allChoose&&(t.forEach((function(t,a){t.list.forEach((function(t,a){1==t.choose&&(t.choose=!1,t.isChange=!t.isChange)}))})),this.setData({allChoose:!1})):(t.forEach((function(t,a){t.list.forEach((function(t,a){0==t.choose&&(t.choose=!0,t.isChange=!t.isChange)}))})),this.setData({allChoose:!0})),0==this.data.cardIndex?this.setData({skinListTemporaryByQuality:this.data.skinListTemporaryByQuality}):1==this.data.cardIndex?this.setData({skinListTemporaryByCamp:this.data.skinListTemporaryByCamp}):2==this.data.cardIndex&&this.setData({skinListTemporaryByDiscontinuedSign:this.data.skinListTemporaryByDiscontinuedSign})},skinChoose:function(a){var e=a.currentTarget.dataset.faindex,i=a.currentTarget.dataset.index,s="";if(0==this.data.cardIndex?s=this.data.skinListTemporaryByQuality:1==this.data.cardIndex?s=this.data.skinListTemporaryByCamp:2==this.data.cardIndex&&(s=this.data.skinListTemporaryByDiscontinuedSign),s[e].list[i].choose=!s[e].list[i].choose,s[e].list[i].isChange=!s[e].list[i].isChange,0==this.data.cardIndex){var n="skinListTemporaryByQuality["+e+"].list["+i+"]";this.setData(t({},n,s[e].list[i]))}else 1==this.data.cardIndex?this.setData({skinListTemporaryByCamp:this.data.skinListTemporaryByCamp}):2==this.data.cardIndex&&this.setData({skinListTemporaryByDiscontinuedSign:this.data.skinListTemporaryByDiscontinuedSign});var r=0,o=0;s.forEach((function(t,a){t.list.forEach((function(t,a){r++,0==t.choose||1==t.choose&&o++}))})),r==o?this.setData({allChoose:!0}):this.setData({allChoose:!1})},skinAffirm:function(){var t=this,a="",e="";0==t.data.cardIndex?(a=t.data.skinListTemporaryByQuality,e=t.data.skinListByQuality):1==t.data.cardIndex?(a=t.data.skinListTemporaryByCamp,e=t.data.skinListByCamp):2==t.data.cardIndex&&(a=t.data.skinListTemporaryByDiscontinuedSign,e=t.data.skinListByDiscontinuedSign),a.forEach((function(t,a){t.list.forEach((function(t,i){t.isChange&&(t.choose?t.choose&&e[a].list.push(t):e[a].list.forEach((function(i,s){i.wyId==t.wyId&&e[a].list.splice(s,1)})),t.isChange=!1)}))})),0==t.data.cardIndex?(t.setData({skinListByQuality:e}),t.drag2.init(),t.drag3.init(),t.drag4.init()):1==t.data.cardIndex?(t.setData({skinListByCamp:e}),t.drag0.init(),t.drag1.init()):2==t.data.cardIndex&&(t.setData({skinListByDiscontinuedSign:e}),t.data.skinListByDiscontinuedSign.forEach((function(a,e){""!=a.list&&(console.log(a.sign+10),t["drag"+(a.sign+10)].init())}))),t.hideSkinChoose()},skindel:function(t){var a="",e="",i=t.detail.data,s=parseInt(t.detail.extra.test),n=t.detail.key;0==this.data.cardIndex?(a=this.data.skinListTemporaryByQuality,e=this.data.skinListByQuality):1==this.data.cardIndex?(a=this.data.skinListTemporaryByCamp,e=this.data.skinListByCamp):2==this.data.cardIndex&&(a=this.data.skinListTemporaryByDiscontinuedSign,e=this.data.skinListByDiscontinuedSign),a[s].list.forEach((function(t,a){i.wyId==t.wyId&&(t.choose=!1)})),e[s].list.splice(n,1),0==this.data.cardIndex?(this.setData({skinListByQuality:e,skinListTemporaryByQuality:a,allChoose:!1}),this["drag"+(s+2)].init()):1==this.data.cardIndex?(this.setData({skinListByCamp:e,skinListTemporaryByCamp:a,allChoose:!1}),this["drag"+s].init()):2==this.data.cardIndex&&(this.setData({skinListByDiscontinuedSign:e,skinListTemporaryByDiscontinuedSign:a,allChoose:!1}),this["drag"+(i.discontinuedSignInt+10)].init())},showSkinClear:function(t){var a=this,e="",i=t.currentTarget.dataset.index;wx.reportEvent("mycollect_skinclear",{}),wx.showModal({title:"提示",content:"确定清空所有展示时装吗？",success:function(t){t.cancel||t.confirm&&(0==a.data.cardIndex?e=a.data.skinListTemporaryByQuality:1==a.data.cardIndex?e=a.data.skinListTemporaryByCamp:2==a.data.cardIndex&&(e=a.data.skinListTemporaryByDiscontinuedSign),e[i].list.forEach((function(t,a){t.choose=!1})),0==a.data.cardIndex?(a.data.skinListByQuality[i].list=[],a.setData({skinListByQuality:a.data.skinListByQuality,skinListTemporaryByQuality:e,allChoose:!1})):1==a.data.cardIndex?(a.data.skinListByCamp[i].list=[],a.setData({skinListByCamp:a.data.skinListByCamp,skinListTemporaryByCamp:e,allChoose:!1})):2==a.data.cardIndex&&(a.data.skinListByDiscontinuedSign[i].list=[],a.setData({skinListByDiscontinuedSign:a.data.skinListByDiscontinuedSign,skinListTemporaryByDiscontinuedSign:e,allChoose:!1})))}})},sortEnd:function(t){0==this.data.cardIndex?(this.data.skinListByQuality[this.data.longPressIndex].list=t.detail.listData,this.setData({skinListByQuality:this.data.skinListByQuality}),this["drag"+(this.data.longPressIndex+2)].init()):1==this.data.cardIndex?(this.data.skinListByCamp[this.data.longPressIndex].list=t.detail.listData,this.setData({skinListByCamp:this.data.skinListByCamp}),this["drag"+this.data.longPressIndex].init()):2==this.data.cardIndex&&(this.data.skinListByDiscontinuedSign[this.data.longPressIndex].list=t.detail.listData,this.setData({skinListByDiscontinuedSign:this.data.skinListByDiscontinuedSign}),this["drag"+(this.data.skinListByDiscontinuedSign[this.data.longPressIndex].list[0].discontinuedSignInt+10)].init())},skinlongpress:function(t){this.data.longPressIndex=t.currentTarget.dataset.index},changeCard:function(t){var a=this,e="";a.setData({cardIndex:t.detail.value}),wx.reportEvent("mycollect_changecard",{}),0==a.data.cardIndex?e=a.data.skinListTemporaryByQuality:1==a.data.cardIndex?e=a.data.skinListTemporaryByCamp:2==a.data.cardIndex&&(e=a.data.skinListTemporaryByDiscontinuedSign),a.data.allChoose=!0,e.forEach((function(t,e){t.list.forEach((function(t,e){0==t.choose&&(a.data.allChoose=!1)}))})),a.setData({allChoose:a.data.allChoose}),a.drag0.init(),a.drag1.init(),a.drag2.init(),a.drag3.init(),a.drag4.init(),a.data.skinListByDiscontinuedSign.forEach((function(t,e){""!=t.list&&a["drag"+(t.sign+10)].init()}))},getQrcode:function(){var t=this;wx.getImageInfo({src:"https://dwxcx.fp.ps.netease.com/file/6594ba1a271d8c0bb8dfb7ffviUmLMJS05",success:function(a){t.data.canvasQrcode=a.path},fail:function(t){console.log("错误-res",t,res.data.msg)}})},showSkinChoose:function(t){wx.reportEvent("mycollect_skinchoose",{});console.log(t.currentTarget.dataset.index);var a=this.data.skinListByDiscontinuedSign[t.currentTarget.dataset.index].sign;2==this.data.cardIndex?this.data.skinListByDiscontinuedSignChoose.forEach((function(e,i){a==e.sign&&(t.detail.value=i)})):t.detail.value=t.currentTarget.dataset.index+1,this.changeSkinType(t),this.setData({skinChooseShow:!0})},hideSkinChoose:function(){this.setData({skinChooseShow:!1})},getAdditions:function(t){var a=this;t=t.replace("[","").replace("]",""),wx.request({url:this.data.apiUrl+"/w/epro/baseInfo/additions",method:"POST",header:{"Content-Type":"application/x-www-form-urlencoded"},data:{idList:t,wxToken:e.globalData.wxToken},success:function(t){if(200==t.data.code&&t.data.data){var e=t.data.data;Promise.all([a.data.promiseList,a.data.promiseList2]).then((function(t){a.data.promiseList3=new Promise((function(t,i){var s=0,n=e.length;console.log(3),a.data.onTest||function i(){if(n>s){var r=e[s];wx.getImageInfo({src:a.data.imgUrl+"/greed"+r.iconPath,success:function(t){r.endUrl=t.path,i(),s++},fail:function(t){console.log("错误-res",t,r,s),i(),s++}})}else n==s&&(console.log("3加载完了"),t())}()}))})),a.setData({additionsList:e})}else console.log(t.data.msg);a.data.loaded++,a.canShowIndex()}})},getEntourage:function(t){var a=this;t=t.replace("[","").replace("]",""),wx.request({url:this.data.apiUrl+"/w/epro/baseInfo/entourage",method:"POST",header:{"Content-Type":"application/x-www-form-urlencoded"},data:{idList:t,wxToken:e.globalData.wxToken},success:function(t){if(200==t.data.code&&t.data.data){var e=t.data.data;Promise.all([a.data.promiseList,a.data.promiseList2,a.data.promiseList3]).then((function(t){a.data.promiseList4=new Promise((function(t,i){var s=0,n=e.length;console.log(4),a.data.onTest||function i(){if(n>s){var r=e[s];wx.getImageInfo({src:a.data.imgUrl+"/greed"+r.iconPath,success:function(t){r.endUrl=t.path,s++,i()},fail:function(t){console.log("错误-res",t,r,s),s++,i()}})}else n==s&&(console.log("4加载完了"),t())}()}))})),a.setData({entourageList:e})}a.data.loaded++,a.canShowIndex()}})},getFrame:function(t){var a=this;t=t.replace("[","").replace("]",""),wx.request({url:this.data.apiUrl+"/w/epro/baseInfo/frame",method:"POST",header:{"Content-Type":"application/x-www-form-urlencoded"},data:{idList:t,wxToken:e.globalData.wxToken},success:function(t){if(200==t.data.code&&t.data.data){var e=t.data.data;Promise.all([a.data.promiseList,a.data.promiseList2,a.data.promiseList3,a.data.promiseList4]).then((function(t){a.data.promiseList5=new Promise((function(t,a){e.length;console.log("5不要了"),console.log("5加载完了"),t()}))})),a.setData({frameList:e})}a.data.loaded++,a.canShowIndex()}})},handlerGobackClick:function(t){var a=this;wx.showModal({title:"提示",content:"是否保存当前操作",success:function(i){i.cancel||i.confirm&&a.saveSkinData(),getCurrentPages().length>=2?wx.navigateBack({delta:t}):wx.redirectTo({url:e.globalData.pageIndex})}})},handlerGohomeClick:function(){wx.redirectTo({url:e.globalData.pageIndex})},getUserProfile:function(t){var a=this;wx.getUserProfile({desc:"用于完善用户资料",success:function(t){wx.setStorage({key:"userInfo",data:t.userInfo}),a.setData({userInfo:t.userInfo,hasUserInfo:!0}),wx.request({url:a.data.apiUrl+"/w/epro/wechatuser/mine/info/update",data:{nickname:t.userInfo.nickName,avatar:t.userInfo.avatarUrl},method:"POST",header:{wxToken:a.data.wxToken,"Content-Type":"application/json"},success:function(t){}})}})},getSysInfo:function(){var t=this,a=this;wx.request({url:a.data.apiUrl+"/w/lottery/activity/query",header:{wxToken:a.data.wxToken},success:function(t){console.log(t,"活动列表"),200==t.data.code&&wx.request({url:a.data.apiUrl+"/w/mission/setDrawStatus",header:{wxToken:a.data.wxToken},data:{activityId:t.data.data[0].id,taskId:"241c22ee121243a68dc34145ebd96111"},success:function(t){console.log(t,"战绩已分享")}})}});var i,s=[],n=0;(0==a.data.cardIndex?s=a.data.skinListByQuality:1==a.data.cardIndex?s=a.data.skinListByCamp:2==a.data.cardIndex&&(s=a.data.skinListByDiscontinuedSign),s.forEach((function(t,a){n+=t.list.length})),wx.reportEvent("mycollectt_bulid",{}),console.log(n),a.setData({timeEights:!1}),e.globalData.collectMsgUsed)?n>80?wx.showModal({title:"提示",content:"当前物品数量过多，生成全部图鉴易导致加载时间过长或生成失败的情况，建议只展示稀有度较高的物品。",cancelText:"部分生成",confirmText:"仍要生成",success:function(t){t.cancel?a.data.bulidLess=!0:t.confirm&&(a.data.bulidLess=!1),r()}}):r():e.getUserSetting((function(s){var o=!1;console.log(s),"accept"===s.subscriptionsSetting["qu4m8mq3gcIqUtrih-GradI1Bl8nXkXmEqn16Gw1Mcg"]?(console.log("总是订阅了该条订阅消息"),o=!0):(t.setData({messageTipGif:!0}),i=setInterval((function(){t.setData({messageTipGifUrl:"".concat(e.globalData.imgUrl,"/vsrecord/message_subscription-wechat.gif?time=").concat(Date.now())})}),5e3));var d="qu4m8mq3gcIqUtrih-GradI1Bl8nXkXmEqn16Gw1Mcg";wx.requestSubscribeMessage({tmplIds:[d],success:function(i){e.getUserSetting((function(e){"accept"===e.subscriptionsSetting[d]&&(console.log("总是订阅了该条订阅消息"),o=!0),wx.request({url:a.data.apiUrl+"/w/subscribe/subscribe",data:{type:2,idvId:t.data.gameId,always:o},method:"POST",header:{wxToken:a.data.wxToken},success:function(t){wx.reportEvent("collect_message_success",{}),200==t.data.code?console.log("subscribe/subscribe成功"):console.log(t.data.msg)}})}))},complete:function(s){wx.reportEvent("collect_message_touch",{}),n>80?wx.showModal({title:"提示",content:"当前物品数量过多，生成全部图鉴易导致加载时间过长或生成失败的情况，建议只展示稀有度较高的物品。",cancelText:"部分生成",confirmText:"仍要生成",success:function(t){t.cancel?a.data.bulidLess=!0:t.confirm&&(a.data.bulidLess=!1),r()}}):r(),e.globalData.collectMsgUsed=!0,i&&(t.setData({messageTipGif:!1}),clearInterval(i),i=null)}})}));function r(){a.data.imgbuilded||(a.data.imgbuilded=!0,a.setData({showCanvas:!0}),setTimeout((function(){a.setData({timeEights:!0}),wx.showLoading({title:"图片生成中"}),a.getImginfo()}),5e3))}a.saveSkinData()},saveSkinData:function(){var t=this,a=JSON.parse(JSON.stringify(t.data.skinListTemporaryByQuality)),i=JSON.parse(JSON.stringify(t.data.skinListTemporaryByCamp)),s=JSON.parse(JSON.stringify(t.data.skinListTemporaryByDiscontinuedSign));a.forEach((function(a,e){a.list.forEach((function(a,i){t.data.skinListByQuality[e].list.forEach((function(t,e){t.wyId==a.wyId&&(a.n=e)})),a.d=parseInt(a.wyId),a.c=a.choose?1:0,null==a.n&&(a.n=999),delete a.wyId,delete a.choose,delete a.camp,delete a.discontinuedSignInt,delete a.dragId,delete a.faIndex,delete a.iconPath,delete a.isChange,delete a.name,delete a.quality,delete a.useName}))})),i.forEach((function(a,e){a.list.forEach((function(a,i){t.data.skinListByCamp[e].list.forEach((function(t,e){t.wyId==a.wyId&&(a.n=e)})),a.d=parseInt(a.wyId),a.c=a.choose?1:0,null==a.n&&(a.n=999),delete a.wyId,delete a.choose,delete a.camp,delete a.discontinuedSignInt,delete a.dragId,delete a.faIndex,delete a.iconPath,delete a.isChange,delete a.name,delete a.quality,delete a.useName}))})),s.forEach((function(a,e){a.list.forEach((function(a,i){t.data.skinListByDiscontinuedSign[e].list.forEach((function(t,e){t.wyId==a.wyId&&(a.n=e)})),a.d=parseInt(a.wyId),a.c=a.choose?1:0,null==a.n&&(a.n=999),delete a.wyId,delete a.choose,delete a.camp,delete a.discontinuedSignInt,delete a.dragId,delete a.faIndex,delete a.iconPath,delete a.isChange,delete a.name,delete a.quality,delete a.useName}))}));var n={skinListTemporaryByCamp:i,skinListTemporaryByDiscontinuedSign:s,skinListTemporaryByQuality:a};wx.request({url:this.data.apiUrl+"/w/epro/baseInfo/save",method:"POST",header:{wxToken:e.globalData.wxToken},data:{skinList:JSON.stringify(n)},success:function(t){}})},canvasHide:function(){this.setData({showCanvas:!1,loadImagePath:""})},getImginfo:function(t){var a=this;Promise.all([a.data.promiseList,a.data.promiseList2,a.data.promiseList3,a.data.promiseList4,a.data.promiseList5]).then((function(t){a.createNewImg()}))},onPageScroll:function(t){var a=this;clearTimeout(a.data.setScroll),a.data.setScroll=setTimeout((function(){a.setData({scrollTop:t.scrollTop})}),200)},scroll:function(t){this.setData({pageMetaScrollTop:t.detail.scrollTop})},hideTips:function(){this.setData({showTips:!1})},canShowIndex:function(){4==this.data.loaded&&(this.setData({isLoading:!1}),wx.hideLoading())},compare:function(t){return function(a,e){return a[t]-e[t]}},getStartDay:function(){var t=this;wx.request({url:this.data.apiUrl+"/w/epro/wechatuser/mine/createDt",data:{wxToken:t.data.wxToken,server:10001,roleId:t.data.gameId},success:function(a){var e=a.data.data;if(200==a.data.code&&null!=e.create_dt){var i=new Date(e.create_dt.substring(0,4)+"/"+e.create_dt.substring(4,6)+"/"+e.create_dt.substring(6,8)).getTime(),s=(new Date).getTime(),n="你已经加入第五庄园"+parseInt((s-i)/864e5)+"天";t.setData({dayDesc:n})}else wx.showToast({title:a.data.msg,icon:"none",duration:2e3})}})},moveDiscontinuedToQualityFirst:function(t){for(var a,e=[].concat(t),i=0,s=!1,n=0,r=!1,o=0;o<t.length;o++)s||5!=t[o].quality||(i=o,s=!0),r||4!=t[o].quality||(n=o,r=!0);console.log(i,n);for(var d=t.length-1;d>=0;d--){var l=t[d];5==t[d].quality&&1==t[d].discontinuedSignInt&&e.splice(i,0,l),4==t[d].quality&&1==t[d].discontinuedSignInt&&e.splice(n,0,l)}return a=e,e=Array.from(a.reduce((function(t,a){var e=a.wyId;return t.has(e)||t.set(e,a),t}),new Map).values())},onShareAppMessage:function(){return{path:"/pages_user/pages/user/collect",success:function(t){},fail:function(){},complete:function(){}}}});
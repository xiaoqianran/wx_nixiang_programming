var e=require("../../../@babel/runtime/helpers/typeof"),t=require("../../../@babel/runtime/helpers/objectSpread2"),a=getApp(),n=require("./config.js"),s="https://nie.res.netease.com/id5/m/zt/20201215094138/data";Page({data:{imgUrl:a.globalData.imgUrl,apiUrl:a.globalData.apiUrl,wxToken:a.globalData.wxToken,user:[],gameId:"",skinList:[],frameList:[],entourageList:[],additionsList:[],_canvasw:0,_canvasH:0,showCanvas:!1,canvasQrcode:null,caImg:[{url:s+"/precious/p1ex.jpg",w:750,h:1795,t:0,l:0},{url:"",w:136,h:136,t:76,l:293},{w:164,h:152,t:62,l:280},{url:"",w:86,h:86,t:474,l:73},{url:"",w:144,h:144,t:445,l:44},{w:651,h:370,t:-154,l:0},{url:s+"/precious/tt1.png",w:503,h:118,t:0,l:126,unus:!0},{url:s+"/precious/allrole.png",w:100,h:86,t:1120,l:230,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/skin3.png",w:160,h:240,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/skin4.png",w:160,h:240,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sc4.png",w:140,h:140,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sc3.png",w:140,h:140,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/pet3.png",w:140,h:140,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/pet2.png",w:140,h:140,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/pet1.png",w:140,h:140,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/user/inner_bg2.png",w:140,h:140,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sk_bz1.png",w:120,h:120,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sk_bz2.png",w:120,h:120,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sk_bz3.png",w:120,h:120,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sk_bz4.png",w:120,h:120,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sk_bz5.png",w:120,h:120,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sk_bz6.png",w:120,h:120,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sk_bz7.png",w:120,h:120,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sk_bz8.png",w:120,h:120,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sk_bz9.png",w:120,h:120,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sk_bz10.png",w:120,h:120,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sk_bz1.png",w:120,h:120,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sk_bz12.png",w:120,h:120,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sk_bz13.png",w:120,h:120,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sk_bz1.png",w:120,h:120,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sk_bz15.png",w:120,h:120,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sc5.png",w:140,h:140,unus:!0},{w:120,h:120},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sk_bz18.png",w:120,h:120,unus:!0},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sk_bz19.png",w:120,h:120},{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/sk_bz20.png",w:120,h:120,unus:!0},{url:s+"/precious/li.png",w:188,h:410,t:655,l:375,unus:!0},{url:s+"/precious/ic2.png",w:145,h:62,t:641,l:375,unus:!0},{url:s+"/precious/ic1.png",w:56,h:56,t:645,l:423,unus:!0},{url:s+"/precious/icon/1.png",w:44,h:44,t:1168,l:93},{url:s+"/precious/icon/2.png",w:44,h:44,t:1168,l:416},{url:s+"/precious/icon/3.png",w:44,h:44,t:1246,l:93},{url:s+"/precious/icon/4.png",w:44,h:44,t:1246,l:416},{url:s+"/precious/icon/5.png",w:44,h:44,t:1322,l:93},{url:s+"/precious/icon/6.png",w:44,h:44,t:1322,l:416},{url:s+"/precious/icon/7.png",w:44,h:44,t:1399,l:93},{url:s+"/precious/icon/8.png",w:44,h:44,t:1399,l:416},{url:s+"/precious/p_t.png",w:733,h:100,t:0,l:8,unus:!0},{url:s+"/precious/p_c.jpg",w:733,h:0,t:0,l:8,unus:!0},{url:s+"/precious/p_b.png",w:733,h:100,t:0,l:8,unus:!0},{url:s+"/precious/bg2.jpg",w:750,h:0,t:0,l:0,unus:!0},{url:s+"/precious/p1_p.png",w:702,h:443,t:1102,l:42,unus:!0},{url:s+"/icon.png",w:105,h:105,t:0,l:627,unus:!0},{url:"",w:0,h:0,t:0,l:0,unus:!0},{url:s+"/greed/sk_bz21.png",w:120,h:120,unus:!0},{url:s+"/greed/sk_bz22.png",w:120,h:120,unus:!0},{url:s+"/greed/sk_bz23.png",w:120,h:120,unus:!0},{url:s+"/greed/sk_bz24.png",w:120,h:120,unus:!0},{url:s+"/greed/sk_bz28.png",w:120,h:120,unus:!0},{url:s+"/greed/sk_bz29.png",w:120,h:120,unus:!0},{url:s+"/greed/sk_bz30.png",w:120,h:120,unus:!0},{url:s+"/greed/sk_bz31.png",w:120,h:120,unus:!0},{url:s+"/greed/sk_bz32.png",w:120,h:120,unus:!0},{url:s+"/greed/sk_bz33.png",w:120,h:120,unus:!0},{url:s+"/greed/sk_bz34.png",w:120,h:120,unus:!0},{url:s+"/greed/sk_bz35.png",w:120,h:120,unus:!0},{url:s+"/greed/sk_bz36.png",w:120,h:120,unus:!0},{url:s+"/greed/sk_bz37.png",w:120,h:120,unus:!0},{url:s+"/greed/sk_bz38.png",w:120,h:120,unus:!0}],bjMapList:n.bjMapList,caReadyImg:[],promiseList:[],promiseList2:[],promiseList3:[],promiseList4:[],promiseList5:[],loadPath:s+"/greed",imgbuilded:!1,bindPopShow:!1,userInfo:null,hasUserInfo:!1,sbex:!1,bindUserVisible:!1,canGetMyCode:!1,loaded:0,timeEights:!1,messageTipGif:!1,messageTipGifUrl:"".concat(a.globalData.imgUrl,"/vsrecord/message_subscription-wechat.gif"),newUploadFile:"",flag:!1,flag_upload:!1,flagName:!0,nameImg:"",inputText:"",comImg:"",inputFlag:!1},getSysInfo:function(){var e,t=this,n=this,s=n.data.skinList.length;(wx.reportEvent("collect_build",{content:s}),n.data.taskId&&wx.request({url:n.data.apiUrl+"/w/mission/doTask",data:{taskId:n.data.taskId,activityId:a.globalData.activityId},header:{wxToken:n.data.wxToken},success:function(e){200==e.data.code?(n.data.taskId=null,wx.setStorage({key:"refreshTaskList",data:!0})):wx.showToast({title:e.data.msg,icon:"none",duration:3e3})}}),n.setData({timeEights:!1}),a.globalData.collectMsgUsed)?s>80?wx.showModal({title:"提示",content:"当前物品数量过多，生成全部图鉴易导致加载时间过长或生成失败的情况，建议只展示稀有度较高的物品。",cancelText:"部分生成",confirmText:"仍要生成",success:function(e){e.cancel?n.data.bulidLess=!0:e.confirm&&(n.data.bulidLess=!1),i()}}):i():a.getUserSetting((function(o){var l=!1;console.log(o),"accept"===o.subscriptionsSetting["qu4m8mq3gcIqUtrih-GradI1Bl8nXkXmEqn16Gw1Mcg"]?(console.log("总是订阅了该条订阅消息"),l=!0):(t.setData({messageTipGif:!0}),e=setInterval((function(){t.setData({messageTipGifUrl:"".concat(a.globalData.imgUrl,"/vsrecord/message_subscription-wechat.gif?time=").concat(Date.now())})}),5e3));var r="qu4m8mq3gcIqUtrih-GradI1Bl8nXkXmEqn16Gw1Mcg";wx.requestSubscribeMessage({tmplIds:[r],success:function(e){a.getUserSetting((function(e){"accept"===e.subscriptionsSetting[r]&&(console.log("总是订阅了该条订阅消息"),l=!0),wx.request({url:n.data.apiUrl+"/w/subscribe/subscribe",data:{type:2,idvId:t.data.gameId,always:l},method:"POST",header:{wxToken:n.data.wxToken},success:function(e){wx.reportEvent("collect_message_success",{}),200==e.data.code?console.log("subscribe/subscribe成功"):console.log(e.data.msg)}})}))},complete:function(o){wx.reportEvent("collect_message_touch",{}),s>80?wx.showModal({title:"提示",content:"当前物品数量过多，生成全部图鉴易导致加载时间过长或生成失败的情况，建议只展示稀有度较高的物品。",cancelText:"部分生成",confirmText:"仍要生成",success:function(e){e.cancel?n.data.bulidLess=!0:e.confirm&&(n.data.bulidLess=!1),i()}}):i(),a.globalData.collectMsgUsed=!0,e&&(t.setData({messageTipGif:!1}),clearInterval(e),e=null)}})}));function i(){n.data.imgbuilded||(n.data.imgbuilded=!0,n.setData({showCanvas:!0}),setTimeout((function(){n.setData({timeEights:!0}),wx.showLoading({title:"图片生成中"}),n.getImginfo()}),5e3))}},canvasHide:function(){this.setData({showCanvas:!1,loadImagePath:""})},getImginfo:function(){var e=this;Promise.all([e.data.promiseList,e.data.promiseList2,e.data.promiseList3,e.data.promiseList4,e.data.promiseList5]).then((function(t){e.createNewImg()}))},handleCustomReject:function(){this.data.gameId&&!a.globalData.userinfoApiStatus&&wx.redirectTo({url:a.globalData.pageIndex})},createNewImg:function(){var e=this,t=750,a=1e3,n=0,s=25,i=!1,o=e.data.caImg,l=e.data.bulidLess,r=e.data.skinList,d=e.data.additionsList,u=e.data.entourageList;e.data.frameList;if(l){var c=[],g=[],w=[];r.forEach((function(e,t){5!=e.quality&&6!=e.quality||c.push(e)})),r=c,d.forEach((function(e,t){5==e.quality&&g.push(e)})),d=g,u.forEach((function(e,t){4==e.quality&&w.push(e)})),u=w}var h=Math.ceil(r.length/4),m=1800,f=m+250*h,p=Math.ceil(d.length/5),x=f+200+136,T=x+144*p,v=Math.ceil(u.length/5),I=T+200+136,b=I+144*v,y=0,k=b,U=k+144*y;a=U+350,console.log(a),a>12e3&&(t=1500,n=375,i=!0,s=40,h=Math.ceil(r.length/8),f=(m=1800)+250*h,p=Math.ceil(d.length/10),T=(x=f+200+136)+144*p,v=Math.ceil(u.length/10),a=(U=(k=b=(I=T+200+136)+144*v)+144*(y=0))+350),console.log("end",a),e.setData({_canvasw:t,_canvasH:a}),setTimeout((function(){var l=wx.createCanvasContext("mycanvas");o.forEach((function(e,a){0==a&&(e.w=t),!e.unus&&e.endUrl&&l.drawImage(e.endUrl,0!=a?e.l+n:e.l,e.t,e.w,e.h),0==a&&l.drawImage(o[51].endUrl,o[51].l+n,o[51].t,o[51].w,o[51].h)})),l.drawImage(o[36].endUrl,o[36].l-o[36].w/2+n,o[36].t,o[36].w,o[36].h),l.drawImage(o[36].endUrl,o[36].l-326+n,o[36].t,o[36].w,o[36].h),l.drawImage(o[36].endUrl,o[36].l+141+n,o[36].t,o[36].w,o[36].h),l.drawImage(o[37].endUrl,o[37].l-o[37].w/2+n,o[37].t,o[37].w,o[37].h),l.drawImage(o[37].endUrl,o[37].l-304+n,o[37].t,o[37].w,o[37].h),l.drawImage(o[37].endUrl,o[37].l+163+n,o[37].t,o[37].w,o[37].h),l.drawImage(o[38].endUrl,o[38].l+n,o[38].t,o[38].w,o[38].h),l.drawImage(o[38].endUrl,o[38].l-230+n,o[38].t,o[38].w,o[38].h),l.drawImage(o[38].endUrl,o[38].l+236+n,o[38].t,o[38].w,o[38].h),l.setFontSize(26),l.setFillStyle("#2e1010"),l.setTextAlign("center"),l.fillText("时装",142+n,676),l.fillText("随身物品",375+n,676),l.fillText("随从",612+n,676),l.setFontSize(20),l.setFillStyle("#c8c6bf"),l.fillText(e.data.user.skin?e.data.user.skin:0,222+n,678),l.fillText(e.data.user.carry?e.data.user.carry:0,451+n,678),l.fillText(e.data.user.pet?e.data.user.pet:0,688+n,678),l.setFontSize(20),l.setFillStyle("#2e1010"),l.setTextAlign("left"),l.fillText("稀世",86+n,964),l.fillText("稀世",318+n,964),l.fillText("稀世",552+n,964),l.fillText("奇珍",86+n,998),l.fillText("奇珍",318+n,998),l.fillText("奇珍",552+n,998),l.fillText("独特",86+n,1032),l.fillText("独特",318+n,1032),l.fillText("独特",552+n,1032),l.setTextAlign("center"),l.fillText(e.data.user.skin_quality5,180+n,964),l.fillText(e.data.user.carry_quality5,412+n,964),l.fillText(e.data.user.pet_quality5,646+n,964),l.fillText(e.data.user.skin_quality4,180+n,998),l.fillText(e.data.user.carry_quality4,412+n,998),l.fillText(e.data.user.pet_quality4,646+n,998),l.fillText(e.data.user.skin_quality3,180+n,1032),l.fillText(e.data.user.carry_quality3,412+n,1032),l.fillText(e.data.user.pet_quality3,646+n,1032),l.setFontSize(24),l.setTextAlign("left"),l.fillText("角色数",157+n,1199),l.fillText("头像",157+n,1276),l.fillText("等待动作",157+n,1353),l.fillText("追击音乐",157+n,1430),l.fillText("涂鸦",478+n,1199),l.fillText("头像框",478+n,1276),l.fillText("个性动作",478+n,1353),l.fillText("归宿分",478+n,1430),l.setFontSize(24),l.setTextAlign("center"),l.fillText(e.data.user.hero,318+n,1200),l.fillText(e.data.user.portrait,318+n,1277),l.fillText(e.data.user.wait_act,318+n,1354),l.fillText(e.data.user.music,318+n,1431),l.fillText(e.data.user.graffiti,640+n,1200),l.fillText(e.data.user.frame,640+n,1277),l.fillText(e.data.user.per_act,640+n,1354),l.fillText(e.data.user.home_score,640+n,1431),e.data.user.hero==e.data.user.allHero&&l.drawImage(o[7].endUrl,o[7].l+n,o[7].t,o[7].w,o[7].h),l.setTextAlign("left"),l.fillText(e.data.user.role_name,188+n,514),l.setFontSize(20),l.fillText("ID:"+e.data.gameId,188+n+24*e.data.user.role_name.length+10,514),e.data.dayDesc&&l.fillText(e.data.dayDesc,188+n,556),l.drawImage(o[50].endUrl,0,m-60,t,a-1700),l.drawImage(o[47].endUrl,o[47].l+(i?16:0),m-100,i?2*o[47].w:o[47].w,o[47].h),l.drawImage(o[48].endUrl,o[48].l+(i?16:0),m,i?2*o[47].w:o[47].w,250*h),l.drawImage(o[49].endUrl,o[49].l+(i?16:0),f,i?2*o[47].w:o[47].w,o[49].h),l.drawImage(o[6].endUrl,o[6].l+n,m-170,o[6].w,o[6].h),l.setFontSize(34),l.setFillStyle("#2e1010"),l.setTextAlign("center"),l.fillText("角色时装展示区",375+n,m-94);var c=[s,s+180,s+360,s+540,s+720,s+900,s+1080,s+1260];r.forEach((function(t,a){var s,r=a%(4*(i?2:1)),d=parseInt(a/(4*(i?2:1)));6==t.quality?(t.endUrl&&l.drawImage(t.endUrl,c[r],m+250*d,o[9].w,o[9].h),l.setFontSize(18),l.setFillStyle("#000"),l.fillText(t.useName,c[r]+80,m+250*d+200)):5==t.quality?(l.drawImage(o[9].endUrl,c[r],m+250*d,o[9].w,o[9].h),l.setFontSize(20),l.setFillStyle("#dbb775"),l.fillText(t.useName,c[r]+80,m+250*d+210)):(l.drawImage(o[8].endUrl,c[r],m+250*d,o[8].w,o[8].h),l.setFontSize(20),l.setFillStyle("#0b090a"),l.fillText(t.useName,c[r]+80,m+250*d+210)),t.endUrl&&6!=t.quality&&l.drawImage(t.endUrl,c[r],m+250*d,o[9].w,o[9].h);var u=e.data.bjMapList[parseInt(t.discontinuedSign)]||null;if(u&&null!==(s=o[u])&&void 0!==s&&s.endUrl&&l.drawImage(o[u].endUrl,c[r]+80,m+250*d-18,o[u].w,o[u].h),0==a){var g,w=70+n,h=710;6==t.quality?(l.drawImage(t.endUrl,w,h,144,216),l.setFontSize(18),l.setFillStyle("#000"),l.fillText(t.useName,w+72,892)):5==t.quality?(l.drawImage(o[9].endUrl,w,h,144,216),l.setFillStyle("#dbb775"),l.fillText(t.useName,w+72,902)):(l.drawImage(o[8].endUrl,w,h,144,216),l.setFillStyle("#0b090a"),l.fillText(t.useName,w+72,902)),6!=t.quality&&l.drawImage(t.endUrl,w,h,144,216);var f=e.data.bjMapList[parseInt(t.discontinuedSign)]||null;f&&null!==(g=o[f])&&void 0!==g&&g.endUrl&&l.drawImage(o[f].endUrl,w+80,692,o[f].w,o[f].h)}})),l.drawImage(o[47].endUrl,o[47].l+(i?16:0),x-100,i?2*o[47].w:o[47].w,o[47].h),l.drawImage(o[48].endUrl,o[48].l+(i?16:0),x,i?2*o[47].w:o[47].w,144*p),l.drawImage(o[49].endUrl,o[49].l+(i?16:0),T,i?2*o[47].w:o[47].w,o[49].h),l.drawImage(o[6].endUrl,o[6].l+n,x-170,o[6].w,o[6].h),l.setFontSize(34),l.setFillStyle("#2e1010"),l.setTextAlign("center"),l.fillText("随身物品展示区",375+n,x-94);var g=[s,s+140,s+280,s+420,s+560,s+700,s+840,s+980,s+1120,s+1260];d.forEach((function(t,a){var s,r=a%(5*(i?2:1)),d=parseInt(a/(5*(i?2:1)));5==t.quality?l.drawImage(o[10].endUrl,g[r],x+144*d,o[10].w,o[10].h):6==t.quality?l.drawImage(o[31].endUrl,g[r],x+144*d,o[10].w,o[10].h):l.drawImage(o[11].endUrl,g[r],x+144*d,o[10].w,o[10].h),t.endUrl&&l.drawImage(t.endUrl,g[r]+20,x+144*d+20,100,100);var u=e.data.bjMapList[parseInt(t.discontinuedSign)]||null;if(u&&null!==(s=o[u])&&void 0!==s&&s.endUrl&&l.drawImage(o[u].endUrl,g[r]+70,x+144*d+3,90,90),0==a){var c,w=305+n;5==t.quality?l.drawImage(o[10].endUrl,w,740,o[10].w,o[10].h):6==t.quality?l.drawImage(o[31].endUrl,w,740,o[10].w,o[10].h):l.drawImage(o[11].endUrl,w,740,o[10].w,o[10].h),l.drawImage(t.endUrl,w+20,760,100,100);var h=e.data.bjMapList[parseInt(t.discontinuedSign)]||null;h&&null!==(c=o[h])&&void 0!==c&&c.endUrl&&l.drawImage(o[h].endUrl,w+70,743,90,90)}})),l.drawImage(o[47].endUrl,o[47].l+(i?16:0),I-100,i?2*o[47].w:o[47].w,o[47].h),l.drawImage(o[48].endUrl,o[48].l+(i?16:0),I,i?2*o[47].w:o[47].w,144*v),l.drawImage(o[49].endUrl,o[49].l+(i?16:0),b,i?2*o[47].w:o[47].w,o[49].h),l.drawImage(o[6].endUrl,o[6].l+n,I-170,o[6].w,o[6].h),l.fillText("随从展示区",375+n,I-94);var w=[s,s+140,s+280,s+420,s+560,s+700,s+840,s+980,s+1120,s+1260];u.forEach((function(e,t){var a=t%(5*(i?2:1)),s=parseInt(t/(5*(i?2:1)));if(4==e.quality?l.drawImage(o[12].endUrl,w[a],I+144*s,o[14].w,o[14].h):3==e.quality?l.drawImage(o[13].endUrl,w[a],I+144*s,o[14].w,o[14].h):l.drawImage(o[14].endUrl,w[a],I+144*s,o[14].w,o[14].h),e.endUrl&&l.drawImage(e.endUrl,w[a]+20,I+144*s+20,100,100),0==t){var r=540+n;4==e.quality?l.drawImage(o[12].endUrl,r,740,o[14].w,o[14].h):3==e.quality?l.drawImage(o[13].endUrl,r,740,o[14].w,o[14].h):l.drawImage(o[14].endUrl,r,740,o[14].w,o[14].h),e.endUrl&&l.drawImage(e.endUrl,r+20,760,100,100)}})),l.setFillStyle("#fff"),l.fillRect(0,a-190,t,190),l.setFontSize("26"),l.setTextAlign("left"),l.setFillStyle("#000000"),l.fillText("查战绩，就上网易第五人格",212+n,a-129),l.setFontSize("20"),l.setTextAlign("left"),l.setFillStyle("#695f53"),l.fillText("扫描二维码，绑定角色即可查看战绩和",212+n,a-77),l.fillText("定制专属图鉴",212+n,a-47),l.drawImage(o[52].endUrl,o[52].l+n,a-148,o[52].w,o[52].h),e.data.canvasQrcode&&l.drawImage(e.data.canvasQrcode,15+n,a-175,160,160),l.draw(!0,(function(){setTimeout((function(){!function n(){wx.canvasToTempFilePath({canvasId:"mycanvas",fileType:"jpg",quality:.6,y:440,destWidth:t,destHeight:a-440,success:function(n){var s=n.tempFilePath;wx.hideLoading(),e.setData({loadImagePath:s,imgbuilded:!1}),wx.showModal({title:"提示",content:"将生成的海报保存到手机相册，可以发送给微信好友或分享到朋友圈",success:function(e){wx.showToast({title:"长按屏幕可保存生成的图鉴",icon:"none",duration:3e3})}}),l.clearRect(0,0,t,a)},fail:function(e){console.log(e),setTimeout((function(){n()}),1e3)}})}()}),2e3)}))}),200)},saveImg:function(){wx.saveImageToPhotosAlbum({filePath:this.data.loadImagePath,success:function(e){wx.showToast({title:"已保存到相册",icon:"success",duration:3e3})}})},getQrcode:function(){var e=this;wx.getImageInfo({src:"https://dwxcx.fp.ps.netease.com/file/6594ba1a271d8c0bb8dfb7ffviUmLMJS05",success:function(t){e.data.canvasQrcode=t.path},fail:function(e){console.log("错误-res",e,res.data.msg)}})},saveCode:function(){var e=this;wx.saveImageToPhotosAlbum({filePath:e.data.loadImagePath,success:function(t){wx.showToast({title:"已保存到相册",icon:"success",duration:3e3}),e.canvasHide()},fail:function(e){console.log("err",e),"saveImageToPhotosAlbum:fail:auth denied"!==e.errMsg&&"saveImageToPhotosAlbum:fail auth deny"!==e.errMsg&&"saveImageToPhotosAlbum:fail authorize no response"!==e.errMsg||wx.showModal({title:"提示",content:"需要您授权保存相册",showCancel:!1,success:function(e){wx.openSetting({success:function(e){console.log("settingdata",e),e.authSetting["scope.writePhotosAlbum"]?wx.showModal({title:"提示",content:"获取权限成功,再次长按图片即可保存",showCancel:!1}):wx.showModal({title:"提示",content:"获取权限失败，将无法保存到相册哦~",showCancel:!1})},fail:function(e){console.log("failData",e)},complete:function(e){console.log("finishData",e)}})}})}})},onLoad:function(e){var t=this;this.setData({gameId:null,taskId:e.task,wxToken:a.globalData.wxToken}),this.data.wxToken?this.getData():a.initOkCallback=function(e){t.setData({wxToken:a.globalData.wxToken}),t.getData()}},getData:function(){this.data.loaded=0,this.setData({isLoading:!0}),wx.showLoading({title:"加载中"}),this.getGameUserInfo(),this.getQrcode()},getGameUserInfo:function(){var e=this;wx.request({url:this.data.apiUrl+"/w/epro/wechatuser/mine/userinfo",data:{wxToken:e.data.wxToken},header:{wxToken:e.data.wxToken},success:function(t){var n=t.data.data,s={};-10000301!=t.data.code?(1==n.codeStatus&&(e.data.canGetMyCode=!0,e.setData({canGetMyCode:e.data.canGetMyCode})),null!=n.userAvatarUrl||null!=n.wxName?(s.avatarUrl=n.userAvatarUrl?n.userAvatarUrl:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/vsrecord/headimg2/3.jpg",s.nickName=n.wxName?n.wxName:"微信用户",e.setData({userInfo:s})):e.setData({userInfo:null}),"该账号暂未绑定游戏角色！"==t.data.msg||null==n.idvId?(e.setData({isLoading:!1}),wx.hideLoading()):200==t.data.code?(e.setData({gameId:t.data.data.idvId}),e.getUser(),e.getStartDay(),wx.getStorage({key:"tipsShow_collect_220223",success:function(e){},fail:function(t){wx.setStorage({key:"tipsShow_collect_220223",data:!0}),e.setData({showTips:!0})}})):wx.showToast({title:t.data.msg,icon:"none",duration:2e3})):e.data.onLogin||(e.data.onLogin=!0,a.getLogin(),a.initOkCallback=function(t){e.setData({wxToken:t}),e.getData(),a.initOkCallback=null,setTimeout((function(){e.data.onLogin=!1}),3e3)})}})},getWxCode:function(){var e=this;e.data.promiseList=new Promise((function(t,a){var n=0,s=e.data.caImg.length;!function a(){if(s>n){var i=e.data.caImg[n];i.url?wx.getImageInfo({src:i.url,success:function(e){i.endUrl=e.path,n++,a()},fail:function(e){console.log("错误-res",e,i,n),n++,a()}}):(n++,a())}else s==n&&(console.log("1加载完了"),t())}()}))},getStartDay:function(){var e=this,t=wx.getStorageSync("mine/createDt");if(t&&!a.ifTimeOut(t.et)&&t.envVersion==a.globalData.envVersion)return n(t.sj),!1;function n(t){var a=t.data.data;if(200==t.data.code&&null!=a.create_dt){var n=new Date(a.create_dt.substring(0,4)+"/"+a.create_dt.substring(4,6)+"/"+a.create_dt.substring(6,8)).getTime(),s=(new Date).getTime(),i="你已经加入第五庄园"+parseInt((s-n)/864e5)+"天";e.setData({dayDesc:i})}}wx.request({url:this.data.apiUrl+"/w/epro/wechatuser/mine/createDt",data:{wxToken:e.data.wxToken,server:10001,roleId:e.data.gameId},success:function(e){200==e.data.code&&wx.setStorage({key:"mine/createDt",data:{et:(new Date).getTime(),sj:e,envVersion:a.globalData.envVersion}}),n(e)}})},getDrawNum:function(){var e=this,t=wx.getStorageSync("lottery/getLuckyLotteryPage");if(t&&!a.ifTimeOut(t.et))return e.setData({drawSuccNum:t.sj.drawSuccNum,drawJoinNum:t.sj.drawJoinNum}),!1;wx.request({url:e.data.apiUrl+"/w/epro/h55/lottery/activity/page",data:{type:"participate",pageNo:1,pageSize:1},method:"POST",header:{wxToken:e.data.wxToken},success:function(t){wx.request({url:e.data.apiUrl+"/w/epro/h55/lottery/activity/page",data:{type:"prized",pageNo:1,pageSize:1},method:"POST",header:{wxToken:e.data.wxToken},success:function(a){200==a.data.code&&wx.setStorage({key:"lottery/getLuckyLotteryPage",data:{et:(new Date).getTime(),sj:{drawSuccNum:a.data.data.total,drawJoinNum:t.data.data.total}}}),e.setData({drawSuccNum:a.data.data.total,drawJoinNum:t.data.data.total})}})}})},bindCol:function(e){this.setData({gameId:e.detail.gameId,loadImagePath:"",imgbuilded:!1,promiseList:[],promiseList2:[],promiseList3:[],promiseList4:[],promiseList5:[]}),this.getData()},getUser:function(){var e=this;wx.getStorageSync("playerstatis");function n(a){var n=t({},a);n.headimg=e.data.imgUrl+"/greed"+(-1!=n.use_portrait?n.use_portrait_path:"/face_common/fs_0005.png"),n.headcover=e.data.imgUrl+"/greed"+(-1!=n.use_frame?n.user_frame_path:"/face_cover/fc_0001.png"),e.setData({user:n,skinList:[],frameList:[],entourageList:[],additionsList:[]}),e.data.caImg[3].url=n.headimg,e.data.caImg[4].url=n.headcover,e.getWxCode(),e.getSkin(n.skin_list),e.getAdditions(n.carry_list),e.getEntourage(n.pet_list),e.getFrame(n.frame_list)}a.globalData.userPlayerStatis?(console.log("已经有了"),n(a.globalData.userPlayerStatis)):(a.userPlayerStatisOver=function(e){console.log("还没有这个, 现在有了"),n(e)},a.getPlayerStatis())},getSkin:function(t){var n=this;t=t.replace("[","").replace("]",""),console.log(e(t),"reData");var s=wx.getStorageSync("baseInfo/skin");if(s&&!a.ifTimeOut(s.et)&&s.envVersion==a.globalData.envVersion)return console.log(2222),i(s.sj),!1;function i(e){if(200==e.data.code&&e.data.data&&200==e.data.code&&e.data.data){var t=e.data.data;t.forEach((function(e,t){e.useName=e.name})),t=n.moveDiscontinuedToQualityFirst(t),Promise.all([n.data.promiseList]).then((function(e){n.data.promiseList2=new Promise((function(e,a){var s=0,i=t.length;console.log(2),function a(){if(i>s){var o=t[s];wx.getImageInfo({src:n.data.loadPath+o.iconPath,success:function(e){o.endUrl=e.path,s++,a()},fail:function(e){console.log("错误-res",e,o,s),s++,a()}})}else i==s&&(console.log("2加载完了"),e())}()}))})),n.setData({skinList:t})}n.data.loaded++,n.canShowIndex()}wx.request({url:this.data.apiUrl+"/w/epro/baseInfo/skin",method:"POST",header:{"Content-Type":"application/x-www-form-urlencoded"},data:{idList:t,wxToken:a.globalData.wxToken},success:function(e){200==e.data.code&&wx.setStorage({key:"baseInfo/skin",data:{et:(new Date).getTime(),sj:e,envVersion:a.globalData.envVersion}}),i(e)}})},getAdditions:function(e){var t=this;e=e.replace("[","").replace("]","");var n=wx.getStorageSync("baseInfo/additions");if(n&&!a.ifTimeOut(n.et)&&n.envVersion==a.globalData.envVersion)return s(n.sj),!1;function s(e){if(200==e.data.code&&e.data.data){var a=e.data.data;Promise.all([t.data.promiseList,t.data.promiseList2]).then((function(e){t.data.promiseList3=new Promise((function(e,n){var s=0,i=a.length;console.log(3),function n(){if(i>s){var o=a[s];wx.getImageInfo({src:t.data.loadPath+o.iconPath,success:function(e){o.endUrl=e.path,n(),s++},fail:function(e){console.log("错误-res",e,o,s),n(),s++}})}else i==s&&(console.log("3加载完了"),e())}()}))})),t.setData({additionsList:a})}else console.log(e.data.msg);t.data.loaded++,t.canShowIndex()}wx.request({url:this.data.apiUrl+"/w/epro/baseInfo/additions",method:"POST",header:{"Content-Type":"application/x-www-form-urlencoded"},data:{idList:e,wxToken:a.globalData.wxToken},success:function(e){200==e.data.code&&wx.setStorage({key:"baseInfo/additions",data:{et:(new Date).getTime(),sj:e,envVersion:a.globalData.envVersion}}),s(e)}})},getEntourage:function(e){var t=this;e=e.replace("[","").replace("]","");var n=wx.getStorageSync("baseInfo/entourage");if(n&&!a.ifTimeOut(n.et)&&n.envVersion==a.globalData.envVersion)return s(n.sj),!1;function s(e){if(200==e.data.code&&e.data.data){var a=e.data.data;Promise.all([t.data.promiseList,t.data.promiseList2,t.data.promiseList3]).then((function(e){t.data.promiseList4=new Promise((function(e,n){var s=0,i=a.length;console.log(4),function n(){if(i>s){var o=a[s];wx.getImageInfo({src:t.data.loadPath+o.iconPath,success:function(e){o.endUrl=e.path,s++,n()},fail:function(e){console.log("错误-res",e,o,s),s++,n()}})}else i==s&&(console.log("4加载完了"),e())}()}))})),t.setData({entourageList:a})}t.data.loaded++,t.canShowIndex()}wx.request({url:this.data.apiUrl+"/w/epro/baseInfo/entourage",method:"POST",header:{"Content-Type":"application/x-www-form-urlencoded"},data:{idList:e,wxToken:a.globalData.wxToken},success:function(e){200==e.data.code&&wx.setStorage({key:"baseInfo/entourage",data:{et:(new Date).getTime(),sj:e,envVersion:a.globalData.envVersion}}),s(e)}})},getFrame:function(e){var t=this;e=e.replace("[","").replace("]","");var n=wx.getStorageSync("baseInfo/frame");if(n&&!a.ifTimeOut(n.et)&&n.envVersion==a.globalData.envVersion)return s(n.sj),!1;function s(e){if(200==e.data.code&&e.data.data){var a=e.data.data;Promise.all([t.data.promiseList,t.data.promiseList2,t.data.promiseList3,t.data.promiseList4]).then((function(e){t.data.promiseList5=new Promise((function(e,t){a.length;console.log("5不要了"),console.log("5加载完了"),e()}))})),t.setData({frameList:a})}t.data.loaded++,t.canShowIndex()}wx.request({url:this.data.apiUrl+"/w/epro/baseInfo/frame",method:"POST",header:{"Content-Type":"application/x-www-form-urlencoded"},data:{idList:e,wxToken:a.globalData.wxToken},success:function(e){200==e.data.code&&wx.setStorage({key:"baseInfo/frame",data:{et:(new Date).getTime(),sj:e,envVersion:a.globalData.envVersion}}),s(e)}})},canShowIndex:function(){4==this.data.loaded&&(this.setData({isLoading:!1}),wx.hideLoading())},goShopping:function(){this.data.gameId&&""!=this.data.gameId?(wx.reportEvent("collect_shop",{}),wx.navigateTo({url:"/pages_user/pages/saishi/dh/index"})):wx.showToast({title:"请先绑定角色",icon:"none",duration:3e3})},goMyRecord:function(){wx.reportEvent("collect_mywin",{}),wx.navigateTo({url:"/pages_user/pages/draw/list?listtype=2"})},goMyJoin:function(){wx.reportEvent("collect_myjoin",{}),wx.navigateTo({url:"/pages_user/pages/draw/list?listtype=1"})},handleBind:function(e){var t,a;"0"===(null==e||null===(t=e.currentTarget)||void 0===t||null===(a=t.dataset)||void 0===a?void 0:a.count)&&wx.reportEvent("personal_first_bind_pvuv",{}),e&&"true"===e.detail?this.setData({bindUserVisible:!1}):(this.setData({bindUserVisible:!this.data.bindUserVisible}),wx.reportEvent("collect_changebind",{}))},showBind:function(e){},search:function(){wx.navigateTo({url:"../index/query?key="+this.data.queryKey})},handlerGobackClick:function(e){getCurrentPages().length>=2?wx.navigateBack({delta:e}):wx.redirectTo({url:a.globalData.pageIndex})},handlerGohomeClick:function(){wx.redirectTo({url:a.globalData.pageIndex})},goMyco:function(){var e,t=this,n=this;(wx.reportEvent("collect_mycollect",{}),a.globalData.collectMsgUsed)?wx.navigateTo({url:"/pages_user/pages/user/mycollect"}):wx.getSetting({withSubscriptions:!0,success:function(s){var i=!1;console.log(s),"accept"===s.subscriptionsSetting["qu4m8mq3gcIqUtrih-GradI1Bl8nXkXmEqn16Gw1Mcg"]?(console.log("总是订阅了该条订阅消息"),i=!0):(t.setData({messageTipGif:!0}),e=setInterval((function(){t.setData({messageTipGifUrl:"".concat(a.globalData.imgUrl,"/vsrecord/message_subscription-wechat.gif?time=").concat(Date.now())})}),5e3));wx.requestSubscribeMessage({tmplIds:["qu4m8mq3gcIqUtrih-GradI1Bl8nXkXmEqn16Gw1Mcg"],success:function(e){wx.request({url:n.data.apiUrl+"/w/subscribe/subscribe",data:{type:2,idvId:t.data.gameId,always:i},method:"POST",header:{wxToken:n.data.wxToken},success:function(e){wx.reportEvent("collect_message_success",{}),200==e.data.code?console.log("subscribe/subscribe成功"):console.log(e.data.msg)}})},complete:function(n){wx.reportEvent("collect_message_touch",{}),wx.navigateTo({url:"/pages_user/pages/user/mycollect"}),a.globalData.collectMsgUsed=!0,e&&(t.setData({messageTipGif:!1}),clearInterval(e),e=null)}})},fail:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e){console.log(fail,"订阅失败")})),complete:function(){console.log("订阅fainally")}})},hideTips:function(){this.setData({showTips:!1})},onShow:function(){},getCode:function(){wx.request({url:this.data.apiUrl+"/w/epro/wechatauth/pcCode",data:{wxToken:this.data.wxToken},success:function(e){e.data.data;200==e.data.code?wx.showModal({title:"提示",content:"您的验证码是："+e.data.data.code+"。\n两分钟之内有效, 请尽快使用",success:function(e){}}):wx.showToast({title:"网络出错了, 稍后再试吧",icon:"none",duration:3e3})}})},goPandaPart:function(){wx.navigateTo({url:"/pages_user/pages/panda/panda"})},onChooseAvatar:function(e){console.log(e),this.setData({newUploadFile:e.detail.avatarUrl})},changeName:function(e){var t,a;this.setData({flag:!0}),this.setData({nameImg:null===(t=this.data.userInfo)||void 0===t?void 0:t.avatarUrl,inputText:null===(a=this.data.userInfo)||void 0===a?void 0:a.nickName}),wx.reportEvent("change_personal_message",{})},close:function(){this.setData({flag:!1})},changPicture:function(e){console.log(this,"a"),console.log(e,"e"),this.upload_file(e.detail.avatarUrl,this)},upload_file:function(e,t){wx.request({url:t.data.apiUrl+"/w/epro/system/file/upload/init",header:{wxToken:t.data.wxToken},method:"GET",success:function(a){200===a.data.code&&function(e,t,a){return console.log("url:".concat(e," token:").concat(t," filePath:").concat(a)),new Promise((function(n,s){wx.uploadFile({url:e,filePath:a,name:"fpfile",formData:{Authorization:"".concat(t),json:!0},success:function(e){200===e.statusCode?n(JSON.parse(e.data)):s(new Error("文件上传失败"))},fail:function(e){console.log(e),s(new Error("文件上传失败"))}})}))}(a.data.data.uploadUrl,a.data.data.token,e).then((function(e){t.setData({comImg:e.url,nameImg:e.url}),wx.showToast({title:"文件上传成功",icon:"success",duration:3e3}),console.log("----nameImg-----",t.getData.nameImg)})).catch((function(e){console.error("文件上传失败",e)}))}})},subimt:function(){var e=this;return e.data.inputText?e.getBLen(e.data.inputText)<2?wx.showToast({title:"输入内容不符合规则，请重新修改",icon:"none"}):(wx.request({url:e.data.apiUrl+"/w/epro/wechatuser/mine/updateCustomizeInfo",header:{wxToken:e.data.wxToken},data:{wxToken:e.data.wxToken,name:e.data.inputText,profilePic:e.data.comImg},method:"POST",success:function(t){200===t.data.code?wx.request({url:e.data.apiUrl+"/w/epro/wechatuser/mine/getCustomizeInfo?wxToken=asafadbvbsfgf",data:{wxToken:e.data.wxToken},success:function(t){console.log(t,"用户自定义图片");var a={nickName:t.data.data.name,avatarUrl:t.data.data.profilePic};e.setData({userInfo:a})}}):wx.showToast({title:t.data.msg,icon:"none"})}}),void this.setData({flag:!1})):wx.showToast({title:"名称不能为空",icon:"none"})},closeUpload:function(){this.setData({flag_upload:!1})},nameInput:function(){this.setData({flagName:!1})},inputBlur:function(e){this.setData({flagName:!0}),this.setData({inputText:e.detail.value})},inputChang:function(e){for(var t=e.detail.value,a=0,n=0;n<t.length;n++)(a+=this.getBLen(t[n]))>32&&this.setData({inputText:this.data.inputText.slice(0,n)})},inputFocus:function(){console.log(this.data.inputText,"获取焦点")},getBLen:function(e){return null==e?0:("string"!=typeof e&&(e+=""),e.replace(/[^\x00-\xff]/g,"01").length)},moveDiscontinuedToQualityFirst:function(e){for(var t,a=[].concat(e),n=0,s=!1,i=0,o=!1,l=0;l<e.length;l++)s||5!=e[l].quality||(n=l,s=!0),o||4!=e[l].quality||(i=l,o=!0);console.log(n,i);for(var r=e.length-1;r>=0;r--){var d=e[r];5==e[r].quality&&1==e[r].discontinuedSignInt&&a.splice(n,0,d),4==e[r].quality&&1==e[r].discontinuedSignInt&&a.splice(i,0,d)}return t=a,a=Array.from(t.reduce((function(e,t){var a=t.wyId;return e.has(a)||e.set(a,t),e}),new Map).values())}});
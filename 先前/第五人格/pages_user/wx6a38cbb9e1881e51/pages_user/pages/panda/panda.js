var t=getApp(),a="https://nie.res.netease.com/id5/m/zt/20201215094138/data";Page({data:{wxToken:t.globalData.wxToken,apiUrl:t.globalData.apiUrl,imgUrl:t.globalData.imgUrl,userInfo:null,nbHeight:60,pageCount:1,drowRolls:0,kpcount:0,helpPeople:0,info:{},cardFaceImg:{mc1:a+"/panda/jiesuo.png",mc2:a+"/panda/suo.png",pandaCard:a+"/panda/card.png"},listIndex:"",unBindTipImgList:[{pic:a+"/panda/limit_card1.png",showBigImg:!1},{pic:a+"/panda/limit_card2.png",showBigImg:!1},{pic:a+"/panda/limit_card3.png",showBigImg:!1},{pic:a+"/panda/limit_card4.png",showBigImg:!1}],limitBigCard:[{pic:a+"/panda/limit_big_card1.jpg",showBigImg:!1},{pic:a+"/panda/limit_big_card2.jpg",showBigImg:!1},{pic:a+"/panda/limit_big_card3.jpg",showBigImg:!1},{pic:a+"/panda/limit_big_card4.jpg",showBigImg:!1}],prizeList:[],prizePic:[a+"/panda/coin.png",a+"/panda/coin.png",a+"/panda/coin.png",a+"/panda/coin.png",a+"/panda/tuya_panda.png",a+"/panda/prize_frame.png"],cardId:0,drawCardShake:!0,bigkpcard:!1,prizename:"",kplist:[],kpcardlist:[{pic:a+"/panda/kcard4.png",showBigImg:!1,text:"大熊猫是世界上最可爱的动物之一，它有着圆圆的脸颊，大大的黑眼圈，胖嘟嘟的身体，标志性的内八字的行走方式，也有解剖刀般锋利的爪子。"},{pic:a+"/panda/kcard1.png",showBigImg:!1,text:"大熊猫为独居动物。野外大熊猫的寿命一般为18--20岁，圈养状态下因为有很好的饲养管理和医疗，有的可以超过30岁。香港海洋公园的佳佳，出生于1978年，是目前全世界最长寿的大熊猫。"},{pic:a+"/panda/kcard4.png",showBigImg:!1,text:"大熊猫曾广泛分布于中国长江、黄河和珠江三大流域，包括从北京附近周口店至两广以及附近的东南亚地区。而现在我们只能在秦岭山系、岷山山系、邛崃山系、凉山和大、小相岭山系找到它们。"},{pic:a+"/panda/kcard1.png",showBigImg:!1,text:"大熊猫99%的食物都是竹子，可供大熊猫食用的竹类植物共有12属、60多种。此外，野生大熊猫还偶食一些动物尸体或其它植物、蜂蜜等。"},{pic:a+"/panda/kcard4.png",showBigImg:!1,text:"大熊猫的食物在体内停留的时间短，消化速度很快，对竹类的消化利用率较低，因而采取大量进食、快速排出的方式，来保证它们吃得更多，获得足够能量以满足其需求。"},{pic:a+"/panda/kcard1.png",showBigImg:!1,text:"圈养条件下雌性大熊猫5岁左右，雄性大熊猫6岁左右进入性成熟，野外大熊猫性成熟稍晚。大熊猫除发情配种季节外，其他时候一般是独居，各有其活动的区域。"},{pic:a+"/panda/kcard2.png",showBigImg:!1,text:"小熊猫的体型比较小，颜色多为红褐色，大熊猫和小熊猫不是同一种动物"},{pic:a+"/panda/kcard3.png",showBigImg:!1,text:"小熊猫是国家二级重点保护动物，又名猫熊、红猫熊、火狐，是一种哺乳类动物，分布在中国南方到喜马拉雅山麓、不丹、印度、老挝、缅甸、尼泊尔等国。属于食肉目、小熊猫科。"},{pic:a+"/panda/kcard2.png",showBigImg:!1,text:"小熊猫四肢粗短，头部棕色白色相间，背部毛色为红棕色，其眼眶和两颊甚至连嘴周围及胡须都是白色。最好看的是一条蓬松的长尾巴，长而粗，其棕色与白色相间的九节环纹，非常惹人喜爱，“九节狼”的别名因此而来。"},{pic:a+"/panda/kcard3.png",showBigImg:!1,text:"小熊猫早晚出来活动觅食，白天多在洞里或大树的荫凉处睡觉。成年小熊猫在交配季节之外很少互动，喜欢吃浆果、花朵、鸟蛋、竹叶和其他植物的小叶子。 竹子的叶子是小熊猫的主要食物来源。"},{pic:a+"/panda/kcard2.png",showBigImg:!1,text:"小熊猫是一种喜温湿而又比较耐高寒的森林动物，主要生活在1500-4000米高山丛林地带。"},{pic:a+"/panda/kcard3.png",showBigImg:!1,text:"小熊猫是熊猫的亲密伙伴，它们虽然都是以竹为生，但小熊猫却与大熊猫又有分享的默契。大熊猫在秋季爱吃竹叶，这时小熊猫却主要是吃野樱桃、花揪等各种野果；大熊猫在春夏爱吃较大径的竹笋，而小熊猫则主要吃大熊猫不吃的小径竹笋；大熊猫多吃竹子上部的枝叶，小熊猫采食在较低部位的竹叶；大熊猫采食地点多在平缓的阴坡，而小熊猫多在陡峭的阳坡采食。"}],btntext:"(5s)",limitList:[],c:[{count:3,ifGet:!1},{count:6,ifGet:!1},{count:9,ifGet:!1},{count:12,ifGet:!1}],d:!0,isPanda:!1,ifShare:!1,ifGameOver:!1,ifRecordShare:!1,ifActivity:!1,ifFriend:!1,ifjoin:!1,userHelpInfo:[],userHelpInfo2:[],bindUserVisible:!1,showAddfri:!1,tcPrize:!1,tcbindid:!1,tcAddFriend:!1,tcbindPart:!1,tcDrowcard:!1,tcToShop:!1,tcCardTask:!1,tcPanda_knowledge:!1,tckpcard:!1,tcCoin:!1,tcHeadPic:!1,tcxdty:!1,tcHelp:!1,tcSubMsg:!1,helpready:!1,helplimit:!1,helpSelf:!1,helpBindGame:!1,userPhone:!1,taskList:[],haveWorkTodo:null,haveWorkTodoTaskId:"",canGetVs:!0,showSharePic:!1,showShare:!1,longBag:!1,scroll_xd:!0,scroll_help:!0,height_xd:0,height_help:0,listNumber:["①","②","③","④","⑤","⑥","⑦","⑧","⑨","⑩","⑪","⑫"],helpFull:!1,firstId:!1,shareNum:1,jall:!1,showremind:!1,partNotStart:!1,partEnd:!1},onLoad:function(a){var e=this;console.log(a);var i=new Date("2022/09/02 23:59:59").getTime(),n=(new Date).getTime();console.log(n),n>i&&this.setData({partEnd:!0});var d={uid:a.uid,userHead:a.userHead};this.setData({info:d});var o=a.count;if(o&&2==o&&this.setData({pageCount:o}),this.data.wxToken=t.globalData.wxToken,this.data.wxToken?this.getdata():t.initOkCallback=function(a){e.setData({wxToken:a}),e.getdata(),t.initOkCallback=null},a.sharetype&&1==a.sharetype?wx.reportEvent("panda_sharecard2_click",{}):a.sharetype&&2==a.sharetype&&wx.reportEvent("panda_sharecard_click",{}),a.from)switch(a.from){case"shequn":wx.reportEvent("panda_shequn",{});break;case"weibo":wx.reportEvent("panda_weibo",{});break;case"weixin":wx.reportEvent("panda_weixin",{});break;case"xiaochengxu":wx.reportEvent("panda_xiaochengxu",{});break;case"beiyong":wx.reportEvent("panda_beiyong",{})}a.sub&&wx.reportEvent("panda_subscription",{})},getdata:function(){var a=this,e=t.globalData.userInfo;e?(this.setData({userInfo:e}),e.phone&&""!=e.phone&&this.setData({userPhone:!0}),this.getPartInfo()):t.initUserOver=function(t){a.setData({userInfo:t}),t.phone&&""!=t.phone&&a.setData({userPhone:!0}),a.getPartInfo()}},getPartInfo:function(){2==this.data.pageCount?(wx.reportEvent("panda_helppage_pop_pv",{}),this.gethelpInfo(this.data.userInfo.uid),this.gethelpInfo2(this.data.info.uid)):(wx.reportEvent("panda_main_pv",{}),this.gethelpInfo(this.data.userInfo.id),this.getUserJoinInfo())},getDrawChance:function(){var a=this;wx.request({url:a.data.apiUrl+"/w/mission/getDrawTime",data:{activityId:t.globalData.activityId2},header:{wxToken:a.data.wxToken},success:function(t){200==t.data.code?a.setData({drowRolls:t.data.data.num}):wx.showToast({title:t.data.msg,icon:"none",duration:3e3})}})},getShareNum:function(){var a=this;wx.getStorage({key:"20220801ShareNum",success:function(t){a.data.shareNum=t.data,a.setWxmlToCanvas()},fail:function(){wx.request({url:a.data.apiUrl+"/w/lottery/activity/share",data:{activityId:t.globalData.activityId2},header:{wxToken:a.data.wxToken},success:function(t){200==t.data.code?(a.data.shareNum=t.data.data,wx.setStorage({key:"20220801ShareNum",data:t.data.data}),a.setWxmlToCanvas()):wx.showToast({title:t.data.msg,icon:"none",duration:3e3})}})}})},gethelpInfo:function(a){var e=this;wx.request({url:e.data.apiUrl+"/w/lottery/activity/helpInfo",data:{activityId:t.globalData.activityId2,userId:a},header:{wxToken:e.data.wxToken},method:"GET",success:function(t){200==t.data.code?(t.data.data.userList&&t.data.data.userList.length>0&&t.data.data.userList.forEach((function(t){t.id==e.data.userInfo.id&&e.setData({helpready:!0})})),e.setData({userHelpInfo:t.data.data,helpPeople:t.data.data.count})):wx.showToast({title:t.data.msg,icon:"none",duration:3e3})}})},gethelpInfo2:function(a){var e=this;wx.request({url:e.data.apiUrl+"/w/lottery/activity/helpInfo",data:{activityId:t.globalData.activityId2,userId:a},header:{wxToken:e.data.wxToken},method:"GET",success:function(t){200==t.data.code?e.setData({userHelpInfo2:t.data.data}):wx.showToast({title:t.data.msg,icon:"none",duration:3e3})}})},getMyPrize:function(){var a=this;wx.request({url:a.data.apiUrl+"/w/lottery/person/my",data:{activityId:t.globalData.activityId2},header:{wxToken:a.data.wxToken},method:"GET",success:function(t){if(200==t.data.code){var e=t.data.data;e.forEach((function(t){var a=new Date(t.winTime),e=a.getFullYear()+"-"+(a.getMonth()+1)+"-"+a.getDate();t.winTime=e})),a.setData({prizeList:e})}else wx.showToast({title:t.data.msg,icon:"none",duration:3e3})}})},getremarks:function(a){var e=this;wx.request({url:e.data.apiUrl+"/w/epro/common/dict/get/type/data/remarks",data:{type:"isEnterprise",name:"isPandaOpen"},header:{wxToken:e.data.wxToken},success:function(i){"true"==i.data.data?e.getqwFriend(a):"false"==i.data.data?(e.setData({ifFriend:!0}),a&&a()):t.requestError(i.msg)},fail:function(a){t.requestError()},complete:function(){}})},getqwFriend:function(a){var e=this,i=e.data,n=i.wxToken,d=i.apiUrl;wx.getStorage({key:"20220801joinQwFriend",success:function(t){e.setData({ifFriend:!0}),a&&a()},fail:function(){wx.request({url:d+"/w/weChatEnterprise/isWechatContact",data:{wxToken:n},success:function(i){200===i.statusCode?(e.setData({ifFriend:i.data.data}),a&&a(),i.data.data&&wx.setStorage({key:"20220801joinQwFriend",data:i.data.data,success:function(t){},fail:function(){},complete:function(){}})):t.requestError(i.msg)},fail:function(a){t.requestError()},complete:function(){}})},complete:function(){}})},findwqFanBao:function(){var a=this,e=a.data,i=e.wxToken,n=e.apiUrl;wx.request({url:n+"/w/weChatEnterprise/limit",data:{wxToken:i},success:function(e){200===e.data.code?e.data.data.limit||a.setData({ifFriend:!0}):t.requestError(e.msg)},fail:function(a){t.requestError()},complete:function(){}})},getPhoneNumber:function(t){var a=this;"getPhoneNumber:ok"==t.detail.errMsg&&wx.request({url:a.data.apiUrl+"/w/epro/wechatuser/mine/bindPhone",data:{code:t.detail.code?t.detail.code:"",encryptedData:t.detail.encryptedData?t.detail.encryptedData:"",iv:t.detail.iv?t.detail.iv:""},header:{wxToken:a.data.wxToken},method:"POST",dataType:"json",responseType:"text",success:function(t){a.setData({userPhone:!0})},fail:function(){},complete:function(){}})},getUserJoinInfo:function(){var a=this,e=this;function i(){e.data.somethingChanged||(e.getMyPrize(),e.getDrawChance(),e.getPandaList(),e.getShareNum())}wx.getStorage({key:"20220801joinPart",success:function(t){t.data!=a.data.userInfo.idvId?e.data.somethingChanged=!0:e.data.somethingChanged=!1,e.setData({ifjoin:!0,ifFriend:!0}),i(),e.getTaskList()},fail:function(){wx.request({url:e.data.apiUrl+"/w/mission/whetherPartActivity",data:{activityId:t.globalData.activityId2},header:{wxToken:e.data.wxToken},method:"GET",success:function(t){console.log(t.code),-10000900==t.data.code?e.setData({partNotStart:!0}):-10000901==t.data.code?e.setData({partEnd:!0}):200==t.data.code?(t.data.data.firstUse!=e.data.userInfo.idvId?e.data.somethingChanged=!0:e.data.somethingChanged=!1,e.setData({ifjoin:t.data.data.result}),t.data.data.result?(wx.setStorage({key:"20220801joinPart",data:t.data.data.firstUse,success:function(t){},fail:function(){},complete:function(){}}),e.setData({ifFriend:!0}),i()):e.getremarks()):wx.showToast({title:t.data.msg,icon:"none",duration:3e3}),e.getTaskList()}})},complete:function(){}})},joinPart:function(){var a=this;this.data.drawCardShake&&(a.setData({drawCardShake:!1}),wx.request({url:a.data.apiUrl+"/w/mission/insertActivity",data:{activityId:t.globalData.activityId2},header:{wxToken:a.data.wxToken},method:"GET",success:function(t){200==t.data.code?(t.data.msg&&wx.showToast({title:"绑定成功",icon:"none",duration:2e3}),a.setData({tcbindPart:!a.data.tcbindPart,tcSubMsg:!0}),a.getUserJoinInfo()):wx.showToast({title:t.data.msg,icon:"none",duration:3e3}),setTimeout((function(){a.setData({drawCardShake:!0})}),1e3)}}))},judgeAll:function(){var t=this,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;if(console.log(a),this.data.partNotStart)wx.showToast({title:"活动未开始",icon:"none",duration:3e3});else if(this.data.partEnd&&1==a)wx.showToast({title:"活动已结束",icon:"none",duration:3e3});else if(this.data.userPhone)if(""!=this.data.userInfo.idvId&&this.data.userInfo.idvId)if(this.data.ifFriend)if(this.data.ifjoin){if(!this.data.somethingChanged)return this.setData({jall:!0}),!0;wx.showToast({title:"请绑定第一次参与的游戏id",icon:"none",duration:3e3})}else this.setData({tcbindPart:!this.data.tcbindPart});else this.getremarks((function(){t.data.ifFriend?t.judgeAll():t.setData({tcAddFriend:!t.data.tcAddFriend})}));else this.setData({tcbindid:!this.data.tcbindid});else this.getPhoneNumber()},handlerGobackClick:function(a){getCurrentPages().length>=2?wx.navigateBack({delta:a}):wx.redirectTo({url:t.globalData.pageIndex})},handlerGohomeClick:function(){2==this.data.pageCount?this.goPanda():wx.redirectTo({url:t.globalData.pageIndex})},getPandaGraffiti:function(){var a=this;a.judgeAll()&&a.data.drawCardShake&&(wx.reportEvent("panda_taskpandaframe_click",{}),a.data.kpcount>=12&&a.data.limitList.length>=4?(a.setData({drawCardShake:!1}),wx.request({url:a.data.apiUrl+"/w/lottery/prize/setQualifiedCard",data:{activityId:t.globalData.activityId2,card:"5"},header:{wxToken:a.data.wxToken},method:"GET",success:function(t){200==t.data.code?(t.data.data.panda&&(a.setData({tcxdty:!a.data.tcxdty}),wx.reportEvent("panda_frame_pop_pv",{})),t.data.data.frame&&(a.setData({tcHeadPic:!a.data.tcHeadPic}),wx.reportEvent("panda_panda_pop_pv",{})),a.getMyPrize(),a.setData({isPanda:!0})):wx.showToast({title:t.data.msg,icon:"none",duration:3e3}),setTimeout((function(){a.setData({drawCardShake:!0})}),1e3)}})):wx.showToast({title:"请解锁完4张限定卡后才能领取哦",icon:"none",duration:3e3}))},changeifget:function(a){var e=this;if(e.judgeAll()){var i=a.currentTarget.dataset.index;switch(i){case 0:wx.reportEvent("panda_limitcard_click1",{});break;case 1:wx.reportEvent("panda_limitcard_click2",{});break;case 2:wx.reportEvent("panda_limitcard_click3",{});break;case 3:wx.reportEvent("panda_limitcard_click4",{})}var n=e.data.c;e.data.kpcount>=n[i].count?wx.request({url:e.data.apiUrl+"/w/lottery/prize/setQualifiedCard",data:{activityId:t.globalData.activityId2,card:i+1},header:{wxToken:e.data.wxToken},method:"GET",success:function(t){200==t.data.code?(wx.showToast({title:"解锁成功",icon:"none",duration:3e3}),e.getQualifiedCard()):wx.showToast({title:t.data.msg,icon:"none",duration:3e3})}}):wx.showToast({title:"没有足够的科普卡解锁该限定卡片哦！！",icon:"none",duration:2e3})}},getQualifiedCard:function(){var a=this;wx.request({url:a.data.apiUrl+"/w/lottery/prize/getQualifiedCard",data:{activityId:t.globalData.activityId2},header:{wxToken:a.data.wxToken},method:"GET",success:function(t){if(200==t.data.code){var e=a.data.c;t.data.data.forEach((function(t){t<=4?e[t-1].ifGet=!0:5==t&&a.setData({isPanda:!0})})),a.setData({limitList:t.data.data,c:e})}else wx.showToast({title:t.data.msg,icon:"none",duration:3e3})}})},handlePreview:function(t){var a=t.currentTarget.dataset.index,e=this.data.limitBigCard;e[a].showBigImg=!0,this.setData({limitBigCard:e,listIndex:a})},setWxmlToCanvas:function(){var t=this;t.setData({_canvasw:750,_canvasH:1500});var a=wx.createCanvasContext("mycanvas"),e=[{url:this.data.imgUrl+"/panda/share_bg3.jpg",w:750,h:1500,t:0,l:0},{url:this.data.imgUrl+"/panda/qrcode2.jpg",w:263,h:263,t:883,l:242},{url:this.data.userInfo.userAvatarUrl,w:91,h:91,t:1375,l:65},{url:this.data.imgUrl+"/panda/ic_zz.png",w:131,h:131,t:1355,l:45}],i=0,n=e.length;!function d(){if(n>i){var o=e[i];o.url?wx.getImageInfo({src:o.url,success:function(t){o.endUrl=t.path,i++,d()},fail:function(t){i++,d()}}):(i++,d())}else n==i&&(e.forEach((function(t,e){t.endUrl&&a.drawImage(t.endUrl,t.l,t.t,t.w,t.h)})),a.setFontSize(24),a.setFillStyle("#ffffff"),a.fillText("我是全服第".concat(t.data.shareNum,"个大熊猫x小熊猫公益助力者，"),175,1412),a.fillText("保护熊猫，从我做起！",175,1448),a.draw(!0,(function(a){setTimeout((function(){!function a(){wx.canvasToTempFilePath({canvasId:"mycanvas",fileType:"jpg",quality:.8,destWidth:750,destHeight:1500,success:function(a){t.setData({shareImgUrl:a.tempFilePath})},fail:function(t){setTimeout((function(){a()}),200)}})}()}),200)})))}()},closeBigImg:function(){var t=this.data,a=t.listIndex,e=t.limitBigCard;e[a].showBigImg=!1,this.setData({limitBigCard:e})},noneShow:function(){},friendHelp:function(){this.setData({pnbox:!0})},btnlazy:function(){var t=this,a=5,e=setInterval((function(){a>0?(t.setData({btntext:"("+a+"s)"}),a--):(t.setData({btntext:"",d:!1}),clearInterval(e))}),1e3)},drawcard:function(){var a=this;if(a.judgeAll()){if(wx.reportEvent("panda_draw_click",{}),a.data.drowRolls>0&&a.data.drawCardShake&&(a.setData({drawCardShake:!1}),wx.request({url:a.data.apiUrl+"/w/lottery/draw/panda/drawPrize",data:{activityId:t.globalData.activityId2},header:{wxToken:a.data.wxToken},method:"POST",success:function(t){200==t.data.code?(a.getMyPrize(),a.getPandaList(),a.getDrawChance(),a.setData({d:!0,cardId:t.data.data.id-1,prizename:t.data.data.prizeName,tckpcard:!a.data.tckpcard}),wx.reportEvent("panda_kpcard_pop_pv",{}),a.btnlazy()):wx.showToast({title:t.data.msg,icon:"none",duration:3e3}),setTimeout((function(){a.setData({drawCardShake:!0})}),1e3)}})),a.data.drowRolls<=0&&a.data.kpcount<12){wx.getSystemInfoSync().windowHeight;var e=wx.createSelectorQuery(),i=0;return e.select(".drawTitle").boundingClientRect((function(t){i=t.top})).exec(),e.select(".cardTask").boundingClientRect((function(t){wx.pageScrollTo({scrollTop:t.top+t.height-i,duration:400})})).exec(),void wx.showToast({title:"你的抽卡券为0,\r\n请完成下方任务领取抽卡券",icon:"none",duration:2e3})}if(a.data.kpcount>=12)return void wx.showToast({title:"您已获得所有科普卡",icon:"none",duration:2e3})}},catGameId:function(){this.setData({bindUserVisible:!0,tcbindid:!1}),""!=this.data.userInfo.idvId&&this.data.userInfo.idvId?wx.reportEvent("panda_cut_click",{}):wx.reportEvent("panda_bindid_click",{})},closeTcbindid:function(){this.setData({tcbindid:!1})},handleBind:function(){this.setData({bindUserVisible:!1})},showPraize:function(){this.judgeAll(2)&&(this.setData({tcPrize:!this.data.tcPrize}),wx.reportEvent("panda_price_click",{}))},closePraize:function(){this.setData({tcPrize:!this.data.tcPrize})},showTcAddFriend:function(){this.setData({tcAddFriend:!this.data.tcAddFriend})},closeTcbindPart:function(){this.setData({tcbindPart:!this.data.tcbindPart})},addFriend:function(){this.setData({showAddfri:!this.data.showAddfri,tcAddFriend:!1}),wx.reportEvent("panda_qwposter_pop_pv",{})},showTitle:function(){this.setData({showremind:!this.data.showremind})},shareShow:function(){this.setData({showShare:!this.data.showShare}),wx.reportEvent("panda_partposter_pop_pv",{}),this.data.isDoTaskShare&&(this.data.isDoTaskShare=!1,wx.showToast({title:"任务完成，抽奖券+1",icon:"none",duration:2e3}))},tagQwFriend:function(){this.setData({longBag:!0})},showTcDrowcard:function(){this.setData({tcDrowcard:!this.data.tcDrowcard})},showTcToShop:function(){this.setData({tcToShop:!this.data.tcToShop})},showTcCardTask:function(){this.setData({tcCardTask:!this.data.tcCardTask})},showTcPanda_knowledge:function(){this.judgeAll(2)&&(this.setData({tcPanda_knowledge:!this.data.tcPanda_knowledge}),wx.reportEvent("panda_knowledge_pop_pv",{}),wx.reportEvent("panda_knowledge_click",{}))},getPandaList:function(){var a=this;wx.request({url:a.data.apiUrl+"/w/lottery/prize/getPandaList",data:{activityId:t.globalData.activityId2},header:{wxToken:a.data.wxToken},method:"GET",success:function(t){200==t.data.code?a.setData({kplist:t.data.data,kpcount:t.data.data.length}):wx.showToast({title:t.data.msg,icon:"none",duration:3e3})}})},showTckpcard:function(){wx.reportEvent("panda_takenow_click",{}),this.setData({tckpcard:!this.data.tckpcard,tcCoin:!this.data.tcCoin}),wx.reportEvent("panda_coin_pop_pv",{})},showTcCoin:function(){this.setData({tcCoin:!this.data.tcCoin})},showTcHeadPic:function(){wx.reportEvent("panda_takeframe_click",{}),this.setData({tcHeadPic:!this.data.tcHeadPic})},showTcxdty:function(){wx.reportEvent("panda_takepanda_click",{}),this.setData({tcxdty:!this.data.tcxdty})},preventTouchMove:function(){},showimg:function(t){var a=t.target.dataset.index,e=this.data.kplist[a]-1;this.setData({cardId:e,bigkpcard:!this.data.bigkpcard})},closeBigCard:function(){this.setData({bigkpcard:!this.data.bigkpcard})},colsetc:function(){this.setData({tcHelp:!this.data.tcHelp})},helpIf:function(){return this.data.userPhone?this.data.userInfo.userAvatarUrl&&this.data.userInfo.wxName?!(""==this.data.userInfo.idvId||!this.data.userInfo.idvId)||(this.setData({tcHelp:!0,helpBindGame:!0}),void wx.reportEvent("panda_bindid_pop_pv",{})):void this.getUserProfile():void this.getPhoneNumber()},helpNow:function(){var a=this,e=a.data.userInfo;if(a.helpIf()){if(wx.reportEvent("panda_helpnow_click",{}),a.data.info.uid==e.id)return a.setData({tcHelp:!0,helpSelf:!0}),void wx.reportEvent("panda_helpmyself_pop_pv",{});if(a.data.userHelpInfo.userList.length>=3)return a.setData({tcHelp:!0,helplimit:!0}),void wx.reportEvent("panda_helplimit_pop_pv",{});if(a.data.userHelpInfo2.userList.length>=3)return void a.setData({tcHelp:!0,helpFull:!0});wx.request({url:a.data.apiUrl+"/w/lottery/activity/help",data:{activityId:t.globalData.activityId2,beHelpId:a.data.info.uid},header:{wxToken:a.data.wxToken},success:function(t){t.data.data;200==t.data.code?a.setData({tcHelp:!0,helpready:!0}):wx.showToast({title:t.data.msg,icon:"none",duration:2e3})}})}},goPanda:function(){wx.reportEvent("panda_takeparttoo_click",{}),this.setData({pageCount:1}),this.getdata()},getTaskList:function(){var a=this;wx.request({url:a.data.apiUrl+"/w/mission/taskList",data:{activityId:t.globalData.activityId2},header:{wxToken:a.data.wxToken},success:function(t){t.data.data;200==t.data.code?(a.data.somethingChanged&&t.data.data.forEach((function(t,a){t.status=0})),t.data.data.forEach((function(t,a){switch(a){case 0:console.log(a,t),1==t.status?wx.reportEvent("panda_taskshare_gray_pv",{}):2==t.status&&wx.reportEvent("panda_taskshare_end_pv",{});break;case 1:1==t.status?wx.reportEvent("panda_taskfind_gray_pv",{}):2==t.status&&wx.reportEvent("panda_taskfind_end_pv",{});break;case 2:1==t.status?wx.reportEvent("panda_tasktosharerecord_gray_pv",{}):2==t.status&&wx.reportEvent("panda_tasktosharerecord_end_pv",{})}})),a.setData({taskList:t.data.data}),null!=a.data.haveWorkTodo&&a.doWork()):wx.showToast({title:t.data.msg,icon:"none",duration:2e3})}})},doWork:function(a){var e=this,i=a?parseInt(a.currentTarget.dataset.index):null,n=a?a.currentTarget.dataset.task:null;if(!this.judgeAll())return e.data.haveWorkTodo=i,e.data.haveWorkTodoTaskId=n,!1;switch(null!=e.data.haveWorkTodo&&(i=e.data.haveWorkTodo,n=e.data.haveWorkTodoTaskId,e.data.haveWorkTodo=null,e.data.canGetVs=!0),i){case 0:e.data.userInfo.userAvatarUrl&&e.data.userInfo.wxName?this.data.showShare?wx.request({url:e.data.apiUrl+"/w/mission/doTask",data:{taskId:e.data.taskList[0].id,activityId:t.globalData.activityId2},header:{wxToken:e.data.wxToken},success:function(t){200==t.data.code?(e.getTaskList(),e.getDrawChance(),e.data.isDoTaskShare=!0):wx.showToast({title:t.data.msg,icon:"none",duration:3e3})}}):(wx.reportEvent("panda_taskshare_click",{}),this.shareShow(),wx.showToast({title:"长按图片分享给好友吧~",icon:"none",duration:3e3})):this.getUserProfile();break;case 1:wx.reportEvent("panda_taskfind_click",{}),e.data.canGetVs&&(e.data.canGetVs=!1,wx.request({url:e.data.apiUrl+"/w/mission/selectDataPlay",data:{taskId:n,activityId:t.globalData.activityId2},header:{wxToken:e.data.wxToken},success:function(t){200==t.data.code?t.data.data.flag?t.data.data.flag&&(wx.showToast({title:"任务完成，抽奖券+1",icon:"none",duration:2e3}),e.getTaskList(),e.getDrawChance()):wx.showToast({title:"今天尚未进行对局，快打开游戏玩一把吧～",icon:"none",duration:2e3}):wx.showToast({title:t.data.msg,icon:"none",duration:2e3}),setTimeout((function(){e.data.canGetVs=!0}),1e3)}}));break;case 2:wx.reportEvent("panda_tasktosharerecord_click",{}),console.log(this.data.refreshTaskList,"refreshTaskList"),wx.navigateTo({url:"/pages/vsrecord/index?task="+n}),this.data.refreshTaskList=!0}},handleShoppingMall:function(t){this.data.userInfo.userAvatarUrl&&this.data.userInfo.wxName?this.data.userInfo.idvId&&""!=this.data.userInfo.idvId?(wx.reportEvent("panda_shop_click",{}),wx.navigateTo({url:"/pages_user/pages/saishi/dh/index"})):this.setData({bindUserVisible:!this.data.bindUserVisible}):this.getUserProfile()},helpBtn:function(){this.judgeAll()},getUserProfile:function(a){var e=this;wx.getUserProfile({desc:"用于完善用户资料",success:function(a){wx.request({url:e.data.apiUrl+"/w/epro/wechatuser/mine/bdWxName",data:{wxName:a.userInfo.nickName,userAvatarUrl:a.userInfo.avatarUrl},method:"POST",header:{wxToken:e.data.wxToken,"Content-Type":"application/x-www-form-urlencoded"},success:function(a){t.reGetUserInfo((function(t){e.setData({userInfo:t}),e.setWxmlToCanvas()}))}})}})},judgeHead:function(){this.judgeAll()&&(this.data.userInfo.userAvatarUrl&&this.data.userInfo.wxName||this.getUserProfile())},getAward:function(){var a=this.judgeAll(),e=this;a&&(wx.reportEvent("panda_getcoin5_click",{}),e.data.userHelpInfo.hadPrize?wx.showToast({title:"已领取，不能重复领取",icon:"none",duration:2e3}):e.data.drawCardShake&&(e.setData({drawCardShake:!1}),wx.request({url:e.data.apiUrl+"/w/lottery/activity/acceptPrize",data:{activityId:t.globalData.activityId2},header:{wxToken:e.data.wxToken},success:function(t){200==t.data.code?(e.getMyPrize(),e.gethelpInfo(e.data.userInfo.id),wx.showToast({title:"领取成功",icon:"none",duration:3e3})):wx.showToast({title:t.data.msg,icon:"none",duration:2e3}),setTimeout((function(){e.setData({drawCardShake:!0})}),1e3)}})))},bindCol:function(t){this.getdata()},subscribeMsg:function(){var t=this,a="rziIrEMaSy5-bHcO3FaUu8ewPldLq6bGoeH7FQEBX60";wx.requestSubscribeMessage({tmplIds:[a],success:function(e){"accept"==e[a]&&(wx.reportEvent("panda_subscribe_sums",{}),wx.request({url:t.data.apiUrl+"/w/subscribe/subscribe",data:{type:3,always:!1,idvId:t.data.userInfo.idvId},header:{wxToken:t.data.wxToken},method:"POST",success:function(t){200==t.data.code||wx.showToast({title:t.data.msg,icon:"none",duration:2e3})}}))},fail:function(){},complete:function(){t.setData({tcSubMsg:!1})}})},closeTcSubMag:function(){this.setData({tcSubMsg:!this.data.tcSubMsg})},handleCustomReject:function(){this.getdata()},onReady:function(){var t=this.selectComponent("#navBar");this.setData({nbHeight:t.data.navBarExtendHeight+t.data.navBarHeight});var a=wx.getSystemInfoSync().windowHeight,e=this;wx.createSelectorQuery().select(".cardSm").boundingClientRect((function(t){e.setData({height_xd:t.top-a})})).exec(),wx.createSelectorQuery().select(".headBox").boundingClientRect((function(t){e.setData({height_help:t.top-a})})).exec()},onShow:function(){this.data.longBag&&(wx.showToast({title:"添加好友系统可能存在延迟,请一分钟后再尝试抽卡",icon:"none",duration:3e3}),this.getremarks()),this.data.refreshTaskList&&(this.data.refreshTaskList=!1,this.getTaskList(),this.getDrawChance())},onHide:function(){},onUnload:function(){},onPullDownRefresh:function(){},onReachBottom:function(){},onShareAppMessage:function(t){return"button"==t.from&&(t.target.dataset.btntype&&1==t.target.dataset.btntype?wx.reportEvent("panda_invitehelp_click",{}):t.target.dataset.btntype&&2==t.target.dataset.btntype&&wx.reportEvent("panda_invitehelp_click2",{})),{title:"button"==t.from?"拿到限定涂鸦就差你的助力啦！":"点击👇👇领[限定涂鸦]",imageUrl:"button"==t.from?a+"/panda/shareex_2.jpg":a+"/panda/share3.png",path:"button"==t.from?"pages_user/pages/panda/panda?count=2&uid="+this.data.userInfo.id+"&userHead="+this.data.userInfo.userAvatarUrl+"&sharetype=2":"pages_user/pages/panda/panda?sharetype=1",success:function(t){},fail:function(){},complete:function(){}}},onPageScroll:function(t){if(2!=this.data.pageCount&&this.data.ifjoin&&!this.data.somethingChanged&&t.scrollTop>=this.data.height_xd&&this.data.scroll_xd&&(this.getQualifiedCard(),this.setData({scroll_xd:!1})),2!=this.data.pageCount&&t.scrollTop>=this.data.height_help&&this.data.scroll_help){var a=!(!this.data.userInfo.idvId||!this.data.ifFriend||!this.data.ifjoin||this.data.somethingChanged);this.setData({scroll_help:!1,jall:a})}},onTabItemTap:function(t){}});
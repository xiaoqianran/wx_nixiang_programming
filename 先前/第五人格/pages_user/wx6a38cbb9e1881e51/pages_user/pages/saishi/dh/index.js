var a=require("../../../../@babel/runtime/helpers/toConsumableArray"),t=require("../../../../utils/util").debounce,e=getApp();Page({data:{imgUrl:e.globalData.imgUrl,apiUrl:e.globalData.apiUrl,wxToken:e.globalData.wxToken,user:[],prList:[],prListNo:1,prListReget:!0,prDetailShow:0,popDh1Show:!1,popDh2Show:!1,dhNum1:0,dhMaxNum:0,dhNum1Sum:0,dhNum1SumDes:"",dhNum1SumDes_gold:0,dhNum1SumDes_silver:0,usersy_gold:0,usersy_silver:0,nameVal:"",telVal:"",addressVal:"",wIdVal:"",canDh:!0,canDhAdd:!0,canDhReduce:!1,tipsShow:!1,region:["请选择您的地区","",""],notEnoughFlag:!1,exchangeId:""},onLoad:function(){var a=this;this.setData({wxToken:e.globalData.wxToken}),this.data.wxToken?this.getData():e.initOkCallback=function(t){a.setData({wxToken:e.globalData.wxToken}),a.getData()}},getData:function(){this.getList(),this.getUserInfo()},dhNum1Add:function(){var a=this.data.dhNum1+1,t=0,e=0,i=this.data.prDetailInfo.exchangeLimit>0&&this.data.prDetailInfo.exchangeCount<this.data.prDetailInfo.exchangeLimit?this.data.prDetailInfo.exchangeLimit-this.data.prDetailInfo.exchangeCount:this.data.prDetailInfo.stock;"gold"==this.data.prDetailInfo.coinType?e=this.data.prDetailInfo.unitAmount*a:t=this.data.prDetailInfo.unitAmount*a,this.data.user.silverCoin>=t&&this.data.user.goldCoin>=e&&(a<=i||this.data.prDetailInfo.exchangeLimit<=0)&&a<=this.data.prDetailInfo.stock&&this.dhNum1Con(a),this.dhNum1arCol()},dhNum1Reduce:function(){var a=this.data.dhNum1-1;a>0&&this.dhNum1Con(a),this.dhNum1arCol()},dhNum1arCol:function(){var a=this.data.dhNum1,t=this.data.dhNum1+1,e=0,i=0,n=this.data.prDetailInfo.exchangeLimit>0&&this.data.prDetailInfo.exchangeCount<this.data.prDetailInfo.exchangeLimit?this.data.prDetailInfo.exchangeLimit-this.data.prDetailInfo.exchangeCount:this.data.prDetailInfo.stock;"gold"==this.data.prDetailInfo.coinType?i=this.data.prDetailInfo.unitAmount*t:e=this.data.prDetailInfo.unitAmount*t,a>1?this.setData({canDhReduce:!0}):this.setData({canDhReduce:!1}),this.data.user.silverCoin>=e&&this.data.user.goldCoin>=i&&(a<n||this.data.prDetailInfo.exchangeLimit<=0)&&t<=this.data.prDetailInfo.stock?this.setData({canDhAdd:!0}):this.setData({canDhAdd:!1})},dhNum1Con:function(a){var t=0,e=0;this.data.prDetailInfo.exchangeLimit>0&&this.data.prDetailInfo.exchangeCount<this.data.prDetailInfo.exchangeLimit?(this.data.prDetailInfo.exchangeLimit,this.data.prDetailInfo.exchangeCount):this.data.prDetailInfo.stock;"gold"==this.data.prDetailInfo.coinType?e=this.data.prDetailInfo.unitAmount*a:t=this.data.prDetailInfo.unitAmount*a;var i=this.data.user.goldCoin-e,n=this.data.user.silverCoin-t;this.setData({dhNum1:a,dhNum1SumDes_gold:e,dhNum1SumDes_silver:t,usersy_gold:i,usersy_silver:n})},ljdh:function(a){return!(this.data.prDetailInfo.remainTimes<=0&&null!=this.data.prDetailInfo.totalTimes)&&(this.data.prDetailInfo.silverCoin>this.data.user.silverCoin?(wx.showToast({title:"银币不足",icon:"none",duration:2e3}),!1):this.data.prDetailInfo.goldCoin>this.data.user.goldCoin?(wx.showToast({title:"时装券不足",icon:"none",duration:2e3}),!1):this.data.prDetailInfo.stock<=0?(wx.showToast({title:"库存不足",icon:"none",duration:2e3}),!1):void("physicals"===this.data.prDetailInfo.prizeType?(this.setData({popDh2Show:!0,dhNum1:0,nameVal:"",telVal:"",addressVal:"",region:["请选择您的地区","",""],wIdVal:""}),this.dhNum1Add()):(this.setData({popDh1Show:!0,dhNum1:0,nameVal:"",telVal:"",addressVal:"",wIdVal:""}),this.dhNum1Add())))},fectPriceDh:function(){var a=this;if(!a.data.wxToken)return wx.showToast({title:"需绑定才可以领取哦~~",icon:"none",duration:2e3}),!1;if(0==a.data.canDh)return!1;if(0==a.data.dhNum1)return wx.showToast({title:"余额不足",icon:"none",duration:2e3}),!1;if("physicals"==a.data.prDetailInfo.prizeType){if(""==a.data.nameVal)return wx.showToast({title:"请输入您的名字",icon:"none",duration:2e3}),!1;if(""==a.data.telVal)return wx.showToast({title:"请输入您的手机号",icon:"none",duration:2e3}),!1;if("请选择您的地区"==a.data.region[0])return wx.showToast({title:"请选择您的地区",icon:"none",duration:2e3}),!1;if(""==a.data.addressVal)return wx.showToast({title:"请输入您的详细地址",icon:"none",duration:2e3}),!1}a.data.canDh=!1,wx.request({url:this.data.apiUrl+"/w/epro/h55/exchange/exchange",data:{id:a.data.prDetailInfo.id,num:a.data.dhNum1,consignee:a.data.nameVal||null,phone:a.data.telVal||null,address:a.data.region[0]+" "+a.data.region[1]+" "+a.data.region[2]+" "+a.data.addressVal||null},method:"POST",header:{wxToken:a.data.wxToken},success:function(t){200==t.data.code?(a.setData({exchangeId:t.data.data}),"physicals"===a.data.prDetailInfo.prizeType?wx.showModal({title:"恭喜您, 奖励兑换成功",content:"奖励正在安排发放中，请耐心等待",success:function(t){a.setData({popDh1Show:!1,popDh2Show:!1,prDetailShow:2})}}):wx.showModal({title:"兑换成功",content:"兑换成功",success:function(t){a.setData({popDh1Show:!1,popDh2Show:!1,prDetailShow:2})}}),a.getData()):wx.showToast({title:t.data.msg,icon:"none",duration:2e3}),a.data.canDh=!0}})},priceDh:t((function(){var a=this;if(!a.data.wxToken)return wx.showToast({title:"需绑定才可以领取哦~~",icon:"none",duration:2e3}),!1;if(0==a.data.canDh)return!1;if(0==a.data.dhNum1)return wx.showToast({title:"余额不足",icon:"none",duration:2e3}),!1;if("physicals"==a.data.prDetailInfo.prizeType){if(""==a.data.nameVal)return wx.showToast({title:"请输入您的名字",icon:"none",duration:2e3}),!1;if(""==a.data.telVal)return wx.showToast({title:"请输入您的手机号",icon:"none",duration:2e3}),!1;if("请选择您的地区"==a.data.region[0])return wx.showToast({title:"请选择您的地区",icon:"none",duration:2e3}),!1;if(""==a.data.addressVal)return wx.showToast({title:"请输入您的详细地址",icon:"none",duration:2e3}),!1}a.data.canDh=!1,wx.request({url:this.data.apiUrl+"/w/epro/h55/exchange/exchange",data:{id:a.data.prDetailInfo.id,num:a.data.dhNum1,consignee:a.data.nameVal||null,phone:a.data.telVal||null,address:a.data.region[0]+" "+a.data.region[1]+" "+a.data.region[2]+" "+a.data.addressVal||null},method:"POST",header:{wxToken:a.data.wxToken},success:function(t){200==t.data.code?(a.setData({exchangeId:t.data.data}),"physicals"===a.data.prDetailInfo.prizeType?wx.showModal({title:"恭喜您, 奖励兑换成功",content:"奖励正在安排发放中，请耐心等待",success:function(t){a.setData({popDh1Show:!1,popDh2Show:!1,prDetailShow:2})}}):wx.showModal({title:"兑换成功",content:"兑换成功",success:function(t){a.setData({popDh1Show:!1,popDh2Show:!1,prDetailShow:2})}}),a.getData()):wx.showToast({title:t.data.msg,icon:"none",duration:2e3}),a.data.canDh=!0}})}),1e3),popDh1Close:function(){this.setData({popDh1Show:!1})},popDh2Close:function(){this.setData({popDh2Show:!1})},backList:function(){this.setData({prDetailShow:0})},getUserInfo:function(){var a=this;wx.request({url:this.data.apiUrl+"/w/epro/wechatuser/mine/userinfo",data:{wxToken:a.data.wxToken},header:{wxToken:a.data.wxToken},success:function(t){var e=t.data.data;null==e.silverCoin&&(e.silverCoin=0),null==e.goldCoin&&(e.goldCoin=0),a.setData({user:e})}})},getList:function(){var t=this;if(!t.data.prListReget)return!1;wx.request({url:this.data.apiUrl+"/w/epro/h55/exchange/prize/page",data:{pageNo:t.data.prListNo,pageSize:10},method:"GET",header:{wxToken:t.data.wxToken},success:function(e){var i,n=e.data.data.records;if(n.length<1)return t.data.prListReget=!1,!1;n.forEach((function(a,e){null!==a&&(a.prizeImage.indexOf("/uploads/")>-1?a.prizeImage=t.data.apiUrl+"/resources"+a.prizeImage:a.prizeImage=a.prizeImage.replace("/uploads",""))})),(i=t.data.prList).push.apply(i,a(n)),t.setData({prList:n})}})},goDetails:function(a){var t=this;t.setData({notEnoughFlag:!1}),console.log(t.data.notEnoughFlag,"notEnoughFlag11111----------"),wx.request({url:this.data.apiUrl+"/w/epro/h55/exchange/prize/get",data:{id:a.currentTarget.dataset.newsid},header:{wxToken:t.data.wxToken},success:function(e){var i=e.data.data;"gold"==i.coinType?t.data.user.goldCoin<i.unitAmount&&(console.log(t.data.notEnoughFlag,"notEnoughFlag222222----------"),t.setData({notEnoughFlag:!0})):"silver"==i.coinType&&t.data.user.silverCoin<i.unitAmount&&(console.log(t.data.notEnoughFlag,"notEnoughFlag23332----------"),t.setData({notEnoughFlag:!0})),t.setData({prDetailShow:1,prDetailInfo:i,nowDetailId:a.currentTarget.dataset.newsid}),wx.reportEvent("dh_thing_det",{content:i.prizeName})}})},changeSize:function(a){wx.setStorage({key:"detailTextSize",data:a.currentTarget.dataset.size}),this.setData({textSize:a.currentTarget.dataset.size}),this.getNews()},goHistory:function(a){wx.reportEvent("dh_det",{}),wx.navigateTo({url:"/pages_user/pages/saishi/dh/history"})},goList:function(a){wx.reportEvent("dh_det",{}),wx.navigateTo({url:"/pages_user/pages/saishi/dh/list"})},watchOrder:function(a){console.log(this.data.exchangeId,"22222222"),wx.navigateTo({url:"/pages_user/pages/saishi/dh/detail?id="+this.data.exchangeId})},handlerGobackClick:function(a){var t=getCurrentPages();1==this.data.prDetailShow||2==this.data.prDetailShow?this.setData({prDetailShow:0,popDh1Show:!1,popDh2Show:!1}):t.length>=2?(console.log(a),console.log(t),wx.navigateBack({delta:a})):wx.redirectTo({url:e.globalData.pageIndex})},handlerGohomeClick:function(){wx.redirectTo({url:e.globalData.pageIndex})},bindRegionChange:function(a){this.setData({region:a.detail.value})},nameVal:function(a){this.setData({nameVal:a.detail.value})},telVal:function(a){this.setData({telVal:a.detail.value})},addressVal:function(a){this.setData({addressVal:a.detail.value})},wIdVal:function(a){this.setData({wIdVal:a.detail.value})},showTips:function(){this.setData({tipsShow:!0}),wx.reportEvent("dh_wen_click",{})},hideTips:function(){this.setData({tipsShow:!1})},onPullDownRefresh:function(){},onReachBottom:function(){},onShareAppMessage:function(){}});
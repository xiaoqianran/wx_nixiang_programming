var t=require("../../../@babel/runtime/helpers/defineProperty"),e=getApp();Page({data:{wxToken:e.globalData.wxToken,apiUrl:e.globalData.apiUrl,imgUrl:e.globalData.imgUrl,messageTipGif:!1,messageTipGifUrl:"".concat(e.globalData.imgUrl,"/vsrecord/message_subscription-wechat.gif"),messageWxid:["n-tiZwyPqdpegyzypayWsJk0wB2zYq3uK0xf6iHsjFo"],sharePicShow:!1,bindUserVisible:!1,canClick:!0,canRefresh:!0},onLoad:function(t){var a=this;this.data.wxToken=e.globalData.wxToken,this.data.wxToken?this.getUserInit():e.initOkCallback=function(t){a.setData({wxToken:t}),a.getUserInit(),e.initOkCallback=null}},getUserInit:function(){var t=this;this.setData({userInfo:e.globalData.userInfo}),this.data.userInfo?this.getData():e.initUserOver=function(a){t.setData({userInfo:e.globalData.userInfo}),t.getData(),e.initUserOver=null}},getData:function(){this.getActUserInfo()},reGetInfo:function(){var t=this;this.data.canRefresh&&(this.data.canRefresh=!1,this.getActUserInfo((function(){t.setData({popTipsText:"刷新成功",popTipsShow:!0}),setTimeout((function(){t.data.canRefresh=!0}),3e3)})))},getActUserInfo:function(t){var e=this;if(!this.data.userInfo.idvId)return!1;this.myQequest("/user/info",{},(function(a){console.log("/user/info",a),e.setData({actUserInfo:a.data}),t&&t()}))},showSharePic:function(){if(!this.data.userInfo.idvId)return this.handleBindUserDialog(),!1;this.setData({sharePicShow:!0})},doShareEvent:function(){var t=this;this.data.actUserInfo.share||setTimeout((function(){t.myQequest("/user/share",{},(function(e){console.log("/user/share",e),t.getActUserInfo()}))}),2e3)},revicePr:function(){var t=this;!this.data.actUserInfo.receive&&this.data.canClick&&(this.data.canClick=!1,this.myQequest("/user/receive",{},(function(e){console.log("/user/receive",e),t.setData({popTipsText:"您已领取成功，时装将于48小时内\n发放至游戏邮箱，请耐心等待",popTipsShow:!0}),t.getActUserInfo()})))},handleBindUserDialog:function(){this.setData({bindUserVisible:!0})},bindCol:function(t){var a=this;e.reGetUserInfo((function(t){a.setData({userInfo:t}),a.getData()}))},handleCustomReject:function(){var t;null!==(t=this.data.userInfo)&&void 0!==t&&t.idvId&&!e.globalData.userinfoApiStatus&&wx.redirectTo({url:e.globalData.pageIndex})},handlerGobackClick:function(t){getCurrentPages().length>=2?wx.navigateBack({delta:t}):wx.redirectTo({url:e.globalData.pageIndex})},handleBind:function(t){"true"!==t.detail?this.setData({bindUserVisible:!this.data.bindUserVisible}):this.setData({bindUserVisible:!1})},onShow:function(){},onShareAppMessage:function(){var t=this;return this.data.actUserInfo&&!this.data.actUserInfo.share&&setTimeout((function(){t.myQequest("/user/share",{},(function(e){console.log("/user/share",e),t.getActUserInfo()}))}),2e3),{title:"免费领取玩具商罗森主题时装！",imageUrl:"".concat(this.data.imgUrl,"/active/lawson/share2.jpg"),path:"/pages_user/pages/lawson/index"}},popShow:function(e){this.setData(t({},e.currentTarget.dataset.name,!0))},popHide:function(e){this.setData(t({},e.currentTarget.dataset.name,!1))},myQequest:function(t,a,s,i){var n=this;wx.request({url:"".concat(this.data.apiUrl,"/w/epro/fashion").concat(t),data:a,method:i||"get",header:{wxToken:this.data.wxToken},success:function(t){setTimeout((function(){n.data.canClick=!0}),1e3),t.data.status?s&&s(t.data):-10000301==t.data.code?n.data.onLogin||(n.data.onLogin=!0,e.getLogin(),e.initOkCallback=function(t){n.setData({wxToken:t}),n.getData(),e.initOkCallback=null,setTimeout((function(){n.data.onLogin=!1}),3e3)}):wx.showToast({title:t.data.msg,icon:"none",duration:2e3})}})},wxMsg:function(){var t=this;if(!e.globalData.signMsgUsed){e.getUserSetting((function(a){console.log(a),t.data.always=!1,"accept"===a.subscriptionsSetting[t.data.messageWxid[0]]?(console.log("总是订阅了该条订阅消息"),t.data.always=!0):(t.setData({showMsgTips:!0}),setInterval((function(){t.setData({messageTipGifUrl:"".concat(e.globalData.imgUrl,"/vsrecord/message_subscription-wechat.gif")})}),5e3)),t.getMsg()})),e.globalData.signMsgUsed=!0}},getMsg:function(){var t,a=this,s=this;this.setData({showMsgTips:!1}),wx.reportEvent("signin_openmsg",{}),this.data.always||(this.setData({messageTipGif:!0}),t=setInterval((function(){a.setData({messageTipGifUrl:"".concat(e.globalData.imgUrl,"/vsrecord/message_subscription-wechat.gif?time=").concat(Date.now())})}),5e3)),console.log("getMsg","----------------------");wx.requestSubscribeMessage({tmplIds:a.data.messageWxid,success:function(t){console.log("requestSubscribeMessage__succ",t),wx.reportEvent("signin_authsucc",{}),e.getUserSetting((function(t){"accept"===t.subscriptionsSetting[a.data.messageWxid[0]]&&(a.data.always=!0),wx.request({url:s.data.apiUrl+"/w/subscribe/subscribe",data:{always:a.data.always},method:"POST",header:{wxToken:s.data.wxToken},success:function(t){}})}))},fail:function(t){console.log("requestSubscribeMessage__fail",t)},complete:function(e){t&&(a.setData({messageTipGif:!1}),clearInterval(t),t=null)}})},jumpLink:function(){wx.navigateTo({url:"/pages/out/out?url="+encodeURIComponent("https://game.163.com/s/?id=956")})}});
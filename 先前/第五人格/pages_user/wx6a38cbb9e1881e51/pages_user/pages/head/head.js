var a=getApp();Page({data:{wxToken:a.globalData.wxToken,apiUrl:a.globalData.apiUrl,imgUrl:a.globalData.imgUrl,userInfo:a.globalData.userInfo,activeData:null,taskOneStartDate:"",taskOneEndDate:"",taskTwoStartDate:"",taskTwoEndDate:"",prizeList:null,taskList1:null,taskList2:null,answerList:null,stage:1,ruleFlag:!1,ruleText:"",recordFalg:!1,num:0,onceFlag:!1,manyFalg:!1,onceData:null,answerflag:!1,answer_class:!1,answer_class1:!1,answerChange:[{A:0,B:0,C:0,D:0},{A:0,B:0,C:0,D:0}],answerNumber:[!1,!1],answerNum:[],recordNum:0,recordOne:0,recordTc:null,bindUserVisible:!1,messageWxid:["rziIrEMaSy5-bHcO3FaUu8ewPldLq6bGoeH7FQEBX60","sB-3QWLaTa-JnKsnkGMj6Utcostt2hCjOTGwQFEzmbo","yjFFsl7dJSo3UoNEdM3tpzJiUXw6kHXviLCL78G4ysI"],yc:!0},onLoad:function(t){var e=this;console.log(e.data.userInfo,"u"),this.setData({isLoading:!0}),wx.showLoading({title:"加载中"}),this.data.wxToken=a.globalData.wxToken,e.data.wxToken?e.getData(e):a.initOkCallback=function(t){e.setData({wxToken:t}),e.getData(e),a.initOkCallback=null}},getData:function(a){wx.request({url:a.data.apiUrl+"/w/epro/wechatuser/mine/userinfo",data:{wxToken:a.data.wxToken},header:{wxToken:a.data.wxToken},success:function(t){console.log(t,"1"),200===t.data.code&&a.setData({userInfo:t.data.data})}}),wx.request({url:a.data.apiUrl+"/w/lottery/activity/query",header:{wxToken:a.data.wxToken},method:"GET",success:function(t){if(200===t.data.code){a.setData({activeData:t.data.data[0].id,ruleText:t.data.data[0].activityRule,taskOneStartDate:a.dateFun(t.data.data[0].taskOneStartDate),taskOneEndDate:a.dateFun(t.data.data[0].taskOneEndDate),taskTwoStartDate:a.dateFun(t.data.data[0].taskTwoStartDate),taskTwoEndDate:a.dateFun(t.data.data[0].taskTwoEndDate)});var e=t.data.data[0];200===t.data.code&&(wx.request({url:a.data.apiUrl+"/w/epro/signIn/getPrizeList",data:{wxToken:a.data.wxToken},success:function(t){200===t.data.code&&t.data.data.prizeIds.length>0&&wx.request({url:a.data.apiUrl+"/w/lottery/activity/query",header:{wxToken:a.data.wxToken},success:function(t){console.log(t,"活动列表"),200===t.data.code&&wx.request({url:a.data.apiUrl+"/w/mission/setDrawStatus",header:{wxToken:a.data.wxToken},data:{activityId:t.data.data[0].id,taskId:"d1441dc932884ff8bca07aa8800e9902"},success:function(a){console.log(a,"每日礼包")}})}})}}),a.getNumber(a,e.id),a.getTask(a,e.id))}else wx.showToast({title:t.data.msg,duration:1e3}),wx.hideLoading()}})},bindCol:function(a){this.getdata()},handlerGobackClick:function(t){getCurrentPages().length>=2?wx.navigateBack({delta:t}):wx.redirectTo({url:a.globalData.pageIndex})},handlerGohomeClick:function(){wx.redirectTo({url:a.globalData.pageIndex})},dateFun:function(a){return new Date(a).getMonth()+"/"+new Date(a).getDate()},getActive:function(a,t){wx.request({url:a.data.apiUrl+"/w/lottery/prize/getPrizeListByActivityId",data:{activityId:t},header:{wxToken:a.data.wxToken},success:function(t){200===t.data.code?a.setData({prizeList:t.data.data}):wx.showToast({title:t.data.msg,duration:1e3})}})},getNumber:function(a,t){wx.request({url:a.data.apiUrl+"/w/mission/getDrawTime",data:{activityId:t},header:{wxToken:a.data.wxToken},success:function(t){200===t.data.code?a.setData({num:t.data.data.num}):wx.showToast({title:t.data.msg,duration:1e3})}})},getTask:function(a,t){a.scorllStart(),wx.request({url:a.data.apiUrl+"/w/mission/taskList",data:{activityId:t},header:{wxToken:a.data.wxToken},success:function(t){200===t.data.code?a.setData({taskList1:t.data.data.filter((function(a){return"阶段一"===a.stage})),taskList2:t.data.data.filter((function(a){return"阶段一"!==a.stage}))}):wx.showToast({title:t.data.msg,duration:1e3})}})},recordFun:function(a,t,e){wx.request({url:a.data.apiUrl+"/w/mission/selectDataPlay",data:{taskId:e,activityId:t},header:{wxToken:a.data.wxToken},success:function(t){200===t.data.code?("933311e58a2c456ebcd888bad886e01b"===e?a.setData({recordNum:t.data.data.num}):a.setData({recordOne:t.data.data.num}),a.getTask(a,a.data.activeData)):wx.showToast({title:t.data.msg,duration:1e3})}})},scorllClose:function(){},scorllStart:function(){},rule:function(){this.setData({ruleFlag:!0}),this.scorllClose()},record:function(){wx.reportEvent("draw_record",{});var a=this;this.scorllClose(),wx.request({url:a.data.apiUrl+"/w/mission/getDrawRecord",data:{activityId:a.data.activeData},header:{wxToken:a.data.wxToken},success:function(t){200===t.data.code?a.setData({recordFalg:!0,recordTc:t.data.data}):wx.showToast({title:t.data.msg,duration:1e3})}})},drawOnce:function(){var a=this;console.log(1),a.setData({yc:!1}),setTimeout((function(){a.setData({yc:!0})}),1e3),a.data.userInfo.idvId?a.data.num>0?(wx.reportEvent("one_draw",{}),wx.request({url:a.data.apiUrl+"/w/lottery/draw/solarTerm/drawPrize",data:{activityId:a.data.activeData,times:1},method:"POST",header:{wxToken:a.data.wxToken},success:function(t){console.log(t.data.data,"eeex"),200===t.data.code?(a.setData({onceData:t.data.data,onceFlag:!0}),a.getNumber(a,a.data.activeData)):wx.showToast({title:t.data.msg,duration:1e3})}})):wx.showToast({title:"抽奖次数不足",icon:"error",duration:1e3}):wx.showToast({title:"请绑定角色",icon:"error",duration:1e3}),a.scorllClose()},rode:function(a){"accept"!==wx.getStorageSync("订阅")?wx.requestSubscribeMessage({tmplIds:a.data.messageWxid,success:function(t){wx.request({url:a.data.apiUrl+"/w/subscribe/subscribe",data:{type:1,idvId:a.data.userInfo.idvId,always:a.data.always},method:"POST",header:{wxToken:a.data.wxToken},success:function(a){}}),wx.request({url:a.data.apiUrl+"/w/subscribe/subscribe",data:{type:4,idvId:a.data.userInfo.idvId,always:a.data.always},method:"POST",header:{wxToken:a.data.wxToken},success:function(a){}}),wx.request({url:a.data.apiUrl+"/w/subscribe/subscribe",data:{type:6,idvId:a.data.userInfo.idvId,always:a.data.always},method:"POST",header:{wxToken:a.data.wxToken},success:function(a){}}),wx.setStorageSync("订阅",t["rziIrEMaSy5-bHcO3FaUu8ewPldLq6bGoeH7FQEBX60"])}}):(wx.request({url:a.data.apiUrl+"/w/subscribe/subscribe",data:{type:1,idvId:a.data.userInfo.idvId,always:a.data.always},method:"POST",header:{wxToken:a.data.wxToken},success:function(a){}}),wx.request({url:a.data.apiUrl+"/w/subscribe/subscribe",data:{type:4,idvId:a.data.userInfo.idvId,always:a.data.always},method:"POST",header:{wxToken:a.data.wxToken},success:function(a){}}),wx.request({url:a.data.apiUrl+"/w/subscribe/subscribe",data:{type:6,idvId:a.data.userInfo.idvId,always:a.data.always},method:"POST",header:{wxToken:a.data.wxToken},success:function(a){}}))},drawMany:function(){var a=this;console.log(1),a.setData({yc:!1}),setTimeout((function(){a.setData({yc:!0})}),1e3),a.data.userInfo.idvId?(wx.reportEvent("many_draw",{}),wx.request({url:a.data.apiUrl+"/w/lottery/draw/solarTerm/drawPrize10",header:{wxToken:a.data.wxToken},method:"POST",data:{activityId:a.data.activeData,times:1},success:function(t){console.log(t,"res"),200===t.data.code?(a.getNumber(a,a.data.activeData),a.setData({manyFalg:!0})):905===t.data.code?wx.showToast({title:"抽奖劵不足",icon:"error",duration:1e3}):wx.showToast({title:t.data.msg,duration:1e3})}})):wx.showToast({title:"请绑定角色",icon:"error",duration:1e3})},happy:function(){this.rode(this),this.close()},recordBreak:function(){this.recordFun(this,this.data.activeData,"933311e58a2c456ebcd888bad886e01b"),that.recordFun(this,this.data.activeData,"4a3dfca703e911eda72a0242ac110003")},gowc:function(a){var t=this;if(t.data.userInfo.idvId){var e=a.currentTarget.dataset.taskid;"0cfefd8703e911eda72a0242ac110003"===e?t.goChange(t):"f3e28987dd9b4d4a9b05522591260f50"===e?wx.request({url:t.data.apiUrl+"/w/mission/setDrawStatus",header:{wxToken:t.data.wxToken},data:{activityId:t.data.activeData,taskId:"f3e28987dd9b4d4a9b05522591260f50"},success:function(a){200===a.data.code?t.getTask(t,t.data.activeData):wx.showToast({title:a.data.msg,duration:1e3})}}):"241c22ee121243a68dc34145ebd96111"===e?wx.navigateTo({url:"/pages_user/pages/user/collect"}):"d1441dc932884ff8bca07aa8800e9902"===e?wx.navigateTo({url:"/pages_user/pages/signin/index"}):"5f26a49803e911eda72a0242ac110003"===e&&wx.navigateTo({url:"/pages/vsrecord/index"})}else wx.showToast({title:"请绑定角色",icon:"error",duration:1e3});this.scorllClose()},goSuccess:function(a){var t=this;t.data.userInfo.idvId?wx.request({url:t.data.apiUrl+"/w/mission/doTask",data:{activityId:t.data.activeData,taskId:a.currentTarget.dataset.taskid},header:{wxToken:t.data.wxToken},success:function(a){200===a.data.code?(t.getNumber(t,t.data.activeData),t.getTask(t,t.data.activeData),wx.showToast({title:"领取成功",icon:"success",duration:1e3})):wx.showToast({title:a.data.msg,duration:1e3})}}):wx.showToast({title:"请绑定角色",icon:"error",duration:1e3})},goChange:function(a){a.setData({answerflag:!0,answerChange:[{A:0,B:0,C:0,D:0},{A:0,B:0,C:0,D:0}],answerNumber:[!1,!1],answerNum:[],answer_class:!1,answer_class1:!1}),wx.request({url:a.data.apiUrl+"/w/mission/getQuestion",data:{activityId:a.data.activeData},header:{wxToken:a.data.wxToken},success:function(t){200==t.data.code?a.setData({answerList:t.data.data}):wx.showToast({title:t.data.msg,duration:1e3})}})},change:function(a){var t=a.currentTarget.dataset.index,e=a.currentTarget.dataset.option,s=[this.data.answerChange[0],{A:0,B:0,C:0,D:0}],n=this.data.answerList[t].answer===e;if(this.setData({answer_class:!n}),n){s[t][e]=1;var d=this.data.answerNumber;d[1]=!0,this.setData({answerChange:s,answerNumber:d,answerNum:d.filter((function(a){return a}))})}else{s[t][e]=2;var r=this.data.answerNumber;r[1]=!1,this.setData({answerChange:s,answerNumber:r,answerNum:r.filter((function(a){return a}))})}},change1:function(a){var t=a.currentTarget.dataset.index,e=a.currentTarget.dataset.option,s=[{A:0,B:0,C:0,D:0},this.data.answerChange[1]],n=this.data.answerList[t].answer===e;if(this.setData({answer_class1:!n}),n){s[t][e]=1;var d=this.data.answerNumber;d[0]=!0,this.setData({answerChange:s,answerNumber:d,answerNum:d.filter((function(a){return a}))})}else{s[t][e]=2;var r=this.data.answerNumber;r[0]=!1,this.setData({answerChange:s,answerNumber:r,answerNum:r.filter((function(a){return a}))})}},receive:function(){wx.reportEvent("answer_receive",{}),this.close();var a=this;wx.request({url:a.data.apiUrl+"/w/mission/setDrawStatus",header:{wxToken:a.data.wxToken},data:{activityId:a.data.activeData,taskId:"0cfefd8703e911eda72a0242ac110003"},success:function(t){200===t.data.code?a.getTask(a,a.data.activeData):wx.showToast({title:t.data.msg,duration:1e3})}})},break:function(){var a=this;a.setData({yc:!1}),wx.showLoading({title:"刷新中"}),setTimeout((function(){wx.hideLoading(),a.getNumber(a,a.data.activeData),a.setData({yc:!0})}),1e3),wx.reportEvent("draw_num",{})},sx:function(){var a=this;wx.showLoading({title:"刷新中"}),a.setData({yc:!1}),setTimeout((function(){wx.hideLoading(),a.recordFun(a,a.data.activeData,"933311e58a2c456ebcd888bad886e01b"),a.setData({yc:!0})}),1e3)},sx1:function(){var a=this;wx.showLoading({title:"刷新中"}),a.setData({yc:!1}),setTimeout((function(){wx.hideLoading(),a.recordFun(a,a.data.activeData,"4a3dfca703e911eda72a0242ac110003"),a.setData({yc:!0})}),1e3)},bindRole:function(){this.setData({bindUserVisible:!0}),wx.reportEvent("home_bindcansee",{})},handleBind:function(a){"true"!==a.detail?this.setData({bindUserVisible:!this.data.bindUserVisible}):this.setData({bindUserVisible:!1})},handleCustomReject:function(){var t;null!==(t=this.data.userInfo)&&void 0!==t&&t.idvId&&!a.globalData.userinfoApiStatus&&wx.redirectTo({url:a.globalData.pageIndex})},close:function(){this.scorllStart(),this.setData({ruleFlag:!1,onceFlag:!1,answerflag:!1,recordFalg:!1,manyFalg:!1})},taskStage:function(a){this.setData({stage:a.currentTarget.dataset.index})},onReady:function(){},onShow:function(){this.getData(this),wx.hideLoading(),this.setData({isLoading:!1})},onHide:function(){},onUnload:function(){},onPullDownRefresh:function(){},onReachBottom:function(){},onShareAppMessage:function(){return{title:"快来领取立春【头像】啦~",path:"/pages_user/pages/head/head",imageUrl:this.data.imgUrl+"/head/new/share.jpg"}},onShareTimeline:function(){return{title:"快来领取立春【头像】啦~",imageUrl:this.data.imgUrl+"/head/new/share.jpg"}}});
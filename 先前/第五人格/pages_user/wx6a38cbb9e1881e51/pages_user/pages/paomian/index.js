var e=getApp();Page({data:{wxToken:"",userPhone:"",apiUrl:e.globalData.apiUrl,isloadIng:!1,userInfo:{},bindUserVisible:!1,unBindVisible:!1,popName:"",playbtn:!0,videoContext:"",imgUrl:e.globalData.imgUrl},onLoad:function(t){var a=this;this.data.wxToken=e.globalData.wxToken,this.data.wxToken?this.getUserInfo():e.initOkCallback=function(t){a.setData({wxToken:t}),a.getUserInfo(),e.initOkCallback=null}},getUserInfo:function(){var e=this;wx.request({url:e.data.apiUrl+"/w/epro/noodle/order/user/info",header:{wxToken:e.data.wxToken},method:"get",dataType:"json",responseType:"text",success:function(t){200===t.data.code?(e.setData({userInfo:t.data.data}),e.data.userInfo.uid||e.setData({bindUserVisible:!0})):wx.showToast({title:t.data.msg,icon:"none",duration:3e3})},fail:function(e){wx.showToast({title:"网络异常",icon:"none",duration:3e3})},complete:function(){}})},getPhoneNumber:function(e){var t=this;"getPhoneNumber:ok"==e.detail.errMsg&&wx.request({url:t.data.apiUrl+"/w/epro/noodle/order/user/order",data:{code:e.detail.code?e.detail.code:"",encryptedData:e.detail.encryptedData?e.detail.encryptedData:"",iv:e.detail.iv?e.detail.iv:""},header:{wxToken:t.data.wxToken},method:"POST",dataType:"json",responseType:"text",success:function(e){200===e.data.code?(t.setData({"userInfo.order":1}),t.getUserInfo()):wx.showToast({title:e.data.msg,icon:"none",duration:3e3})},fail:function(){wx.showToast({title:"网络异常",icon:"none",duration:3e3})},complete:function(){}})},subMsg:function(){var e=(new Date).getDate(),t=["WxeAbZCbyA3QmrZSUFvtXXvsMz4RhiIt7HVmo3JEBsQ"],a={WxeAbZCbyA3QmrZSUFvtXXvsMz4RhiIt7HVmo3JEBsQ:{time:0,status:""}},n=wx.getStorageSync("paomian0315");n&&(a=JSON.parse(n));var o=!1;t.forEach((function(e){"accept"!==a[e].status&&(o=!0)})),o&&wx.requestSubscribeMessage({tmplIds:t,success:function(t){for(var n in a)a[n].status=t[n],a[n].time=e;wx.setStorageSync("paomian0315",JSON.stringify(a));var o="";for(var i in a)"accept"===a[i].status&&(o=o.length>0?o+","+i:o+i)},fail:function(e){console.log(e)}})},share:function(){var e=this;if(!this.data.isloadIng){this.setData({isloadIng:!0});var t=this;wx.request({url:t.data.apiUrl+"/w/epro/noodle/order/user/share",header:{wxToken:t.data.wxToken},method:"get",dataType:"json",responseType:"text",success:function(e){200===e.data.code&&(t.setData({"userInfo.share":1}),t.getUserInfo())},fail:function(e){wx.showToast({title:"网络异常",icon:"none",duration:3e3})},complete:function(){e.setData({isloadIng:!1})}})}},bind:function(){var e=this;if(!this.data.isloadIng){this.setData({isloadIng:!0,popName:""});var t=this;wx.request({url:t.data.apiUrl+"/w/epro/noodle/order/user/bind",data:{nickName:t.data.userInfo.nickName,uid:t.data.userInfo.uid},header:{wxToken:t.data.wxToken},method:"get",dataType:"json",responseType:"text",success:function(e){200===e.data.code?t.getUserInfo():wx.showToast({title:e.data.msg,icon:"none",duration:3e3})},fail:function(e){wx.showToast({title:"网络异常",icon:"none",duration:3e3})},complete:function(){e.setData({isloadIng:!1})}})}},gokanfan:function(){wx.navigateToMiniProgram({appId:"wx7564fd5313d24844",path:"pages/pgcvideo/pgcvideo?ssid=47527",envVersion:"release",success:function(e){}})},showbind:function(){this.data.userInfo.uid?this.setData({popName:"popbind"}):this.setData({bindUserVisible:!0})},showbind2:function(){this.setData({bindUserVisible:!0})},orderFirst:function(){wx.showToast({title:"请先预约泡面番更新",icon:"none",duration:3e3})},changerole:function(){this.setData({unBindVisible:!0,popName:""})},showRule:function(){this.setData({popName:"poprule"})},showShare:function(){this.setData({popName:"popshare"})},handleLongPress:function(){this.data.userInfo&&0===this.data.userInfo.share&&1===this.data.userInfo.bindPhone&&this.share()},gowenjuan:function(){wx.navigateTo({url:"/pages/out/out?url="+encodeURIComponent("https://game.163.com/s/?id=957")})},receive:function(){var e=this;if(0!==this.data.userInfo.bind)if(1!==this.data.userInfo.receive){if(!this.data.isloadIng){this.setData({isloadIng:!0});var t=this;wx.request({url:t.data.apiUrl+"/w/epro/noodle/order/user/receive",header:{wxToken:t.data.wxToken},method:"get",dataType:"json",responseType:"text",success:function(e){200===e.data.code?(t.setData({popName:"getSucc"}),t.getUserInfo()):wx.showToast({title:e.data.msg,icon:"none",duration:3e3})},fail:function(e){wx.showToast({title:"网络异常",icon:"none",duration:3e3})},complete:function(){e.setData({isloadIng:!1})}})}}else wx.showToast({title:"已领取过啦",icon:"none",duration:3e3});else this.showbind()},close:function(){this.setData({popName:""})},stopp:function(){},playVideo:function(){this.videoContext.play()},bindplay:function(){this.setData({playbtn:!1})},bindended:function(){this.setData({playbtn:!0})},handlerGobackClick:function(t){getCurrentPages().length>=2?wx.navigateBack({delta:t}):wx.redirectTo({url:e.globalData.pageIndex})},handlerGohomeClick:function(){wx.redirectTo({url:e.globalData.pageIndex})},handleBind:function(e){"true"!==e.detail?this.setData({bindUserVisible:!this.data.bindUserVisible}):this.setData({bindUserVisible:!1})},bindCol:function(e){this.getUserInfo()},handleCustomReject:function(){this.data.userInfo.uid&&!e.globalData.userinfoApiStatus&&wx.redirectTo({url:e.globalData.pageIndex})},onReady:function(){this.videoContext=wx.createVideoContext("myVideo")},onShow:function(){},onHide:function(){},onUnload:function(){},onPullDownRefresh:function(){},onReachBottom:function(){},onShareAppMessage:function(){return this.data.userInfo&&0===this.data.userInfo.share&&1===this.data.userInfo.bindPhone&&this.share(),{title:"预约追番免费领活动头像！",imageUrl:e.globalData.imgUrl+"/paomian/share.jpg"}}});
var e=require("../../../@babel/runtime/helpers/regeneratorRuntime"),t=require("../../../@babel/runtime/helpers/objectSpread2"),a=require("../../../@babel/runtime/helpers/asyncToGenerator");require("../../../@babel/runtime/helpers/Objectvalues");var i=getApp();Page({data:{wxToken:i.globalData.wxToken,userInfo:i.globalData.userInfo,imgUrl:i.globalData.imgUrl,apiUrl:i.globalData.apiUrl+"/w/epro/detailList/user/",defaultHead:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/face_common/fs_0005.png",bindUserInfo:null,bindUserVisible:!1,headerUrl:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/greed/",bdTypeList:[],bdAll:[],endTime:new Date("2024/04/03 23:59:59").getTime(),isInTime:!1,task:[{key:"dailyLogin",name:"每日登录活动页面",tips:"绑定角色后生效",voice:5,state:0},{key:"dailyWinner",name:"获得1次游戏对局胜利",tips:"仅限排位/匹配/联合狩猎模式",voice:2,state:0},{key:"dailyPlay",name:"完成3局游戏对局",tips:"仅限排位/匹配/联合狩猎模式",voice:2,state:0},{key:"dailyShare",name:"分享1次本活动",tips:"",voice:1,state:0,isShare:!0}],isOverTask:!1,popup:{bindConfirm:!1,voiceTip:!1,changeBind:!1,notBind:!1,dailyRemind:!1,giveVoice:!1,taskProg:!1,unBindVisible:!1,succ:!1,gonggao:!1},showPopupMask:!1,giveParams:{typeId:null,detailId:null,sum:1},typeid:"",playerid:"",isFirstGive2:!0,isSubscribe2:!1,refreshTimer:null,debounce:{refreshTask:!1,giveVoice:!1,bindConfirm:!1,getVoice:!1},messageWxid:["n-tiZwyPqdpegyzypayWsJk0wB2zYq3uK0xf6iHsjFo"]},onLoad:function(e){var t=this,a=e.typeid,i=e.playerid;a&&i&&this.setData({typeid:a,playerid:i}),(new Date).getTime()<=this.data.endTime&&this.setData({isInTime:!0}),wx.getStorage({key:"isFirstGive2",success:function(e){t.setData({isFirstGive2:e.data})}}),wx.getStorage({key:"isSubscribe2",success:function(e){t.setData({isSubscribe2:e.data})}}),console.log(this.data.apiUrl)},onShow:function(){var e=this;e.data.wxToken&&e.data.userInfo?(e.getBindUserInfo((function(){e.getBdList((function(){e.data.playerid&&e.data.typeid&&e.openSendVoice()}))})),e.handleRefreshTask()):this.getInit((function(){e.getBindUserInfo((function(){e.getBdList((function(){e.data.playerid&&e.data.typeid&&e.openSendVoice()}))})),e.handleRefreshTask()})),this.data.refreshTimer||this.refreshListData()},onHide:function(){var e=this.data.refreshTimer;clearInterval(e),e=null,this.setData({refreshTimer:e})},getInit:function(e){var t=this,a=new Promise((function(e,a){i.globalData.wxToken?t.setData({wxToken:i.globalData.wxToken},(function(){return e()})):i.initOkCallback=function(a){t.setData({wxToken:a},(function(){return e()}))}})),n=new Promise((function(e,a){i.globalData.userInfo?t.setData({userInfo:i.globalData.userInfo},(function(){return e()})):i.initUserOver=function(a){t.setData({userInfo:a},(function(){return e()}))}}));Promise.all([a,n]).then((function(){e&&e()}))},refreshListData:function(){var e=this,t=setInterval((function(){e.getBdList()}),12e4);this.setData({refreshTimer:t})},handlerGobackClick:function(e){getCurrentPages().length>=2?wx.navigateBack({delta:e}):wx.redirectTo({url:i.globalData.pageIndex})},handlerGohomeClick:function(){wx.redirectTo({url:i.globalData.pageIndex})},openPop:function(e){var t;t="string"==typeof e?e:e.target.dataset.key;var a=this.data.popup;for(var i in a)a[i]=i==t;this.setData({popup:a,showPopupMask:!Object.values(a).every((function(e){return!e}))})},closePop:function(e){var t;this.setData({playerid:"",typeid:""}),t="string"==typeof e?e:e.target.dataset.key;var a=this.data.popup;a[t]=!1,this.setData({popup:a,showPopupMask:!Object.values(a).every((function(e){return!e}))})},getBindUserInfo:function(e){var t=this;wx.request({url:t.data.apiUrl+"info",header:{wxToken:t.data.wxToken},method:"GET",success:function(a){var i=a.data,n=i.code,s=i.data;200==n?(s.header=t.data.headerUrl+s.header,t.setData({bindUserInfo:s},(function(){console.log("bindUserInfo",t.data.bindUserInfo)})),e&&e()):t.errorMsg(a.data)}})},handleBind:function(){this.setData({bindUserVisible:!1})},bindCol:function(){},handleCustomReject:function(){var e;null!==(e=this.data.userInfo)&&void 0!==e&&e.idvId&&!i.globalData.userinfoApiStatus&&wx.redirectTo({url:i.globalData.pageIndex})},handleBindGame:function(){this.data.userInfo.idvId?this.openPop("bindConfirm"):this.setData({bindUserVisible:!0})},handleBindConfirm:function(){var e=this;if(1!=e.data.bindUserInfo.bind&&!e.data.debounce.bindConfirm){var t=e.data.debounce;t.bindConfirm=!0,e.setData({debounce:t}),wx.request({url:e.data.apiUrl+"bind",header:{wxToken:e.data.wxToken},data:{nickName:e.data.userInfo.nickname,uid:e.data.userInfo.idvId},method:"POST",success:function(t){var a=t.data,i=a.code;a.data;200==i?(e.getBindUserInfo(),e.closePop("bindConfirm")):e.errorMsg(t.data)},complete:function(){setTimeout((function(){t.bindConfirm=!1,e.setData({debounce:t})}),500)}})}},getbdTypeList:function(){var e=this;return new Promise((function(t){wx.request({url:e.data.apiUrl+"list",method:"GET",success:function(a){var i=a.data.data;i=["人气监管者","人气求生者","人气战队","人气解说","优秀创作者","人气主播"].map((function(e){return{id:i.find((function(t){return t.typeName==e})),typeName:e}})),e.setData({bdTypeList:i}),t(i)}})}))},getBdList:function(i){var n=this;wx.request({url:n.data.apiUrl+"typeList",method:"GET",success:function(s){return a(e().mark((function a(){var o,r,d,u,c,l;return e().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.getbdTypeList();case 2:o=e.sent,r=[],d=0;case 5:if(!(d<o.length)){e.next=16;break}if(u=o[d],c=s.data.data[u.typeName]){e.next=10;break}return e.abrupt("continue",13);case 10:l=(l=c.filter((function(e){return null!=e.top})).sort((function(e,t){return e.top-t.top})).slice(0,3)).concat(c.filter((function(e){return null==e.top}))),r.push(t(t({},u),{},{list:l}));case 13:d++,e.next=5;break;case 16:n.setData({bdAll:r}),i&&i();case 18:case"end":return e.stop()}}),a)})))()}})},gobdTypeList:function(e){var t=e.target.dataset.typename;wx.navigateTo({url:"/pages_user/pages/zbtxpx/list?typename="+encodeURIComponent(t)})},openSendVoice:function(e){var t,a=this,i=this.data.bindUserInfo;if(0==i.open){var n=1;i.reputation>=10&&(n=5);var s=(null==e?void 0:e.target.dataset)||{},o=s.typeid,r=s.id;!o&&!r&&this.data.playerid&&this.data.typeid&&(r=this.data.playerid,o=this.data.typeid,console.log("分享进来的"));var d=null===(t=this.data.bdAll.find((function(e){return e.id.id==o})))||void 0===t?void 0:t.list;if(d){var u=d.find((function(e){return e.id==r}));u&&this.setData({giveParams:{typeId:o,detailId:r,sum:n,playerInfo:u},typeid:o,playerid:r},(function(){a.openPop("giveVoice")}))}}else wx.showToast({title:"当前不在活动开放时间",icon:"none",duration:3e3})},handleVoiceNum:function(e){var t=e.target.dataset.type,a=this.data.giveParams;"minus"==t?a.sum=Math.max(--a.sum,1):"add"==t&&(a.sum=Math.min(++a.sum,Math.max(this.data.bindUserInfo.reputation,1))),this.setData({giveParams:a})},handleGiveVolume:function(){if(0!=this.data.bindUserInfo.bind)if(0!=this.data.bindUserInfo.reputation){var e=this;if(!e.data.debounce.giveVoice){var t=e.data.debounce;t.giveVoice=!0,e.setData({debounce:t}),wx.request({url:e.data.apiUrl+"giveReputation",header:{wxToken:e.data.wxToken},data:e.data.giveParams,method:"GET",success:function(t){200==t.data.code?(e.closePop("giveVoice"),e.data.isFirstGive2?(e.openPop("dailyRemind"),e.setData({isFirstGive2:!1}),wx.setStorage({key:"isFirstGive2",data:!1})):(e.openPop("succ"),e.data.isSubscribe2&&e.wxMsg()),e.getBdList(),e.getBindUserInfo()):e.errorMsg(t.data)},complete:function(){setTimeout((function(){t.giveVoice=!1,e.setData({debounce:t})}),500)}})}}else wx.showToast({title:"你的声量已用完，请明日再来",icon:"none",duration:3e3});else this.handleBindGame()},subscribeMsg:function(){this.wxMsg()},wxMsg:function(){var e=this;i.getUserSetting((function(t){console.log(t),"accept"===t.subscriptionsSetting[e.data.messageWxid[0]]&&(console.log("总是订阅了该条订阅消息"),e.closePop("dailyRemind")),e.getMsg()}))},getMsg:function(){var e=this;wx.reportEvent("signin_openmsg",{});wx.requestSubscribeMessage({tmplIds:e.data.messageWxid,success:function(t){console.log("requestSubscribeMessage__succ",t),wx.reportEvent("signin_authsucc",{}),i.getUserSetting((function(a){"accept"===a.subscriptionsSetting[e.data.messageWxid[0]]||"accept"===t[e.data.messageWxid[0]]?(e.closePop("dailyRemind"),e.setData({isSubscribe2:!0}),wx.setStorage({key:"isSubscribe2",data:!0})):(e.setData({isSubscribe2:!1}),wx.setStorage({key:"isSubscribe2",data:!1}))}))},fail:function(e){console.log("requestSubscribeMessage__fail",e)}})},errorMsg:function(e){var t=e.code,a=e.msg;-10001003!=t?-10040011!=t?-10000304!=t?wx.showToast({title:a,icon:"none",duration:3e3}):this.handleBindGame():this.openPop("changeBind"):this.openPop("notBind")},openTask:function(){var e,t=this;if(1==(null===(e=this.data.bindUserInfo)||void 0===e?void 0:e.bind))this.handleRefreshTask((function(){t.openPop("taskProg")}));else{if(!this.data.userInfo.idvId)return void this.setData({bindUserVisible:!0});if(0==this.data.bindUserInfo.bind)return void this.openPop("bindConfirm")}},handleRefreshTask:function(e){var t=this;if(!t.data.debounce.refreshTask){var a=t.data.debounce;a.refreshTask=!0,t.setData({debounce:a}),wx.request({url:t.data.apiUrl+"taskCompleteness",header:{wxToken:t.data.wxToken},method:"GET",success:function(a){if(200==a.data.code){var i,n=t.data.task;i=(n=n.map((function(e){return e.state=a.data.data[e.key],e}))).filter((function(e){return 2==e.state})).length,t.setData({task:n,isOverTask:4==i}),e&&"function"==typeof e&&e()}else t.errorMsg(a.data)},complete:function(){setTimeout((function(){a.refreshTask=!1,t.setData({debounce:a})}),500)}})}},getVolume:function(e){var t=this;if(!t.data.debounce.getVoice){var a=t.data.debounce;a.getVoice=!0,t.setData({debounce:a});var i={dailyLogin:1,dailyWinner:2,dailyPlay:3,dailyShare:4}[e.target.dataset.key];wx.request({url:t.data.apiUrl+"receiveReputation",header:{wxToken:t.data.wxToken},data:{type:i},method:"GET",success:function(e){200==e.data.code?(t.handleRefreshTask(),t.getBindUserInfo()):t.errorMsg(e.data)},complete:function(){setTimeout((function(){a.getVoice=!1,t.setData({debounce:a})}),500)}})}},handleShare:function(){if(0!=this.data.bindUserInfo.bind){var e=this.data.task.find((function(e){return"dailyShare"==e.key})).state,t=this;0==e&&setTimeout((function(){wx.request({url:t.data.apiUrl+"share",header:{wxToken:t.data.wxToken},method:"GET",success:function(e){200==e.data.code?t.handleRefreshTask():t.errorMsg(e.data)}})}),3e3)}},onShareAppMessage:function(e){var t="/pages_user/pages/zbtxpx/index";return this.data.playerid&&this.data.typeid&&(t+="?typeid="+this.data.typeid+"&playerid="+this.data.playerid),console.log("sharePath",t),{title:"为喜欢的选手/战队/解说/主播/创作者呐喊助威吧！",imageUrl:this.data.imgUrl+"/zbtxpx/share.jpg",path:t}},handleGoQuestionnaire:function(){wx.navigateTo({url:"/pages/out/out?url="+encodeURIComponent("https://game.163.com/s/?id=955")})}});
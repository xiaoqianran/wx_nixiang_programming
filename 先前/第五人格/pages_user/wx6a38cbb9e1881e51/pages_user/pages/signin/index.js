var t=require("../../../@babel/runtime/helpers/regeneratorRuntime"),e=require("../../../@babel/runtime/helpers/defineProperty"),a=require("../../../@babel/runtime/helpers/asyncToGenerator"),n=getApp(),i=require("../../../utils/qwfriend.js");Page({data:{count:0,count2:0,wxToken:n.globalData.wxToken,apiUrl:n.globalData.apiUrl,imgUrl:n.globalData.imgUrl,userInfo:null,userPhone:!1,ifFriend:!1,bindUserVisible:!1,signinList:[{prizeId:110,title:"每日签到礼包",image:"",prize:"线索x10",getType:1},{prizeId:120,title:"每周首签礼包",image:"",prize:"线索x10",getType:1},{prizeId:130,title:"周累计签到3天礼包",image:"",prize:"线索x20  1天角色体验卡 x1",getType:1},{prizeId:140,title:"周连续签到7天礼包",image:"",prize:"线索x20 碎片x20 1天独特时装体验卡x1",getType:1}],prizelist:[],edaySignin:!1,getNum:0,weekSignin:0,totalSignin:0,guijiList:[{tt:"累签3天",total:3,ifget:!1,prizeId:210},{tt:"累签7天",total:7,ifget:!1,prizeId:220},{tt:"累签15天",total:15,ifget:!1,prizeId:230},{tt:"累签30天",total:30,ifget:!1,prizeId:240},{tt:"累签50天",total:50,ifget:!1,prizeId:250},{tt:"累签100天",total:100,ifget:!1,prizeId:260},{tt:"累签200天",total:200,ifget:!1,prizeId:270}],showpop:!1,showPopGetAll:!1,showPrize:!1,showPopGetOne:!1,showPopleiqian:!1,showSigninSuccess:!1,shareSuccess:!1,isSignShared:!1,showRule:!1,fandou:!1,thispid:0,showAddfri:!1,showMsgTips:!1,showAddfriTips:!1,messageTipGif:!1,messageTipGifUrl:"".concat(n.globalData.imgUrl,"/vsrecord/message_subscription-wechat.gif"),messageWxid:["yjFFsl7dJSo3UoNEdM3tpzJiUXw6kHXviLCL78G4ysI"],scrollBiao1:!1,scrollBiao2:!0,bannerList:[],user_date_log:[],currSelectDate:"".concat((new Date).getFullYear()).concat((new Date).getMonth()+1>9?(new Date).getMonth()+1:"0"+((new Date).getMonth()+1)),isShowDate:!0,signBanner:[]},onLoad:function(t){var e=this;this.data.wxToken=n.globalData.wxToken,this.data.wxToken?this.getdata():n.initOkCallback=function(t){e.setData({wxToken:t}),e.getdata(),n.initOkCallback=null},n.globalData.userPlayerStatis&&this.setData({updatedName:n.globalData.userPlayerStatis.role_name}),wx.reportEvent("signin_main",{}),"sharebtn"==t.from?wx.reportEvent("signin_load_sharebtn",{}):"share"==t.from?wx.reportEvent("signin_load_share",{}):"siyu"==t.from?wx.reportEvent("signin_load_siyu",{}):"haibao"==t.from?wx.reportEvent("signin_load_haibao",{}):"gzhrc"==t.from?wx.reportEvent("signin_load_gzhrc",{}):"gzhtt"==t.from?wx.reportEvent("signin_load_gzhtt",{}):"wb"==t.from?wx.reportEvent("signin_load_wb",{}):"liebian"==t.from?wx.reportEvent("signin_load_liebian",{}):"friend"==t.sub?(wx.reportEvent("signin_load_friend",{}),this.setData({showAddfriTips:!0})):"sign"==t.sub?wx.reportEvent("signin_load_sign",{}):t.from&&wx.reportEvent("signin_load_from",{content:t.from}),console.log(t)},goDetails:function(t){t.currentTarget.dataset.newsid;var e=t.currentTarget.dataset.type,a=t.currentTarget.dataset.url;if("banner"==t.currentTarget.dataset.from&&wx.reportEvent("index_banner_click",{news_name:t.currentTarget.dataset.title,content:a}),"inside-mp"===e)wx.navigateTo({url:a});else if("web-view"===e)wx.navigateTo({url:"/pages/out/out?url="+a});else{var n=t.currentTarget.dataset.appid;n?wx.navigateToMiniProgram({appId:n,path:a}):wx.navigateTo({url:"/pages/out/out?url="+a})}},getBanner:function(){var t=this;wx.request({url:this.data.apiUrl+"/w/epro/ad/banner/get",header:{wxToken:t.data.wxToken},success:function(e){e.data.data?(console.log(e.data.data.signIn,"---signBanner---"),t.setData({signBanner:e.data.data.signIn})):console.log("getBanner__err",e)}})},getdata:function(){var t=this,e=n.globalData.userInfo;e?(this.setData({userInfo:e}),e.phone&&""!=e.phone&&this.setData({userPhone:!0})):n.initUserOver=function(e){t.setData({userInfo:e}),e.phone&&""!=e.phone&&t.setData({userPhone:!0})},this.getPrizeList((function(){t.myFriend()})),this.getRecordList(),this.getBanner()},api:function(t){var e=this,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"GET",r=this;return new Promise((function(s,o){wx.request({url:r.data.apiUrl+t,data:a,header:{"content-type":"application/json",wxToken:r.data.wxToken},method:i,dataType:"json",responseType:"text",success:function(t){console.log(t),-10000301==t.data.code?(r.showTt("请登录"),r.data.onLogin||(r.data.onLogin=!0,n.getLogin(),n.initOkCallback=function(t){e.setData({wxToken:t}),e.getdata(),n.initOkCallback=null,setTimeout((function(){r.data.onLogin=!1}),3e3)})):s(t.data)},fail:o,complete:function(){}})}))},getPrizeList:function(n){var i=this;return a(t().mark((function a(){var r,s,o,d,c,l,u,g;return t().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,i.api("/w/epro/signIn/getPrizeList");case 2:r=t.sent,console.log(r),200==r.code&&(s=i.data,o=s.signinList,d=s.guijiList,c=s.guijiList2,o.forEach((function(t){var e=t.prizeId.toString();r.data.prizeIds.indexOf(e)>-1&&(t.getType=2)})),d.forEach((function(t){var e=t.prizeId.toString();r.data.prizeIds.indexOf(e)>-1&&(t.ifget=!0)})),l=r.data.totalSignIn||0,u=0,g=100/6,l>3&&l<7?u=0+g*(l-3)/4:l>=7&&l<15?u=1*g+g*(l-7)/8:l>=15&&l<30?u=2*g+g*(l-15)/15:l>=30&&l<50?u=50+g*(l-30)/20:l>=50&&l<100?u=4*g+g*(l-50)/50:l>=100&&l<200?u=5*g+g*(l-100)/100:l>=200&&(u=100),l>50?i.setData({scrollBiao2:!1}):i.setData({scrollBiao2:!0}),l<15?i.setData({scrollBiao1:!1}):i.setData({scrollBiao1:!0}),i.setData(e(e(e(e({signinList:o,edaySignin:r.data.daySignIn>=1,totalSignin:r.data.totalSignIn||0,weekSignin:r.data.weekSignIn||0},"signinList",o),"guijiList",d),"guijiList2",c),"jdt",u)),n&&n(),wx.createSelectorQuery().select(".sum_signin_box .inner").node().exec((function(t){var e=t[0].node;wx.createSelectorQuery().selectAll(".jdtbox .jdt, .sum_signin_box .inner, .jdtbox").boundingClientRect((function(t){var a=t[2].width+t[2].left/2-t[0].width/2;a<0&&(a=0),t[2].width>t[1].width/6*4.5&&(a=t[1].width/6*4.5+t[2].left/2-t[0].width/2,console.log("最大",a)),e.scrollTo({left:a,animated:!1}),i.data.innerScroll_l=t[2].left/2,i.data.innerScroll_r=t[1].width+t[2].left/2-t[0].width})).exec()})),7==r.data.weekSignIn&&wx.reportEvent("signin_aweek",{}));case 5:case"end":return t.stop()}}),a)})))()},innerOnScroll:function(t){this.data.scrollBiao1&&t.detail.scrollLeft<this.data.innerScroll_l?this.setData({scrollBiao1:!1}):!this.data.scrollBiao1&&t.detail.scrollLeft>this.data.innerScroll_l&&this.setData({scrollBiao1:!0}),this.data.scrollBiao2&&t.detail.scrollLeft>this.data.innerScroll_r?this.setData({scrollBiao2:!1}):!this.data.scrollBiao2&&t.detail.scrollLeft<this.data.innerScroll_r&&this.setData({scrollBiao2:!0})},myFriend:function(t){var e=this;wx.getStorageSync("20220906joinQwFriend")?this.setData({ifFriend:!0}):i.findqwfriend(this.data.wxToken,(function(){var a=wx.getStorageSync("20220906joinQwFriend");a?e.setData({ifFriend:a}):t&&(e.showTt("请先添加企微好友"),e.addFriend())})),this.data.edaySignin||this.signin()},catGameId:function(){wx.reportEvent("signin_bind",{}),this.setData({bindUserVisible:!0})},handleBind:function(){this.setData({bindUserVisible:!1})},bindCol:function(t){this.getdata()},handleCustomReject:function(){this.getdata()},getAllPrize:function(){var e=this;return a(t().mark((function a(){var i,r,s,o,d,c;return t().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e.beforeSignin()){t.next=2;break}return t.abrupt("return");case 2:if(e.data.edaySignin){t.next=5;break}return e.showTt("请先进行今天的签到哦"),t.abrupt("return");case 5:if(n.globalData.signMsgUsed){t.next=9;break}return e.data.needGetAllPrize=!0,e.wxMsg(),t.abrupt("return");case 9:if(!e.data.fandou){t.next=11;break}return t.abrupt("return");case 11:if(i=e.data.signinList,i.find((function(t){return 1==t.getType}))&&!e.data.doNotGetAll){t.next=17;break}return e.showTt("暂无可领取的奖励"),console.log("-----无可领取或已领取"),t.abrupt("return");case 17:return r=[],i.forEach((function(t){1==t.getType&&r.push(t.prizeId)})),t.next=21,e.api("/w/epro/signIn/autoPrize",{prizeIds:r.join(",")});case 21:if(s=t.sent,console.log("autoPrize",s),200!=s.code){t.next=43;break}if(wx.reportEvent("signin_getallpr",{}),e.setData({showpop:!0,showPopGetAll:!0,getNum:r.length,count2:s.data.count?s.data.count:0}),console.log("prizrIds",s.data.prizeIds.length),0==s.data.prizeIds.length){t.next=42;break}o=function(t,e){return t-e},(d=s.data.prizeIds).sort(o),e.setData({prizelist:d}),c=0;case 33:if(!(c<d.length)){t.next=39;break}return t.next=36,e.getPrize(d[c]);case 36:c++,t.next=33;break;case 39:setTimeout((function(){e.setData({showPrize:!0}),e.getPrizeList()}),3e3),t.next=43;break;case 42:setTimeout((function(){e.setData({showpop:!1,showPopGetAll:!1}),e.showTt("暂无可领取的奖励"),console.log("----- prizrIds为0 已领取过奖品后导致暂无可领取"),e.data.doNotGetAll=!0}),3e3);case 43:setTimeout((function(){e.setData({fandou:!1})}),1e3);case 44:case"end":return t.stop()}}),a)})))()},getPrize:function(t){var e=this;return new Promise((function(a,n){setTimeout((function(){var n=e.data,i=(n.signinList,n.count);return i<n.count2&&i++,e.setData({count:i}),console.log("id",t,"count",e.data.count),a()}),1e3)}))},getOne:function(e){var n=this;return a(t().mark((function a(){var i,r,s;return t().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n,n.beforeSignin()){t.next=3;break}return t.abrupt("return");case 3:if(n.data.edaySignin){t.next=6;break}return n.showTt("请先进行今天的签到哦"),t.abrupt("return");case 6:if(i=e.currentTarget.dataset.type,r=e.currentTarget.dataset.prizeid,console.log("type",i),"week"!=i){t.next=13;break}if(!(2==e.currentTarget.dataset.index&&n.data.weekSignin<3||3==e.currentTarget.dataset.index&&n.data.weekSignin<7)){t.next=13;break}return n.showTt("累计签到次数不足，无法领取"),t.abrupt("return");case 13:if(n.wxMsg(),!n.data.fandou){t.next=16;break}return t.abrupt("return");case 16:return n.setData({fandou:!0}),t.next=19,n.api("/w/epro/signIn/getPrize",{prizeId:r});case 19:200==(s=t.sent).code?(console.log("领取成功"),e.currentTarget.dataset.tit&&wx.reportEvent("signin_getpr",{content:e.currentTarget.dataset.tit}),e.currentTarget.dataset.tt&&wx.reportEvent("signin_getleijipr",{content:e.currentTarget.dataset.tt}),setTimeout((function(){"lq"==i?n.setData({showPopleiqian:!0}):n.setData({showPopGetOne:!0}),n.setData({showpop:!0,thispid:r}),n.getPrizeList()}),500)):n.showTt(s.msg),setTimeout((function(){n.setData({fandou:!1})}),1e3);case 22:case"end":return t.stop()}}),a)})))()},showTt:function(t){wx.showToast({title:t,icon:"none",duration:1500})},ruleShow:function(){wx.reportEvent("signin_rule",{}),this.setData({showpop:!0,showRule:!0})},wxMsg:function(){var t=this;if(!n.globalData.signMsgUsed){n.getUserSetting((function(e){t.data.always=!1,console.log(e),"accept"===e.subscriptionsSetting[t.data.messageWxid[0]]?(console.log("总是订阅了该条订阅消息"),t.data.always=!0):(t.setData({showMsgTips:!0}),setInterval((function(){t.setData({messageTipGifUrl:"".concat(n.globalData.imgUrl,"/vsrecord/message_subscription-wechat.gif")})}),5e3)),t.getMsg()})),n.globalData.signMsgUsed=!0}},getMsg:function(){var t,e=this,a=this;this.setData({showMsgTips:!1}),wx.reportEvent("signin_openmsg",{}),this.data.always||(this.setData({messageTipGif:!0}),t=setInterval((function(){e.setData({messageTipGifUrl:"".concat(n.globalData.imgUrl,"/vsrecord/message_subscription-wechat.gif?time=").concat(Date.now())})}),5e3)),console.log("getMsg","----------------------");wx.requestSubscribeMessage({tmplIds:e.data.messageWxid,success:function(t){console.log("requestSubscribeMessage__succ",t),wx.reportEvent("signin_authsucc",{}),n.getUserSetting((function(t){"accept"===t.subscriptionsSetting[e.data.messageWxid[0]]&&(console.log("总是订阅了该条订阅消息"),e.data.always=!0),wx.request({url:a.data.apiUrl+"/w/subscribe/subscribe",data:{type:4,idvId:e.data.userInfo.idvId,always:e.data.always},method:"POST",header:{wxToken:a.data.wxToken},success:function(t){}})}))},fail:function(t){console.log("requestSubscribeMessage__fail",t)},complete:function(a){t&&(e.setData({messageTipGif:!1}),clearInterval(t),t=null),e.data.needGetAllPrize&&(e.getAllPrize(),e.data.needGetAllPrize=!1)}})},beforeSignin:function(){var t=this.data,e=(t.ifFriend,t.userInfo);return!(""==!!e.idvId||!e.idvId)||(this.showTt("请先绑定游戏账号"),this.catGameId(),!1)},tagQwFriend:function(){var e=this;return a(t().mark((function a(){var n;return t().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e.setData({longBag:!0}),!e.data.fandou&&!e.data.isLongPress){t.next=3;break}return t.abrupt("return");case 3:return t.next=5,e.api("/w/epro/wechatuser/mine/sendFriendPrize");case 5:n=t.sent,console.log(n),n.code,e.data.isLongPress=!0,setTimeout((function(){e.setData({fandou:!1})}),1e3);case 10:case"end":return t.stop()}}),a)})))()},addFriend:function(t){this.setData({showAddfri:!this.data.showAddfri,showAddfriTips:!1}),"toadd"==t.currentTarget.dataset.type&&(wx.reportEvent("signin_pop_toadd",{}),wx.reportEvent("signin_qwcode",{}))},signin:function(){var e=this;return a(t().mark((function a(){var n;return t().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(console.log("签到"),e.beforeSignin()){t.next=3;break}return t.abrupt("return");case 3:if(!e.data.fandou){t.next=5;break}return t.abrupt("return");case 5:return t.next=7,e.api("/w/epro/signIn/signIn");case 7:n=t.sent,console.log(n),200==n.code?(wx.reportEvent("signin_signin",{}),e.setData({showpop:!0,showSigninSuccess:!0,edaySignin:!0}),setTimeout((function(){e.getPrizeList()}),200)):e.showTt(n.msg),setTimeout((function(){e.setData({fandou:!1})}),1e3);case 11:case"end":return t.stop()}}),a)})))()},shareGetChance:function(){var e=this;return a(t().mark((function a(){var n;return t().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(wx.reportEvent("signin_share",{}),e.beforeSignin()){t.next=3;break}return t.abrupt("return");case 3:if(!e.data.fandou){t.next=5;break}return t.abrupt("return");case 5:if(!e.data.isSignShared){t.next=8;break}return e.setData({showpop:!0,shareSuccess:!0,isSignShared:!0}),t.abrupt("return");case 8:return t.next=10,e.api("/w/epro/signIn/share");case 10:n=t.sent,setTimeout((function(){console.log(n),200==n.code?(e.getPrizeList(),e.setData({showpop:!0,shareSuccess:!0}),e.data.isSignShared=!0):-10000800==n.code?e.setData({showpop:!0,shareSuccess:!0,isSignShared:!0}):e.showTt(n.msg),setTimeout((function(){e.setData({fandou:!1})}),1e3)}),1e3);case 12:case"end":return t.stop()}}),a)})))()},getSumPrize:function(t){if(this.data.edaySignin){var e=this.data,a=e.totalSignin,n=e.guijiList,i=t.currentTarget.dataset.index-1;if(a>=n[i].total&&!n[i].ifget)this.getOne(t);else{if(a>=n[i].total&&n[i].ifget)return;this.showTt("未满足领取条件")}}else this.showTt("请先进行今天的签到哦")},close:function(t){var e=t.currentTarget.dataset.index;t.currentTarget.dataset.type;switch(console.log(e),e){case"1":this.setData({showSigninSuccess:!1});break;case"2":this.setData({showPopGetAll:!1,showPrize:!1,count:0}),this.data.ifFriend||this.data.alreadyShowAddfri||(this.setData({showAddfriTips:!0,alreadyShowAddfri:!0}),wx.reportEvent("signin_pop_add",{}));break;case"3":this.setData({showPopGetOne:!1}),this.data.ifFriend||this.data.alreadyShowAddfri||(this.setData({showAddfriTips:!0,alreadyShowAddfri:!0}),wx.reportEvent("signin_pop_add",{}));break;case"4":this.setData({showRule:!1})}this.setData({showpop:!1})},closeRule:function(){this.data.showRule&&this.setData({showRule:!1,showpop:!1})},popShow:function(t){var a=t.currentTarget.dataset.name;this.setData(e({},a,!0)),"showAddfriTips"==a&&(wx.reportEvent("signin_btn_fu",{}),wx.reportEvent("signin_qwcode",{}))},closePop:function(t){var a=t.currentTarget.dataset.name;this.setData(e({},a,!1)),"showMsgTips"==a?(this.setData({showpop:!0}),this.data.needGetAllPrize&&(this.getAllPrize(),this.data.needGetAllPrize=!1)):this.setData({showpop:!1}),"showPopleiqian"==a&&(this.data.ifFriend||this.data.alreadyShowAddfri||(this.setData({showAddfriTips:!0,alreadyShowAddfri:!0}),wx.reportEvent("signin_pop_add",{})))},loginAgain:function(){var e=this;return a(t().mark((function a(){return t().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return wx.showLoading({title:"正在重新登录"}),t.next=3,n.getLogin();case 3:n.initOkCallback=function(t){e.setData({wxToken:t}),e.getdata(),n.initOkCallback=null};case 4:case"end":return t.stop()}}),a)})))()},compareVersion:function(t,e){t=t.split("."),e=e.split(".");for(var a=Math.max(t.length,e.length);t.length<a;)t.push("0");for(;e.length<a;)e.push("0");for(var n=0;n<a;n++){var i=parseInt(t[n]),r=parseInt(e[n]);if(i>r)return!0;if(i<r)return!1}return 0},getPhoneNumber:function(t){var e=this,a=e.compareVersion(n.globalData.sys.SDKVersion,"2.21.2");if("getPhoneNumber:ok"==t.detail.errMsg){if(!t.detail.code&&!t.detail.encryptedData&&!t.detail.iv)return void e.showTt("授权手机号失败请重新授权");if(!a&&(console.log("低版本"),!t.detail.encryptedData||!t.detail.iv))return void e.showTt("微信版本过低，请先升级微信版本");wx.request({url:e.data.apiUrl+"/w/epro/wechatuser/mine/bindPhone",data:{code:t.detail.code?t.detail.code:"",encryptedData:t.detail.encryptedData?t.detail.encryptedData:"",iv:t.detail.iv?t.detail.iv:""},header:{wxToken:e.data.wxToken},method:"POST",dataType:"json",responseType:"text",success:function(t){-10000301==t.data.code?e.loginAgain():n.reGetUserInfo((function(t){console.log(t),e.setData({userInfo:t}),t.phone&&e.setData({userPhone:!0})}))},fail:function(){},complete:function(){}})}},goTransfer:function(){wx.navigateTo({url:"/pages/transfer/transfer?id=50361273&t=grid_lottery&e=1"}),this.setData({shareSuccess:!1,showpop:!1})},onShow:function(){this.data.longBag&&(this.data.longBag=!1,this.myFriend())},onHide:function(){},onUnload:function(){},onPullDownRefresh:function(){},onReachBottom:function(){},onShareAppMessage:function(t){return{title:"button"==t.from?"签到领好礼，每日抽6480回声":"每日签到领海量游戏奖励",imageUrl:this.data.imgUrl+"/signin/signin_share.jpg",path:"button"==t.from?"pages_user/pages/signin/index?from=sharebtn":"pages_user/pages/signin/index?from=share"}},onPageScroll:function(){},onTabItemTap:function(t){},handlerGobackClick:function(t){getCurrentPages().length>=2?wx.navigateBack({delta:t}):wx.redirectTo({url:n.globalData.pageIndex})},notice:function(t){wx.reportEvent("signin_notice",{}),wx.navigateTo({url:"/pages/details/index?id="+t.currentTarget.dataset.id})},getRecordList:function(){var e=this;return a(t().mark((function a(){var n;return t().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e,t.next=3,wx.request({url:n.data.apiUrl+"/w/epro/signIn/record/list",header:{wxToken:n.data.wxToken},data:{month:e.data.currSelectDate},success:function(t){var e=[];t.data.data&&(t.data.data.forEach((function(t){e.push(t.date)})),n.setData({user_date_log:e}),console.log(n.data.user_date_log,"签到列表日期"))}});case 3:case"end":return t.stop()}}),a)})))()},onPreShow:function(t){var e=t.detail.chooseYear+""+(t.detail.chooseMonth>9?t.detail.chooseMonth:"0"+t.detail.chooseMonth);console.log("preDate：",e),this.setData({currSelectDate:e}),this.getRecordList()},onNextShow:function(t){var e=t.detail.chooseYear+""+(t.detail.chooseMonth>9?t.detail.chooseMonth:"0"+t.detail.chooseMonth);console.log("nextDate：",e),this.setData({currSelectDate:e}),this.getRecordList()}});
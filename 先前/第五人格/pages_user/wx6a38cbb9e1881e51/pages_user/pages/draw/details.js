var a=require("../../../@babel/runtime/helpers/objectSpread2"),t=require("../../../@babel/runtime/helpers/toConsumableArray"),e=getApp();Page({data:{imgUrl:e.globalData.imgUrl,apiUrl:e.globalData.apiUrl,wxToken:e.globalData.wxToken,drawResId:null,drawRes:null,drawDet:null,bannerIndex:0,drawId:null,joinSucShow:!1,userInfo:{},hasUserInfo:!1,addressInfo:{name:"",phoneNo:"",region:"",wechatId:"",detailedAddress:""},canDh:!0,addressShow:!1,region:["请选择您的地区","",""],receiveAwardShow:!1,drawNowShow:!1,drawNowRes:null,admin:!1,isbind:!1,gameId:null,bindUserVisible:!1,addressListShow:!1,addressList:[],haveReal:!1,isUpdateList:!1,canJoin:!0,lotteryResultSize:16,showGetMoreluckyPeople:!1,setTime:0,fives:"",taskSucc:!1,whereFrom:null,addressListPageNo:1,addressListPageSize:20,addressListTotal:0,swiperArr:[],partpic:[],ispartsm:!1,showCommentPop:!1},onLoad:function(a){var t=this,d=Date.parse(new Date),i=new Date(d),s=i.getFullYear(),o=i.getMonth()+1<10?"0"+(i.getMonth()+1):i.getMonth()+1,n=i.getDate()<10?"0"+i.getDate():i.getDate();"gzh"==a.from&&(t.data.whereFrom="gzh"),"share"==a.from&&wx.reportEvent("draw_from_share",{}),t.setData({nowDate:s+"-"+o+"-"+n,nowTime:i.getHours()+":"+i.getMinutes(),wxToken:e.globalData.wxToken,drawId:a.id}),t.data.wxToken?(t.getData(),t.isAdmin(),t.getUserInfo()):e.initOkCallback=function(a){t.setData({wxToken:e.globalData.wxToken}),t.getData(),t.isAdmin(),t.getUserInfo()};setInterval((function(){var a=t.data.drawDet;if(""!=a&&!t.data.isUpdateList){var e=Date.parse(new Date);if(a.lotteryType&&"timer"==a.lotteryType){var d,i=Date.parse(new Date(null===(d=a.luckyDate)||void 0===d?void 0:d.replace(/-/g,"/")))-e;if(i>0){var s=parseInt(i/864e5),o=parseInt(i%864e5/36e5),n=parseInt(i%36e5/6e4);a.timeDes=s>0?"距离开奖还有"+s+"天"+o+"小时":"距离开奖还有"+o+"小时"+n+"分钟"}else 2!=a.status&&3!=a.status&&(a.status=1)}else a.lotteryType&&"threadhold"==a.lotteryType&&a.peopleNum==a.luckyPeopleNum&&2!=a.status&&3!=a.status&&(a.status=1);t.setData({drawDet:a})}}),3e3)},getData:function(){this.getDetail()},isAdmin:function(){var a=this;wx.request({url:a.data.apiUrl+"/w/epro/lottery/isAdmin",data:{},header:{wxToken:a.data.wxToken},success:function(t){200==t.data.code?t.data.data&&a.setData({admin:!0}):wx.showToast({title:t.data.msg,icon:"none",duration:2e3})}})},joinNow:function(a){var t=this;return console.log("参与11"),3==t.data.drawDet.status?(wx.showToast({title:"该抽奖活动已关闭",icon:"none",duration:2e3}),!1):!!t.data.canJoin&&void(t.data.hasUserInfo?!t.data.isbind&&t.data.needBind?this.handleBind():1!=t.data.drawDet.activityType||t.data.taskSucc?2!=t.data.drawDet.activityType||1!=t.data.drawDet.configurationType||t.data.taskSucc?2!=t.data.drawDet.activityType||2!=t.data.drawDet.configurationType||t.data.taskSucc?t.data.drawNowShow||2!=t.data.drawDet.lotteryType?(t.data.canJoin=!1,2!=t.data.drawDet.lotteryType?wx.requestSubscribeMessage({tmplIds:["Ns1Zbo9KbPNiTcdYKFltERz1pg1-UWfaj0pLgW-am8Y"],success:function(e){a.isSub=1,t.join(a)},fail:function(e){a.isSub=0,t.join(a)},complete:function(a){wx.showLoading({title:"参与中"})}}):(a.isSub=0,t.join(a))):t.setData({drawNowShow:!0}):t.setData({sph1Show:!0}):t.setData({sph2Show:!0}):t.gzhKeywrodCol():t.getUserProfile())},partLotty:function(){var a=this;if("comment"!=a.data.drawDet.joinType||a.data.drawDet.user.commentTaskCompleted){var t=function(){wx.request({url:a.data.apiUrl+"/w/epro/h55/lottery/activity/participate",data:{id:a.data.drawId},method:"GET",header:{wxToken:a.data.wxToken},success:function(t){wx.showToast({title:t.data.msg,icon:"none",duration:2e3}),a.getDetail()}})};wx.requestSubscribeMessage({tmplIds:["Ns1Zbo9KbPNiTcdYKFltERz1pg1-UWfaj0pLgW-am8Y"],success:function(a){t()},fail:function(a){t()},complete:function(a){wx.showLoading({title:"参与中"})}})}else wx.setStorage({key:"refreshComment",data:!0}),wx.navigateTo({url:"/pages/details/index?id="+a.data.drawDet.commentArticleId})},partImmediateLotty:function(){var a=this;"comment"!=a.data.drawDet.joinType||a.data.drawDet.user.commentTaskCompleted?wx.request({url:a.data.apiUrl+"/w/epro/h55/lottery/immediate/lottery",data:{id:a.data.drawId},method:"GET",header:{wxToken:a.data.wxToken},success:function(t){200==t.data.code?t.data.data.prized?wx.showToast({title:"恭喜您中奖啦！",icon:"none",duration:2e3}):wx.showToast({title:"很遗憾，您未中奖~",icon:"none",duration:2e3}):wx.showToast({title:t.data.msg,icon:"none",duration:2e3}),a.getDetail()}}):(wx.setStorage({key:"refreshComment",data:!0}),wx.navigateTo({url:"/pages/details/index?id="+a.data.drawDet.commentArticleId}))},join:function(a){var t=this;wx.showLoading({title:"请稍等"}),wx.request({url:t.data.apiUrl+"/w/epro/drawPrize/savePersonnel",data:{activityId:t.data.drawId,type:2==t.data.drawDet.lotteryType?2:1,isSubscribe:a.isSub},method:"POST",header:{wxToken:t.data.wxToken},success:function(e){console.log(e),200==e.data.code?(2!=t.data.drawDet.lotteryType?t.setData({joinSucShow:!0}):2==t.data.drawDet.lotteryType&&(t.setData({drawNowRes:e.data.data}),t.drawResShow(a)),wx.reportEvent("draw_det_join",{}),wx.hideLoading()):-10000527==e.data.code?(t.setData({showCommentPop:!0}),t.data.canJoin=!0,wx.hideLoading()):(wx.hideLoading(),wx.showToast({title:e.data.msg,icon:"none",duration:2e3}),t.data.canJoin=!0)}})},shareRecord:function(){wx.reportEvent("draw_det_share",{})},gzhKeywrodCol:function(){this.setData({gzhShow:!0})},gzhGolink:function(){wx.navigateTo({url:"../out/out?url=https://mp.weixin.qq.com/s/JHJdyncUYSXSF7MqgVvvSg"})},hideGzh:function(){this.setData({gzhShow:!1})},hidesph1:function(){this.setData({sph1Show:!1})},hidesph2:function(){this.setData({sph2Show:!1})},closeCommentPop:function(){this.setData({showCommentPop:!1})},gzharticleCol:function(){var a=this;a.data.setTime=0,a.data.maxTime=15,a.data.setInt=setInterval((function(){a.data.setTime++}),1e3),a.hidesph2(),wx.navigateTo({url:"../out/out?url="+a.data.drawDet.articleLinks+"&settime="+a.data.maxTime})},goComment:function(){console.log("去资讯页"),this.setData({showCommentPop:!1}),wx.redirectTo({url:"/pages/details/index?from=draw&id="+this.data.drawDet.articleId})},copyAndGo:function(){var a=this;console.log("复制并去资讯页","口令",a.data.drawDet.comment),console.log("资讯id",a.data.drawDet.articleId),wx.setClipboardData({data:a.data.drawDet.comment,success:function(t){setTimeout((function(){a.goComment()}),1e3)}})},gzhvideoCol:function(){var a=this;a.data.setTime=0,a.data.maxTime=5,a.data.setInt=setInterval((function(){a.data.setTime++}),1e3),a.hidesph1(),wx.openChannelsActivity({finderUserName:a.data.drawDet.finderUserName,feedId:a.data.drawDet.feedId,success:function(a){console.log(a)},fail:function(a){console.log(a),wx.showToast({title:"打开视频号失败, 请检查是否为微信最新版",icon:"none",duration:2e3})}})},showAddressList:function(){wx.navigateTo({url:"/pages_user/pages/draw/addlist?id="+this.data.drawId})},atUlBottom:function(){this.data.addressListTotal>this.data.addressListPageNo*this.data.addressListPageSize&&(this.data.addressListPageNo++,this.getMoreAddress())},getMoreAddress:function(){var a=this;wx.request({url:a.data.apiUrl+"/w/epro/lottery/getPrizeRecord",data:{activityId:a.data.drawId,pageNo:a.data.addressListPageNo,pageSize:a.data.addressListPageSize},header:{wxToken:a.data.wxToken},success:function(e){var d;200==e.data.code?((d=a.data.addressList).push.apply(d,t(e.data.data.list)),a.data.addressListTotal=e.data.data.total,a.setData({addressList:a.data.addressList})):wx.showToast({title:e.data.msg,icon:"none",duration:2e3})}})},hideAddressList:function(){this.setData({addressListShow:!1,addressList:[],addressListPageNo:1,addressListPageSize:20})},handleBind:function(a){console.log(a),a&&"true"===a.detail?this.setData({bindUserVisible:!1}):this.setData({bindUserVisible:!this.data.bindUserVisible})},handleCustomReject:function(){this.data.gameId&&!e.globalData.userinfoApiStatus&&wx.redirectTo({url:e.globalData.pageIndex})},handlerGobackClick:function(a){getCurrentPages().length>=2?wx.navigateBack({delta:a}):wx.redirectTo({url:e.globalData.pageIndex})},handlerGohomeClick:function(){wx.redirectTo({url:e.globalData.pageIndex})},getDrawList:function(){wx.request({url:this.data.apiUrl+"/w/epro/h55/lottery/activity/page",data:{type:"recommend"},method:"POST",header:{wxToken:this.data.wxToken},success:function(a){200==a.data.code||wx.showToast({title:a.data.msg,icon:"none",duration:2e3})}})},getDetail:function(){var t=this;t.data.isUpdateList=!0,wx.request({url:t.data.apiUrl+"/w/epro/h55/lottery/activity/detail/get",data:{id:t.data.drawId},header:{wxToken:t.data.wxToken},success:function(d){if(200==d.data.code){var i="";null!=d.data.data.page.activityDescription&&(i=(i=d.data.data.page.activityDescription.replace(/class=[\"|'](.*?)[\"|'].*?/g,"").replace(/width=[\"|'](.*?)[\"|'].*?/g,"").replace(/height=[\"|'](.*?)[\"|'].*?/g,"").replace(/width:(.*?)[\;].*?/g,"").replace(/height:(.*?)[\;].*?/g,"")).replace(/\<img/gi,'<img class="rich-img"'));var s=0;t.data.swiperArr=[],d.data.data.prizeList&&d.data.data.prizeList.forEach((function(a,e){s+=a.total,a.lotteryExchangeCodeList=null,1==a.type&&(t.data.needBind=!0),2==a.prizeType&&(t.data.needBind=!0),0==a.type&&0==a.prizeType&&t.setData({haveReal:!0}),a.prizeImage.indexOf("/w/epro/upload/getPictureStream")>-1&&(a.prizeImage=t.data.apiUrl+a.prizeImage),t.data.swiperArr.push(a.prizeImage)})),1==d.data.data.needIdvId&&(t.data.needBind=!0),d.data.data.participatorList&&d.data.data.participatorList.splice(7),t.data.needBind&&null==t.data.gameId&&t.getGameId(),d.data.data.prSum=s,3!=d.data.data.peopleStatus&&2!=d.data.data.status||t.drawRes();var o,n=Date.parse(new Date);if(0==d.data.data.lotteryType)Date.parse(new Date(null===(o=d.data.data.luckyDate)||void 0===o?void 0:o.replace(/-/g,"/")))-n>0||2!=d.data.data.status&&3!=d.data.data.status&&(d.data.data.status=1);else if(1==d.data.data.lotteryType)d.data.data.peopleNum==d.data.data.luckyPeopleNum&&2!=d.data.data.status&&3!=d.data.data.status&&(d.data.data.status=1);else if(2==d.data.data.lotteryType){var r=0;d.data.data.prizeList&&d.data.data.prizeList.forEach((function(a,e){r+=a.total,"/uploads/"==a.prizeImage.substring(0,9)&&(a.prizeImage=t.data.apiUrl+"/resources"+a.prizeImage)})),d.data.data.prSum=r,0==d.data.data.prSum&&2==d.data.data.lotteryType&&3!=d.data.data.status&&(d.data.data.status=2)}d.data.data.missionFlag&&(t.data.taskSucc=d.data.data.missionFlag),null==t.data.drawDet&&d.data.data.prizeList&&wx.reportEvent("draw_det_pvuv",{news_name:d.data.data.id,content:d.data.data.prizeList[0].prizeName}),t.setData({drawDet:a(a({},d.data.data),{},{content:i})}),1==d.data.data.activityType&&"gzh"==t.data.whereFrom&&(t.data.taskSucc=!0,wx.request({url:t.data.apiUrl+"/w/epro/lottery/finishMission",data:{activityId:t.data.drawDet.id},header:{wxToken:t.data.wxToken},success:function(a){200==a.data.code||wx.showToast({title:a.data.msg,icon:"none",duration:2e3})}})),1==d.data.data.shareEnabled&&wx.hideShareMenu({menus:["shareAppMessage","shareTimeline"]}),wx.setStorage({key:"refeshDrawData",data:d.data.data})}else-10000301==d.data.code?(t.data.onLogin||(t.data.onLogin=!0,e.getLogin(),e.initOkCallback=function(a){t.setData({wxToken:a}),t.getData(),e.initOkCallback=null,setTimeout((function(){t.data.onLogin=!1}),3e3)}),console.log("app.initOkCallback",e.initOkCallback)):wx.showToast({title:d.data.msg,icon:"none",duration:2e3});t.data.isUpdateList=!1;var c=[];t.data.drawDet.statePic&&(c=t.data.drawDet.statePic.split(",")),t.setData({partpic:c}),""==t.data.drawDet.statePic&&null==t.data.drawDet.state||t.setData({ispartsm:!0})}})},priceDh:function(){if(3==this.data.drawDet.status)return wx.showToast({title:"该抽奖活动已关闭",icon:"none",duration:2e3}),!1;wx.navigateTo({url:"/pages_user/pages/draw/addinput?id="+this.data.drawId})},nameVal:function(a){this.data.addressInfo.name=a.detail.value},wechatIdVal:function(a){this.data.addressInfo.wechatId=a.detail.value},telVal:function(a){this.data.addressInfo.phoneNo=a.detail.value},addressVal:function(a){this.data.addressInfo.detailedAddress=a.detail.value},getGameId:function(){var a=this;wx.request({url:this.data.apiUrl+"/w/epro/wechatuser/mine/getIdvId",data:{wxToken:a.data.wxToken},success:function(t){-10000304==t.data.code&&"该账号暂未绑定游戏角色！"==t.data.msg?a.setData({isbind:!1,bindUserVisible:!0}):200==t.data.code?a.setData({isbind:!0,gameId:t.data.data.idvId}):wx.showToast({title:t.data.msg,icon:"none",duration:2e3})}})},drawRes:function(){var a=this;wx.request({url:a.data.apiUrl+"/w/epro/drawPrize/getLotteryResult",data:{activityId:a.data.drawId,pageSize:a.data.lotteryResultSize},method:"POST",header:{wxToken:a.data.wxToken},success:function(t){if(200==t.data.code){var e=!1;t.data.data.prizeList&&t.data.data.prizeList.forEach((function(t,d){t.personnelDtoList&&t.personnelDtoList.length<4&&(t.big=!0),a.data.lotteryResultSize<t.prizeTotal-t.total&&(e=!0)})),e&&100!=a.data.lotteryResultSize?a.setData({showGetMoreluckyPeople:!0}):a.setData({showGetMoreluckyPeople:!1}),a.setData({drawRes:t.data.data})}else wx.showToast({title:t.data.msg,icon:"none",duration:2e3})}})},getMoreluckyPeople:function(){this.data.lotteryResultSize+16>=100?this.data.lotteryResultSize=100:this.data.lotteryResultSize=this.data.lotteryResultSize+16,this.drawRes()},searchNext:function(){var a=this;wx.request({url:a.data.apiUrl+"/w/epro/lottery/getLuckyLotteryPage",data:{type:4,id:a.data.drawId},method:"POST",header:{wxToken:a.data.wxToken},success:function(t){200==t.data.code?t.data.data.list[0]&&a.setData({nextId:t.data.data.list[0].id}):wx.showToast({title:t.data.msg,icon:"none",duration:2e3})}})},getUserInfo:function(){var a=this;wx.request({url:this.data.apiUrl+"/w/epro/wechatuser/mine/userinfo",data:{wxToken:a.data.wxToken},header:{wxToken:a.data.wxToken},success:function(t){var e=t.data.data;a.setData({userInfo:e,hasUserInfo:!0})}})},bindCol:function(a){this.setData({gameId:a.detail.gameId,isbind:!0})},drawResShow:function(a){var t=this;a.currentTarget.dataset.id;null==t.data.drawResId&&(t.setData({drawResId:a.currentTarget.dataset.id}),setTimeout((function(){t.setData({drawNowShow:!1}),t.getData()}),2400))},swiperChange:function(a){this.setData({bannerIndex:a.detail.current})},previewImage:function(a){var t=a.target.dataset.src;wx.previewImage({current:t,urls:this.data.swiperArr})},hideJoinSuc:function(){this.setData({joinSucShow:!1}),this.getData()},copyCode:function(a){var t=a.currentTarget.dataset.code,e=[];if(t.forEach((function(a){e.push(a.content)})),Array.isArray(e)&&(e=e.join(";")),""==e)return!1;wx.setClipboardData({data:e,success:function(a){wx.showToast({title:"复制成功",duration:1500})}})},getUserProfile:function(a){var t=this;wx.getUserProfile({desc:"用于完善用户资料",success:function(a){wx.setStorage({key:"userInfo",data:a.userInfo}),t.setData({userInfo:a.userInfo,hasUserInfo:!0}),wx.request({url:t.data.apiUrl+"/w/epro/wechatuser/mine/info/update",data:{nickname:a.userInfo.nickName,avatar:a.userInfo.avatarUrl},method:"POST",header:{wxToken:t.data.wxToken,"Content-Type":"application/json"},success:function(a){}})}})},inputAddressShow:function(a){wx.navigateTo({url:"/pages_user/pages/draw/addinput?id="+a.currentTarget.dataset.id})},inputAddressHide:function(){this.setData({addressShow:!1})},showReceiveAward:function(){this.setData({receiveAwardShow:!0})},hideReceiveAward:function(){this.setData({receiveAwardShow:!1})},bindRegionChange:function(a){this.setData({region:a.detail.value})},goNext:function(){if(wx.reportEvent("draw_det_next",{}),!this.data.nextId)return wx.showToast({title:"暂时没有未参与的抽奖活动了",icon:"none",duration:2e3}),!1;wx.removeStorage({key:"refeshDrawId",success:function(a){}}),wx.redirectTo({url:"/pages_user/pages/draw/details?id="+this.data.nextId})},fixDraw:function(){if(3==this.data.drawDet.status||2==this.data.drawDet.status)return wx.showToast({title:"该抽奖活动已关闭或已发奖完成, 不可再编辑",icon:"none",duration:2e3}),!1;wx.navigateTo({url:"/pages_user/pages/draw/add?id="+this.data.drawId})},closeDraw:function(){var a=this;wx.showModal({title:"温馨提示",content:"关闭抽奖后，该抽奖将无法开启，是否确认关闭该抽奖？",success:function(t){t.confirm?wx.request({url:a.data.apiUrl+"/w/epro/lottery/closeActivity/"+a.data.drawId,data:{},method:"POST",header:{wxToken:a.data.wxToken},success:function(a){200==a.data.code?(wx.showToast({title:"关闭成功",icon:"success",duration:2e3}),wx.setStorage({key:"refresh",data:!0}),wx.navigateBack()):wx.showToast({title:a.data.msg,icon:"none",duration:2e3})}}):t.cancel}})},getPhoneNumber:function(a){var t=this;console.log(a.detail),wx.request({url:t.data.apiUrl+"/w/epro/wechatuser/mine/bindPhone",data:{code:a.detail.code?a.detail.code:"",encryptedData:a.detail.encryptedData?a.detail.encryptedData:"",iv:a.detail.iv?a.detail.iv:""},method:"POST",header:{wxToken:t.data.wxToken},success:function(a){console.log(a),200==a.data.code&&(t.data.userInfo.phone=!0,t.setData({userInfo:t.data.userInfo}))}})},onReady:function(){},onShow:function(){var a=this;wx.getStorage({key:"refreshComment",success:function(t){a.getData(),wx.removeStorage({key:"refreshComment",success:function(a){}})}}),wx.getStorage({key:"refreshDet",success:function(t){a.getData(),wx.removeStorage({key:"refreshDet",success:function(a){}})}}),a.data.maxTime&&(a.data.setTime>=a.data.maxTime?(a.data.taskSucc=!0,a.data.maxTime=null,wx.showToast({title:"任务完成，快点击按钮参与抽奖吧",icon:"none",duration:2e3}),clearInterval(a.data.setInt),wx.request({url:a.data.apiUrl+"/w/epro/lottery/finishMission",data:{activityId:a.data.drawDet.id},header:{wxToken:a.data.wxToken},success:function(a){200==a.data.code||wx.showToast({title:a.data.msg,icon:"none",duration:2e3})}})):a.data.setTime>0&&a.data.setTime<a.data.maxTime&&(1==a.data.drawDet.configurationType?(wx.showToast({title:"请阅读"+a.data.maxTime+"秒再返回重试",icon:"none",duration:2e3}),a.data.maxTime=null):2==a.data.drawDet.configurationType&&wx.showToast({title:"请观看任一视频再返回重试",icon:"none",duration:2e3}),clearInterval(a.data.setInt),wx.request({url:a.data.apiUrl+"/w/epro/lottery/finishMission",data:{activityId:a.data.drawDet.id},header:{wxToken:a.data.wxToken},success:function(a){200==a.data.code||wx.showToast({title:a.data.msg,icon:"none",duration:2e3})}})))},onHide:function(){},onUnload:function(){},onPullDownRefresh:function(){},onReachBottom:function(){},onShareAppMessage:function(){return{title:this.data.drawDet.page.shareTitle,path:"/pages_user/pages/draw/details?from=share&id="+this.data.drawId,imageUrl:this.data.drawDet.page.shareImage,success:function(a){},fail:function(){},complete:function(){}}}});
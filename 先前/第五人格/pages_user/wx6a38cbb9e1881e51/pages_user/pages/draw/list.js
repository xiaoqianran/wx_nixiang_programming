var a=require("../../../@babel/runtime/helpers/toConsumableArray"),t=getApp();Page({data:{imgUrl:t.globalData.imgUrl,apiUrl:t.globalData.apiUrl,wxToken:t.globalData.wxToken,drawList:[],listType:0,admin:!1,pageNo:1,pageSize:10,total:0,isUpdateList:!1,blankTitle:""},onLoad:function(a){var e=this;a.listtype&&(console.log(a.listtype),e.setData({listType:a.listtype})),e.setData({wxToken:t.globalData.wxToken}),e.data.wxToken?(e.getData(),e.isAdmin()):t.initOkCallback=function(a){e.setData({wxToken:t.globalData.wxToken}),e.getData(),e.isAdmin()};setInterval((function(){var a=e.data.drawList;if(""!=a&&!e.data.isUpdateList){var t=Date.parse(new Date);a.forEach((function(a,e){var s=!1;if(a.startDate&&""!=a.startDate){var r=Date.parse(new Date(a.startDate.replace(/-/g,"/")))-t;if(r>0){var i=parseInt(r/864e5),n=parseInt(r%864e5/36e5),o=parseInt(r%36e5/6e4);a.timeDes=i>0?"距离抽奖开始还有"+i+"天"+n+"小时":"距离抽奖开始还有"+n+"小时"+o+"分钟",2!=a.status&&3!=a.status&&(a.status=5)}else s=!0}else s=!0;if(s)if(0==a.lotteryType){var d=Date.parse(new Date(a.luckyDate.replace(/-/g,"/")))-t;if(d>0){var u=parseInt(d/864e5),p=parseInt(d%864e5/36e5),l=parseInt(d%36e5/6e4);a.timeDes=u>0?"距离开奖还有"+u+"天"+p+"小时":"距离开奖还有"+p+"小时"+l+"分钟",a.status=0}else 2!=a.status&&3!=a.status&&(a.status=1)}else 1==a.lotteryType?a.peopleNum==a.luckyPeopleNum?2!=a.status&&3!=a.status&&(a.status=1):2!=a.status&&3!=a.status&&(a.status=0):2==a.lotteryType&&2!=a.status&&3!=a.status&&(a.status=0)})),e.setData({drawList:e.data.drawList})}}),3e3)},getData:function(){this.getDrawList()},getDrawList:function(){var e=this,s=Date.parse(new Date);e.data.isUpdateList=!0;var r={0:"recommend",1:"participate",2:"prized"}[e.data.listType]||"";wx.request({url:e.data.apiUrl+"/w/epro/h55/lottery/activity/page",data:{type:r,pageNo:e.data.pageNo,pageSize:e.data.pageSize},method:"GET",header:{wxToken:e.data.wxToken},success:function(r){var i;if(200==r.data.code){if(r.data.data.records.forEach((function(a,t){var r=0;a.idx=0,a.prizeList&&a.prizeList.forEach((function(a,t){r+=a.prizeNum,"/uploads/"==a.prizeImage.substring(0,9)&&(a.prizeImage=e.data.apiUrl+"/resources"+a.prizeImage)})),a.prSum=r;var i=!1;if(a.startDate&&""!=a.startDate){var n=Date.parse(new Date(a.startDate.replace(/-/g,"/")))-s;if(n>0){var o=parseInt(n/864e5),d=parseInt(n%864e5/36e5),u=parseInt(n%36e5/6e4);a.timeDes=o>0?"距离抽奖开始还有"+o+"天"+d+"小时":"距离抽奖开始还有"+d+"小时"+u+"分钟",2!=a.status&&3!=a.status&&(a.status=5)}else i=!0}else i=!0;if(i)if(0==a.lotteryType){var p=Date.parse(new Date(a.luckyDate.replace(/-/g,"/")))-s;if(p>0){var l=parseInt(p/864e5),c=parseInt(p%864e5/36e5),w=parseInt(p%36e5/6e4);a.timeDes=l>0?"距离开奖还有"+l+"天"+c+"小时":"距离开奖还有"+c+"小时"+w+"分钟",a.status=0}else 2!=a.status&&3!=a.status&&(a.status=1)}else 1==a.lotteryType?a.peopleNum==a.luckyPeopleNum?2!=a.status&&3!=a.status&&(a.status=1):2!=a.status&&3!=a.status&&(a.status=0):2==a.lotteryType&&2!=a.status&&3!=a.status&&(a.status=0);a.prizeList&&a.prizeList.forEach((function(a,t){a.prizeImage.indexOf("/w/epro/upload/getPictureStream")>-1&&(a.prizeImage=e.data.apiUrl+a.prizeImage)}))})),(i=e.data.drawList).push.apply(i,a(r.data.data.records)),e.data.total=r.data.data.total,e.setData({drawList:e.data.drawList}),""==e.data.drawList){var n="";0==e.data.listType?(wx.showToast({title:"暂无福利活动",icon:"none",duration:2e3}),n="暂无福利活动"):1==e.data.listType?(wx.showToast({title:"暂无我参与的活动",icon:"none",duration:2e3}),n="暂无我参与的活动"):2==e.data.listType?(wx.showToast({title:"暂无中奖记录",icon:"none",duration:2e3}),n="暂无中奖记录"):3==e.data.listType&&(wx.showToast({title:"暂无我发起的活动",icon:"none",duration:2e3}),n="暂无我发起的活动"),e.setData({blankTitle:n})}}else-10000301==r.data.code?e.data.onLogin||(e.data.onLogin=!0,t.getLogin(),t.initOkCallback=function(a){e.setData({wxToken:a}),e.getData(),t.initOkCallback=null,setTimeout((function(){e.data.onLogin=!1}),3e3)}):wx.showToast({title:r.data.msg,icon:"none",duration:2e3});e.data.isUpdateList=!1}})},isAdmin:function(){var a=this;wx.request({url:a.data.apiUrl+"/w/epro/lottery/isAdmin",data:{},header:{wxToken:a.data.wxToken},success:function(t){200==t.data.code?t.data.data&&a.setData({admin:!0}):wx.showToast({title:t.data.msg,icon:"none",duration:2e3})}})},handlerGobackClick:function(a){getCurrentPages().length>=2?wx.navigateBack({delta:a}):wx.redirectTo({url:t.globalData.pageIndex})},handlerGohomeClick:function(){wx.redirectTo({url:t.globalData.pageIndex})},viewChange:function(a){this.setData({listType:a.currentTarget.dataset.change}),this.data.drawList=[],this.data.pageNo=1,this.getDrawList(),0==this.data.listType&&wx.reportEvent("draw_btn_fuli",{}),1==this.data.listType&&wx.reportEvent("draw_btn_joined",{}),2==this.data.listType&&wx.reportEvent("draw_btn_record",{})},goDetail:function(a){return 3==a.currentTarget.dataset.status?(wx.showToast({title:"该抽奖活动已关闭",icon:"none",duration:2e3}),!1):5!=a.currentTarget.dataset.status||this.data.admin?(wx.setStorage({key:"refeshDrawId",data:a.currentTarget.dataset.id}),void wx.navigateTo({url:"/pages_user/pages/draw/details?id="+a.currentTarget.dataset.id})):(wx.showToast({title:"抽奖活动暂未开始",icon:"none",duration:2e3}),!1)},goAddDraw:function(){wx.navigateTo({url:"/pages_user/pages/draw/add"})},onReady:function(){},onShow:function(){var a=this;wx.getStorage({key:"refresh",success:function(t){a.data.drawList=[],a.data.pageNo=1,a.getData(),wx.removeStorage({key:"refresh",success:function(a){}}),wx.removeStorage({key:"refeshDrawId",success:function(a){}}),wx.removeStorage({key:"refeshDrawData",success:function(a){}})}}),wx.getStorage({key:"refeshDrawId",success:function(t){var e=Date.parse(new Date);wx.getStorage({key:"refeshDrawData",success:function(s){a.data.drawList.forEach((function(r,i){if(r.id==t.data){var n=0;s.data.prizeList.forEach((function(t,e){n+=t.prizeNum,"/uploads/"==t.prizeImage.substring(0,9)&&(t.prizeImage=a.data.apiUrl+"/resources"+t.prizeImage)})),s.data.prSum=n;var o=!1;if(s.data.startDate&&""!=s.data.startDate){var d=Date.parse(new Date(s.data.startDate.replace(/-/g,"/")))-e;if(d>0){var u=parseInt(d/864e5),p=parseInt(d%864e5/36e5),l=parseInt(d%36e5/6e4);s.data.timeDes=u>0?"距离抽奖开始还有"+u+"天"+p+"小时":"距离抽奖开始还有"+p+"小时"+l+"分钟",2!=s.data.status&&3!=s.data.status&&(s.data.status=5)}else o=!0}else o=!0;if(o&&0==s.data.lotteryType){var c=Date.parse(new Date(s.data.luckyDate.replace(/-/g,"/")))-e;if(c>0){var w=parseInt(c/864e5),g=parseInt(c%864e5/36e5),f=parseInt(c%36e5/6e4);s.data.timeDes=w>0?"距离开奖还有"+w+"天"+g+"小时":"距离开奖还有"+g+"小时"+f+"分钟"}else 2!=s.data.status&&3!=s.data.status&&(s.data.status=1)}s.data.idx=a.data.drawList[i].idx,a.data.drawList[i]=JSON.parse(JSON.stringify(s.data))}})),a.setData({drawList:a.data.drawList}),wx.removeStorage({key:"refeshDrawId",success:function(a){}}),wx.removeStorage({key:"refeshDrawData",success:function(a){}})}})}})},swiperChange:function(a){this.data.drawList[a.currentTarget.dataset.faidx].idx=a.detail.current,this.setData({drawList:this.data.drawList})},onHide:function(){},onUnload:function(){},onPullDownRefresh:function(){},onReachBottom:function(){this.data.total>this.data.pageNo*this.data.pageSize&&(this.data.pageNo++,this.getDrawList())},onShareAppMessage:function(){return{path:"/pages_user/pages/draw/draw?id="+this.data.drawId,imageUrl:this.data.apiUrl+this.data.drawDet.prizeList[0].prizeImage,success:function(a){},fail:function(){},complete:function(){}}}});
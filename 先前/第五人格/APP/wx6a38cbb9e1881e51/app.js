var e,a=require("@babel/runtime/helpers/slicedToArray"),t=require("@babel/runtime/helpers/toConsumableArray"),o=require("@babel/runtime/helpers/objectSpread2");e=Page,Page=function(a){a=Object.assign({onShareAppMessage:function(){return{title:"查战绩就上网易第五人格小程序",imageUrl:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/share2.jpg"}}},a),e(a)};var r=require("./utils/level.js"),n=require("./utils/hukeTrack.min.js");App({globalData:{userInfo:null,userRecord:null,userPlayerStatis:null,userPlayerrecord:null,userButPvpPart:null,userCivPvpPart:null,userInfoRequestCount:0,envVersion:"release",apiUrl:"https://h55.s3.game.163.com",imgUrl:"https://nie.res.netease.com/id5/m/zt/20201215094138/data",wxcode:null,wxToken:null,navHeight:0,navTop:0,windowHeight:0,activityId:"f2c570ef2a32432d8e3ae41faceeba04",activityId2:"8a960cc300e011eda72a0242ac110003",activeNewsId:"ef42e14d8f4f47d8bc65d987f8ce2210",pageIndex:"/pages/home/home/home",overTime:18e5,closeDialog:!1,userinfoApiStatus:null,userInfoCountStatus:!1,hFirst:!0,sys:"",isADShow:!0,isFirstADShow:!0},onLaunch:function(e){this.globalData.sys=wx.getSystemInfoSync(),console.log("sys",this.globalData.sys);var a=wx.getAccountInfoSync();this.globalData.envVersion=a.miniProgram.envVersion,this.getLogin(),wx.onAppRoute((function(e){var a;console.log("onAppRoute",e),null!=e&&null!==(a=e.query)&&void 0!==a&&a.hukeShareInfo&&(n.registerApp({hukeShareInfo:e.query.hukeShareInfo}),n.init())}))},onShow:function(e){if(console.log("---------onshow"),wx.canIUse("getUpdateManager")){var a=wx.getUpdateManager();a.onCheckForUpdate((function(e){e.hasUpdate&&(a.onUpdateReady((function(){wx.showModal({title:"更新提示",content:"新版本已经准备好，是否重启应用？",success:function(e){e.confirm&&a.applyUpdate()}})})),a.onUpdateFailed((function(){wx.showModal({title:"已经有新版本了哟~",content:"新版本已经上线啦~，请您删除当前小程序，重新搜索打开~"})})))}))}var t=this.globalData,o=t.wxToken,r=t.userInfoRequestCount;o&&r&&this.handleBind()},onHide:function(){this.globalData.isADShow=!0,this.globalData.isFirstADShow=!0},randomNum:function(e,a){return Math.round(Math.random()*(a-e)+e)},ifTimeOut:function(e){return(new Date).getTime()-e>this.globalData.overTime},getLogin:function(){var e=this;wx.login({success:function(a){e.globalData.wxcode=a.code,e.getWxToken()}})},getWxToken:function(){var e=this,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.globalData.wxcode;wx.request({url:this.globalData.apiUrl+"/w/epro/wechatauth/callback",data:{jsCode:a,token:wx.getStorageSync("key")},success:function(a){200==a.data.code&&a.data.data?(e.globalData.wxToken=a.data.data,console.log(a.data.data,"-----wxToken----"),wx.setStorageSync("wxToken",a.data.data),e.handleBind(),e.initOkCallback&&e.initOkCallback(e.globalData.wxToken)):wx.showToast({title:"服务器维护中",icon:"loading",duration:1e4})},error:function(){wx.showToast({title:"服务器维护中",icon:"loading",duration:1e4})}})},handleBind:function(){var e=this,a=!1;wx.getStorageSync("openId_appName")&&(this.globalData.closeDialog="pending",a=!0),wx.request({url:this.globalData.apiUrl+"/w/epro/wechatuser/mine/userinfo",data:{wxToken:this.globalData.wxToken},success:function(a){console.log("/mine/userinfo",a);var t=a.data.data;if(t&&t.idvId){var r;if(wx.getStorageSync("openId_appName"))(null===(r=e.globalData.userInfo)||void 0===r?void 0:r.idvId)!==(null==t?void 0:t.idvId)&&wx.showToast({title:"绑定成功"}),e.globalData.useBindCol=!0,wx.removeStorageSync("openId_appName");e.globalData.userInfo=o(o({},t),{},{nickName:t.wxName,avatarUrl:t.userAvatarUrl}),e.globalData.closeDialog="success",e.globalData.userinfoApiStatus=!0,t.openId&&n.setOpenid(a.openId)}else e.globalData.closeDialog="unbind",e.globalData.userInfo&&!t.idvId&&e.globalData.userInfo.idvId!==t.idvId&&wx.showToast({title:"解绑成功"}),e.globalData.userinfoApiStatus=!1,e.globalData.userInfo=o(o({},t),{},{nickName:t.wxName,avatarUrl:t.userAvatarUrl});e.initUserOver&&e.initUserOver(e.globalData.userInfo),e.globalData.userInfoCountStatus=!0},fail:function(a){e.globalData.userInfo=null,e.globalData.closeDialog="reject",e.globalData.userInfoCountStatus=!0,e.globalData.userinfoApiStatus=null},complete:function(){a&&!e.globalData.userInfo&&(wx.showToast({icon:"error",title:"绑定失败"}),wx.removeStorageSync("openId_appName"),"unbind"!==e.globalData.closeDialog&&(e.globalData.closeDialog="reject")),e.globalData.userInfoRequestCount++}})},reGetUserInfo:function(e){wx.request({url:this.globalData.apiUrl+"/w/epro/wechatuser/mine/userinfo",data:{wxToken:this.globalData.wxToken},success:function(a){e&&e(a.data.data)},fail:function(e){wx.showToast({icon:"none",title:"网络繁忙，请稍后重试"})}})},getAuthCode:function(e){wx.request({url:this.globalData.apiUrl+"/w/epro/open/auth/get_code",data:{appid:"m5oy6w5t6gy0opuex7"},method:"GET",header:{wxToken:this.globalData.wxToken},success:function(a){console.log("getAuthCode",a.data),e&&e(a.data)}})},getUserRecord:function(){var e=this;this._getUserRecord().then((function(a){var r=a.data.data[0],n=(r.but_saiji_hero_list,r.but_total_hero_list),l=(r.civ_saiji_hero_list,r.civ_total_hero_list),s=[].concat(t(n||[]),t(l||[])),i=null,u=-1;if(s.forEach((function(e){if(e.badge>-1){if(u>-1&&e.badge>u)return;u=parseInt(e.badge),i=e}})),console.log("排名",u),i&&-1!==i.badge){var c="";c=i.badge<11?"s":i.badge<101?"a":i.badge<301?"b":"c",i.card=(i&&null!==i.kill&&void 0!==i.kill?"j_":"q_")+c}e.globalData.userRecord=o(o({},a.data.data[0]),{},{dev_hero_list_all:s,dev_max_badeg:i}),e.userRecordOver&&(e.userRecordOver({userRecord:e.globalData.userRecord}),e.userRecordOver=null)}))},_getUserRecord:function(){var e=this;return new Promise((function(a,t){var o=e.globalData,r=o.apiUrl,n=o.wxToken,l=o.userInfo,s=wx.getStorageSync("record/day");if(s&&!e.ifTimeOut(s.et)&&s.envVersion==e.globalData.envVersion)return a(s.sj),!1;wx.request({url:"".concat(r,"/w/epro/wechatuser/mine/record/day"),data:{wxToken:n,server:10001,roleId:l.idvId},success:function(t){var o=t.data;200==o.code&&o.data?o.data.data&&(wx.setStorage({key:"record/day",data:{et:(new Date).getTime(),sj:o,envVersion:e.globalData.envVersion}}),a(o)):(e.userRecordOver({userRecord:null}),e.userRecordOver=null)}})}))},getPlayerStatis:function(){var e=this,t=function(t){if("err"!==t){var n=t.data.data[0],l=n.civ_pvp_part,s=n.but_pvp_part,i=l.split("_").map((function(e){return parseInt(e)||0})),u=a(i,3),c=u[0],d=u[1],g=u[2],p=s.split("_").map((function(e){return parseInt(e)||0})),v=a(p,3),h=v[0],f=v[1],w=v[2];e.globalData.userPlayerStatis=o(o({},t.data.data[0]),{},{dev_civ_pvp_part_large:c,dev_civ_pvp_part_small:d,dev_civ_pvp_part_star:g,dev_but_pvp_part_large:h,dev_but_pvp_part_small:f,dev_but_pvp_part_star:w,dev_civ_pvp_part_large_zh:r.levelToZh[c],dev_civ_pvp_part_small_rome:r.smallLevelToRome[d],dev_but_pvp_part_large_zh:r.levelToZh[h],dev_but_pvp_part_small_rome:r.smallLevelToRome[f]}),e.userPlayerStatisOver&&e.userPlayerStatisOver(e.globalData.userPlayerStatis)}else e.userPlayerStatisOver&&e.userPlayerStatisOver(t)};this._getPlayerStatis(t).then(t)},_getPlayerStatis:function(){var e=this;return new Promise((function(a,t){var o=e.globalData,r=o.apiUrl,n=o.wxToken,l=o.userInfo,s=wx.getStorageSync("playerstatis");if(s&&s.sj&&!e.ifTimeOut(s.et)&&s.envVersion==e.globalData.envVersion)return console.log(3),a(s.sj),!1;console.log("开始获取_getPlayerStatis"),wx.request({url:"".concat(r,"/w/epro/wechatuser/mine/playerstatis"),data:{wxToken:n,server:10001,roleId:null==l?void 0:l.idvId},success:function(t){var o,r,n=t.data;console.log("开始获取_getPlayerStatis_返回信息",n),200===n.code&&null!==(o=n.data)&&void 0!==o&&null!==(r=o.data)&&void 0!==r&&r[0]&&(wx.setStorage({key:"playerstatis",data:{et:(new Date).getTime(),sj:n,envVersion:e.globalData.envVersion}}),a(n)),n||(console.log("没有返回信息"),a("err"))}})}))},getPlayerrecord:function(){var e=this,a=this.globalData,t=a.apiUrl,r=a.wxToken,n=a.userInfo;wx.request({url:"".concat(t,"/w/epro/wechatuser/mine/playerrecord"),data:{wxToken:r,server:10001,roleId:n.idvId},success:function(a){var t=(a.data.data||[]).map((function(e){return o(o({},e),{},{parsePlayerInfo:e.playerInfo?JSON.parse(e.playerInfo.replace(/\s/g,"").replace(/\\/g,'"')):[]})}))||[];t.forEach((function(e,a){e.twhen=e.twhen.replace(/-/g,"/")}));var r=[],l=[];t.reverse().forEach((function(e){"2"===e.battleMode&&e.parsePlayerInfo.every((function(a){return a.role_id!==n.idvId||(2===a.camp_id?(l.push(o(o({},a),{},{twhen:e.twhen})),l.length>30&&l.splice(0,1)):1==a.camp_id&&(r.push(o(o({},a),{},{twhen:e.twhen})),r.length>30&&r.splice(0,1)),!1)}))})),e.globalData.userPlayerrecord=t,e.globalData.userButPvpPart=r,e.globalData.userCivPvpPart=l,e.userPlayerrecordOver&&e.userPlayerrecordOver(t,r,l)}})},getDpr:function(){var e=0;return wx.getSystemInfo({success:function(a){e=a.pixelRatio},fail:function(){e=0}}),e},requestError:function(e){wx.showToast({title:e||"请求超时",icon:"none",duration:3e3})},getUserSetting:function(e){wx.getSetting({withSubscriptions:!0,success:function(a){e&&e(a)},fail:function(e){console.log(e,"getUserSetting失败")},complete:function(){}})},clearGlobalData:function(){console.log("清除globalData数据");var e=wx.getStorageSync("lastShowTime");wx.clearStorageSync(),wx.setStorageSync("lastShowTime",e),this.globalData.userPlayerStatis=null,this.globalData.userPlayerrecord=null,this.globalData.userRecord=null},eventTracking:function(e,a){console.log(e,a,"-------in-----"),wx.request({url:this.globalData.apiUrl+"/w/epro/article/banner/click",data:{type:e,bannerId:a},method:"GET",header:{wxToken:this.globalData.wxToken},success:function(e){}})}});
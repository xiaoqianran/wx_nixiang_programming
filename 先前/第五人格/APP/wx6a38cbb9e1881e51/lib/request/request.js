Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkLogin=exports.doLogin=exports.request=void 0;var e=require("../../config/app.config"),t=require("../storage/storage"),o=!1,n=[],r=e.request.max_try||3,s=e.request.app_type,i=function(e){var t=u();return Object.assign(e||{},{vid:t.vid,skey:t.skey,type:t.type})},a=function(e,t){var o;return 200===e.statusCode||(o=/^5\d+/g.test(e.statusCode)?"系统繁忙，请稍后重试":"请确保网络通畅，并重试",t&&t.silent||wx.showModal({showCancel:!1,title:"网络异常",content:o,confirmText:"确定"}),!1)},c=function(e){return new Promise((function(t,o){u().skey||!0===e.ignore?t():o(new Error("empty session"))}))};exports.checkLogin=c;var u=function(){return t.getStorage("session",!1)||{}},d=function(o){var n=t.getStorage("freego",!1)||{};return new Promise((function(o,r){new Promise((function(e,t){wx.login({success:e,fail:t})})).then((function(i){console.info("codeInfo %o",i),wx.request({url:e.request.api_prefix+"xcx/login",method:"POST",dataType:"json",data:{type:s,code:i.code},header:{cookie:n.cookie||"","Content-Type":"application/x-www-form-urlencoded"},success:function(e){var n,i=e.data.data;console.log("login response: %o",i),a(e)&&i&&"skey"in i?(n={gid:i.gid,skey:i.skey,vid:i.vid,type:s,corpname:i.corp_name},t.setStorage("session",n,!1),o(e)):r(e)},fail:r})})).catch((function(e){wx.showModal({content:"登录失败",showCancel:!1})}))}))};exports.doLogin=d;exports.request=function(s){var u=t.getStorage("freego",!1)||{},l=function(t,c){s.success=function(e){console.log("request sucess callback:%o",e),a(e,s)?e.data&&e.data.result&&-3===e.data.result.errCode?(s.tryTimes=s.tryTimes||0,s.tryTimes++,s.tryTimes<r?o?n.push(s):(o=!0,n=[],d().then((function(){o=!1,s.data=i(s.data),wx.request(s),n.forEach((function(e,t){e.data=i(e.data),wx.request(e)}))})).catch((function(){o=!1}))):t({data:{retcode:-102,retmsg:"login abort"}})):t(e):c(e)},s.fail=function(e){c(e)},s.url=/^http/g.test(s.url)?s.url:e.request.api_prefix+s.url,s.data=i(s.data),s.method=s.method||"GET",s.header=Object.assign(s.header||{},{cookie:u.cookie||"","Content-Type":"application/json"}),console.log("request options:%o",s),wx.request(s)};return new Promise((function(e,t){c(s).then((function(){l(e,t)})).catch((function(){d().then((function(){l(e,t)})).catch((function(e){console.log("login error %o",e),wx.showModal({content:"登录失败",showCancel:!1})}))}))}))};
require("../common/utils");var a=getApp();Page({data:{imgUrl:a.globalData.imgUrl,apiUrl:a.globalData.apiUrl,wxToken:a.globalData.wxToken,applyType:"",bindPic:"",idvId:"",applyMsg:"",wxUser:"",wxName:""},onLoad:function(t){var e=this;console.log("options----",t),this.setData({options:t});var o=this;this.setData({wxToken:a.globalData.wxToken}),this.data.wxToken?this.getData():a.initOkCallback=function(t){e.setData({wxToken:a.globalData.wxToken}),e.getData()},wx.getSystemInfo({success:function(a){"ios"!=a.platform&&"devtools"!=a.platform||o.setData({isIOS:!0})}})},getData:function(){this.getUserInfo()},getUserInfo:function(){var a=this;wx.request({url:this.data.apiUrl+"/w/epro/wechatuser/mine/userinfo",data:{wxToken:a.data.wxToken},success:function(t){200==t.data.code&&a.setData({userInfo:t.data.data})}})},formSubmit:function(a){console.log("form发生了submit事件，携带数据为：",a.detail.value);var t=this;return""===t.data.applyType?(wx.showToast({title:"请选择解绑原因",icon:"none",duration:2e3}),!1):1==t.data.applyType&&""==t.data.bindPic?(wx.showToast({title:"请上传小程序绑定截图",icon:"none",duration:2e3}),!1):2==t.data.applyType&&""==t.data.cbgPic?(wx.showToast({title:"请上传藏宝阁上架截图",icon:"none",duration:2e3}),!1):2==t.data.applyType&&""==t.data.cbgSellPic?(wx.showToast({title:"请上传藏宝阁售出截图",icon:"none",duration:2e3}),!1):""==t.data.idvId?(wx.showToast({title:"请输入游戏数字ID",icon:"none",duration:2e3}),!1):1==t.data.applyType&&""==t.data.applyMsg?(wx.showToast({title:"请输入何种原因",icon:"none",duration:2e3}),!1):""==t.data.wxUser?(wx.showToast({title:"请输入您的微信账号",icon:"none",duration:2e3}),!1):""==t.data.wxName?(wx.showToast({title:"请输入您的微信昵称",icon:"none",duration:2e3}),!1):void wx.request({url:t.data.apiUrl+"/w/epro/unbind/user/apply",data:{idvId:t.data.idvId,wxName:t.data.wxName,wxUser:t.data.wxUser,applyType:t.data.applyType,applyMsg:1==t.data.applyType?t.data.applyMsg:"账号上架藏宝阁，无法登录及解绑",bindPic:t.data.bindPic,cbgPic:t.data.cbgPic,cbgSellPic:t.data.cbgSellPic},method:"POST",header:{wxToken:t.data.wxToken},success:function(a){200===a.data.code?(wx.showToast({title:"提交成功",icon:"success",duration:4e3}),t.setData({idvId:"",wxName:"",wxUser:"",applyType:"",applyMsg:"",bindPic:"",cbgPic:"",cbgSellPic:""}),wx.navigateTo({url:"/pages/home/home/home"})):wx.showToast({title:a.data.msg,icon:"success",duration:4e3})}})},handlerGobackClick:function(t){getCurrentPages().length>=2?wx.navigateBack({delta:t}):wx.redirectTo({url:a.globalData.pageIndex})},handlerGohomeClick:function(){wx.redirectTo({url:a.globalData.pageIndex})},upload_file:function(a,t,e){wx.request({url:t.data.apiUrl+"/w/epro/system/file/upload/init",header:{wxToken:t.data.wxToken},method:"GET",success:function(o){200===o.data.code&&function(a,t,e){return console.log("url:".concat(a," token:").concat(t," filePath:").concat(e)),new Promise((function(o,i){wx.uploadFile({url:a,filePath:e,name:"fpfile",formData:{Authorization:"".concat(t),json:!0},success:function(a){200===a.statusCode?o(JSON.parse(a.data)):i(new Error("文件上传失败"))},fail:function(a){console.log(a),i(new Error("文件上传失败"))}})}))}(o.data.data.uploadUrl,o.data.data.token,a).then((function(a){"bindPic"==e?t.setData({bindPic:a.url}):"cbgPic"==e?t.setData({cbgPic:a.url}):"cbgSellPic"==e&&t.setData({cbgSellPic:a.url}),wx.showToast({title:"文件上传成功",icon:"success",duration:3e3})})).catch((function(a){console.error("文件上传失败",a)}))}})},chooseImg:function(a){var t=this,e=a.currentTarget.dataset.type;console.log("----------type----",e),wx.chooseMedia({count:1,mediaType:["image"],sizeType:["original","compressed"],sourceType:["album","camera"],success:function(a){console.log(a.tempFiles[0].tempFilePath);var o=a.tempFiles[0];o.size>2097152?wx.showToast({title:"图片大小不能超过2MB",icon:"none"}):t.upload_file(o.tempFilePath,t,e)},fail:function(a){},complete:function(a){}})},comImgDelete:function(a){var t=a.currentTarget.dataset.type;"bindPic"==t?this.setData({bindPic:""}):"cbgPic"==t?this.setData({cbgPic:""}):"cbgSellPic"==t&&this.setData({cbgSellPic:""})},previewImage:function(a){var t=a.target.dataset.src;wx.previewImage({current:t,urls:[t]})},radioChange:function(a){console.log("radio发生change事件，携带value值为：",a.detail.value),this.setData({applyType:a.detail.value})},idvIdVal:function(a){this.data.idvId=a.detail.value},applyMsgVal:function(a){this.data.applyMsg=a.detail.value},wxUserVal:function(a){this.data.wxUser=a.detail.value},wxNameVal:function(a){this.data.wxName=a.detail.value},goSite:function(){wx.navigateTo({url:"/pages/out/out?url=https://gm.163.com/user_help.html?index=5&paper_id=4370"})},clearChoose:function(){this.setData({applyType:""})}});
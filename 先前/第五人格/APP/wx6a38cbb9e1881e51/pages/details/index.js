var t=require("../../@babel/runtime/helpers/toConsumableArray"),a=require("../../@babel/runtime/helpers/defineProperty"),e=require("../../@babel/runtime/helpers/objectSpread2"),o=require("../common/utils"),i=getApp();Page({data:{imgUrl:i.globalData.imgUrl,apiUrl:i.globalData.apiUrl,wxToken:i.globalData.wxToken,newsDet:{title:null,content:null,classify:null,createTime:null,videoUrl:null,cover:null,isOwnLike:null},newsId:null,newsIsOwnLike:0,textSize:"n",tagStyle:{p:"line-height: 38rpx; color: #211009; margin-top: 10rpx; font-size: 28rpx; display: block;",h1:"line-height: 52rpx; color: #211009; margin-top: 10rpx; font-size: 36rpx; display: block;",h2:"line-height: 50rpx; color: #211009; margin-top: 10rpx; font-size: 34rpx; display: block;",h3:"line-height: 48rpx; color: #211009; margin-top: 10rpx; font-size: 32rpx; display: block;",h4:"line-height: 46rpx; color: #211009; margin-top: 10rpx; font-size: 30rpx; display: block;",h5:"line-height: 44rpx; color: #211009; margin-top: 10rpx; font-size: 28rpx; display: block;",h6:"line-height: 44rpx; color: #211009; margin-top: 10rpx; font-size: 28rpx; display: block;",video:"width: 650rpx; height: 366rpx; margin: 0 auto 0;",table:"width: 650rpx; margin: 0 auto 0; border-collapse: collapse; border-spacing: 0;",td:"font-size: 30rpx; color: #211009; line-height: 44rpx; text-align: center; border: 1px solid #211009;",th:"font-size: 30rpx; color: #211009; line-height: 44rpx; text-align: center; border: 1px solid #211009;"},tagStyle_s:{p:"line-height: 34rpx; color: #211009; margin-top: 10rpx; font-size: 24rpx; display: block;",h1:"line-height: 48rpx; color: #211009; margin-top: 10rpx; font-size: 32rpx; display: block;",h2:"line-height: 46rpx; color: #211009; margin-top: 10rpx; font-size: 30rpx; display: block;",h3:"line-height: 44rpx; color: #211009; margin-top: 10rpx; font-size: 28rpx; display: block;",h4:"line-height: 42rpx; color: #211009; margin-top: 10rpx; font-size: 26rpx; display: block;",h5:"line-height: 40rpx; color: #211009; margin-top: 10rpx; font-size: 24rpx; display: block;",h6:"line-height: 40rpx; color: #211009; margin-top: 10rpx; font-size: 24rpx; display: block;",video:"width: 650rpx; height: 366rpx; margin: 0 auto 0;",table:"width: 650rpx; margin: 0 auto 0; border-collapse: collapse; border-spacing: 0;",td:"font-size: 26rpx; color: #211009; line-height: 40rpx; text-align: center; border: 1px solid #211009;",th:"font-size: 26rpx; color: #211009; line-height: 40rpx; text-align: center; border: 1px solid #211009;"},tagStyle_n:{p:"line-height: 38rpx; color: #211009; margin-top: 10rpx; font-size: 28rpx; display: block;",h1:"line-height: 52rpx; color: #211009; margin-top: 10rpx; font-size: 36rpx; display: block;",h2:"line-height: 50rpx; color: #211009; margin-top: 10rpx; font-size: 34rpx; display: block;",h3:"line-height: 48rpx; color: #211009; margin-top: 10rpx; font-size: 32rpx; display: block;",h4:"line-height: 46rpx; color: #211009; margin-top: 10rpx; font-size: 30rpx; display: block;",h5:"line-height: 44rpx; color: #211009; margin-top: 10rpx; font-size: 28rpx; display: block;",h6:"line-height: 44rpx; color: #211009; margin-top: 10rpx; font-size: 28rpx; display: block;",video:"width: 650rpx; height: 366rpx; margin: 0 auto 0;",table:"width: 650rpx; margin: 0 auto 0; border-collapse: collapse; border-spacing: 0;",td:"font-size: 30rpx; color: #211009; line-height: 44rpx; text-align: center; border: 1px solid #211009;",th:"font-size: 30rpx; color: #211009; line-height: 44rpx; text-align: center; border: 1px solid #211009;"},tagStyle_b:{p:"line-height: 42rpx; color: #211009; margin-top: 10rpx; font-size: 32rpx; display: block;",h1:"line-height: 56rpx; color: #211009; margin-top: 10rpx; font-size: 40rpx; display: block;",h2:"line-height: 54rpx; color: #211009; margin-top: 10rpx; font-size: 38rpx; display: block;",h3:"line-height: 52rpx; color: #211009; margin-top: 10rpx; font-size: 36rpx; display: block;",h4:"line-height: 50rpx; color: #211009; margin-top: 10rpx; font-size: 34rpx; display: block;",h5:"line-height: 48rpx; color: #211009; margin-top: 10rpx; font-size: 32rpx; display: block;",h6:"line-height: 48rpx; color: #211009; margin-top: 10rpx; font-size: 32rpx; display: block;",video:"width: 650rpx; height: 366rpx; margin: 0 auto 0;",table:"width: 650rpx; margin: 0 auto 0; border-collapse: collapse; border-spacing: 0;",td:"font-size: 34rpx; color: #211009; line-height: 48rpx; text-align: center; border: 1px solid #211009;",th:"font-size: 34rpx; color: #211009; line-height: 48rpx; text-align: center; border: 1px solid #211009;"},imgLoading:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/imgload2.jpg",imgErr:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/imgerr2.jpg",comInputPabot:0,comInputlineNum:1,comDes:"",comImg:"",comNum:0,likeNum:0,userInfo:{},hasUserInfo:!1,comList:[],pageNo:1,pageSize:15,comBy:"H",ownerCom:{},ifshowSeLvCom:!1,faCom:null,seComList:[],sepageNo:1,sepageSize:15,seTop:0,canSend:!1,dontgetCom:!0,toView:"comment",textareaFocus:!1,textareaHfName:"",textareaPlaceholder:"我有话要说...",isIOS:!1,isCommentAdmin:!1,options:{},count:0,messageTipGif:!1,messageTipGifUrl:"".concat(i.globalData.imgUrl,"/vsrecord/message_subscription-wechat.gif"),showCommentPop:!1,drawId:null,showCom:!1,ifdisab:!1,userPlayerStatis:null,bindUserVisible:!1,disabled:!1},onLoad:function(t){var a=this;console.log("options",t);var e=+new Date;this.setData({options:t}),"like"===t.type?wx.reportEvent("zx_detail_subscribe_link_click",{}):"comment"===t.type&&wx.reportEvent("zx_detail_subscribe_reply_click",{});var o=this;this.setData({wxToken:i.globalData.wxToken,newsId:t.id,taskId:t.task}),this.data.wxToken?this.getData():i.initOkCallback=function(t){a.setData({wxToken:i.globalData.wxToken}),a.getData()},wx.getSystemInfo({success:function(t){"ios"!=t.platform&&"devtools"!=t.platform||o.setData({isIOS:!0})}}),e>=+new Date("2024/06/03 20:00:00")&&e<=+new Date("2024/06/05 20:00:00")&&this.setData({showCom:!0})},getData:function(){this.getNews(),this.getComList(),this.getCommentNumber(),this.getUserInfo()},getPlayerStatis:function(){var t=this,a=i.globalData.userPlayerStatis;a?(console.log("获取游戏信息__缓存"),this.setData({userPlayerStatis:(0,o.formatUserPlayerStatis)(a)})):(console.log("获取游戏信息__非缓存"),i.userPlayerStatisOver=function(a){console.log("userPlayerStatisOver--func：",a),t.setData({userPlayerStatis:(0,o.formatUserPlayerStatis)(a)}),i.userPlayerStatisOver=null,t.getUserEx()},i.getPlayerStatis())},handleBindUserDialog:function(){this.setData({bindUserVisible:!0})},handleBind:function(t){"true"!==t.detail?this.setData({bindUserVisible:!this.data.bindUserVisible}):this.setData({bindUserVisible:!1})},bindCol:function(t){this.getData()},handleCustomReject:function(){var t;null!==(t=this.data.userInfo)&&void 0!==t&&t.idvId&&!i.globalData.userinfoApiStatus&&wx.redirectTo({url:i.globalData.pageIndex})},getNews:function(){console.log("获取数据"),wx.showLoading({title:"加载中",mask:!0});var t=this;wx.request({url:this.data.apiUrl+"/w/epro/article/detail/get",data:{wxToken:t.data.wxToken,id:t.data.newsId},success:function(a){if(200==a.data.code){var o="";o=null!=a.data.data.content?(o=(o=a.data.data.content.replace(/class=[\"|'](.*?)[\"|'].*?/g,"").replace(/width=[\"|'](.*?)[\"|'].*?/g,"").replace(/height=[\"|'](.*?)[\"|'].*?/g,"").replace(/width:(.*?)[\;].*?/g,"").replace(/height:(.*?)[\;].*?/g,"")).replace(/\<img/gi,'<img class="rich-img"')).replace(/\<p/gi,'<p class="rich-p '+t.data.textSize+'" '):null!=a.data.data.videoUrl?'<p class="rich-p '+t.data.textSize+'"></p>':'<p class="rich-p '+t.data.textSize+'">暂无内容</p>',wx.reportEvent("news_details_pvuv",{click:"被点击",news_name:a.data.data.title}),a.data.data.videoPictureUrl.indexOf(":13024")>-1&&(a.data.data.videoPictureUrl=a.data.data.videoPictureUrl.replace(":13024","")),t.setData({newsDet:e(e({},a.data.data),{},{content:o,classify:a.data.data.catalogName,banner:a.data.data.videoPictureUrl,cover:a.data.data.wechatThumbUrl?a.data.data.wechatThumbUrl:a.data.data.videoPictureUrl}),newsIsOwnLike:a.data.data.isOwnLike,likeNum:a.data.data.like}),setTimeout((function(){t.data.dontgetCom=!1}),500)}else-10000301==a.data.code?wx.login({success:function(a){i.globalData.wxcode=a.code,wx.request({url:t.data.apiUrl+"/w/epro/wechatauth/callback",data:{jsCode:a.code},success:function(a){200==a.data.code?(i.globalData.wxToken=a.data.data,t.data.wxToken=a.data.data,t.getData()):wx.showToast({title:"服务器出错啦",icon:"loading",duration:1e4})}})}}):wx.showToast({title:a.data.msg,icon:"loading",duration:1e4})},fail:function(a){t.setData({showCom:!0}),wx.showToast({title:"网络开了点小差哦~请稍后再试",icon:"loading",duration:1e4})},complete:function(){wx.hideLoading()}})},getComList:function(){var t=this,a=this,e=this.data,o=e.apiUrl,i=e.comBy,n=e.pageNo,s=e.pageSize,r=e.newsId,d=e.wxToken;wx.request({url:o+"/w/epro/comment/query",data:{commentType:1,typeId:r,orderType:i,pageNo:n,pageSize:s},method:"POST",header:{wxToken:d},success:function(e){var o=/http[^"']*is_end=1/g;if(200==e.data.code){if(e.data.data.records){e.data.data.records.forEach((function(t,e){if(t.ranking&&t.ranking.indexOf("空军地勤")>-1&&(t.ranking=t.ranking.replace("地勤","")),t.imgUrl&&t.imgUrl.indexOf("/upload/")>-1&&(t.imgUrl=a.data.apiUrl+t.imgUrl),t.content){var i=t.content.match(o);i&&i.length&&(t.h5Url=i[0])}}));var i=e.data.data.records,n=t.data,s=n.newsDet;n.comList,n.count,n.id;t.setData({comList:t.data.comList.concat(i),count:1},(function(){if(s.videoUrl){var a=t.data.comList;a.length?t.handleStorage(a[0]):t.handleStorage({},"delete")}}))}}else wx.showToast({title:e.data.msg,icon:"none",duration:2e3});setTimeout((function(){a.data.dontgetCom=!1}),500)}})},handleStorage:function(t){var e=t.id,o=t.content,i=t.nickName,n=t.ranking,s=t.like,r=t.imgUrl,d=t.isOwnLike,l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"add",c={},m=wx.getStorageSync("index_daily_newComment");m&&Object.assign(c,m),"add"===l?Object.assign(c,a({},this.data.options.id,{id:e,content:o,nickName:i,ranking:n,like:s,imgUrl:r,isOwnLike:d})):(m[this.data.options.id]=null,c=m),wx.setStorageSync("index_daily_newComment",c)},regetCom:function(t){this.data.dontgetCom=!0,this.data.comList=[],this.setData({comBy:t.currentTarget.dataset.by,pageNo:1}),this.getComList()},doMylike:function(t){var a=this,e=this,o=t.currentTarget.dataset,i=o.item,n=o.id,s=o.index,r="";r=e.data.faCom&&e.data.faCom.id!=n?e.data.faCom.id:e.data.newsId,wx.request({url:e.data.apiUrl+"/w/epro/comment/like",data:{commentType:1,typeId:n,parentTypeId:r},header:{wxToken:e.data.wxToken},success:function(t){200==t.data.code?(console.log(a.data.faCom,n),e.data.faCom&&e.data.faCom.id!=n?(e.data.seComList[s].isOwnLike=1==t.data.data?1:0,e.data.seComList[s].like=e.data.seComList[s].like+t.data.data,s||a.handleStorage(a.data.seComList[s]),e.setData({seComList:e.data.seComList})):(e.data.comList[s].isOwnLike=1==t.data.data?1:0,e.data.comList[s].like=e.data.comList[s].like+t.data.data,s||a.handleStorage(a.data.comList[s]),e.setData({comList:e.data.comList,faCom:e.data.faCom})),s||console.log(i,"item")):-10000301==t.data.code?wx.showToast({title:"登录过期，请重新登录",icon:"none",duration:2e3}):-10000325==t.data.code?wx.showToast({title:"你的手速太快了~",icon:"none",duration:2e3}):wx.showToast({title:t.data.msg,icon:"none",duration:2e3})}})},showShare:function(){wx.reportEvent("news_sharebtn_click",{click:"被点击",news_name:this.data.newsDet.title}),wx.request({url:this.data.apiUrl+"/w/epro/article/banner/share",method:"GET",data:{detailId:this.data.newsId},header:{wxToken:this.data.wxToken},success:function(t){}})},goCom:function(t){var a=wx.createSelectorQuery().in(this);a.selectViewport().scrollOffset(),a.select("#comment").boundingClientRect(),a.exec((function(t){var a=t[0].scrollTop+t[1].top-80;wx.pageScrollTo({scrollTop:a,duration:300})})),wx.reportEvent("news_bottom_tocom",{click:"被点击",news_name:this.data.newsDet.title})},articleLike:function(){var t=this;wx.request({url:t.data.apiUrl+"/w/epro/article/like",data:{id:t.data.newsId},header:{wxToken:t.data.wxToken},success:function(a){200==a.data.code?(t.setData({newsIsOwnLike:1==a.data.data?1:0,likeNum:1==a.data.data?t.data.likeNum+1:t.data.likeNum-1}),wx.reportEvent("news_bottom_like",{click:"被点击",news_name:t.data.newsDet.title})):-10000325==a.data.code?wx.showToast({title:"你的手速太快了~",icon:"none",duration:2e3}):-10000301==a.data.code?wx.showToast({title:"登录过期，请重新登录",icon:"none",duration:2e3}):wx.showToast({title:a.data.msg,icon:"none",duration:2e3})}})},sendCom:function(){var t=this.data,a=t.hasUserInfo,e=t.comDes,o=t.comImg;t.options;if(a)if(""==e&&""==o)wx.showToast({title:"请先输入评论或上传图片",icon:"none",duration:2e3});else{var i=this.data,n=i.isCommentAdmin,s=i.faCom;if(!s)return wx.reportEvent("zx_detail_commit",{}),void this.handleSubscribeMessage();n||parseInt(s.own)?this.handleSendCommit():this.handleSubscribeMessage()}else this.getUserProfile()},showSeLvCom:function(t){console.log(t);var a=t.currentTarget.dataset.h5url;if(console.log(a),a)wx.navigateTo({url:"/pages/out/out?url=".concat(encodeURIComponent(a))});else{var e=this.data.comList[t.currentTarget.dataset.index];e.index=t.currentTarget.dataset.index,this.setData({faCom:e,ifshowSeLvCom:!0,textareaPlaceholder:"回复@"+e.nickName}),console.log("faCom:",this.data.comList,e),this.getSeLvComList(e.id),wx.reportEvent("news_com_details",{click:"被点击",news_name:this.data.newsDet.title,content:e.content})}},getSeLvComList:function(a,e){var o=this;wx.request({url:o.data.apiUrl+"/w/epro/comment/query",data:{commentType:1,typeId:a,orderType:"H",pageNo:o.data.sepageNo,pageSize:o.data.sepageSize,location:e},method:"POST",header:{wxToken:o.data.wxToken},success:function(a){if(200==a.data.code){var e;if(a.data.data.records)o.data.faCom.commentNum<1&&(o.data.faCom.firstChildName=a.data.data.records[0].nickName),console.log(o.data.faCom,a.data,"---commentNum----"),o.data.faCom.commentNum=a.data.data.total,a.data.data.records.forEach((function(t,a){t.ranking&&t.ranking.indexOf("空军地勤")>-1&&(t.ranking=t.ranking.replace("地勤","")),t.imgUrl&&t.imgUrl.indexOf("/upload/")>-1&&(t.imgUrl=o.data.apiUrl+t.imgUrl)})),(e=o.data.seComList).push.apply(e,t(a.data.data.records)),o.setData({seComList:o.data.seComList,faCom:o.data.faCom,comList:o.data.comList});o.data.isLoading&&setTimeout((function(){o.data.isLoading=!1,wx.hideLoading(),wx.showToast({title:"获取成功",icon:"success",duration:2e3})}),300)}else-10000301==a.data.code?wx.showToast({title:"登录过期，请重新登录",icon:"none",duration:2e3}):wx.showToast({title:a.data.msg,icon:"none",duration:2e3})}})},getCommentNumber:function(){var t=this;wx.request({url:t.data.apiUrl+"/w/epro/comment/getCommentNumber",data:{commentType:1,typeId:t.data.newsId},method:"POST",header:{wxToken:t.data.wxToken},success:function(a){200==a.data.code?t.setData({comNum:a.data.data}):wx.showToast({title:a.data.msg,icon:"none",duration:2e3})}})},deleteCom:function(t){var a=this,e=this,o=t.currentTarget.dataset.comid,i=t.currentTarget.dataset.index;wx.showModal({title:"提示",content:"确认要删除该条评论吗？",success:function(t){t.confirm&&wx.request({url:e.data.apiUrl+"/w/epro/comment/delete",data:{commentType:1,typeId:o,parentTypeId:e.data.faCom?e.data.faCom.id:e.data.newsId},method:"POST",header:{wxToken:e.data.wxToken},success:function(t){200==t.data.code?(wx.showToast({title:"删除成功",icon:"success",duration:2e3}),e.data.faCom?(e.data.seComList.splice(i,1),e.data.faCom.commentNum=e.data.faCom.commentNum-1,e.setData({seComList:e.data.seComList,comList:e.data.comList,faCom:e.data.faCom})):(e.data.comList.splice(i,1),e.data.comNum=e.data.comNum-1,e.handleStorage(a.data.comList[0]||{},a.data.comList.length?"add":"delete"),e.setData({comList:e.data.comList,comNum:e.data.comNum}))):-10000301==t.data.code?wx.showToast({title:"登录过期，请重新登录",icon:"none",duration:2e3}):wx.showToast({title:t.data.msg,icon:"none",duration:2e3})}})}})},getUserInfo:function(){var t=this;wx.request({url:this.data.apiUrl+"/w/epro/wechatuser/mine/userinfo",data:{wxToken:t.data.wxToken},success:function(a){200==a.data.code&&(t.setData({isCommentAdmin:1==a.data.data.commentAdmin}),a.data.data.avatarUrl=a.data.data.userAvatarUrl,a.data.data.nickName=a.data.data.wxName,t.setData({userInfo:a.data.data,hasUserInfo:!0}),a.data.data.idvId&&t.getPlayerStatis())}})},roleIdHave:function(t){var a=this;console.log("roleIdHave",this.data.userInfo),this.data.userInfo.idvId||(this.setData({disabled:!0}),wx.showToast({title:"请先完成角色绑定",icon:"none",duration:1500}),setTimeout((function(){a.handleBindUserDialog()}),2e3))},comfocus:function(t){this.data.userPlayerStatis&&this.data.userPlayerStatis.role_id&&this.setData({comInputPabot:t.detail.height,isfocus:!0})},comfos2:function(t){wx.showToast({title:"功能维护中",icon:"none",duration:1500})},comblur:function(t){},hidecom:function(){this.setData({comInputPabot:0,isfocus:!1,textareaPlaceholder:this.data.faCom?"回复@"+this.data.faCom.nickName:"我有话要说...",textareaHfName:""})},previewImage:function(t){var a=t.target.dataset.src;wx.previewImage({current:a,urls:[a]})},comkeyboardheightchange:function(t){this.setData({comInputPabot:t.detail.height})},comlinechange:function(t){this.setData({comInputlineNum:t.detail.lineCount})},upload_file:function(t,a){wx.request({url:a.data.apiUrl+"/w/epro/system/file/upload/init",header:{wxToken:a.data.wxToken},method:"GET",success:function(e){200===e.data.code&&function(t,a,e){return console.log("url:".concat(t," token:").concat(a," filePath:").concat(e)),new Promise((function(o,i){wx.uploadFile({url:t,filePath:e,name:"fpfile",formData:{Authorization:"".concat(a),json:!0},success:function(t){200===t.statusCode?o(JSON.parse(t.data)):i(new Error("文件上传失败"))},fail:function(t){console.log(t),i(new Error("文件上传失败"))}})}))}(e.data.data.uploadUrl,e.data.data.token,t).then((function(t){a.setData({comImg:t.url,nameImg:t.url}),wx.showToast({title:"文件上传成功",icon:"success",duration:3e3})})).catch((function(t){console.error("文件上传失败",t)}))}})},chooseImg:function(){var t=this;wx.chooseMedia({count:1,mediaType:["image"],sizeType:["original","compressed"],sourceType:["album","camera"],success:function(a){console.log(a.tempFiles[0].tempFilePath),t.upload_file(a.tempFiles[0].tempFilePath,t)},fail:function(t){},complete:function(t){}})},comImgDelete:function(t){this.setData({comImg:""})},handleSubscribeMessage:function(){var t,a=this;wx.getSetting({withSubscriptions:!0,success:function(e){"accept"===e.subscriptionsSetting.UGQ1EHBWQvhpVhw7W1BV1NoIlFRNBWK3GA63BXYcDDw&&"accept"===e.subscriptionsSetting["uSUdTsFhjTYh3IKeppO-T6kZ4hMfKgtkwNAqdhepdm0"]?console.log("1231231231231231232131"):(a.setData({messageTipGif:!0}),t=setInterval((function(){a.setData({messageTipGifUrl:"".concat(i.globalData.imgUrl,"/vsrecord/message_subscription-wechat.gif?time=").concat(Date.now())})}),5e3));var o="UGQ1EHBWQvhpVhw7W1BV1NoIlFRNBWK3GA63BXYcDDw",n="uSUdTsFhjTYh3IKeppO-T6kZ4hMfKgtkwNAqdhepdm0";wx.requestSubscribeMessage({tmplIds:[o,n],complete:function(e){a.handleSendCommit({isSubComment:"accept"===e[o],isSubLike:"accept"===e[n]}),t&&(a.setData({messageTipGif:!1}),clearInterval(t),t=null)}})},fail:function(t){function a(a){return t.apply(this,arguments)}return a.toString=function(){return t.toString()},a}((function(t){console.log(fail,"订阅失败")})),complete:function(){console.log("订阅fainally")}})},handleSendCommit:function(){var t=this,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},o=this;if(this.data.canSend)return!1;this.setData({canSend:!0}),wx.request({url:o.data.apiUrl+"/w/epro/comment/post",data:e({content:(""==o.data.textareaHfName?"":"@"+o.data.textareaHfName+" ")+o.data.comDes,commentType:1,typeId:o.data.faCom?o.data.faCom.id:o.data.newsId,headPicUrl:o.data.userInfo.avatarUrl,nickName:o.data.userInfo.nickName,imgUrl:o.data.comImg,articleId:o.data.newsId},a),method:"POST",header:{wxToken:o.data.wxToken},success:function(t){200==t.data.code?(wx.showToast({title:"发表成功",icon:"success",duration:2e3}),wx.reportEvent("news_com_send_success",{status:"发表成功",news_name:o.data.newsDet.title}),o.setData({comImg:"",comDes:""}),o.hidecom(),o.data.faCom?(o.data.sepageNo=1,o.data.seComList=[],o.getSeLvComList(o.data.faCom.id),o.data.comList[o.data.faCom.index].commentNum<1&&(o.data.comList[o.data.faCom.index].firstChildName=o.data.userInfo.nickName),o.data.faCom.commentNum=o.data.faCom.commentNum+1,o.setData({faCom:o.data.faCom,comList:o.data.comList,seTop:0})):(o.data.comList=[],o.setData({comBy:"T",pageNo:1}),o.getComList(),o.getCommentNumber()),o.data.taskId&&wx.request({url:o.data.apiUrl+"/w/mission/doTask",data:{taskId:o.data.taskId,activityId:i.globalData.activityId},header:{wxToken:o.data.wxToken},success:function(t){200==t.data.code?(o.data.taskId=null,wx.setStorage({key:"refreshTaskList",data:!0})):wx.showToast({title:t.data.msg,icon:"none",duration:3e3})}}),console.log(t.data.data.draw,t.data.data.first),t.data.data.draw&&t.data.data.first&&o.setData({drawId:t.data.data.drawId,showCommentPop:!0})):-1==t.data.code?(wx.showToast({title:t.data.msg,icon:"none",duration:2e3}),wx.reportEvent("news_com_send_msgfail",{status:"评论涉嫌违规",news_name:o.data.newsDet.title,content:o.data.comDes})):-10000301==t.data.code?wx.showToast({title:"登录过期，请重新登录",icon:"none",duration:2e3}):wx.showToast({title:t.data.msg,icon:"none",duration:2e3})},complete:function(){t.setData({canSend:!1})}})},seClose:function(){this.setData({ifshowSeLvCom:!1,seComList:[],faCom:null,sepageNo:1,textareaPlaceholder:"我有话要说..."})},seReget:function(){this.data.seComList=[],this.data.sepageNo=1,this.getSeLvComList(this.data.faCom.id),this.data.isLoading=!0,this.setData({seTop:0})},toFocus:function(t){this.setData({textareaFocus:!0})},seisBo:function(){this.data.sepageNo++,this.getSeLvComList(this.data.faCom.id)},getUserProfile:function(t){var a=this;wx.getUserProfile({desc:"用于完善用户资料",success:function(t){wx.setStorage({key:"userInfo",data:t.userInfo}),a.setData({userInfo:t.userInfo,hasUserInfo:!0}),wx.setStorage({key:"isReget",data:!0}),wx.request({url:a.data.apiUrl+"/w/epro/wechatuser/mine/info/update",data:{nickname:t.userInfo.nickName,avatar:t.userInfo.avatarUrl},method:"POST",header:{wxToken:a.data.wxToken,"Content-Type":"application/json"},success:function(t){}})}})},showImg:function(t){var a=t.currentTarget.dataset.index;this.data.seComList[a].imgshow=!0,this.setData({seComList:this.data.seComList})},onShareAppMessage:function(t){wx.request({url:this.data.apiUrl+"/w/epro/article/forWordNum",data:{id:this.data.newsId},header:{wxToken:this.data.wxToken}});var a="/pages/details/index?id="+this.data.newsId;return this.data.task&&(a=a+"&task="+this.data.task),console.log(a),{title:this.data.newsDet.title,imageUrl:this.data.newsDet.cover,path:a,success:function(t){},fail:function(){},complete:function(){}}},handlerGobackClick:function(t){getCurrentPages().length>=2?wx.navigateBack({delta:t}):wx.redirectTo({url:i.globalData.pageIndex})},handlerGohomeClick:function(){wx.redirectTo({url:i.globalData.pageIndex})},comVal:function(t){this.setData({comDes:t.detail.value})},comVal2:function(t){wx.showToast({title:"功能维护中",icon:"none",duration:1500})},changeSize:function(t){wx.setStorage({key:"detailTextSize",data:t.currentTarget.dataset.size}),"s"==t.currentTarget.dataset.size?this.data.tagStyle=this.data.tagStyle_s:"n"==t.currentTarget.dataset.size?this.data.tagStyle=this.data.tagStyle_n:"b"==t.currentTarget.dataset.size&&(this.data.tagStyle=this.data.tagStyle_b);var a=this.data.newsDet;this.setData({newsDet:[]}),this.setData({textSize:t.currentTarget.dataset.size,tagStyle:this.data.tagStyle,newsDet:a})},closeCommentPop:function(){this.setData({showCommentPop:!1})},goDraw:function(){if(!this.data.drawId)return!1;this.closeCommentPop(),wx.navigateTo({url:"/pages_user/pages/draw/details?id="+this.data.drawId})},onReachBottom:function(){if(this.data.dontgetCom)return!1;this.data.pageNo++,this.getComList()}});
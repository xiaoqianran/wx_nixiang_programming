var t=getApp();Page({data:{imgUrl:t.globalData.imgUrl,apiUrl:t.globalData.apiUrl,wxToken:t.globalData.wxToken,currentDate:"",dayList:"",currentDayList:"",currentObj:"",currentDay:"",currentMonth:"",currentYear:"",currentClickKey:"",nowDay:"",nowMonth:"",nowYear:"",nowDate:"",nowZd:"",monthChange:!1,selectIndex:-1,selectList:[{id:0,name:"赛事筛选"},{id:1,name:"赛事战队"},{id:2,name:"赛事时间"}],popSelectShow:!1,allVsData:[],allZdData:[],nowPage:1,canGetNextPage:!0,competitionID:"",zdChIndex:null,zdChName:"",allComData:"",comChIndex:0,comChName:"",nowCom:"",thisComId:"",firstLoad:!0,already:!1},onLoad:function(e){var a=this;this.setData({wxToken:t.globalData.wxToken}),this.data.wxToken?this.getData():t.initOkCallback=function(e){a.setData({wxToken:t.globalData.wxToken}),a.getData()};var n=this.getCurrentDayString(),o=n.getFullYear(),r=n.getMonth()+1;this.setData({currentDate:o+"年"+r+"月",currentDateEx:o+"-"+r,currentDay:n.getDate(),currentMonth:r,currentYear:o,currentObj:n,nowMonth:r,nowYear:o}),this.setSchedule(n)},getData:function(){this.getAllCom()},getAllVs:function(){var t=this;wx.request({url:this.data.apiUrl+"/w/spider/idvschedule/getscheduledatabycondition",data:{wxToken:t.data.wxToken,competitionID:t.data.competitionID,pageNo:t.data.nowPage,pageSize:10,date:t.data.nowDate,teamID:t.data.nowZd},success:function(e){var a=e.data.data.items,n=[],o=(new Date).getTime();a.forEach((function(t,e){var a={};t.scheduleDatetime=t.scheduleDatetime.replace(/-/g,"/"),a.zbTime=new Date(t.scheduleDatetime).getHours(),a.zbDate=t.scheduleDatetime.split(" ")[0],a.teamAID=t.teamAID,a.teamALogoUrl=t.teamALogoUrl,a.teamANameEng=t.teamANameEng,a.teamBID=t.teamBID,a.teamBLogoUrl=t.teamBLogoUrl,a.teamBNameEng=t.teamBNameEng,a.competitionName=t.competitionName,a.competitionStageName=t.competitionStageName,a.loseTeamID=t.loseTeamID,o<new Date(t.scheduleDatetime).getTime()?a.state="未开始":o>new Date(t.scheduleDatetime).getTime()&&o-new Date(t.scheduleDatetime).getTime()<72e5?a.state="进行中":a.state="已结束",n[e]=a}));var r=t.data.allVsData;r.push.apply(r,n),t.setData({allVsData:r,canGetNextPage:!0,firstLoad:!1,already:!0})}})},getAllZd:function(){var t=this;wx.request({url:this.data.apiUrl+"/w/epro/team/event/"+this.data.competitionID,data:{wxToken:t.data.wxToken},success:function(e){console.log("NowZd:",e);var a=e.data.data;t.setData({allZdData:a})}})},getAllCom:function(){var t=this;wx.request({url:this.data.apiUrl+"/w/spider/idvschedule/getschedulecategory",data:{wxToken:t.data.wxToken},success:function(e){console.log("getAllCom:",e.data.data),t.setData({allComData:e.data.data,thisComId:e.data.data[0].eventNameEn,competitionID:e.data.data[0].wyId}),t.getAllVs(),t.getAllZd()}})},selectByTimeOrZd:function(){var t="";t=""==this.data.nowDay?"":this.data.currentDateEx+"-"+this.data.nowDay,this.setData({nowDate:t,nowPage:1,allVsData:[],nowZd:this.data.zdChName,nowCom:this.data.comChName,already:!1}),this.hidePop(),this.getAllVs()},chZdTap:function(t){this.data.zdChName==t.currentTarget.dataset.name?this.setData({zdChIndex:null,zdChName:""}):this.setData({zdChIndex:t.currentTarget.dataset.index,zdChName:t.currentTarget.dataset.name})},chComTap:function(t){this.setData({comChIndex:t.currentTarget.dataset.index,comChName:t.currentTarget.dataset.name,thisComId:t.currentTarget.dataset.url,competitionID:t.currentTarget.dataset.name}),this.getAllZd()},doDay:function(t){var e=this.data.currentObj,a=e.getFullYear(),n=e.getMonth()+1,o=(e.getDate(),"");o="left"==t.currentTarget.dataset.key?(n-=1)<=0?a-1+"/12/1":a+"/"+n+"/1":(n+=1)<=12?a+"/"+n+"/1":a+1+"/1/1",e=new Date(o),this.setData({currentDate:e.getFullYear()+"年"+(e.getMonth()+1)+"月",currentDateEx:e.getFullYear()+"-"+(e.getMonth()+1),currentObj:e,nowMonth:n,nowYear:a,monthChange:!0,nowDay:1}),this.setSchedule(e)},getCurrentDayString:function(){var t=this.data.currentObj;if(""!=t)return t;var e=new Date,a=e.getFullYear()+"/"+(e.getMonth()+1)+"/"+e.getDate();return new Date(a)},setSchedule:function(t){for(var e=t.getMonth()+1,a=t.getFullYear(),n=t.getDate(),o=(t.getDate(),new Date(a,e,0).getDate()),r=t.getUTCDay()+1-(n%7-1),i=r<=0?7+r:r,s=[],c=0,d=0;d<42;d++){d<i-1?s[d]="":c<o?(s[d]=c+1,c=s[d],1==s[d]&&this.data.monthChange&&this.setData({currentClickKey:d.toString(),monthChange:!1})):c>=o&&(s[d]="")}this.setData({currentDayList:s})},onClickItem:function(t){var e=this.data.currentDateEx+"-"+this.data.currentDayList[t.currentTarget.id];this.data.currentDateEx+"-"+this.data.nowDay===e?this.setData({currentClickKey:"",nowDay:""}):this.setData({currentClickKey:t.currentTarget.id,nowDay:this.data.currentDayList[t.currentTarget.id]})},chSelect:function(t){this.setData({selectIndex:t.currentTarget.dataset.index,popSelectShow:!0})},hidePop:function(t){this.setData({popSelectShow:!1,selectIndex:-1})},onReady:function(){},onShow:function(){},handlerGobackClick:function(e){getCurrentPages().length>=2?wx.navigateBack({delta:e}):wx.redirectTo({url:t.globalData.pageIndex})},handlerGohomeClick:function(){wx.redirectTo({url:t.globalData.pageIndex})},onHide:function(){},onUnload:function(){},onPullDownRefresh:function(){},goVideoList:function(t){var e=t.currentTarget.dataset.name;wx.navigateTo({url:"/pages/saishi/video/video?comId="+e})},onReachBottom:function(){if(this.data.canGetNextPage){var t=this.data.nowPage+1;this.setData({nowPage:t,canGetNextPage:!1}),this.getAllVs()}},onShareAppMessage:function(){}});
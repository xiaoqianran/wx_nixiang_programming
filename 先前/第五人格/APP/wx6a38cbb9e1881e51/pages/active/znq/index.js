var a=getApp();Page({data:{imgUrl:a.globalData.imgUrl,apiUrl:a.globalData.apiUrl,wxToken:a.globalData.wxToken,_canvasw:0,_canvasH:0,showCanvas:!1,caHeadImg:[],caImg:[{url:"https://nie.res.netease.com/id5/m/zt/20201215094138/data/vsrecord/bg.jpg",w:750,h:586,t:0,l:0}],caText:[{text:"",size:32,color:"#f9ece1",align:"left",l:172,t:62}],caReadyImg:[],promiseList:[],isjoin:!1,drawChance:0,gameId:null,bindPopShow:!1,taskList:[],canGetVs:!0,showAddfri:!1,showSharePic:!1,prdet:null,prShow:!1,prlist:[],prlistShow:!1,nowCh:null,canDraw:!0,nickname:null,usnickname:null,canGetPrlist:!0,userInfo:null,glShow:!1,userPhone:null,haveWorkTodo:null,haveWorkTodoTaskId:"",tipsShow:!1,bindUserVisible:!1},onLoad:function(t){var e=this;e.setData({wxToken:a.globalData.wxToken}),e.data.wxToken?e.getData():a.initOkCallback=function(t){e.setData({wxToken:a.globalData.wxToken}),e.getData()},wx.getStorage({key:"znqTips",success:function(a){},fail:function(a){e.setData({tipsShow:!0}),wx.setStorage({key:"znqTips",data:!0})}})},getData:function(){this.getGameUserInfo(),this.getLbShow()},ifJoin:function(){var t=this,e=wx.getStorageSync("whetherPartActivity");if(e&&e.envVersion==a.globalData.envVersion)return n(e.sj),!1;function n(a){a.data.data;200==a.data.code?(t.setData({isjoin:a.data.data.result}),t.getTaskList(),a.data.data.result&&t.getDrawChance()):900==a.data.code||901==a.data.code?t.getTaskList():wx.showToast({title:a.data.msg,icon:"none",duration:2e3})}wx.request({url:t.data.apiUrl+"/w/mission/whetherPartActivity",data:{activityId:a.globalData.activityId},header:{wxToken:t.data.wxToken},success:function(a){n(a)}})},chBind:function(a){},handleBind:function(a){this.setData({bindUserVisible:!this.data.bindUserVisible}),""==this.data.gameId?wx.reportEvent("znq_btn_bind",{}):wx.reportEvent("znq_btn_bindchange",{})},handleShoppingMall:function(a){0==a.currentTarget.dataset.type?wx.reportEvent("znq_jump_dh",{}):wx.reportEvent("znq_jump_dh2",{}),this.data.userInfo||""==this.data.userInfo?this.data.gameId&&""!=this.data.gameId?wx.navigateTo({url:"/pages_user/pages/saishi/dh/index"}):this.setData({bindUserVisible:!this.data.bindUserVisible}):this.getUserProfile()},goDh:function(a){},priceDraw:function(){var t=this;if(t.isBindAndJoin())if(t.data.userInfo)if(t.data.drawChance>0){if(!t.data.canDraw)return;t.data.canDraw=!1,wx.reportEvent("znq_draw",{}),wx.request({url:t.data.apiUrl+"/w/lottery/draw/drawPrize",data:{activityId:a.globalData.activityId},method:"POST",header:{wxToken:t.data.wxToken},success:function(e){if(200==e.data.code){var n=e.data.data;if(n.prizeName.indexOf("银币")<0){var i={wxName:t.data.nickname,prizeName:n.prizeName};t.data.lbList.unshift(i)}if(t.setData({prdet:n,drawChance:t.data.drawChance-1}),"296912a057974fcc80ca2792e5e956d8"==n.id)t.zqq(4);else if("40ae672ab34e4ebcb06ac81f53075569"==n.id)t.zqq(5);else if("42dc46e353a148ada75938cc092eb76e"==n.id){0==a.randomNum(0,1)?t.zqq(7):t.zqq(9)}else if("5f6f16f77562465db130922cec7aa83e"==n.id)t.zqq(1);else if("70033d70dc3c4f7dbe2a4ae3623be8b9"==n.id)t.zqq(10);else if("77e1cc6f7dac44afbd75061dd75b3ee8"==n.id)t.zqq(3);else if("9b553f334aec4615a54cb3af2e38568b"==n.id){var o=a.randomNum(0,2);0==o?t.zqq(0):1==o?t.zqq(2):t.zqq(6)}else"ff3df2f43b374db385466854153af219"==n.id?t.zqq(8):n.id&&(t.setData({prShow:!0,lbList:t.data.lbList}),t.data.canDraw=!0)}else t.data.canDraw=!0,wx.showToast({title:e.data.msg,icon:"none",duration:2e3})}})}else wx.showToast({title:"暂时没有抽奖券哦，快去做任务获取更多抽奖券吧~",icon:"none",duration:2e3});else t.getUserProfile();else t.bindAndJoin()},zqq:function(a){var t=this,e=!1,n=100,i=setInterval((function o(){t.data.nowCh>10||null==t.data.nowCh?t.data.nowCh=0:t.data.nowCh++;e&&(a==t.data.nowCh||n>100)&&(n>=820?(clearInterval(i),setTimeout((function(){t.setData({prShow:!0,lbList:t.data.lbList}),t.data.canDraw=!0}),500)):(clearInterval(i),i=setInterval(o,n),n+=60));t.setData({nowCh:t.data.nowCh})}),n);setTimeout((function(){e=!0}),2e3)},getTaskList:function(){var t=this;wx.request({url:t.data.apiUrl+"/w/mission/taskList",data:{activityId:a.globalData.activityId},header:{wxToken:t.data.wxToken},success:function(a){a.data.data;200==a.data.code?(t.setData({taskList:a.data.data}),null!=t.data.haveWorkTodo&&t.doWork()):wx.showToast({title:a.data.msg,icon:"none",duration:2e3})}})},getDrawChance:function(){var t=this;wx.request({url:t.data.apiUrl+"/w/mission/getDrawTime",data:{activityId:a.globalData.activityId},header:{wxToken:t.data.wxToken},success:function(a){200==a.data.code?t.setData({drawChance:a.data.data.num}):wx.showToast({title:a.data.msg,icon:"none",duration:2e3})}})},getGameUserInfo:function(){var a=this;wx.request({url:a.data.apiUrl+"/w/epro/wechatuser/mine/userinfo",data:{wxToken:a.data.wxToken},header:{wxToken:a.data.wxToken},success:function(t){var e=t.data.data,n={};if("该账号暂未绑定游戏角色！"==t.data.msg||null==t.data.data.idvId)a.setData({gameId:""}),a.getTaskList();else if(200==t.data.code){if(t.data.data.wxName){var i=t.data.data.wxName,o=i.length;a.isEmojiCharacter(i)||(o>4?i=i.replace(i.substring(o-3),"***"):o>1&&(i=i.replace(i.substring(o-1),"*"))),a.setData({nickname:i})}null!=e.userAvatarUrl||null!=e.wxName?(n.avatarUrl=e.userAvatarUrl,n.nickName=e.wxName,a.setData({userInfo:n})):a.setData({userInfo:null}),a.setData({gameId:t.data.data.idvId,usnickname:t.data.data.nickname}),a.ifJoin()}else wx.showToast({title:t.data.msg,icon:"none",duration:2e3});e.phone&&""!=e.phone&&a.setData({userPhone:!0})}})},doWork:function(t){var e=this,n=t?t.currentTarget.dataset.index:null,i=t?t.currentTarget.dataset.task:null;if(!e.isBindAndJoin())return e.data.haveWorkTodo=n,e.data.haveWorkTodoTaskId=i,e.bindAndJoin(),!1;switch(null!=e.data.haveWorkTodo&&(n=e.data.haveWorkTodo,i=e.data.haveWorkTodoTaskId,e.data.haveWorkTodo=null,e.data.canGetVs=!0),n){case 0:wx.reportEvent("znq_task_1",{}),wx.request({url:e.data.apiUrl+"/w/mission/doTask",data:{taskId:i,activityId:a.globalData.activityId},header:{wxToken:e.data.wxToken},success:function(a){200==a.data.code?(wx.showToast({title:"签到成功，抽奖券+1",icon:"none",duration:2e3}),e.getTaskList(),e.getDrawChance()):wx.showToast({title:a.data.msg,icon:"none",duration:3e3})}});break;case 1:wx.reportEvent("znq_task_2",{}),e.data.canGetVs&&(e.data.canGetVs=!1,wx.request({url:e.data.apiUrl+"/w/mission/selectDataPlay",data:{taskId:i,activityId:a.globalData.activityId},header:{wxToken:e.data.wxToken},success:function(a){200==a.data.code?(a.data.data.flag?a.data.data.flag&&(wx.showToast({title:"任务完成，抽奖券+1",icon:"none",duration:2e3}),e.getTaskList(),e.getDrawChance()):wx.showToast({title:"今天尚未进行对局，快打开游戏玩一把吧～",icon:"none",duration:2e3}),setTimeout((function(){e.data.canGetVs=!0}),1e3)):(wx.showToast({title:a.data.msg,icon:"none",duration:2e3}),setTimeout((function(){e.data.canGetVs=!0}),1e3))}}));break;case 2:wx.reportEvent("znq_task_3",{}),e.data.canGetVs&&(e.data.canGetVs=!1,wx.request({url:e.data.apiUrl+"/w/weChatEnterprise/enterpriseContact",data:{taskId:i,activityId:a.globalData.activityId},header:{wxToken:e.data.wxToken},success:function(a){200==a.data.code?(a.data.data.flag?a.data.data.flag&&(wx.showToast({title:"任务完成，抽奖券+2",icon:"none",duration:2e3}),e.getTaskList(),e.getDrawChance()):e.setData({showAddfri:!0}),setTimeout((function(){e.data.canGetVs=!0}),1e3)):(wx.showToast({title:a.data.msg,icon:"none",duration:2e3}),setTimeout((function(){e.data.canGetVs=!0}),1e3))}}));break;case 3:wx.reportEvent("znq_task_4",{}),wx.navigateTo({url:"/pages/vsrecord/index?task="+i});break;case 4:wx.reportEvent("znq_task_5",{}),wx.navigateTo({url:"/pages_user/pages/user/collect?task="+i});break;case 5:wx.reportEvent("znq_task_6",{}),wx.navigateTo({url:"/pages/details/index?id="+a.globalData.activeNewsId+"&task="+i});break;case 6:wx.reportEvent("znq_task_7",{}),e.setData({showSharePic:!0}),wx.showToast({title:"长按图片分享给好友吧~",icon:"none",duration:3e3})}},bindAndJoin:function(){var t=this;t.data.gameId&&""!=t.data.gameId?t.data.isjoin||(wx.reportEvent("znq_pop_change",{}),wx.showModal({title:"提示",content:"你当前参与活动绑定的游戏账号是"+t.data.gameId+"，确定用此游戏账号继续参与？（注：同个微信和同个游戏账号只能参与一次哦）",success:function(e){e.confirm?(wx.reportEvent("znq_pop_change_ex",{status:"是"}),wx.request({url:t.data.apiUrl+"/w/mission/insertActivity",data:{activityId:a.globalData.activityId},header:{wxToken:t.data.wxToken},success:function(a){200==a.data.code?t.ifJoin():(wx.showToast({title:a.data.msg,icon:"none",duration:2e3}),t.data.haveWorkTodo=null)}})):wx.reportEvent("znq_pop_change_ex",{status:"否"})}})):(t.data.bindAndJoin=null,t.setData({bindUserVisible:!0}))},isBindAndJoin:function(){return""!=this.data.gameId&&this.data.isjoin},hidePrbox:function(){this.setData({prShow:!1})},hidePrlistbox:function(){this.setData({prlistShow:!1})},getPrlist:function(t){var e=this;if(!e.data.canGetPrlist)return!1;function n(a){return a<10?"0"+a:a}e.data.canGetPrlist=!1,wx.reportEvent("znq_myprecious",{}),wx.request({url:e.data.apiUrl+"/w/lottery/person/my",data:{activityId:a.globalData.activityId},header:{wxToken:e.data.wxToken},success:function(a){200==a.data.code?""==a.data.data?wx.showToast({title:"暂无奖品",icon:"none",duration:2e3}):(a.data.data.forEach((function(a,t){var e,i,o,s,r;a.winTime=(e=a.winTime,i=new Date(e),o=i.getFullYear(),s=i.getMonth()+1,r=i.getDate(),o+"-"+n(s)+"-"+n(r))})),e.setData({prlist:a.data.data}),"pop"==t&&e.setData({prlistShow:!0})):wx.showToast({title:a.data.msg,icon:"none",duration:2e3}),e.data.canGetPrlist=!0}})},handlerGobackClick:function(t){getCurrentPages().length>=2?wx.navigateBack({delta:t}):wx.redirectTo({url:a.globalData.pageIndex})},handlerGohomeClick:function(){wx.redirectTo({url:a.globalData.pageIndex})},inputAdd:function(a){wx.reportEvent("znq_addinput",{}),wx.navigateTo({url:"/pages/active/znq/addinput?type="+a.currentTarget.dataset.type+"&id="+a.currentTarget.dataset.id})},finishAddfri:function(){wx.reportEvent("znq_qywx_longpress",{})},finishShareTask:function(){var t=this;wx.reportEvent("znq_sharepic_longpress",{}),wx.request({url:t.data.apiUrl+"/w/mission/doTask",data:{taskId:t.data.taskList[6].id,activityId:a.globalData.activityId},header:{wxToken:t.data.wxToken},success:function(a){200==a.data.code?(t.getTaskList(),t.getDrawChance()):wx.showToast({title:a.data.msg,icon:"none",duration:3e3})}})},getPhoneNumber:function(a){var t=this;"getPhoneNumber:fail user deny"!=a.detail.errMsg?wx.request({url:t.data.apiUrl+"/w/epro/wechatuser/mine/bindPhone",data:{code:a.detail.code?a.detail.code:"",encryptedData:a.detail.encryptedData?a.detail.encryptedData:"",iv:a.detail.iv?a.detail.iv:""},method:"POST",header:{wxToken:t.data.wxToken},success:function(a){200==a.data.code?(t.data.userPhone=!0,t.setData({userPhone:t.data.userPhone}),wx.reportEvent("phone_number_success",{})):t.setData({userPhone:!0})}}):wx.reportEvent("phone_number_show",{})},bindCol:function(a){this.setData({gameId:a.detail.gameId}),this.getData()},hideAddfri:function(){var t=this;wx.request({url:t.data.apiUrl+"/w/weChatEnterprise/enterpriseContact",data:{taskId:t.data.taskList[2].id,activityId:a.globalData.activityId},header:{wxToken:t.data.wxToken},success:function(a){200==a.data.code?a.data.data.flag&&a.data.data.flag&&(wx.showToast({title:"任务完成，抽奖券+2",icon:"none",duration:2e3}),t.getTaskList(),t.getDrawChance()):wx.showToast({title:a.data.msg,icon:"none",duration:2e3})}}),this.setData({showAddfri:!1})},hideSharePic:function(){this.setData({showSharePic:!1})},getLbShow:function(){var t=this;wx.request({url:t.data.apiUrl+"/w/lottery/person/carousel?activityId="+a.globalData.activityId,data:{},header:{wxToken:t.data.wxToken},success:function(a){200==a.data.code?t.setData({lbList:a.data.data}):wx.showToast({title:a.data.msg,icon:"none",duration:2e3})}})},showPrlist:function(){this.getPrlist("pop")},onShow:function(){var a=this;wx.getStorage({key:"refreshTaskList",success:function(t){a.getTaskList(),a.getDrawChance(),wx.removeStorage({key:"refreshTaskList",success:function(a){}})}}),wx.getStorage({key:"refreshPrList",success:function(t){a.data.prShow?a.setData({prShow:!1}):a.getPrlist(),wx.removeStorage({key:"refreshPrList",success:function(a){}})}})},getUserProfile:function(a){var t=this;wx.getUserProfile({desc:"用于完善用户资料",success:function(a){wx.setStorage({key:"userInfo",data:a.userInfo});var e=a.userInfo.nickName,n=e.length;t.isEmojiCharacter(e)||(n>4?e=e.replace(e.substring(n-3),"***"):n>1&&(e=e.replace(e.substring(n-1),"*"))),t.setData({nickname:e,userInfo:a.userInfo,hasUserInfo:!0}),wx.request({url:t.data.apiUrl+"/w/epro/wechatuser/mine/info/update",data:{nickname:a.userInfo.nickName,avatar:a.userInfo.avatarUrl},method:"POST",header:{wxToken:t.data.wxToken,"Content-Type":"application/json"},success:function(a){}})}})},isEmojiCharacter:function(a){for(var t=0;t<a.length;t++){var e=a.charCodeAt(t);if(55296<=e&&e<=56319){if(a.length>1){var n=1024*(e-55296)+(a.charCodeAt(t+1)-56320)+65536;if(118784<=n&&n<=128895)return!0}}else if(a.length>1){if(8419==a.charCodeAt(t+1))return!0}else{if(8448<=e&&e<=10239)return!0;if(11013<=e&&e<=11015)return!0;if(10548<=e&&e<=10549)return!0;if(12951<=e&&e<=12953)return!0;if(169==e||174==e||12349==e||12336==e||11093==e||11036==e||11035==e||11088==e)return!0}}},hideGlbox:function(){this.setData({glShow:!1})},showGlbox:function(){this.setData({glShow:!0})},catchTouchMove:function(){return!1},hideTips:function(){this.setData({tipsShow:!1})},onHide:function(){},onUnload:function(){},onPullDownRefresh:function(){},onReachBottom:function(){}});
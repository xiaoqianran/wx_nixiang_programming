var e=getApp();Page({data:{imgUrl:e.globalData.imgUrl,apiUrl:e.globalData.apiUrl,wxToken:e.globalData.wxToken,hdList:[],prListNo:1,prListReget:!0,videoHidden:!0,videoSrc:null,newsList:[],pageNo:1,pageSize:10,isbind:!1,bindPopShow:!1,hdData:{},userInfo:null,bindUserVisible:!1},onLoad:function(){var a=this;this.setData({wxToken:e.globalData.wxToken}),this.data.wxToken?this.getData():e.initOkCallback=function(t){a.setData({wxToken:e.globalData.wxToken}),a.getData()},wx.reportEvent("active_pvuv",{})},getData:function(){this.getHd(),this.getNews(),this.getGameId()},getNews:function(){var e=this;wx.request({url:this.data.apiUrl+"/w/epro/article/catalog_page",data:{wxToken:e.data.wxToken,pageNo:e.data.pageNo,pageSize:e.data.pageSize,catalogId:"576381befe5c40d282afb1d0d58b0edf"},success:function(a){var t,i=[];a.data.data.items.forEach((function(e,a){var t=e.createTime.split(" ")[0].split("-");i[a]=e,i[a].showDate=t[1]+"-"+t[2]})),(t=e.data.newsList).push.apply(t,i),e.setData({newsList:e.data.newsList})}})},getHd:function(){var e=(new Date).getTime(),a=new Date("2022/08/16 14:30:00"),t=new Date("2022/09/02 23:59:59");e>=a.getTime()&&e<=t.getTime()?this.data.hdData.lasePeriodType="now":e<=a.getTime()?this.data.hdData.lasePeriodType="fet":e>=t.getTime()&&(this.data.hdData.lasePeriodType="yet");var i=a.getTime()-e,s=t.getTime()-e;if(i>0){var r=parseInt(i/1e3/60/60/24),n=parseInt(i/1e3/60/60)-24*r,o=parseInt(i/1e3/60)-60*n-24*r*60;this.data.hdData.dateDes=r<1&&n<1&&o<60?"距离活动开始还有"+(o+1)+"分钟":"距离活动开始还有"+r+"天"+n+"小时"}else if(s>0){var d=parseInt(s/1e3/60/60/24),l=parseInt(s/1e3/60/60)-24*d;this.data.hdData.dateDes="距离活动截止还有"+d+"天"+l+"小时"}else this.data.hdData.dateDes="活动已结束";this.setData({hdData:this.data.hdData})},getHdList:function(){var e=this,a=(new Date).getTime();if(!e.data.prListReget)return!1;wx.request({url:this.data.apiUrl+"/w/epro/idvPointsRace/list",data:{pageNo:e.data.prListNo,pageSize:20,wxToken:e.data.wxToken},header:{wxToken:e.data.wxToken},success:function(t){var i=t.data.data;i.forEach((function(e,t){var i=new Date(e.entryPeriodFrom.replace(/-/g,"/")),s=new Date(e.entryPeriodTo.replace(/-/g,"/")),r=new Date(e.lasePeriodFrom.replace(/-/g,"/")),n=new Date(e.lastPeriodTo.replace(/-/g,"/"));e.entryPeriodFrom=e.entryPeriodFrom.split("-")[1]+"-"+e.entryPeriodFrom.split("-")[2].substring(0,8),e.entryPeriodTo=e.entryPeriodTo.split("-")[1]+"-"+e.entryPeriodTo.split("-")[2].substring(0,8),e.lasePeriodFrom=e.lasePeriodFrom.split("-")[1]+"-"+e.lasePeriodFrom.split("-")[2].substring(0,8),e.lastPeriodTo=e.lastPeriodTo.split("-")[1]+"-"+e.lastPeriodTo.split("-")[2].substring(0,8),a>=i.getTime()&&a<=s.getTime()?e.entryPeriodType="now":a<=i.getTime()?e.entryPeriodType="fet":a>=s.getTime()&&(e.entryPeriodType="yet"),a>=r.getTime()&&a<=n.getTime()?e.lasePeriodType="now":a<=r.getTime()?e.lasePeriodType="fet":a>=n.getTime()&&(e.lasePeriodType="yet");var o=i.getTime()-a,d=s.getTime()-a,l=r.getTime()-a,g=n.getTime()-a;if(o>0){var p=parseInt(o/1e3/60/60/24),u=parseInt(o/1e3/60/60)-24*p;e.dateDes="距离报名开始还有"+p+"天"+u+"小时"}else if(d>0){var h=parseInt(d/1e3/60/60/24),c=parseInt(d/1e3/60/60)-24*h;e.dateDes="距离报名截止还有"+h+"天"+c+"小时"}else if(l>0){var w=parseInt(l/1e3/60/60/24),T=parseInt(l/1e3/60/60)-24*w;e.dateDes="距离活动开始还有"+w+"天"+T+"小时"}else if(g>0){var f=parseInt(g/1e3/60/60/24),D=parseInt(g/1e3/60/60)-24*f;e.dateDes="距离活动截止还有"+f+"天"+D+"小时"}else e.dateDes="活动已结束"})),e.setData({hdList:i})}})},hdDetails:function(e){wx.reportEvent("active_index_banner",{}),wx.navigateTo({url:"/pages_user/pages/panda/panda"})},goDh:function(){this.data.userInfo?this.data.isbind?wx.navigateTo({url:"/pages_user/pages/saishi/dh/index"}):this.handleBind():this.getUserProfile()},goMyList:function(){if(!this.data.isbind)return this.handleBind(),!1;wx.navigateTo({url:"/pages_user/pages/draw/list"})},goDraw:function(){wx.reportEvent("draw_btn_enter",{}),wx.navigateTo({url:"/pages_user/pages/draw/list"})},handleBind:function(e){e&&"true"===e.detail?this.setData({bindUserVisible:!1}):this.setData({bindUserVisible:!this.data.bindUserVisible})},bindCol:function(e){this.setData({gameId:e.detail.gameId,isbind:!0})},search:function(){wx.navigateTo({url:"/pages/index/query?key="+this.data.queryKey})},getGameId:function(){var e=this;wx.request({url:this.data.apiUrl+"/w/epro/wechatuser/mine/userinfo",data:{wxToken:e.data.wxToken},success:function(a){var t=a.data.data,i={};null!=t.userAvatarUrl||null!=t.wxName?(i.avatarUrl=t.userAvatarUrl,i.nickName=t.wxName,e.setData({userInfo:i})):e.setData({userInfo:null}),"该账号暂未绑定游戏角色！"==a.data.msg||null==t.idvId?e.setData({isbind:!1}):e.setData({isbind:!0,gameId:a.data.data.idvId})}})},getUserProfile:function(e){var a=this;wx.reportEvent("collect_wxlogin",{}),wx.getUserProfile({desc:"用于完善用户资料",success:function(e){wx.setStorage({key:"userInfo",data:e.userInfo}),a.setData({userInfo:e.userInfo,hasUserInfo:!0}),wx.request({url:a.data.apiUrl+"/w/epro/wechatuser/mine/info/update",data:{nickname:e.userInfo.nickName,avatar:e.userInfo.avatarUrl},method:"POST",header:{wxToken:a.data.wxToken,"Content-Type":"application/json"},success:function(e){}})}})},handlerGobackClick:function(a){getCurrentPages().length>=2?wx.navigateBack({delta:a}):wx.redirectTo({url:e.globalData.pageIndex})},handlerGohomeClick:function(){wx.redirectTo({url:e.globalData.pageIndex})},onShow:function(){},onReachBottom:function(){this.data.pageNo++,this.getNews()}});
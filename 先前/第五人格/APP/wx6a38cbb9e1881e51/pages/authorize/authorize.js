var e=require("../../@babel/runtime/helpers/regeneratorRuntime"),t=require("../../@babel/runtime/helpers/asyncToGenerator"),n=getApp();Page({data:{wxToken:n.globalData.wxToken,imgUrl:n.globalData.imgUrl,apiUrl:n.globalData.apiUrl,userInfo:null,userPhone:!1,dsToken:"",actId:"",type:"",activityUrl:"https://crm.u1.netease.com/",shareConfig:{title:"",imgUrl:"",path:""},fandou:!1},onLoad:function(e){var t,a,o=this;wx.showLoading({title:"加载中"}),e.token&&wx.setStorageSync("h5_sjzp_token",e.token),this.data.actId=null!==(t=null==e?void 0:e.actId)&&void 0!==t?t:"",this.data.type=null!==(a=null==e?void 0:e.type)&&void 0!==a?a:"",this.buried(2),this.data.wxToken=n.globalData.wxToken,this.data.wxToken?this.getdata():n.initOkCallback=function(e){o.setData({wxToken:e}),o.getdata(),n.initOkCallback=null}},loginAgain:function(){var a=this;return t(e().mark((function t(){return e().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return wx.showLoading({title:"正在重新登录"}),e.next=3,n.getLogin();case 3:n.initOkCallback=function(e){a.setData({wxToken:e}),a.getdata(),n.initOkCallback=null};case 4:case"end":return e.stop()}}),t)})))()},onReady:function(){},onShow:function(){},handlerGobackClick:function(e){getCurrentPages().length>=2?wx.navigateBack({delta:e}):wx.redirectTo({url:n.globalData.pageIndex})},getdata:function(){var e=this,t=n.globalData.userInfo;t?(this.setData({userInfo:t}),t.phone&&""!=t.phone&&this.setData({userPhone:!0}),setTimeout((function(){wx.hideLoading()}),500)):n.initUserOver=function(t){e.setData({userInfo:t}),t.phone&&""!=t.phone&&e.setData({userPhone:!0}),setTimeout((function(){wx.hideLoading()}),500)}},compareVersion:function(e,t){e=e.split("."),t=t.split(".");for(var n=Math.max(e.length,t.length);e.length<n;)e.push("0");for(;t.length<n;)t.push("0");for(var a=0;a<n;a++){var o=parseInt(e[a]),i=parseInt(t[a]);if(o>i)return!0;if(o<i)return!1}return 0},getPhoneNumber:function(e){var t=this,a=t.compareVersion(n.globalData.sys.SDKVersion,"2.21.2");if("getPhoneNumber:ok"==e.detail.errMsg){if(t.buried(3),!e.detail.code&&!e.detail.encryptedData&&!e.detail.iv)return void wx.showToast({title:"授权手机号失败请重新授权",icon:"none",duration:1500});if(!(a||e.detail.encryptedData&&e.detail.iv))return void wx.showToast({title:"微信版本过低，请先升级微信版本",icon:"none",duration:5e3});wx.request({url:t.data.apiUrl+"/w/epro/wechatuser/mine/bindPhone",data:{code:e.detail.code?e.detail.code:"",encryptedData:e.detail.encryptedData?e.detail.encryptedData:"",iv:e.detail.iv?e.detail.iv:""},header:{wxToken:t.data.wxToken},method:"POST",dataType:"json",responseType:"text",success:function(e){-10000301==e.data.code?t.loginAgain():n.reGetUserInfo((function(e){t.setData({userInfo:e}),e.phone&&(t.setData({userPhone:!0}),t.goTransfer())}))},fail:function(){},complete:function(){}})}else t.skipLink()},goTransfer:function(){var e=this;e.data.fandou||(e.data.fandou=!0,e.buried(3),wx.request({url:e.data.apiUrl+"/w/epro/wechatuser/mine/encodePhone",data:{phone:e.data.userInfo.phone?e.data.userInfo.phone:""},header:{wxToken:e.data.wxToken},method:"GET",success:function(t){t.data.ok?e.bind_mobile(t.data.msg):-10000301==t.data.code?e.loginAgain():wx.showToast({title:"error",icon:"none",duration:1500})},fail:function(){},complete:function(){e.data.fandou=!1}}))},bind_mobile:function(e){var t=this;wx.getStorage({key:"h5_sjzp_token",success:function(n){wx.request({url:t.data.activityUrl+"api/h5/base/user/bind_mobile_v2",data:{appid:"H15wGJvuhrB1aTqJmx",encryptedData:e||""},header:{token:n.data},method:"POST",success:function(e){200==e.data.code?wx.showToast({title:"绑定成功",icon:"none",duration:1500}):wx.showToast({title:"绑定失败",icon:"none",duration:1500})},fail:function(e){},complete:function(){setTimeout((function(){t.skipLink()}),1e3)}})},fail:function(){},complete:function(){}})},skipLink:function(){1===getCurrentPages().length?wx.redirectTo({url:n.globalData.pageIndex}):wx.navigateBack({delta:1})},buried:function(e){wx.request({url:"https://fuliyang.u1.netease.com/st/api/add",data:{appId:"J2XFsdUxkSD0",userId:wx.getStorageSync("h5_sjzp_token"),item:e,code:this.data.actId},header:{"content-type":"application/json"},method:"GET",dataType:"json",responseType:"text",success:function(e){},fail:function(){},complete:function(){}})},onHide:function(){},onUnload:function(){},onPullDownRefresh:function(){},onReachBottom:function(){},onShareAppMessage:function(){},onPageScroll:function(){},onTabItemTap:function(e){}});
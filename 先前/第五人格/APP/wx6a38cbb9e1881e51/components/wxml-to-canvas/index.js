var e,t=require("../../@babel/runtime/helpers/interopRequireDefault"),a=t(require("../../@babel/runtime/regenerator")),r=t(require("../../@babel/runtime/helpers/asyncToGenerator")),n=require("./xml-parser"),i=require("./widget").Widget,s=require("./draw").Draw,u=require("./utils").compareVersion;Component({properties:{width:{type:Number,value:400},height:{type:Number,value:300},forceUseOldCanvas:{type:Boolean,value:!1}},data:{use2dCanvas:!1},lifetimes:{attached:function(){this.init()}},methods:{init:function(){var e=this,t=wx.getSystemInfoSync(),a=t.SDKVersion,r=t.pixelRatio,n=u(a,"2.9.2")>=0&&!this.data.forceUseOldCanvas;this.dpr=r,this.setData({use2dCanvas:n},(function(){n?e.createSelectorQuery().select("#".concat("weui-canvas")).fields({node:!0,size:!0}).exec((function(t){var a=t[0].node,n=a.getContext("2d");a.width=t[0].width*r,a.height=t[0].height*r,n.scale(r,r),e.ctx=n,e.canvas=a})):e.ctx=wx.createCanvasContext("weui-canvas",e)}))},renderToCanvas:(e=(0,r.default)(a.default.mark((function e(t){var r,u,o,c,d,h,l,v,p,f;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.wxml,u=t.style,o=this.ctx,c=this.canvas,!(d=this.data.use2dCanvas)||c){e.next=6;break}return e.abrupt("return",Promise.reject(new Error("renderToCanvas: fail canvas has not been created")));case 6:return o.clearRect(0,0,this.data.width,this.data.height),h=n(r),l=h.root,v=new i(l,u),p=v.init(),this.boundary={top:p.layoutBox.top,left:p.layoutBox.left,width:p.computedStyle.width,height:p.computedStyle.height},f=new s(o,c,d),e.next=14,f.drawNode(p);case 14:if(d){e.next=17;break}return e.next=17,this.canvasDraw(o);case 17:return e.abrupt("return",Promise.resolve(p));case 18:case"end":return e.stop()}}),e,this)}))),function(t){return e.apply(this,arguments)}),canvasDraw:function(e,t){return new Promise((function(a){e.draw(t,(function(){a()}))}))},canvasToTempFilePath:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},a=this.data.use2dCanvas;return new Promise((function(r,n){var i=e.boundary,s=i.top,u=i.left,o=i.width,c=i.height,d={x:u,y:s,width:o,height:c,destWidth:o*e.dpr,destHeight:c*e.dpr,canvasId:"weui-canvas",fileType:t.fileType||"png",quality:t.quality||1,success:r,fail:n};a&&(delete d.canvasId,d.canvas=e.canvas),wx.canvasToTempFilePath(d,e)}))}}});
var e=require("../../@babel/runtime/helpers/interopRequireDefault");require("../../@babel/runtime/helpers/Objectvalues");var t=e(require("../../@babel/runtime/regenerator")),r=e(require("../../@babel/runtime/helpers/asyncToGenerator")),a=e(require("../../@babel/runtime/helpers/classCallCheck")),n=e(require("../../@babel/runtime/helpers/createClass"));function i(e){if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(e=function(e,t){if(!e)return;if("string"==typeof e)return o(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(r);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return o(e,t)}(e))){var t=0,r=function(){};return{s:r,n:function(){return t>=e.length?{done:!0}:{done:!1,value:e[t++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,n,i=!0,l=!1;return{s:function(){a=e[Symbol.iterator]()},n:function(){var e=a.next();return i=e.done,e},e:function(e){l=!0,n=e},f:function(){try{i||null==a.return||a.return()}finally{if(l)throw n}}}}function o(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,a=new Array(t);r<t;r++)a[r]=e[r];return a}var l=function(){function e(t,r){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];(0,a.default)(this,e),this.ctx=t,this.canvas=r||null,this.use2dCanvas=n}var o,l;return(0,n.default)(e,[{key:"roundRect",value:function(e,t,r,a,n){var i=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],o=arguments.length>6&&void 0!==arguments[6]&&arguments[6];if(!(n<0)){var l=this.ctx;l.beginPath(),l.arc(e+n,t+n,n,Math.PI,3*Math.PI/2),l.arc(e+r-n,t+n,n,3*Math.PI/2,0),l.arc(e+r-n,t+a-n,n,0,Math.PI/2),l.arc(e+n,t+a-n,n,Math.PI/2,Math.PI),l.lineTo(e,t+n),o&&l.stroke(),i&&l.fill()}}},{key:"drawView",value:function(e,t){var r=this.ctx,a=e.left,n=e.top,i=e.width,o=e.height,l=t.borderRadius,c=void 0===l?0:l,s=t.borderWidth,u=void 0===s?0:s,f=t.borderColor,d=t.color,h=void 0===d?"#000":d,v=t.backgroundColor,b=void 0===v?"transparent":v;r.save(),u>0&&(r.fillStyle=f||h,this.roundRect(a,n,i,o,c)),r.fillStyle=b;var p=i-2*u,m=o-2*u,w=c-u>=0?c-u:0;this.roundRect(a+u,n+u,p,m,w),r.restore()}},{key:"drawImage",value:(l=(0,r.default)(t.default.mark((function e(r,a,n){var i=this;return t.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,new Promise((function(e,t){var o=i.ctx,l=i.canvas,c=n.borderRadius,s=void 0===c?0:c,u=a.left,f=a.top,d=a.width,h=a.height;o.save(),i.roundRect(u,f,d,h,s,!1,!1),o.clip();var v=function(r){if(i.use2dCanvas){var a=l.createImage();a.onload=function(){o.drawImage(a,u,f,d,h),o.restore(),e()},a.onerror=function(){t(new Error("createImage fail: ".concat(r)))},a.src=r}else o.drawImage(r,u,f,d,h),o.restore(),e()},b=/^wxfile:\/\//.test(r),p=/^https?:\/\//.test(r);b?v(r):p?wx.downloadFile({url:r,success:function(e){200===e.statusCode?v(e.tempFilePath):t(new Error("downloadFile:fail ".concat(r)))},fail:function(){t(new Error("downloadFile:fail ".concat(r)))}}):t(new Error("image format error: ".concat(r)))}));case 2:case"end":return e.stop()}}),e)}))),function(e,t,r){return l.apply(this,arguments)})},{key:"drawText",value:function(e,t,r){var a=this.ctx,n=t.left,o=t.top,l=t.width,c=t.height,s=r.color,u=void 0===s?"#000":s,f=r.lineHeight,d=void 0===f?"1.4em":f,h=r.fontSize,v=void 0===h?14:h,b=r.fontWeight,p=void 0===b?"normal":b,m=r.textAlign,w=void 0===m?"left":m,x=r.verticalAlign,y=void 0===x?"top":x,g=r.backgroundColor,k=void 0===g?"transparent":g;if("string"==typeof d&&(d=Math.ceil(parseFloat(d.replace("em"))*v)),e&&!(d>c)){switch(a.save(),a.textBaseline="top",a.font="".concat(p," ").concat(v,"px sans-serif"),a.textAlign=w,a.fillStyle=k,this.roundRect(n,o,l,c,0),a.fillStyle=u,w){case"left":break;case"center":n+=.5*l;break;case"right":n+=l}var I=a.measureText(e).width,S=Math.ceil(I/l)*d,M=Math.ceil((c-S)/2);switch(M<0&&(M=0),y){case"top":break;case"middle":o+=M;break;case"bottom":o+=2*M}var C=Math.ceil((d-v)/2);if(I<=l)a.fillText(e,n,o+C);else{var T,A=o,P="",R=i(e.split(""));try{for(R.s();!(T=R.n()).done;){var q=T.value,j=P+q;if(a.measureText(j).width>l){if(a.fillText(P,n,o+C),P=q,(o+=d)+d>A+c)break}else P=j}}catch(e){R.e(e)}finally{R.f()}o+d<=A+c&&a.fillText(P,n,o+C),a.restore()}}}},{key:"drawNode",value:(o=(0,r.default)(t.default.mark((function e(r){var a,n,i,o,l,c,s,u,f,d;return t.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=r.layoutBox,n=r.computedStyle,i=r.name,o=r.attributes,l=o.src,c=o.text,"view"!==i){e.next=6;break}this.drawView(a,n),e.next=12;break;case 6:if("image"!==i){e.next=11;break}return e.next=9,this.drawImage(l,a,n);case 9:e.next=12;break;case 11:"text"===i&&this.drawText(c,a,n);case 12:s=Object.values(r.children),u=0,f=s;case 14:if(!(u<f.length)){e.next=21;break}return d=f[u],e.next=18,this.drawNode(d);case 18:u++,e.next=14;break;case 21:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})}]),e}();module.exports={Draw:l};
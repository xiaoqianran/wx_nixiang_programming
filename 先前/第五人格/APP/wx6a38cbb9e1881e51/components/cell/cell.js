var t=require("../../@babel/runtime/helpers/interopRequireDefault")(require("../../@babel/runtime/helpers/defineProperty")),e=require("./wxmlTocanvasData.js"),o=require("../../lib/util/index");function n(t,e){var o=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),o.push.apply(o,n)}return o}var i=require("../../lib/request/request"),a=require("../../lib/storage/storage"),r=["联系我","立即联系","咨询服务","在线咨询","联系客服"],s=["咨询服务","在线咨询","联系客服"],c=["有什么问题可以联系我咨询","联系服务人员咨询","获取服务人员联系方式","联系客服咨询更多问题"],u={avatorStyle:function(t){return(-1==["rect","circle"].indexOf(t)?"circle":t).toUpperCase()},isMask:function(t){return-1==[0,1].indexOf(t)?0:t},contactText:function(t){return s[t>=0&&t<s.length?t:0]},buttonText:function(t){return r[t>=0&&t<r.length?t:0]},serviceText:function(t){return c[t>=0&&t<c.length?t:0]},buttonStyle:function(t){return(-1==["light","primary"].indexOf(t)?"primary":t).toUpperCase()},buttonSize:function(t){return(-1==["small"].indexOf(t)?"small":t).toUpperCase()},paddingStyle:function(t){return t=isNaN(t)?0:parseInt(t),0==(t=Math.max(0,t))?0:t+"px"},bubbleColor:function(t){return/^([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(t)?"#"+t:"#4790EE"},iconStyle:function(t){return(-1==["light","primary","avator"].indexOf(t)?"avator":t).toUpperCase()},blockStyle:function(t){return(-1==["bubble","button"].indexOf(t)?"bubble":t).toUpperCase()},styleType:function(t){return 1==t||2==t||3==t?t:1},pluginType:function(t){return 0==t||2==t?0:1==t?1:0}},p={ROW:{avatorStyle:u.avatorStyle,isMask:u.isMask,contactText:u.contactText,buttonText:u.buttonText,buttonStyle:u.buttonStyle,buttonSize:u.buttonSize,paddingStyle:u.paddingStyle},BLOCK:{BUBBLE:{bubbleColor:u.bubbleColor},BUTTON:{buttonStyle:u.buttonStyle,buttonText:u.buttonText,buttonSize:u.buttonSize}},MESSAGE:{iconStyle:u.iconStyle,contactText:u.contactText,serviceText:u.serviceText}},d={ROW:{iconStyle:u.iconStyle,contactText:u.contactText,paddingStyle:u.paddingStyle},BLOCK:{BUBBLE:{bubbleColor:u.bubbleColor},BUTTON:{buttonStyle:u.buttonStyle,buttonText:u.buttonText,buttonSize:u.buttonSize}}},l={},g=wx.getSystemInfoSync().platform;Component({data:{isReady:!1,isNeedAuth:!1,args:{withCredentials:!0,lang:"zh_CN"},render:{},hackClass:"",postInit:!1,postWidth:300,postHeight:500,cardHeight:0,postImg:"",postGenerating:!1,descDom:"",descWidths:{},isPC:"windows"===g||"mac"===g},properties:{reqType:{type:Number,value:0,observer:function(t,e,o){this.queryPluginConfig()}},vcode:{type:String,value:"",observer:function(t,e,o){this.queryPluginConfig()}},plugid:{type:String,value:"",observer:function(t,e,o){this.queryPluginConfig()}},avatorStyle:{type:String},isMask:{type:Number},contactText:{type:Number},buttonText:{type:Number},buttonStyle:{type:String},buttonSize:{type:Number},paddingStyle:{type:Number},styleType:{type:Number},serviceText:{type:Number},plugType:{type:Number},blockStyle:{type:String},bubbleColor:{type:String},iconStyle:{type:String}},attached:function(){var t=this;a.initNameSpace(),a.setStorage("freego",{cookie:""},!1),wx.login?wx.login({success:function(e){console.log("success %o",e),t.setData({isNeedAuth:!1})},fail:function(e){t.setData({isNeedAuth:!0})}}):(t.notifyToHostApp({errcode:-3010}),t.setData({isNeedAuth:!0})),this.queryPluginConfig()},methods:{loginSuccess:function(t){this.checkWxVersion()?this.getPreviewQRCode(t.detail,"qrcode_xcxplug"):this.sendMsgToWx(t.detail,"contactplugin/sendmsgtowx"),this.report("sample_authorize_yes")},loginFail:function(t){this.notifyToHostApp({errcode:-3004}),this.report("sample_authorize_no")},onBindTap:function(){this.notifyToHostApp({state:1})},statFunctionalPage:function(){this.report(0==l.type?"plug_single_miniapp_use":"plug_multi_miniapp_use",79505335)},makeAuthReq:function(t){var e=t.forceMsg,o=this;wx.login({success:function(t){wx.getUserInfo({withCredentials:!0,success:function(n){var i={code:t.code,encryptedData:n.encryptedData,iv:n.iv};!e&&o.checkWxVersion()?o.getPreviewQRCode(i,"qrcode_xcxplug"):o.sendMsgToWx(i,"contactplugin/sendmsgtowx")},fail:function(){o.notifyToHostApp({errcode:-3004})}})},fail:function(){o.notifyToHostApp({errcode:-3004})}}),this.report(0==l.type?"plug_single_miniapp_use":"plug_multi_miniapp_use",79505335)},getRenderConfigByType:function(t,e){var o=0==t?p:d,n="",i=o.ROW;2==e?i=o.BLOCK:3==e&&0==t&&(i=o.MESSAGE),2==e&&(i=i[n=u.blockStyle(this.data.blockStyle)]);var a={};for(var r in i)i.hasOwnProperty(r)&&(a[r]=i[r](this.data[r]));return a.plugType=0==t?"SINGLE":"MULTI",a.styleType=1==e?"ROW":2==e?"BLOCK":"MESSAGE",a.blockStyle=n,a},queryPluginConfig:function(){var t=this;""==t.data.vcode&&""==t.data.plugid||i.request({ignore:!0,method:"POST",url:"contactplugin/queryconfig",data:{req_type:t.data.reqType,vcode:t.data.vcode,plugid:t.data.plugid}}).then((function(e){e.data&&e.data.data?(l=e.data.data,t.computeRenderData()):t.notifyToHostApp({errcode:-3002})}))},computeRenderData:function(){var t=this.data.plugType?this.data.plugType:u.pluginType(l.type),e=this.data.styleType?this.data.styleType:u.styleType(l.style),o=this.getRenderConfigByType(t,e);o.avatorUrl=l.headurl||"../../assets/people_icon_big.png",o.nickName=l.name||"",console.log("%o",o),this.setData({render:o,isReady:!0})},checkWxVersion:function(){var t=wx.getSystemInfoSync(),e=t.version,n=t.platform;return"wxwork"!==t.environment&&("ios"==n&&(0,o.compareVersion)(e,"8.0.6")>=0||"android"==n&&(0,o.compareVersion)(e,"8.0.3")>=0)},getPreviewQRCode:function(t,e){var o=this;this.data.postImg?wx.previewImage({urls:[this.data.postImg]}):this.data.postGenerating?wx.showToast({title:"二维码生成中，请稍等",icon:"none"}):(this.setData({postGenerating:!0}),wx.showLoading({title:"加载中"}),this.sendReqToSvr(t,e,1,(function(t){console.log(t),t.headurl||(t.headurl="https://wwcdn.weixin.qq.com/node/wework/images/people-default-avatar.7a88fbdae5.png"),o.getPost(t)})))},sendMsgToWx:function(t,e){this.sendReqToSvr(t,e,0)},sendReqToSvr:function(t,e,o,n){var a=this;this.triggerEvent("startmessage",{}),i.request({ignore:!0,method:"POST",url:e,data:{req_type:a.data.reqType,vcode:a.data.vcode,plugid:a.data.plugid,code:t.code,iv:t.iv,encryptedData:t.encryptedData}}).then((function(t){t.data&&t.data.data&&"{}"!=JSON.stringify(t.data.data)?1==t.data.data.type?0==o?a.notifyToHostApp({errcode:-3006,name:t.data.data.name,headurl:t.data.data.headurl,notifytype:o}):n&&n(t.data.data):2==t.data.data.type?a.notifyToHostApp({errcode:-3007}):0==o?a.notifyToHostApp({errcode:0,name:t.data.data.name,headurl:t.data.data.headurl,notifytype:o}):n&&n(t.data.data):t.data&&t.data.result&&"-20116"==t.data.result.errCode?a.notifyToHostApp({errcode:-3008}):a.notifyToHostApp({errcode:-3005})})).catch((function(t){a.setData({postGenerating:!1}),wx.hideLoading()}))},notifyToHostApp:function(t){this.triggerEvent("completemessage",t)},report:function(t,e){var o="https://work.weixin.qq.com/wework_admin/report?r="+Math.random()+"&q=";o+=encodeURIComponent('st:sgkvuin_report={"kv":'+(e||79505334)+',"key":"'+t+'","id":'+ +new Date+"}"),wx.request({url:o})},logkvReport:function(t,e){var o="https://work.weixin.qq.com/wework_admin/report?r="+Math.random()+"&q=";o+=encodeURIComponent('st:logkv_report={"kv": "'.concat(t,'", "value": "').concat(e||1,'"}'))+"&_t=".concat(+new Date),console.log(o),wx.request({url:o})},logkvAutoReport:function(t,e){var o="https://work.weixin.qq.com/wework_admin/report?r="+Math.random()+"&q=";o+=encodeURIComponent('st:logkvauto_report={"kv": "'.concat(t,'", "key": "').concat(e,'"}'))+"&_t=".concat(+new Date),console.log(o),wx.request({url:o})},initPostData:function(t){var e=wx.getSystemInfoSync(),o=e.screenWidth,n=(e.screenHeight,this.selectComponent(".widget").ctx),i="你好，我是来自".concat(t.corpname,"的").concat(t.name,"，添加我的企业微信与我联系吧。"),a=o-96-24,r=this.drawContent(n,i,a),s="",c={};console.log(r),r.forEach((function(t,e){var o='<text class="desc-text desc-text'.concat(e,'">').concat(t.text,"</text>").concat(e===r.length?"":"\n");c["descText".concat(e)]={width:t.width,marginLeft:0!==e?20:0},s+=o}));var u=548+22*(r.length-1),p=u+22+24+68;this.setData({descDom:s,descWidths:c,postWidth:o,postHeight:p,cardHeight:u,postInit:!0}),console.log("init post done")},drawContent:function(t,e,o){t.font="15px sans-serif";var n=e.split("\n"),i=[];return n.forEach((function(e){var n=0,a=0;""==e?i.push(""):e.split("").forEach((function(r,s){(n+=t.measureText(r).width)>o&&(i.push({text:e.slice(a,s),width:n-t.measureText(r).width}),n=t.measureText(r).width,a=s),s==e.length-1&&i.push({text:e.slice(a),width:n})}))})),i},getPost:function(t){var e=wx.getSystemInfoSync().pixelRatio;this.data.postInit||this.initPostData(t),this.widget=this.selectComponent(".widget"),this.widget.ctx&&this.widget.canvas?(this.widget.ctx.scale(1,1),this.widget.canvas.height=this.data.postHeight*e,this.widget.canvas.width=this.data.postWidth*e,console.log(this.widget.canvas.height,this.widget.canvas.width),this.widget.ctx.scale(e,e),this.widget.dpr=e,this.getPostCanvas(t)):this.postErrHandle(!0)},getPostCanvas:function(o){var i=this;this.widget=this.selectComponent(".widget");var a=(0,e.getPostWxml)(function(e){for(var o=1;o<arguments.length;o++){var i=null!=arguments[o]?arguments[o]:{};o%2?n(Object(i),!0).forEach((function(o){(0,t.default)(e,o,i[o])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):n(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}({},this.data,{},o)),r=(0,e.getPostStyle)(this.data);this.widget.renderToCanvas({wxml:a,style:r}).then((function(t){i.container=t,i.extraImage(o)})).catch((function(t){console.log(t),i.postErrHandle()}))},extraImage:function(t){var e=this;this.widget.canvasToTempFilePath().then((function(o){wx.hideLoading(),wx.previewImage({urls:[o.tempFilePath]}),e.setData({postImg:o.tempFilePath,postGenerating:!1}),e.notifyToHostApp({errcode:1==t.type?-3006:0,name:t.name,headurl:t.headurl,notifytype:1})})).catch((function(t){console.log(t),e.postErrHandle()}))},postErrHandle:function(t){this.makeAuthReq({forceMsg:!0}),wx.hideLoading(),this.setData({postGenerating:!1}),t?this.logkvAutoReport(49591,"contact|postfail|versionlow"):this.logkvAutoReport(49591,"contact|postfail")}}});
var t=require("../../@babel/runtime/helpers/typeof");module.exports=function(e){var n={};function i(t){if(n[t])return n[t].exports;var s=n[t]={i:t,l:!1,exports:{}};return e[t].call(s.exports,s,s.exports,i),s.l=!0,s.exports}return i.m=e,i.c=n,i.d=function(t,e,n){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(e,n){if(1&n&&(e=i(e)),8&n)return e;if(4&n&&"object"===t(e)&&e&&e.__esModule)return e;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var a in e)i.d(s,a,function(t){return e[t]}.bind(null,a));return s},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=1)}([function(t,e,n){function i(t){return t.replace(/[^\x00-\xff]/g,"aa").length}t.exports={getStrLen:i,substring:function(t,e){if(!t)return"";if(e>=i(t))return t;for(var n=0,s="",a=0;a<t.length;a++){var l=t.charAt(a);if(s+=l,(n=/[^\x00-\xff]/i.test(l)?n+2:n+1)>=e)break}return s},getRandom:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return Math.floor(Math.random()*(t-e)+e)},getFontSize:function(t){var e=t.match(/(\d+)(px)/i);return e&&e[1]||10},compareVersion:function(t,e){t=t.split("."),e=e.split(".");for(var n=Math.max(t.length,e.length);t.length<n;)t.push("0");for(;e.length<n;)e.push("0");for(var i=0;i<n;i++){var s=parseInt(t[i],10),a=parseInt(e[i],10);if(s>a)return 1;if(s<a)return-1}return 0},isArray:function(t){return"Array"===function(t){return Object.prototype.toString.call(t).slice(8,-1)}(t)}}},function(t,e,n){var i=a(n(2)),s=a(n(3));function a(t){return t&&t.__esModule?t:{default:t}}Component({options:{addGlobalClass:!0},properties:{zIndex:{type:Number,value:10},renderingMode:{type:String,value:"canvas"}},methods:{getBarrageInstance:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return t.comp=this,this.barrageInstance="dom"===this.data.renderingMode?new i.default(t):new s.default(t),this.barrageInstance},onAnimationend:function(t){var e=t.currentTarget.dataset,n=e.tunnelid,i=e.bulletid;this.barrageInstance.animationend({tunnelId:n,bulletId:i})},onTapBullet:function(t){var e=t.currentTarget.dataset,n=e.tunnelid,i=e.bulletid;this.barrageInstance.tapBullet({tunnelId:n,bulletId:i})}}})},function(t,e,n){function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}e.__esModule=!0;var s=n(0),a=s.substring,l=s.getRandom,h=s.getFontSize,r=s.isArray,o=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i(this,t),this.bulletId=e.bulletId,this.addContent(e)}return t.prototype.addContent=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e={duration:0,passtime:0,content:"",color:"#000000",width:0,height:0,image:{},paused:!1};Object.assign(this,e,t)},t.prototype.removeContent=function(){this.addContent({})},t}(),u=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i(this,t);var n={tunnelId:0,height:0,width:0,safeGap:4,maxNum:10,bullets:[],last:-1,bulletStatus:[],disabled:!1,sending:!1,timer:null};Object.assign(this,n,e),this.bulletStatus=new Array(this.maxNum).fill(0);for(var s=0;s<this.maxNum;s++)this.bullets.push(new o({bulletId:s}))}return t.prototype.disable=function(){this.disabled=!0,this.last=-1,this.sending=!1,this.bulletStatus=new Array(this.maxNum).fill(1),this.bullets.forEach((function(t){return t.removeContent()}))},t.prototype.enable=function(){this.disabled&&(this.bulletStatus=new Array(this.maxNum).fill(0)),this.disabled=!1},t.prototype.clear=function(){this.last=-1,this.sending=!1,this.bulletStatus=new Array(this.maxNum).fill(0),this.bullets.forEach((function(t){return t.removeContent()})),this.timer&&clearTimeout(this.timer)},t.prototype.getIdleBulletIdx=function(){var t=this.bulletStatus.indexOf(0,this.last+1);return-1===t&&(t=this.bulletStatus.indexOf(0)),t},t.prototype.getIdleBulletNum=function(){var t=0;return this.bulletStatus.forEach((function(e){0===e&&t++})),t},t.prototype.addBullet=function(t){if(!this.disabled){var e=this.getIdleBulletIdx();e>=0&&(this.bulletStatus[e]=1,this.bullets[e].addContent(t))}},t.prototype.removeBullet=function(t){this.disabled||(this.bulletStatus[t]=0,this.bullets[t].removeContent())},t}(),d=function(){function t(){var e=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i(this,t);var s={duration:10,lineHeight:1.2,padding:[0,0,0,0],alpha:1,font:"10px sans-serif",mode:"separate",range:[0,1],tunnelShow:!1,tunnelMaxNum:30,maxLength:30,safeGap:4,enableTap:!1,tunnelHeight:0,tunnelNum:0,tunnels:[],idleTunnels:null,enableTunnels:null,distance:2e3,comp:null};Object.assign(this,s,n),this._ready=!1,this._deferred=[];var a=this.comp.createSelectorQuery();a.select(".barrage-area").boundingClientRect((function(t){e.init(t),e.ready()})).exec()}return t.prototype.ready=function(){var t=this;this._ready=!0,this._deferred.forEach((function(e){t[e.callback].apply(t,e.args)})),this._deferred=[]},t.prototype._delay=function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];this._deferred.push({callback:t,args:n})},t.prototype.init=function(t){this.width=t.width,this.height=t.height,this.fontSize=h(this.font),this.idleTunnels=new Set,this.enableTunnels=new Set,this.tunnels=[],this.availableHeight=this.height-this.padding[0]-this.padding[2],this.tunnelHeight=this.fontSize*this.lineHeight,this.tunnelNum=Math.floor(this.availableHeight/this.tunnelHeight);for(var e=0;e<this.tunnelNum;e++)this.idleTunnels.add(e),this.enableTunnels.add(e),this.tunnels.push(new u({width:this.width,height:this.tunnelHeight,safeGap:this.safeGap,maxNum:this.tunnelMaxNum,tunnelId:e}));this.comp.setData({fontSize:this.fontSize,tunnelShow:this.tunnelShow,tunnels:this.tunnels,font:this.font,alpha:this.alpha,padding:this.padding.map((function(t){return t+"px"})).join(" ")}),this.setRange()},t.prototype.setRange=function(t){var e=this;if(this._ready){var n=(t=t||this.range)[0]*this.tunnelNum,i=t[1]*this.tunnelNum,s=new Set,a=new Set;this.tunnels.forEach((function(t,l){if(l>=n&&l<i){var h=t.disabled;t.enable(),a.add(l),(h||e.idleTunnels.has(l))&&s.add(l)}else t.disable()})),this.idleTunnels=s,this.enableTunnels=a,this.range=t,this.comp.setData({tunnels:this.tunnels})}else this._delay("setRange",t)},t.prototype.setFont=function(t){this._ready?"string"==typeof t&&(this.font=t,this.comp.setData({font:t})):this._delay("setFont",t)},t.prototype.setAlpha=function(t){this._ready?"number"==typeof t&&(this.alpha=t,this.comp.setData({alpha:t})):this._delay("setAlpha",t)},t.prototype.setDuration=function(t){this._ready?"number"==typeof t&&(this.duration=t,this.clear()):this._delay("setDuration",t)},t.prototype.open=function(){this._ready?this._isActive=!0:this._delay("open")},t.prototype.close=function(){this._ready?(this._isActive=!1,this.clear()):this._delay("close")},t.prototype.clear=function(){this.tunnels.forEach((function(t){return t.clear()})),this.idleTunnels=new Set(this.enableTunnels),this.comp.setData({tunnels:this.tunnels})},t.prototype.addData=function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];r(e)&&(this._ready?this._isActive&&(e.forEach((function(e){e.content=a(e.content,t.maxLength),t.addBullet2Tunnel(e)})),this.comp.setData({tunnels:this.tunnels},(function(){t.updateBullets()}))):this._delay("addData",e))},t.prototype.send=function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(this._ready){var n=this.getEnableTunnel();if(null!==n)var i=setInterval((function(){t.getIdleTunnel()&&(t.addData([e]),clearInterval(i))}),16)}else this._delay("send",e)},t.prototype.addBullet2Tunnel=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=this.getIdleTunnel();if(null!==e){var n=e.tunnelId;e.addBullet(t),0===e.getIdleBulletNum()&&this.removeIdleTunnel(n)}},t.prototype.updateBullets=function(){var t=this,e=this;this.comp.createSelectorQuery().selectAll(".bullet-item").boundingClientRect((function(n){if(t._isActive){for(var i=0;i<n.length;i++){var s=n[i].dataset,a=s.tunnelid,l=s.bulletid,h=e.tunnels[a].bullets[l];h.width=n[i].width,h.height=n[i].height}e.animate()}})).exec()},t.prototype.animate=function(){var t=this;this.tunnels.forEach((function(e){t.tunnelAnimate(e)}))},t.prototype.tunnelAnimate=function(t){var e=this;if(!t.disabled&&!t.sending&&this._isActive){var n=(t.last+1)%t.maxNum,i=t.bullets[n];if(i&&(i.content||i.image.head||i.image.tail)){var s;t.sending=!0,t.last=n;var a=this.duration;"overlap"===this.mode&&(a=this.distance*this.duration/(this.distance+i.width));var l=i.width+t.safeGap;i.duration=a,i.passtime=Math.ceil(l*i.duration*1e3/this.distance),this.comp.setData(((s={})["tunnels["+t.tunnelId+"].bullets["+i.bulletId+"]"]=i,s),(function(){t.timer=setTimeout((function(){t.sending=!1,e.tunnelAnimate(t)}),i.passtime)}))}}},t.prototype.showTunnel=function(){this.comp.setData({tunnelShow:!0})},t.prototype.hideTunnel=function(){this.comp.setData({tunnelShow:!1})},t.prototype.removeIdleTunnel=function(t){this.idleTunnels.delete(t)},t.prototype.addIdleTunnel=function(t){this.idleTunnels.add(t)},t.prototype.getEnableTunnel=function(){if(0===this.enableTunnels.size)return null;var t=Array.from(this.enableTunnels),e=l(t.length);return this.tunnels[t[e]]},t.prototype.getIdleTunnel=function(){if(0===this.idleTunnels.size)return null;var t=Array.from(this.idleTunnels),e=l(t.length);return this.tunnels[t[e]]},t.prototype.animationend=function(t){var e,n=t.tunnelId,i=t.bulletId,s=this.tunnels[n];if(s){var a=s.bullets[i];a&&(s.removeBullet(i),this.addIdleTunnel(n),this.comp.setData(((e={})["tunnels["+n+"].bullets["+i+"]"]=a,e)))}},t.prototype.tapBullet=function(t){var e;if(this.enableTap){var n=t.tunnelId,i=t.bulletId,s=this.tunnels[n].bullets[i];s.paused=!s.paused,this.comp.setData(((e={})["tunnels["+n+"].bullets["+i+"]"]=s,e))}},t}();e.default=d},function(t,e,n){e.__esModule=!0;var i=n(0);function s(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var a=function(){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};s(this,t);var i={color:"#000000",font:"10px sans-serif",fontSize:10,content:"",textWidth:0,speed:0,x:0,y:0,tunnelId:0,image:{},imageHead:null,imageTail:null};Object.assign(this,i,n),this.barrage=e,this.ctx=e.ctx,this.canvas=e.canvas}return t.prototype.move=function(){var t=this;if(this.image.head&&!this.imageHead){var e=this.canvas.createImage();e.src=this.image.head.src,e.onload=function(){t.imageHead=e},e.onerror=function(){console.log("Fail to load image: "+t.image.head.src)}}if(this.image.tail&&!this.imageTail){var n=this.canvas.createImage();n.src=this.image.tail.src,n.onload=function(){t.imageTail=n},n.onerror=function(){console.log("Fail to load image: "+t.image.tail.src)}}if(this.imageHead){var i=this.image.head,s=i.width,a=void 0===s?this.fontSize:s,l=i.height,h=void 0===l?this.fontSize:l,r=i.gap,o=void 0===r?4:r,u=this.x-o-a,d=this.y-.5*h;this.ctx.drawImage(this.imageHead,u,d,a,h)}if(this.imageTail){var c=this.image.tail,f=c.width,p=void 0===f?this.fontSize:f,g=c.height,m=void 0===g?this.fontSize:g,v=c.gap,y=void 0===v?4:v,b=this.x+this.textWidth+y,x=this.y-.5*m;this.ctx.drawImage(this.imageTail,b,x,p,m)}this.x=this.x-this.speed,this.ctx.fillStyle=this.color,this.ctx.fillText(this.content,this.x,this.y)},t}(),l=function(){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};s(this,t);var i={activeQueue:[],nextQueue:[],maxNum:30,freeNum:30,height:0,width:0,disabled:!1,tunnelId:0,safeArea:4,sending:!1};Object.assign(this,i,n),this.freeNum=this.maxNum,this.barrage=e,this.ctx=e.ctx}return t.prototype.disable=function(){this.disabled=!0},t.prototype.enable=function(){this.disabled=!1},t.prototype.clear=function(){this.activeQueue=[],this.nextQueue=[],this.sending=!1,this.freeNum=this.maxNum,this.barrage.addIdleTunnel(this.tunnelId)},t.prototype.addBullet=function(t){this.disabled||0!==this.freeNum&&(this.nextQueue.push(t),this.freeNum--,0===this.freeNum&&this.barrage.removeIdleTunnel(this.tunnelId))},t.prototype.animate=function(){if(!this.disabled){var t=this.nextQueue,e=this.activeQueue;if(!this.sending&&t.length>0){var n=t.shift();e.push(n),this.freeNum++,this.sending=!0,this.barrage.addIdleTunnel(this.tunnelId)}if(e.length>0){e.forEach((function(t){return t.move()}));var i=e[0],s=e[e.length-1];i.x+i.textWidth<0&&e.shift(),s.x+s.textWidth+this.safeArea<this.width&&(this.sending=!1)}}},t}(),h=function(){function t(){var e=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};s(this,t);var i={font:"10px sans-serif",duration:15,lineHeight:1.2,padding:[0,0,0,0],tunnelHeight:0,tunnelNum:0,tunnelMaxNum:30,maxLength:30,safeArea:4,tunnels:[],idleTunnels:[],enableTunnels:[],alpha:1,mode:"separate",range:[0,1],fps:60,tunnelShow:!1,comp:null};Object.assign(this,i,n);var a=wx.getSystemInfoSync();this.ratio=a.pixelRatio,this.selector="#weui-canvas",this._ready=!1,this._deferred=[];var l=this.comp.createSelectorQuery();l.select(this.selector).boundingClientRect(),l.select(this.selector).node(),l.exec((function(t){e.canvas=t[1].node,e.init(t[0]),e.ready()}))}return t.prototype.ready=function(){var t=this;this._ready=!0,this._deferred.forEach((function(e){t[e.callback].apply(t,e.args)})),this._deferred=[]},t.prototype._delay=function(t,e){this._deferred.push({callback:t,args:e})},t.prototype.init=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.width=t.width,this.height=t.height,this.fontSize=(0,i.getFontSize)(this.font),this.innerDuration=this.transfromDuration2Canvas(this.duration);var e=this.ratio;this.canvas.width=this.width*e,this.canvas.height=this.height*e,this.ctx=this.canvas.getContext("2d"),this.ctx.scale(e,e),this.ctx.textBaseline="middle",this.ctx.globalAlpha=this.alpha,this.ctx.font=this.font,this.idleTunnels=[],this.enableTunnels=[],this.tunnels=[],this.availableHeight=this.height-this.padding[0]-this.padding[2],this.tunnelHeight=this.fontSize*this.lineHeight,this.tunnelNum=Math.floor(this.availableHeight/this.tunnelHeight);for(var n=0;n<this.tunnelNum;n++)this.idleTunnels.push(n),this.enableTunnels.push(n),this.tunnels.push(new l(this,{width:this.width,height:this.tunnelHeight,safeArea:this.safeArea,maxNum:this.tunnelMaxNum,tunnelId:n}));this.setRange(),this._isActive=!1},t.prototype.transfromDuration2Canvas=function(t){return t*this.width/2e3},t.prototype.setRange=function(t){var e=this;if(this._ready){var n=(t=t||this.range)[0]*this.tunnelNum,i=t[1]*this.tunnelNum,s=[],a=[];this.tunnels.forEach((function(t,l){l>=n&&l<i?(t.enable(),a.push(l),e.idleTunnels.indexOf(l)>=0&&s.push(l)):t.disable()})),this.idleTunnels=s,this.enableTunnels=a,this.range=t}else this._delay("setRange",t)},t.prototype.setFont=function(t){this._ready?(this.font=t,this.fontSize=(0,i.getFontSize)(this.font),this.ctx.font=t):this._delay("setFont",t)},t.prototype.setAlpha=function(t){this._ready?(this.alpha=t,this.ctx.globalAlpha=t):this._delay("setAlpha",t)},t.prototype.setDuration=function(t){this._ready?(this.clear(),this.duration=t,this.innerDuration=this.transfromDuration2Canvas(t)):this._delay("setDuration",t)},t.prototype.open=function(){this._ready?this._isActive||(this._isActive=!0,this.play()):this._delay("open")},t.prototype.close=function(){this._ready?this._isActive&&(this._isActive=!1,this.pause(),this.clear()):this._delay("close")},t.prototype.play=function(){var t=this;this._rAFId=this.canvas.requestAnimationFrame((function(){t.animate(),t.play()}))},t.prototype.pause=function(){"number"==typeof this._rAFId&&this.canvas.cancelAnimationFrame(this._rAFId)},t.prototype.clear=function(){this.ctx.clearRect(0,0,this.width,this.height),this.tunnels.forEach((function(t){return t.clear()}))},t.prototype.addData=function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];this._ready?this._isActive&&e.forEach((function(e){return t.addBullet2Tunnel(e)})):this._delay("addData",e)},t.prototype.send=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(this._ready){var e=this.getEnableTunnel();if(null!==e){t.tunnelId=e.tunnelId;var n=this.registerBullet(t);e.nextQueue[0]=n}}else this._delay("send",t)},t.prototype.addBullet2Tunnel=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=this.getIdleTunnel();if(null!==e){t.tunnelId=e.tunnelId;var n=this.registerBullet(t);e.addBullet(n)}},t.prototype.registerBullet=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};t.tunnelId=t.tunnelId||0,t.content=(0,i.substring)(t.content,this.maxLength);var e=this.getTextWidth(t.content),n="overlap"===this.mode?this.width+e:this.width;return t.textWidth=e,t.speed=n/(this.innerDuration*this.fps),t.fontSize=this.fontSize,t.x=this.width,t.y=this.tunnelHeight*(t.tunnelId+.5)+this.padding[0],new a(this,t)},t.prototype.animate=function(){this.ctx.clearRect(0,0,this.width,this.height),this.tunnelShow&&this.drawTunnel(),this.tunnels.forEach((function(t){return t.animate()}))},t.prototype.showTunnel=function(){this.tunnelShow=!0},t.prototype.hideTunnel=function(){this.tunnelShow=!1},t.prototype.removeIdleTunnel=function(t){var e=this.idleTunnels.indexOf(t);e>=0&&this.idleTunnels.splice(e,1)},t.prototype.addIdleTunnel=function(t){this.idleTunnels.indexOf(t)<0&&this.idleTunnels.push(t)},t.prototype.getEnableTunnel=function(){if(0===this.enableTunnels.length)return null;var t=(0,i.getRandom)(this.enableTunnels.length);return this.tunnels[this.enableTunnels[t]]},t.prototype.getIdleTunnel=function(){if(0===this.idleTunnels.length)return null;var t=(0,i.getRandom)(this.idleTunnels.length);return this.tunnels[this.idleTunnels[t]]},t.prototype.getTextWidth=function(t){return this.ctx.font=this.font,Math.ceil(this.ctx.measureText(t).width)},t.prototype.drawTunnel=function(){for(var t=this.ctx,e=0;e<=this.tunnelNum;e++){var n=this.padding[0]+e*this.tunnelHeight;t.beginPath(),t.strokeStyle="#CCB24D",t.setLineDash([5,10]),t.moveTo(0,n),t.lineTo(this.width,n),t.stroke(),e<this.tunnelNum&&(t.fillStyle="#CCB24D",t.fillText("弹道"+(e+1),10,this.tunnelHeight/2+n))}},t}();e.default=h}]);
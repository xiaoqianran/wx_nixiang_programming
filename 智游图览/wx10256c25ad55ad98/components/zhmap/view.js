Object.defineProperty(exports,"__esModule",{value:!0}),exports.Track=exports.ScenicFooterLegend=exports.ScenicAreaMap=exports.ScenicArea=exports.RoadType=exports.Road=exports.IconLegend=void 0;var t,i=require("../../@babel/runtime/helpers/classCallCheck"),e=require("../../@babel/runtime/helpers/createClass"),o=require("./LagLng.Utils"),n=require("../../index"),l=require("./util"),a=require("./cronutils"),s=require("./zhconfig"),r=require("../../utils/util"),h=new s.ZhgeoIcons;var u={},_=(exports.IconLegend=function(){return e((function t(e){i(this,t),this.id=null,this.name=null,this.icon=null,this.icon_width=null,this.icon_height=null,this.init(e)}),[{key:"init",value:function(t){this.id=t.id,this.name=t.name,this.icon=null!=t.icon?(0,n.getServeUrl)()+t.icon:null,this.icon_width=t.icon_width,this.icon_height=t.icon_height}}])}(),{}),d=(exports.ScenicFooterLegend=function(){return e((function t(e){i(this,t),this.id=null,this.name=null,this.icon=null,this.triangle_color=null,this.margin_width=null,this.margin_height=null,this.font_color=null,this.init(e)}),[{key:"init",value:function(t){this.id=t.id,this.name=t.name,this.icon=null!=t.icon?(0,n.getServeUrl)()+t.icon:null,this.triangle_color=t.triangle_color,this.margin_width=t.margin_width,this.margin_height=t.margin_height,this.font_color=t.font_color}}])}(),exports.Road=function(){return e((function t(e){i(this,t),this.id=null,this.name=null,this.detail=null,this.road_type=null,this.route=null,this.show_route=!0,this.contour_color=null,this.detailLoaded=!1,this.related_scenics=[],this.init(e)}),[{key:"init",value:function(t){var i;this.id=t.id,this.name=t.name,this.related_scenics=null!==(i=t.related_scenics)&&void 0!==i?i:[],this.detail=(0,r.richImgDefaultFullScreen)(t.detail),this.road_type=t.road_type,this.route=(0,o.lineString2laglngs)(t.route),this.show_route=t.show_route,this.contour_color=t.contour_color}}])}()),c=exports.RoadType=function(){return e((function t(e){i(this,t),this.id=null,this.name=null,this.show=null,this.roads=[],this.init(e)}),[{key:"init",value:function(t){this.id=t.id,this.name=t.name,this.show=t.show;for(var i=0;null!=t.roads&&i<t.roads.length;++i)this.roads.push(new d(t.roads[i]))}}])}(),m=exports.ScenicAreaMap=function(){return e((function t(e){i(this,t),this.id=null,this.name=null,this.left_up=null,this.right_up=null,this.left_down=null,this.right_down=null,this.perspectiveM=null,this.perspectiveMR=null,this.zoom=null,this.min_zoom=null,this.max_zoom=null,this.tile_dir=null,this.img_height=null,this.img_width=null,this.rotateAngle=null,this.rotateImgCenter=null,this.bound_ratio=null,this.bgcolor=null,this.init(e)}),[{key:"init",value:function(t){this.id=t.id,this.name=t.name,this.left_up=(0,o.sridlocation2laglng)(t.left_up),this.right_up=(0,o.sridlocation2laglng)(t.right_up),this.left_down=(0,o.sridlocation2laglng)(t.left_down),this.right_down=(0,o.sridlocation2laglng)(t.right_down),this.perspectiveM=(0,o.formatStringPerspectiveMat)(t.perspectiveM),this.perspectiveMR=(0,o.formatStringPerspectiveMat)(t.perspectiveMR),this.zoom=t.zoom,this.min_zoom=t.min_zoom,this.max_zoom=t.max_zoom,this.tile_dir=t.tile_dir,this.img_height=t.img_height,this.img_width=t.img_width,this.bound_ratio=t.bound_ratio,this.bgcolor=t.bgcolor,this.rotateAngle=(0,l.calcRotateAngle)([this.img_width,this.img_height],this.left_up,this.right_down)}},{key:"_rasterImage2LatLng",value:function(t){if(null==this.perspectiveMR)return function(t,i,e,n){var a=new o.LagLngPoint(0,0),s=[Math.max(0,Math.max(i[0],t[0])),i[1]-Math.max(0,Math.max(i[1],t[1]))],r=(0,l.xy2latLng)(s[0],s[1],0,0,i[0],i[1],e.longitude,e.latitude,n.longitude,n.latitude);return a.longitude=r.lon,a.latitude=r.lat,a}(t,[this.img_width,this.img_height],this.left_up,this.right_down);var i=(0,o.warpPerspective)(t[0],t[1],this.perspectiveMR);return new o.LagLngPoint(i[1],i[0])}},{key:"_latLng2rasterImage",value:function(t){return null==this.perspectiveM?function(t,i,e,o){var n=Math.min(e.longitude,o.longitude),a=Math.max(e.longitude,o.longitude),s=Math.min(e.latitude,o.latitude),r=Math.max(e.latitude,o.latitude),h=Math.min(a,Math.max(t.longitude,n)),u=Math.min(r,Math.max(t.latitude,s)),_=(0,l.latLng2xy)(h,u,0,0,i[0],i[1],e.longitude,e.latitude,o.longitude,o.latitude);return[Math.round(_.x),Math.round(_.y)]}(t,[this.img_width,this.img_height],this.left_up,this.right_down):(0,o.warpPerspective)(t.longitude,t.latitude,this.perspectiveM)}}])}(),p=function(){return e((function t(e){i(this,t),this.id=null,this.name=null,this.show=!1,this.items=[],this.requested=!1,this.init(e)}),[{key:"init",value:function(t){this.id=t.id,this.name=t.name,this.show=t.show}}])}(),g=function(){return e((function t(e){i(this,t),this.id=null,this.name=null,this.scenic_area=null,this.icon=null,this.icon_width=null,this.icon_height=null,this.orderid=null,this.init(e)}),[{key:"init",value:function(t){this.id=t.id,this.name=t.name,this.scenic_area=t.scenic_area,this.icon=t.icon,this.icon_width=t.icon_width,this.icon_height=t.icon_height,this.orderid=t.orderid}}])}();exports.ScenicArea=function(){function l(t,e){i(this,l),this.id=null,this.name=null,this.show_contour_in_parent=null,this.popup_width=null,this.detail=null,this.location=null,this.use_mlocation=null,this.mlocation=null,this.mpoly=null,this.zoom=null,this.min_zoom=null,this.max_zoom=null,this.show_contour=null,this.fill_contour=null,this.contour_color=null,this.cma_color=null,this.legend=null,this.popup_width=null,this.popup_content=null,this.show_footer=null,this.footerPosition=null,this.footer_width=null,this.footer_height=null,this.footer_legend=null,this.geotiff=null,this.geotiff_resolution=null,this.scenic_area_type=null,this.children_scenic_area_type=[],this.road_type_list=[],this.maps=[],this.map=null,this.rc=null,this.mapIndex=-1,this.detailLoaded=!1,this.scenic_area_children_loaded=!1,this.scenic_area_children=[],this.unshow_scenic={},this.audio_file=null,this.show_detail=!0,this.show_map=!0,this.show_nav=!0,this.show_audio=!0,this.multimap=[],this.cron_task_mng=null,this.nearest_show_time=null,this.recent_show_time_str=null,this.recent_show_time=null,this.today_show_time=null,this.bound_ratio=null,this.map_related_to=null,this.map_layer=1,this.init(t,e)}return e(l,[{key:"init",value:function(t,i){var e,l,a,s,h,d;this.id=t.id,this.name=t.name,this.show_contour_in_parent=t.show_contour_in_parent,this.popup_width=t.popup_width,this.detail=(0,r.richImgDefaultFullScreen)(t.detail),this.map_layer=null!==(e=t.map_layer)&&void 0!==e?e:1,i&&(wx.leaflet.map_layer=this.map_layer),this.location=(0,o.sridlocation2laglng)(t.location),this.use_mlocation=t.use_mlocation,this.mlocation=(0,o.sridlocation2laglng)(t.mlocation),this.mpoly=(0,o.polygon2latlngs)(t.mpoly),this.zoom=t.zoom,this.min_zoom=t.min_zoom,this.max_zoom=t.max_zoom,this.show_contour=t.show_contour,this.fill_contour=t.fill_contour,this.contour_color=t.contour_color,this.cma_color=t.cma_color,this.legend=null==t.legend?null:u[t.legend],this.footer_legend=null==t.footer_legend?null:_[t.footer_legend],this.popup_width=t.popup_width,this.popup_content=t.popup_content,this.show_footer=t.show_footer,this.footerPosition=t.footer_position,this.footer_width=t.footer_width,this.footer_height=t.footer_height,this.geotiff=t.geotiff,this.geotiff_resolution=t.geotiff_resolution,this.scenic_area_type=t.scenic_area_type,this.bound_ratio=null!==(l=t.bound_ratio)&&void 0!==l?l:1,this.children_scenic_area_type=[];for(var f=0;null!=t.children_scenic_area_type&&f<t.children_scenic_area_type.length;++f)this.children_scenic_area_type.push(new p(t.children_scenic_area_type[f]));this.unshow_scenic={},this.road_type_list=[];for(var w=0;null!=t.road_type_list&&w<t.road_type_list.length;++w)this.road_type_list.push(new c(t.road_type_list[w]));this.maps=[];for(var y=0;null!=t.maps&&y<t.maps.length;++y)this.maps.push(new m(t.maps[y]));this.audio_file=null!=t.audio_file?(0,n.getServeUrl)()+t.audio_file:null,this.show_detail=null===(a=t.show_detail)||void 0===a||a,this.show_map=null===(s=t.show_map)||void 0===s||s,this.show_nav=null===(h=t.show_nav)||void 0===h||h,this.show_audio=null===(d=t.show_audio)||void 0===d||d,this.multimap=[];for(var v=0;null!=t.multimap&&v<t.multimap.length;++v)this.multimap.push(new g(t.multimap[v]));this.map_related_to=t.map_related_to}},{key:"getMarkerPositon",value:function(){return this.use_mlocation?this.mlocation:this.location}},{key:"createMap",value:function(i,e,o){var n=this;n.page=i,n.maps.length>0&&(n.mapIndex=0),e.initLeafletMap((function(i){if(t=i,require("./lib/leaflet.polylineDecorator"),n.mapIndex>=0){require("./lib/my/rastercoords");var l=n.maps[n.mapIndex];n.map=t.map(e,{crs:t.CRS.Simple,minZoom:l.min_zoom,maxZoom:l.max_zoom,preferCanvas:!0});var a=[l.img_width,l.img_height];n.rc=new t.RasterCoords(n.map,a,l.bound_ratio),n.compassRotateAngle=-l.rotateAngle,null!=o&&o(l)}else n.map=t.map(e,{preferCanvas:!0}),null!=o&&o()}))}},{key:"initTileLayer",value:function(){if(wx.leaflet.map_layer=this.map_layer,this.mapIndex>=0){var i=this.maps[this.mapIndex];this.map.setView(this.rc.unproject([i.img_width/2,i.img_height/2]),i.zoom),t.tileLayer((0,n.getServeUrl)()+i.tile_dir+"/{z}/{x}/{y}.png",{noWrap:!0,bounds:this.rc.getMaxBounds(),tileBounds:this.rc.getTileBounds(),detectRetina:!0}).addTo(this.map)}else if(2==this.map_layer?(require("./lib/qq/qqlayers"),t.tileLayer.txMapTileLayer("Normal",{minNativeZoom:3,maxNativeZoom:18,minZoom:this.min_zoom,maxZoom:this.max_zoom}).addTo(this.map)):3==this.map_layer?(require("./lib/bd/tileLayer.baidu"),this.map.options.crs=t.CRS.Baidu,t.tileLayer.baidu({layer:"vec",minNativeZoom:3,maxNativeZoom:18,minZoom:this.min_zoom,maxZoom:this.max_zoom}).addTo(this.map)):4==this.map_layer?(require("./lib/td/tdlayers"),t.tileLayer.tdMapTileLayer({layer:"vec",minNativeZoom:3,maxNativeZoom:18,minZoom:this.min_zoom,maxZoom:this.max_zoom}).addTo(this.map)):5==this.map_layer?(require("./lib/gg/gglayers"),t.tileLayer.ggMapTileLayer({layer:"vec",minNativeZoom:3,maxNativeZoom:18,minZoom:this.min_zoom,maxZoom:this.max_zoom}).addTo(this.map)):6==this.map_layer?(require("./lib/bd/tileLayer.baidu"),this.map.options.crs=t.CRS.Baidu,t.tileLayer.baidu({layer:"img",minNativeZoom:3,maxNativeZoom:18,minZoom:this.min_zoom,maxZoom:this.max_zoom}).addTo(this.map)):(require("./lib/gd/gdlayers"),t.tileLayer.gdMapTileLayer({subdomains:"1234",minNativeZoom:3,maxNativeZoom:18,minZoom:this.min_zoom,maxZoom:this.max_zoom}).addTo(this.map)),this.map.setView(this.location.toArray(),this.zoom),this.mpoly.length>=2){var e=function(t){for(var i=new o.LagLngPoint(t[0].latitude,t[0].longitude),e=new o.LagLngPoint(t[0].latitude,t[0].longitude),n=1;n<t.length;++n)i.latitude=Math.min(i.latitude,t[n].latitude),i.longitude=Math.min(i.longitude,t[n].longitude),e.latitude=Math.max(e.latitude,t[n].latitude),e.longitude=Math.max(e.longitude,t[n].longitude);return[i,e]}(this.mpoly),l=t.latLng(this.location.latitude-this.bound_ratio*Math.abs(e[0].latitude-this.location.latitude),this.location.longitude-this.bound_ratio*Math.abs(e[0].longitude-this.location.longitude)),a=t.latLng(this.location.latitude+this.bound_ratio*Math.abs(e[1].latitude-this.location.latitude),this.location.longitude+this.bound_ratio*Math.abs(e[1].longitude-this.location.longitude)),s=t.latLngBounds(l,a);this.map.setMaxBounds(s)}}},{key:"showAreaContour",value:function(){null!=this.mpoly&&null!=this.show_contour&&this.show_contour&&this.showPolygon(this,8)}},{key:"initPois",value:function(){var t=this;global.wxRequest.getAllLegendList(t.id,(function(i,e){for(var o=0;o<i.length;++o)u[i[o].id]=i[o];for(var n=0;n<e.length;++n)_[e[n].id]=e[n];for(var l=[],s=0;s<t.children_scenic_area_type.length;++s)t.children_scenic_area_type[s].show&&l.push(s);for(var r=0;r<l.length;++r)t.showPois(t.children_scenic_area_type[l[r]],r==l.length-1);0==l.length&&null==t.cron_task_mng&&(t.cron_task_mng=new a.ScenicCronTaskMng,t.cron_task_mng.init(t))}))}},{key:"showPois",value:function(t,i){var e=this;if(t.requested)for(var o=0;o<t.items.length;++o)e.showPoi(t.items[o]);else global.wxRequest.getScenicAreaChildren(this.id,t.id,(function(o){for(var n={},l=0;l<t.items.length;++l)n[t.items[l].id]=t.items[l];for(var s=0;s<o.length;++s)n.hasOwnProperty(o[s].id)||t.items.push(o[s]);t.requested=!0;for(var r=0;r<t.items.length;++r)e.showPoi(t.items[r]);i&&null==e.cron_task_mng&&(e.cron_task_mng=new a.ScenicCronTaskMng,e.cron_task_mng.init(e))}))}},{key:"showPoi",value:function(i){var e,o;if(null!==(e=i.marker_times)&&void 0!==e||(i.marker_times=0),null!=i.marker_leaflet_id&&(this.map.removeLayer(wx.leaflet.L.id2obj[i.marker_leaflet_id]),i.marker_leaflet_id=null),this.mapIndex>=0){var n,l,a=this.maps[this.mapIndex];o=t.marker(this.rc.unproject(a._latLng2rasterImage(i.getMarkerPositon())),{src:null==i.legend?null:i.legend.icon,width:null==i.legend?i.footer_width:i.legend.icon_width,height:null==i.legend?26:i.legend.icon_height,title:i.name,showFooter:i.show_footer,footerWidth:(null!==(n=i.footer_width)&&void 0!==n?n:22)+(null==i.footer_legend?0:2*i.footer_legend.margin_width),footerHeight:(null!==(l=i.footer_height)&&void 0!==l?l:22)+(null==i.footer_legend?0:2*i.footer_legend.margin_height),footerPosition:i.footerPosition,footerLegend:null==i.footer_legend?null:i.footer_legend,left_badge:i.left_badge,right_badge:i.right_badge,showInCenter:!0,titleStyle:"width: max-content!important;height: max-content!important;"}).addTo(this.map)}else o=t.marker(i.getMarkerPositon().toArray(),{src:null==i.legend?null:i.legend.icon,width:null==i.legend?i.footer_width:i.legend.icon_width,height:null==i.legend?26:i.legend.icon_height,title:i.name,showFooter:i.show_footer,footerWidth:i.footer_width,footerHeight:i.footer_height,footerPosition:i.footerPosition,footerLegend:null==i.footer_legend?null:i.footer_legend,left_badge:i.left_badge,right_badge:i.right_badge,showInCenter:!0,titleStyle:"width: max-content!important;height: max-content!important;"}).addTo(this.map);i.marker_leaflet_id=o._leaflet_id,i.marker_times+=1,null!=i.popup_content&&""!=i.popup_content&&o.bindPopup(i.popup_content,{width:i.popup_width}),o.poi=i,null!=i.mpoly&&null!=i.show_contour_in_parent&&i.show_contour_in_parent&&this.showPolygon(i),o.on({click:this.clickPoi},this.page)}},{key:"hidePoi",value:function(t){null!=t.marker_leaflet_id&&this.map.removeLayer(wx.leaflet.L.id2obj[t.marker_leaflet_id]),t.marker_leaflet_id=null;var i=!1;null!=t.polyline_leaflet_id&&(this.map.removeLayer(wx.leaflet.L.id2obj[t.polyline_leaflet_id]),t.polyline_leaflet_id=null,i=!0),null!=t.marker_times&&(t.marker_times-=1,t.marker_times>0&&(t.marker_times-=1,this.showPoi(t),i&&this.showPolygon(t)))}},{key:"hidePois",value:function(t){if(t.requested)for(var i=0;i<t.items.length;++i)null!=t.items[i].marker_leaflet_id&&this.hidePoi(t.items[i])}},{key:"clickPoi",value:function(t){var i=t.target;null==i._popup?i.poi.show_detail&&this.showPoiDetailHalfScreen(i.poi):(i.togglePopup(),i.isPopupOpen()&&i.poi.show_detail&&this.showPoiDetailHalfScreen(i.poi))}},{key:"showPolygon",value:function(i,e){var o=i.mpoly;if(!(null==o||o.length<2)){null!=i.polyline_leaflet_id&&(this.map.removeLayer(wx.leaflet.L.id2obj[i.polyline_leaflet_id]),i.polyline_leaflet_id=null);var n,l=[];if(this.mapIndex>=0)for(var a=this.maps[this.mapIndex],s=0;s<o.length;++s)l.push(this.rc.unproject(a._latLng2rasterImage(o[s])));else for(var r=0;r<o.length;++r)l.push(o[r].toArray());n=i.fill_contour?t.polygon(l,{color:i.contour_color,weight:null!=e?e:4}).addTo(this.map):t.polyline(l,{color:i.contour_color,weight:null!=e?e:4}).addTo(this.map),i.polyline_leaflet_id=n._leaflet_id}}},{key:"hidePolygon",value:function(t){null!=t.polyline_leaflet_id&&(this.map.removeLayer(wx.leaflet.L.id2obj[t.polyline_leaflet_id]),t.polyline_leaflet_id=null)}},{key:"showLine",value:function(i,e,o){if(!(null==e||e.length<2)){var n=[];if(this.mapIndex>=0)for(var l=this.maps[this.mapIndex],a=0;a<e.length;++a)n.push(this.rc.unproject(l._latLng2rasterImage(e[a])));else for(var s=0;s<e.length;++s)n.push(e[s].toArray());var r=t.polyline(n,{color:i.contour_color,weight:null!=o?o:5}).addTo(this.map),h=t.polylineDecorator(r,{patterns:[{offset:0,repeat:20,symbol:t.Symbol.arrowHead({pixelSize:null!=o?o:3,headAngle:75,polygon:!1,pathOptions:{stroke:!0,weight:null!=o?o:3,color:"#fff"}})}]}).addTo(this.map);i.line_dec_leaflet_id=h._leaflet_id,i.line_leaflet_id=r._leaflet_id}}},{key:"hideLine",value:function(t){null!=t.line_leaflet_id&&(this.map.removeLayer(wx.leaflet.L.id2obj[t.line_leaflet_id]),t.line_leaflet_id=null),null!=t.line_dec_leaflet_id&&(this.map.removeLayer(wx.leaflet.L.id2obj[t.line_dec_leaflet_id]),t.line_dec_leaflet_id=null)}},{key:"showLocation",value:function(){var i=this;wx.getLocation({type:"gcj02",isHighAccuracy:!0,success:function(e){var n,l=e.latitude,a=e.longitude;e.speed,e.accuracy;if(i.mapIndex>=0){var s=i.maps[i.mapIndex];n=i.rc.unproject(s._latLng2rasterImage(new o.LagLngPoint(l,a).toGcj02()))}else{var r=new o.LagLngPoint(l,a).toGcj02();n=[r.latitude,r.longitude]}if(i.location_coords=n,i.map.setView(n),null==i.locatio_marker_leaflet_id){var u=t.marker(n,{src:h.locationNow,width:48,height:48,showInCenter:!1}).addTo(i.map);i.locatio_marker_leaflet_id=u._leaflet_id}else wx.leaflet.L.id2obj[i.locatio_marker_leaflet_id].setLatLng(n)},fail:function(t){console.log(t),null!=i.location_coords&&i.map.setView(i.location_coords)}})}},{key:"showRoadPointsDirect",value:function(t){for(var i={},e={},o=0;o<this.children_scenic_area_type.length;++o){e[this.children_scenic_area_type[o].id]=this.children_scenic_area_type[o];for(var n=0;n<this.children_scenic_area_type[o].items.length;++n){var l=this.children_scenic_area_type[o].items[n];i[l.id]=l}}for(var a in this.unshow_scenic)i.hasOwnProperty(a)||(i[a]=this.unshow_scenic[a]);for(var s=0;s<t.related_scenics.length;++s)if(i.hasOwnProperty(t.related_scenics[s])){var r=i[t.related_scenics[s]];r.left_badge=s+1,this.showPoi(r)}t.show_route&&this.showLine(t,t.route)}},{key:"showRoadPoints",value:function(t){var i=this;i.roadShowing=t;for(var e={},o={},n=0;n<i.children_scenic_area_type.length;++n){o[i.children_scenic_area_type[n].id]=i.children_scenic_area_type[n];for(var a=0;a<i.children_scenic_area_type[n].items.length;++a){var s=i.children_scenic_area_type[n].items[a];e[s.id]=s}}for(var r in i.unshow_scenic)e.hasOwnProperty(r)||(e[r]=i.unshow_scenic[r]);for(var h=[],u=0;u<t.related_scenics.length;++u)e.hasOwnProperty(t.related_scenics[u])||h.push(t.related_scenics[u]);0==h.length?i.showRoadPointsDirect(t):global.wxRequest.postScenicList(h,(function(n){for(var a=0;a<n.length;++a){var s=new l(n[a]);e.hasOwnProperty(s.id)||(o.hasOwnProperty(s.scenic_area_type)?o[s.scenic_area_type].items.push(s):i.unshow_scenic[s.id]=s)}i.showRoadPointsDirect(t)}))}},{key:"hideRoadPoints",value:function(t){for(var i={},e={},o=0;o<this.children_scenic_area_type.length;++o){e[this.children_scenic_area_type[o].id]=this.children_scenic_area_type[o];for(var n=0;n<this.children_scenic_area_type[o].items.length;++n){var l=this.children_scenic_area_type[o].items[n];i[l.id]=l}}for(var a in this.unshow_scenic)i.hasOwnProperty(a)||(i[a]=this.unshow_scenic[a]);for(var s=0;s<t.related_scenics.length;++s)if(i.hasOwnProperty(t.related_scenics[s])){var r=i[t.related_scenics[s]];r.left_badge=null,this.hidePoi(r)}this.roadShowing=null,t.show_route&&this.hideLine(t)}}])}(),exports.Track=e((function t(){i(this,t),this.id=null}));
var e=require("./request.js"),i=require("./zhconfig"),t=require("../../index"),a=require("./const");Component({properties:{rootScenicId:{type:String,value:"0"},mode:{type:String,value:a.MAP_MODE_SCENIC},modeOid:{type:String,value:""},modeType:{type:String,value:""}},data:{mapWidth:wx.getSystemInfoSync().windowWidth,mapHeight:wx.getSystemInfoSync().windowHeight,mapBgColor:"#FFFFFF",poiHalfScreenShow:!1,scenicTypeList:[],isAudioPlay:!1,poiDetailHalfScreenShow:!1,poiOfPoiDetail:null,audioRemainingTime:"00:00",loadingAudio:!0,zhgeoIcons:new i.ZhgeoIcons,roadMultiArray:[[],[]],roadMultiIndex:[0,0],showRoadControl:!1,multimap:[],baseUrl:(0,t.getServeUrl)(),scenicShowControl:!1,scenicShowHalfScreenShow:!1,scenicShowList:[],targetShowTimeScenic:null},methods:{openPoiHalfScreen:function(){this.setData({poiHalfScreenShow:!0})},openScenicShowHalfScreen:function(){for(var e=[],i=this.scenicArea.children_scenic_area_type,t=0;t<i.length;++t)for(var a=0;a<i[t].items.length;++a){var o=i[t].items[a];null!=o.nearest_show_time&&e.push(o)}e.length>0&&e.sort((function(e,i){return e.nearest_show_time.getTime()-i.nearest_show_time.getTime()})),this.setData({scenicShowHalfScreenShow:!0,scenicShowList:e})},showTargetScenicShowTimeList:function(e){for(var i=e.currentTarget.dataset.scenicid,t=this.scenicArea.children_scenic_area_type,a=null,o=0;null==a&&o<t.length;++o)for(var n=0;n<t[o].items.length;++n){var s=t[o].items[n];if(s.id==i){a=s;break}}if(null!=a&&null!=a.today_show_time){var r=null;if(null!=a.recent_show_time)for(var c in a.recent_show_time)(null==r||r.getTime()>a.recent_show_time[c].getTime())&&(r=a.recent_show_time[c]);var l=[];for(var d in a.today_show_time)for(var u=0;u<a.today_show_time[d].length;++u){var h=a.today_show_time[d][u];null!=r?r.getTime()-1e3<=h.getTime()&&l.push(h):l.push(h)}l.sort((function(e,i){return e.getTime()-i.getTime()})),a.show_time_str_list=[];for(var g=0;g<l.length;++g){var m=l[g],f=m.getMonth()+"月"+m.getDate()+"日 "+m.getHours()+"时"+m.getMinutes()+"分";a.show_time_str_list.push(f)}this.setData({targetShowTimeScenic:a})}},showAllScenicShowTimeList:function(){this.setData({targetShowTimeScenic:null})},_showTypeCheckboxChange:function(e,i){for(var t=e.detail.value,a=0;a<i.length;++a){for(var o=!1,n=0;n<t.length;++n)if(i[a].id==t[n]){o=!0,i[a].show||(i[a].show=!0,this.scenicArea.showPois(i[a]));break}o||i[a].show&&(i[a].show=!1,this.scenicArea.hidePois(i[a]))}},scenicTypeCheckboxChange:function(e){this._showTypeCheckboxChange(e,this.data.scenicTypeList)},showPoiDetailHalfScreen:function(i){var t=this;null!=t.audioContext&&(t.audioContext.stop(),t.audioContext.destroy(),t.audioContext=null),i.show_audio&&(t.audioContext=wx.createInnerAudioContext(),t.audioContext.onCanplay((function(){console.log("can play"),t.data.loadingAudio,t.setData({loadingAudio:!1})})),t.audioContext.onTimeUpdate((function(){var e=t.calcAudioTime();t.setData({audioRemainingTime:e})})),t.audioContext.onEnded((function(){t.setData({isAudioPlay:!1})}))),i.detailLoaded?(null!=t.audioContext&&(t.audioContext.src=i.audio_file),t.setData({loadingAudio:!0,isAudioPlay:!1,poiDetailHalfScreenShow:!0,poiOfPoiDetail:i,audioRemainingTime:"00:00"})):(0,e.getScenicAreaDetail)(i,(function(e){t.showPoiDetailHalfScreen(e)}))},closeDetailHalfScreen:function(){var e=this.data.poiOfPoiDetail;this.scenicArea.map._container.wxDomUtils.closePoiPopup(e)},playAudio:function(){var e=this;e.data.loadingAudio||(e.audioContext.play(),setTimeout((function(){e.audioContext.paused}),100),this.setData({isAudioPlay:!0}))},stopAudio:function(){this.audioContext.pause(),this.setData({isAudioPlay:!1})},routerNavToChildScenic:function(){var e;null!=this.data.poiOfPoiDetail&&this.triggerEvent("changeScenic",{scenicId:null!==(e=this.data.poiOfPoiDetail.map_related_to)&&void 0!==e?e:this.data.poiOfPoiDetail.id})},routerNavToMultimap:function(e){var i=e.currentTarget.dataset.scenicid;this.triggerEvent("redirectScenic",{scenicId:i})},navigateToPoi:function(){if(null!=this.data.poiOfPoiDetail&&null!=this.data.poiOfPoiDetail.location){var e=[this.data.poiOfPoiDetail.location.longitude,this.data.poiOfPoiDetail.location.latitude],i=e[1],t=e[0];wx.openLocation({latitude:i,longitude:t,scale:this.data.poiOfPoiDetail.zoom})}},triggerTrail:function(){},bindRoudMultiPickerChange:function(i){var t=this;if(null!=t.scenicArea.roadShowing&&t.scenicArea.hideRoadPoints(t.scenicArea.roadShowing),i.detail.value[0]>0){var a=i.detail.value[0]-1,o=t.scenicArea.road_type_list[a].roads[i.detail.value[1]];o.detailLoaded?t.scenicArea.showRoadPoints(o):(0,e.getRoadDetail)(t.scenicArea,o,(function(e){t.scenicArea.showRoadPoints(e)}))}this.setData({roadMultiIndex:i.detail.value})},bindRoudMultiPickerColumnChange:function(e){var i={roadMultiArray:this.data.roadMultiArray,roadMultiIndex:this.data.roadMultiIndex};switch(i.roadMultiIndex[e.detail.column]=e.detail.value,e.detail.column){case 0:if(i.roadMultiArray[1]=[],e.detail.value>0){for(var t=e.detail.value-1,a=0;a<this.scenicArea.road_type_list[t].roads.length;++a)i.roadMultiArray[1].push(this.scenicArea.road_type_list[t].roads[a].name);i.roadMultiIndex[1]=0,console.log(i.roadMultiIndex)}}console.log(i.roadMultiIndex),this.setData(i)},calcAudioTime:function(){var e=Math.round(this.audioContext.duration-this.audioContext.currentTime);if(e!=this.audioRemainingTime){this.audioRemainingTime=e;var i=Math.floor(e/60);return i+":"+Math.round(e-60*i)}var t=Math.floor(this.audioRemainingTime/60);return t+":"+Math.round(this.audioRemainingTime-60*t)},showModePoints:function(){var i=this;null!=i.scenicArea.roadShowing&&i.scenicArea.hideRoadPoints(i.scenicArea.roadShowing),(0,e.getModePointsDetail)(i.data.modeOid,i.data.modeType,(function(e){i.scenicArea.showRoadPoints(e)}))}},lifetimes:{ready:function(){var i=this,t=this.selectComponent("#zhmap-container");t.initLeafletMap((function(o){var n,s;null!==(s=(n=wx).leaflet)&&void 0!==s||(n.leaflet={}),wx.leaflet.L=o,(0,e.getScenicArea)(i.data.rootScenicId,(function(e){i.scenicArea=e,i.triggerEvent("updateBarTitle",{scenicName:i.scenicArea.name}),i.scenicArea.createMap(i,t,(function(e){var o,n;if(t.showLocation=i.scenicArea.showLocation.bind(i.scenicArea),i.scenicArea.initTileLayer(),i.scenicArea.showAreaContour(),i.data.mode==a.MAP_MODE_POINTS){i.showModePoints();for(var s=0;s<i.scenicArea.children_scenic_area_type.length;++s)i.scenicArea.children_scenic_area_type[s].show=!1}i.scenicArea.initPois();for(var r=[["无"],[]],c=0;c<i.scenicArea.road_type_list.length;++c)r[0].push(i.scenicArea.road_type_list[c].name);t.setData({compassRotateAngle:null!==(o=i.scenicArea.compassRotateAngle)&&void 0!==o?o:0,markerBorderColor:i.scenicArea.cma_color}),i.setData({mapBgColor:null==e?"#FFFFFF":e.bgcolor,rootScenicId:i.scenicArea.id,scenicTypeList:i.scenicArea.children_scenic_area_type,roadMultiArray:r,showRoadControl:i.scenicArea.road_type_list.length>0&&i.data.mode!=a.MAP_MODE_POINTS,multimap:null!==(n=i.scenicArea.multimap)&&void 0!==n?n:[]})}))}),!0)}))},detached:function(){null!=this.audioContext&&(this.audioContext.stop(),this.audioContext.destroy(),this.audioContext=null),null!=this.scenicArea.cron_task_mng&&(this.scenicArea.cron_task_mng.stop(),this.scenicArea.cron_task_mng=null)}},pageLifetimes:{show:function(){console.log("show page");null==this.scenicArea||null==this.scenicArea.cron_task_mng||this.scenicArea.cron_task_mng.running||this.scenicArea.cron_task_mng.start()},hide:function(){console.log("hide page");null!=this.scenicArea&&null!=this.scenicArea.cron_task_mng&&this.scenicArea.cron_task_mng.running&&this.scenicArea.cron_task_mng.stop()}}});
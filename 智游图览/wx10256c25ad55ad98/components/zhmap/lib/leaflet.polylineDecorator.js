var t=function(t,i){return(180*Math.atan2(i.y-t.y,i.x-t.x)/Math.PI+90+360)%360},i=function(t,i){var n=t.value;return t.isInPixels?n/i:n};function n(t){if("string"==typeof t&&-1!==t.indexOf("%"))return{value:parseFloat(t)/100,isInPixels:!1};var i=t?parseFloat(t):0;return{value:i,isInPixels:i>0}}var e,o,a;function r(i){return i.reduce((function(i,n,e,o){if(e>0&&!function(t,i){return t.x===i.x&&t.y===i.y}(n,o[e-1])){var a=o[e-1],r=i.length>0?i[i.length-1].distB:0,s=(l=a,h=(p=n).x-l.x,u=p.y-l.y,Math.sqrt(h*h+u*u));i.push({a:a,b:n,distA:r,distB:r+s,heading:t(a,n)})}var l,p,h,u;return i}),[])}function s(t,i,n){return i.x!==t.x?{x:t.x+n*(i.x-t.x),y:t.y+n*(i.y-t.y)}:{x:t.x,y:t.y+(i.y-t.y)*n}}e=wx.leaflet.L.Marker.prototype._initIcon,o=wx.leaflet.L.Marker.prototype._setPos,a="msTransform"===wx.leaflet.L.DomUtil.TRANSFORM,wx.leaflet.L.Marker.addInitHook((function(){var t=this.options.icon&&this.options.icon.options&&this.options.icon.options.iconAnchor;t&&(t=t[0]+"px "+t[1]+"px"),this.options.rotationOrigin=this.options.rotationOrigin||t||"center bottom",this.options.rotationAngle=this.options.rotationAngle||0,this.on("drag",(function(t){t.target._applyRotation()}))})),wx.leaflet.L.Marker.include({_initIcon:function(){e.call(this)},_setPos:function(t){o.call(this,t),this._applyRotation()},_applyRotation:function(){this.options.rotationAngle&&(this._icon.style[wx.leaflet.L.DomUtil.TRANSFORM+"Origin"]=this.options.rotationOrigin,a?this._icon.style[wx.leaflet.L.DomUtil.TRANSFORM]="rotate("+this.options.rotationAngle+"deg)":this._icon.style[wx.leaflet.L.DomUtil.TRANSFORM]+=" rotateZ("+this.options.rotationAngle+"deg)")},setRotationAngle:function(t){return this.options.rotationAngle=t,this.update(),this},setRotationOrigin:function(t){return this.options.rotationOrigin=t,this.update(),this}}),wx.leaflet.L.Symbol=wx.leaflet.L.Symbol||{},wx.leaflet.L.Symbol.Dash=wx.leaflet.L.Class.extend({options:{pixelSize:10,pathOptions:{}},initialize:function(t){wx.leaflet.L.Util.setOptions(this,t),this.options.pathOptions.clickable=!1},buildSymbol:function(t,i,n,e,o){var a=this.options,r=Math.PI/180;if(a.pixelSize<=1)return wx.leaflet.L.polyline([t.latLng,t.latLng],a.pathOptions);var s=n.project(t.latLng),l=-(t.heading-90)*r,p=wx.leaflet.L.point(s.x+a.pixelSize*Math.cos(l+Math.PI)/2,s.y+a.pixelSize*Math.sin(l)/2),h=s.add(s.subtract(p));return wx.leaflet.L.polyline([n.unproject(p),n.unproject(h)],a.pathOptions)}}),wx.leaflet.L.Symbol.dash=function(t){return new wx.leaflet.L.Symbol.Dash(t)},wx.leaflet.L.Symbol.ArrowHead=wx.leaflet.L.Class.extend({options:{polygon:!0,pixelSize:10,headAngle:60,pathOptions:{stroke:!1,weight:2}},initialize:function(t){wx.leaflet.L.Util.setOptions(this,t),this.options.pathOptions.clickable=!1},buildSymbol:function(t,i,n,e,o){return this.options.polygon?wx.leaflet.L.polygon(this._buildArrowPath(t,n),this.options.pathOptions):wx.leaflet.L.polyline(this._buildArrowPath(t,n),this.options.pathOptions)},_buildArrowPath:function(t,i){var n=Math.PI/180,e=i.project(t.latLng),o=-(t.heading-90)*n,a=this.options.headAngle/2*n,r=o+a,s=o-a,l=wx.leaflet.L.point(e.x-this.options.pixelSize*Math.cos(r),e.y+this.options.pixelSize*Math.sin(r)),p=wx.leaflet.L.point(e.x-this.options.pixelSize*Math.cos(s),e.y+this.options.pixelSize*Math.sin(s));return[i.unproject(l),t.latLng,i.unproject(p)]}}),wx.leaflet.L.Symbol.arrowHead=function(t){return new wx.leaflet.L.Symbol.ArrowHead(t)},wx.leaflet.L.Symbol.Marker=wx.leaflet.L.Class.extend({options:{markerOptions:{},rotate:!1},initialize:function(t){wx.leaflet.L.Util.setOptions(this,t),this.options.markerOptions.clickable=!1,this.options.markerOptions.draggable=!1},buildSymbol:function(t,i,n,e,o){return this.options.rotate&&(this.options.markerOptions.rotationAngle=t.heading+(this.options.angleCorrection||0)),wx.leaflet.L.marker(t.latLng,this.options.markerOptions)}}),wx.leaflet.L.Symbol.marker=function(t){return new wx.leaflet.L.Symbol.Marker(t)};var l=function(t){return Array.isArray(t)&&((i=t[0])instanceof wx.leaflet.L.LatLng||Array.isArray(i)&&2===i.length&&"number"==typeof i[0]);var i};wx.leaflet.L.PolylineDecorator=wx.leaflet.L.FeatureGroup.extend({options:{patterns:[]},initialize:function(t,i){wx.leaflet.L.FeatureGroup.prototype.initialize.call(this),wx.leaflet.L.Util.setOptions(this,i),this._map=null,this._paths=this._initPaths(t),this._bounds=this._initBounds(),this._patterns=this._initPatterns(this.options.patterns)},_initPaths:function(t,i){var n=this;return l(t)?[i?t.concat([t[0]]):t]:t instanceof wx.leaflet.L.Polyline?this._initPaths(t.getLatLngs(),t instanceof wx.leaflet.L.Polygon):Array.isArray(t)?t.reduce((function(t,e){return t.concat(n._initPaths(e,i))}),[]):[]},_initPatterns:function(t){return t.map(this._parsePatternDef)},setPatterns:function(t){this.options.patterns=t,this._patterns=this._initPatterns(this.options.patterns),this.redraw()},setPaths:function(t){this._paths=this._initPaths(t),this._bounds=this._initBounds(),this.redraw()},_parsePatternDef:function(t,i){return{symbolFactory:t.symbol,offset:n(t.offset),endOffset:n(t.endOffset),repeat:n(t.repeat)}},onAdd:function(t){this._map=t,this._draw(),this._map.on("moveend",this.redraw,this)},onRemove:function(t){this._map.off("moveend",this.redraw,this),this._map=null,wx.leaflet.L.FeatureGroup.prototype.onRemove.call(this,t)},_initBounds:function(){var t=this._paths.reduce((function(t,i){return t.concat(i)}),[]);return wx.leaflet.L.latLngBounds(t)},getBounds:function(){return this._bounds},_buildSymbols:function(t,i,n){var e=this;return n.map((function(o,a){return i.buildSymbol(o,t,e._map,a,n.length)}))},_getDirectionPoints:function(t,n){var e=this;return t.length<2?[]:function(t,n){var e=r(t),o=e.length;if(0===o)return[];var a=e[o-1].distB,l=i(n.offset,a),p=i(n.endOffset,a),h=a*i(n.repeat,a),u=p>0?a*p:0,f=[],c=l>0?a*l:0;do{f.push(c),c+=h}while(h>0&&c<a-u);var x=0,d=e[0];return f.map((function(t){for(;t>d.distB&&x<o-1;)x++,d=e[x];var i=(t-d.distA)/(d.distB-d.distA);return{pt:s(d.a,d.b,i),heading:d.heading}}))}(t.map((function(t){return e._map.project(t)})),n).map((function(t){return{latLng:e._map.unproject(wx.leaflet.L.point(t.pt)),heading:t.heading}}))},redraw:function(){this._map&&(this.clearLayers(),this._draw())},_getPatternLayers:function(t){var i=this,n=this._map.getBounds().pad(.1);return this._paths.map((function(e){var o=i._getDirectionPoints(e,t).filter((function(t){return n.contains(t.latLng)}));return wx.leaflet.L.featureGroup(i._buildSymbols(e,t.symbolFactory,o))}))},_draw:function(){var t=this;this._patterns.map((function(i){return t._getPatternLayers(i)})).forEach((function(i){t.addLayer(wx.leaflet.L.featureGroup(i))}))}}),wx.leaflet.L.polylineDecorator=function(t,i){return new wx.leaflet.L.PolylineDecorator(t,i)};
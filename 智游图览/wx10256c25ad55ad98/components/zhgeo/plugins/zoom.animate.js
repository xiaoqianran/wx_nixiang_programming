var t=require("../../../@babel/runtime/helpers/objectSpread2"),n=require("../../zhgeo/level.manager"),i=n.layerLeafletId2name,a=n.canvasImageId2name,e=wx.leaflet.L;e.Map.mergeOptions({pinchAnimateDuration:60,zoomAnimation:!1,zoomingDelay:60}),e.Map.prototype.__moveEnd4zoomAni||(e.Map.prototype.__moveEnd4zoomAni=e.Map.prototype._moveEnd),e.Map.include({_animatePinching:function(t){return this.fire("pinching",t)},_animatePinchEnd:function(t){return this.fire("pinchend",t)},_animatePinchFinalCallback:function(t){t.animateEndCallback&&t.isLastListener&&t.animateEndCallback()},_moveEnd:function(t){return this.processLastPinchEndState(),e.Map.prototype.__moveEnd4zoomAni.call(this,t)},processLastPinchEndState:function(){var t=this;if(null!=t.lastPinchEndState){if(null!=t.lastPinchEndState.tileLayers)for(var n=0;n<t.lastPinchEndState.tileLayers.length;++n){var e=t._container.data.tileLayers[i(t.lastPinchEndState.tileLayers[n])];null!=e&&this._container.wxDomUtils.tileLayerTransform(e.getHidingLevel(),[{translate:[0,0],scale:[1,1],transformOrigin:t.lastPinchEndState.mapOrigin}])}if(null!=t.lastPinchEndState.canvasLayers)for(n=0;n<t.lastPinchEndState.canvasLayers.length;++n){var o=t._container.data.canvasImages[a(t.lastPinchEndState.canvasLayers[n])];null!=o&&this._container.wxDomUtils.overlayCanvasTransform(o.getHidingImage(),[{translate:[0,0],scale:[1,1],transformOrigin:t.lastPinchEndState.canvasOrigin}])}this._container.wxDomUtils.markerLayerTransform(null,[{translate:[0,0]}]),this._container.wxDomUtils.imageLayerTransform(null,[{translate:[0,0]}]),t.lastPinchEndState=null}},getTileLayerTransformOrigin:function(t){var n=this._container.wxDomUtils.getBoundingClientRect(),i=this._container.wxDomUtils.getMapPanePosition(),a=(t.x+n.left-i.x)/n.width*100,e=(t.y+n.top-i.y)/n.height*100;return Math.round(a)+"% "+Math.round(e)+"% 0"},getOverlayCanvasTransformOrigin:function(t){var n=e.point(0,0),i=e.point(0,0),a=this._container.wxDomUtils.getOverlayCanvasSize(),o=(t.x-(i.x+n.x))/a.width*100,s=(t.y-(i.y+n.y))/a.height*100;return Math.round(o)+"% "+Math.round(s)+"% 0"},getTransformOrigin:function(t,n,i){var a=this._container.wxDomUtils.getMapPanePosition(),e=(t.x-(n.x+i.width/2+a.x))/i.width*100,o=(t.y-(n.y+i.height/2+a.y))/i.height*100;return Math.round(e)+"% "+Math.round(o)+"% 0"},setZoomAround:function(t,n,i){var a=this,o=this;if(!o._zooming){o._zooming=!0,o.processLastPinchEndState();var s=a.getZoomScale(n),r=a.getSize().divideBy(2),c=t instanceof e.Point?t:a.latLngToContainerPoint(t),m=c.subtract(r).multiplyBy(1-1/s),h=a.containerPointToLatLng(r.add(m)),l=o.getTileLayerTransformOrigin(c),_=o.getOverlayCanvasTransformOrigin(c),f=o.getZoom();o._animatePinching({pinchOffset:e.point(0,0),centerOffset:m,center:h,startZoom:f,currentZoom:f,mapOrigin:l,canvasOrigin:_,scale:1,centerPoint:c});var g=n;o.lastPinchEndState={centerOffset:m,pinchOffset:e.point(0,0),center:h,startZoom:f,endZoom:g,currentZoom:f,mapOrigin:l,canvasOrigin:_,animateEndZoomScale:o.getZoomScale(g,f),finalZoomScale:1,pinchStartLatLng:o.getCenter(),centerPoint:c,endCenter:h};var p=e.Util.extend({},o.lastPinchEndState,{animateEndCallback:function(){a.setView(h,n,{zoom:i}),setTimeout((function(){o._zooming=!1}),o.options.zoomingDelay)}});o._animatePinchEnd(p)}}}),e.Marker.include({_baseEvents:e.Marker.prototype.getEvents(),getEvents:function(){return t(t({},this._baseEvents),{},{pinching:this._animatePinching,pinchend:this._animatePinchEnd})},_markerOffset:function(t,n,i,a){return this._map._latLngToNewLayerPoint(this._latlng,i,a)._add(t)._subtract(e.point(this._icon.left,this._icon.top))._add(n)},_animatePinching:function(t){var n=this._map,i=this._markerOffset(t.centerOffset,t.pinchOffset,t.currentZoom,t.center);this._lastAnimPinchKeyframe={translate:[i.x,i.y]},n._container.wxDomUtils.markerLayerTransform("#marker-"+this._icon._leaflet_id,[this._lastAnimPinchKeyframe])},_animatePinchEnd:function(t){var n=this,i=n._map;if(t.endZoom===t.startZoom)this._map._container.wxDomUtils.markerLayerTransform("#marker-"+this._icon._leaflet_id,[{translate:[0,0]}],0,(function(){n._map._animatePinchFinalCallback(t)}));else{var a=i._latLngToNewLayerPoint(n._latlng,t.endZoom,t.endCenter)._subtract(e.point(n._icon.left,n._icon.top));n._lastAnimPinchKeyframe.offset=0;var o=[n._lastAnimPinchKeyframe,{translate:[a.x,a.y],offset:1}];this._map._container.wxDomUtils.markerLayerTransform("#marker-"+this._icon._leaflet_id,o,this._map.options.pinchAnimateDuration,(function(){t.startZoom!==t.endZoom&&n._removeIcon(!0),n._map._animatePinchFinalCallback(t)}))}this._lastAnimPinchKeyframe=null}}),e.GridLayer.include({_baseEvents:e.GridLayer.prototype.getEvents(),getEvents:function(){return t(t({},this._baseEvents),{},{pinching:this._animatePinching,pinchend:this._animatePinchEnd})},_animatePinching:function(t){this._lastAnimPinchKeyframe={translate:[t.pinchOffset.x,t.pinchOffset.y],scale:[t.scale,t.scale],transformOrigin:t.mapOrigin},this._map._container.wxDomUtils.tileLayerTransform(this._map._container.data.tileLayers[i(this._leaflet_id)].getShowingLevel(),[this._lastAnimPinchKeyframe])},_animatePinchEnd:function(t){var n,a,e=this._map;null!=e.lastPinchEndState&&(null!==(a=(n=e.lastPinchEndState).tileLayers)&&void 0!==a||(n.tileLayers=[]),e.lastPinchEndState.tileLayers.push(this._leaflet_id));t.startZoom===t.endZoom?e._container.wxDomUtils.tileLayerTransform(this._map._container.data.tileLayers[i(this._leaflet_id)].getShowingLevel(),[{translate:[0,0],scale:[t.finalZoomScale,t.finalZoomScale],transformOrigin:t.mapOrigin}],0,(function(){e._animatePinchFinalCallback(t)})):(e._container.wxDomUtils.tileLayerTransform(this._map._container.data.tileLayers[i(this._leaflet_id)].getHidingLevel(),[{translate:[0,0],scale:[t.finalZoomScale,t.finalZoomScale],transformOrigin:t.mapOrigin}]),this._lastAnimPinchKeyframe.offset=0,e._container.wxDomUtils.tileLayerTransform(this._map._container.data.tileLayers[i(this._leaflet_id)].getShowingLevel(),[this._lastAnimPinchKeyframe,{translate:[t.pinchOffset.x,t.pinchOffset.y],scale:[t.animateEndZoomScale,t.animateEndZoomScale],transformOrigin:t.mapOrigin,offset:1}],e.options.pinchAnimateDuration,(function(){e._animatePinchFinalCallback(t)}))),this._lastAnimPinchKeyframe=null}}),e.Canvas.include({_baseEvents:e.Canvas.prototype.getEvents(),getEvents:function(){return t(t({},this._baseEvents),{},{pinching:this._animatePinching,pinchend:this._animatePinchEnd})},_animatePinching:function(t){this._lastAnimPinchKeyframe={translate:[t.pinchOffset.x,t.pinchOffset.y],scale:[t.scale,t.scale],transformOrigin:t.canvasOrigin},this._map._container.wxDomUtils.overlayCanvasTransform(this._map._container.data.canvasImages[a(this._leaflet_id)].getShowingImage(),[this._lastAnimPinchKeyframe])},_animatePinchEnd:function(t){var n,i,e=this._map;null!=e.lastPinchEndState&&(null!==(i=(n=e.lastPinchEndState).canvasLayers)&&void 0!==i||(n.canvasLayers=[]),e.lastPinchEndState.canvasLayers.push(this._leaflet_id));t.startZoom===t.endZoom?this._map._container.wxDomUtils.overlayCanvasTransform(this._map._container.data.canvasImages[a(this._leaflet_id)].getShowingImage(),[{translate:[0,0],scale:[t.finalZoomScale,t.finalZoomScale],transformOrigin:t.canvasOrigin}],0,(function(){e._animatePinchFinalCallback(t)})):(this._map._container.wxDomUtils.overlayCanvasTransform(this._map._container.data.canvasImages[a(this._leaflet_id)].getHidingImage(),[{translate:[0,0],scale:[t.finalZoomScale,t.finalZoomScale],transformOrigin:t.canvasOrigin}]),this._lastAnimPinchKeyframe.offset=0,this._map._container.wxDomUtils.overlayCanvasTransform(this._map._container.data.canvasImages[a(this._leaflet_id)].getShowingImage(),[this._lastAnimPinchKeyframe,{translate:[t.pinchOffset.x,t.pinchOffset.y],scale:[t.animateEndZoomScale,t.animateEndZoomScale],transformOrigin:t.canvasOrigin,offset:1}],this._map.options.pinchAnimateDuration,(function(){e._animatePinchFinalCallback(t)}))),this._lastAnimPinchKeyframe=null}}),e.Map.TouchZoom.include({addHooks:function(){e.DomEvent.on(this._map._container,"pinch",this._onPinch,this)},removeHooks:function(){e.DomEvent.off(this._map._container,"pinch",this._onPinch,this)},_onPinch:function(t){var n=this._map;"running"==t.status?null!=n._zooming&&n._zooming?this._onTouchMove(t):this._onTouchStart(t):"stop"==t.status&&this._onTouchEnd(t)},_onTouchStart:function(t){var n=this._map;if(t.touches&&2===t.touches.length&&!n._animatingZoom&&!n._zooming){n._zooming=!0,n.processLastPinchEndState();var i=n.mouseEventToContainerPoint(t.touches[0]),a=n.mouseEventToContainerPoint(t.touches[1]);this.centerPoint=i.clone().add(a)._divideBy(2),this._tileLayerTransformOrigin=n.getTileLayerTransformOrigin(this.centerPoint),this._overlayCanvasTransformOrigin=n.getOverlayCanvasTransformOrigin(this.centerPoint),this._centerPoint=n.getSize()._divideBy(2),this._startLatLng=n.containerPointToLatLng(this._centerPoint),this._pinchStartLatLng=n.containerPointToLatLng(i.add(a)._divideBy(2)),this._startDist=i.distanceTo(a),this._startZoom=n.getZoom(),this._moved=!1,this._centerOffset=n.project(this._pinchStartLatLng,this._startZoom)._subtract(n.project(this._startLatLng,this._startZoom)),n._stop(),e.DomEvent.preventDefault(t)}},_onTouchMove:function(t){var n=this._map;if(t.touches&&2===t.touches.length&&n._zooming){var i=n.mouseEventToContainerPoint(t.touches[0]),a=n.mouseEventToContainerPoint(t.touches[1]),o=i.distanceTo(a)/this._startDist;if(o*=null==n.lastPinchEndState?1:n.lastPinchEndState.scale,this._zoom=n.getScaleZoom(o,this._startZoom),n.options.bounceAtZoomLimits||!(this._zoom<n.getMinZoom()&&o<1||this._zoom>n.getMaxZoom()&&o>1)){o=n.getZoomScale(this._zoom,this._startZoom);var s=i._add(a)._divideBy(2)._subtract(this._centerPoint);1===o&&0===s.x&&0===s.y||(this._center=n.unproject(n.project(this._pinchStartLatLng,this._zoom).subtract(s),this._zoom),this._pinchOffset=n.project(this._startLatLng,this._zoom).subtract(n.project(this._center,this._zoom)),this._moved||(n._moveStart(!0,!1),this._moved=!0),this._pinchingScale=o,n._animatePinching({pinchOffset:this._pinchOffset,centerOffset:this._centerOffset,center:this._pinchStartLatLng,startZoom:this._startZoom,currentZoom:this._zoom,mapOrigin:this._tileLayerTransformOrigin,canvasOrigin:this._overlayCanvasTransformOrigin,scale:this._pinchingScale,centerPoint:this.centerPoint}),e.DomEvent.preventDefault(t))}}},_onTouchEnd:function(t){var n=this,i=this._map;if(this._moved&&i._zooming){var a,o;o=this._map._limitZoom(this._zoom>this._startZoom?Math.ceil(this._zoom):Math.floor(this._zoom)),a=1,this._pinchOffset=i.project(this._startLatLng,o).subtract(i.project(this._center,o));var s=i.unproject(i.project(n._pinchStartLatLng,o)._subtract(n._centerOffset)._subtract(n._pinchOffset),o);i.lastPinchEndState={centerOffset:this._centerOffset,pinchOffset:this._pinchOffset,center:this._center,startZoom:this._startZoom,endZoom:o,currentZoom:this._zoom,mapOrigin:this._tileLayerTransformOrigin,canvasOrigin:this._overlayCanvasTransformOrigin,animateEndZoomScale:this._map.getZoomScale(o,this._startZoom),finalZoomScale:a,pinchStartLatLng:this._pinchStartLatLng,centerPoint:this.centerPoint,endCenter:s};var r=e.Util.extend({},i.lastPinchEndState,{animateEndCallback:function(){o===n._startZoom?n._map.setView(s):n._map._resetView(s,o,{pinch:!0,round:!1}),setTimeout((function(){i._zooming=!1}),i.options.zoomingDelay)}});i._animatePinchEnd(r)}else i._zooming=!1}}),e.Control.Zoom.include({_zoomAnimate:function(t,n){var i=this._map;i.processLastPinchEndState();var a=i.getSize()._divideBy(2),o=i.getTileLayerTransformOrigin(a),s=i.getOverlayCanvasTransformOrigin(a),r=i.getZoom();i._animatePinching({pinchOffset:e.point(0,0),centerOffset:e.point(0,0),center:i.getCenter(),startZoom:r,currentZoom:r,mapOrigin:o,canvasOrigin:s,scale:1,centerPoint:a});i.lastPinchEndState={centerOffset:e.point(0,0),pinchOffset:e.point(0,0),center:i.getCenter(),startZoom:r,endZoom:t,currentZoom:r,mapOrigin:o,canvasOrigin:s,animateEndZoomScale:i.getZoomScale(t,r),finalZoomScale:1,pinchStartLatLng:i.getCenter(),centerPoint:a,endCenter:i.getCenter()};var c=e.Util.extend({},i.lastPinchEndState,{animateEndCallback:function(){n(),setTimeout((function(){i._zooming=!1}),i.options.zoomingDelay)}});i._animatePinchEnd(c)},_zoomIn:function(t){var n=this._map;if(!this._disabled&&this._map._zoom<this._map.getMaxZoom()&&!n._zooming){n._zooming=!0;var i=n.options.zoomDelta*(t.shiftKey?3:1),a=n.getZoom()+i;this._zoomAnimate(a,(function(){n.zoomIn(i)}))}},_zoomOut:function(t){var n=this._map;if(!this._disabled&&this._map._zoom>this._map.getMinZoom()&&!n._zooming){n._zooming=!0;var i=n.options.zoomDelta*(t.shiftKey?3:1),a=n.getZoom()-i;this._zoomAnimate(a,(function(){n.zoomOut(i)}))}}}),e.ImageOverlay.include({_baseEvents:e.ImageOverlay.prototype.getEvents(),getEvents:function(){return t(t({},this._baseEvents),{},{pinching:this._animatePinching,pinchend:this._animatePinchEnd})},_imageOffset:function(t,n,i,a,o){var s=e.point(this._image.left+this._image.width/2,this._image.top+this._image.height/2);return this._map._latLngToNewLayerPoint(t,a,o)._add(n)._subtract(s)._add(i)},_animatePinching:function(t){this._map;null==this._transformOrigin&&(this._transformOrigin="50% 50% 0");var n=this._bounds.getCenter(),i=this._imageOffset(n,t.centerOffset,t.pinchOffset,t.currentZoom,t.center);this._lastAnimPinchKeyframe={translate:[i.x,i.y],scale:[t.scale,t.scale],transformOrigin:this._transformOrigin},this._map._container.wxDomUtils.imageLayerTransform(this.getElement(),[this._lastAnimPinchKeyframe])},_animatePinchEnd:function(t){var n=this._map,i=this;if(t.endZoom===t.startZoom)this._map._container.wxDomUtils.imageLayerTransform(this.getElement(),[{translate:[0,0],scale:[1,1],transformOrigin:i._transformOrigin}],0,(function(){n._animatePinchFinalCallback(t)}));else{var a=i._bounds.getCenter(),o=e.point(this._image.left+this._image.width/2,this._image.top+this._image.height/2),s=n._latLngToNewLayerPoint(a,t.endZoom,t.endCenter)._subtract(o);this._lastAnimPinchKeyframe.offset=0;var r=[this._lastAnimPinchKeyframe,{translate:[s.x,s.y],scale:[t.animateEndZoomScale,t.animateEndZoomScale],transformOrigin:i._transformOrigin,offset:1}];this._map._container.wxDomUtils.imageLayerTransform(this.getElement(),r,this._map.options.pinchAnimateDuration,(function(){i.remove(!0),n._animatePinchFinalCallback(t)}))}this._lastAnimPinchKeyframe=null,this._transformOrigin=null}}),e.Popup.include({_baseEvents:e.Popup.prototype.getEvents(),getEvents:function(){return t(t({},this._baseEvents),{},{pinching:this._animatePinching,pinchend:this._animatePinchEnd})},_markerOffset:function(t,n,i,a){var o=this._map._latLngToNewLayerPoint(this._latlng,i,a)._add(t)._add(n);if(null!=this._source._icon)o=o._subtract(e.point(this._source._icon.left,this._source._icon.top));else{var s=this._map.latLngToLayerPoint(this._latlng);o=o._subtract(s)}return o},_animatePinching:function(t){var n=this._map,i=this._markerOffset(t.centerOffset,t.pinchOffset,t.currentZoom,t.center);this._lastAnimPinchKeyframe={translate:[i.x,i.y]},this.isOpen()&&n._container.wxDomUtils.markerLayerTransform("#popup-"+this._container._leaflet_id,[this._lastAnimPinchKeyframe])},_animatePinchEnd:function(t){var n=this,i=n._map;if(t.endZoom===t.startZoom)this.isOpen()&&this._map._container.wxDomUtils.markerLayerTransform("#popup-"+this._container._leaflet_id,[{translate:[0,0]}],0,(function(){i._animatePinchFinalCallback(t)}));else{var a=i._latLngToNewLayerPoint(n._latlng,t.endZoom,t.endCenter);if(null!=n._source._icon)a=a._subtract(e.point(n._source._icon.left,n._source._icon.top));else{var o=i.latLngToLayerPoint(this._latlng);a=a._subtract(o)}n._lastAnimPinchKeyframe.offset=0;var s=[n._lastAnimPinchKeyframe,{translate:[a.x,a.y],offset:1}];n.isOpen()&&i._container.wxDomUtils.markerLayerTransform("#popup-"+this._container._leaflet_id,s,this._map.options.pinchAnimateDuration,(function(){i._container.wxDomUtils.removePopup(n._container),i._animatePinchFinalCallback(t)}))}this._lastAnimPinchKeyframe=null}});
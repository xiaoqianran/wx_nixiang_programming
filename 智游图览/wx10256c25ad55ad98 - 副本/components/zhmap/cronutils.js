Object.defineProperty(exports,"__esModule",{value:!0}),exports.ScenicCronTaskMng=void 0;var e=require("../../@babel/runtime/helpers/classCallCheck"),t=require("../../@babel/runtime/helpers/createClass"),i=require("./later/later"),n=function(){return t((function t(i,n){e(this,t),this.index=i,this.parent_scenic_area=null,this.scenic_area=null,this.cron=null,this.duration=null,this.cronObj=null,this.timer=null,this.schedule=null,this.advance=null,this.init(n)}),[{key:"init",value:function(e){var t=e.split(";");t.length<3&&(t=e.split(",")),this.cron=t[0],this.duration=60*parseInt(t[1])*1e3,this.advance=60*parseInt(t[2])*1e3,i.later.date.localTime(),this.cronObj=i.later.parse.cron(this.cron),this.schedule=i.later.schedule(this.cronObj)}},{key:"calcRecentShowStartTime",value:function(e){var t,i;null!==(i=(t=this.scenic_area).recent_show_time)&&void 0!==i||(t.recent_show_time={}),this.scenic_area.recent_show_time[this.index]=e;var n=null;for(var a in this.scenic_area.recent_show_time)(null==n||n.getTime()>this.scenic_area.recent_show_time[a].getTime())&&(n=this.scenic_area.recent_show_time[a]);this.scenic_area.nearest_show_time=n,this.scenic_area.recent_show_time_str=1+n.getMonth()+"月"+n.getDate()+"日 "+n.getHours()+"时"+n.getMinutes()+"分"}},{key:"calcTodayShowStartTime",value:function(){var e,t,i=new Date,n=new Date(new Date((new Date).toLocaleDateString()).getTime()+864e5-1);null!==(t=(e=this.scenic_area).today_show_time)&&void 0!==t||(e.today_show_time={}),this.scenic_area.today_show_time[this.index]=this.schedule.next(100,i,n)}},{key:"start",value:function(){var e=new Date,t=new Date(new Date((new Date).toLocaleDateString()).getTime()+1728e5-1),i=this.schedule.prev(1),n=this.schedule.next(1,e,t);0!=n&&(this.calcTodayShowStartTime(),0!=i&&i.getTime()+this.duration>e.getTime()?(this.calcRecentShowStartTime(i),this.executeTask(e.getTime(),i.getTime(),i.getTime()+this.duration)):(this.calcRecentShowStartTime(n),this.prepareNextTask(n.getTime(),e.getTime())))}},{key:"stop",value:function(){null!=this.timer&&(this.scenic_area.right_badge=null,this.parent_scenic_area.hidePoi(this.scenic_area),clearTimeout(this.timer),this.timer=null)}},{key:"executeTask",value:function(e,t,i){var n=this;null!=n.timer&&(clearTimeout(n.timer),n.timer=null),n.scenic_area.right_badge="演",n.parent_scenic_area.showPoi(n.scenic_area);var a=i-e;console.log("start date: "+new Date),console.log("executeTask intavalTime: "+a),n.timer=setTimeout((function(){n.scenic_area.right_badge=null,n.parent_scenic_area.hidePoi(n.scenic_area);var e=new Date,t=new Date(new Date((new Date).toLocaleDateString()).getTime()+1728e5-1),i=n.schedule.next(1,e,t);console.log(i),n.calcRecentShowStartTime(i),console.log("end date: "+e),n.prepareNextTask(i.getTime(),e.getTime())}),Math.max(0,a))}},{key:"prepareNextTask",value:function(e,t){var i=this;null!=i.timer&&(clearTimeout(i.timer),i.timer=null);var n=e-t-i.advance;console.log("prepareNextTask intervalTime: "+n),i.timer=setTimeout((function(){i.executeTask(Math.max(t,e-i.advance),e,e+i.duration)}),Math.max(0,e-t-i.advance))}}])}(),a=function(){return t((function t(){e(this,t),this.parent_scenic_area=null,this.scenic_area=null,this.scenicid=null,this.task_type=null,this.grade=null,this.detail=null,this.cron_task=[]}),[{key:"init",value:function(e){if(this.scenicid=e.scenic_area,this.task_type=e.task_type,this.grade=e.grade,this.detail=e.detail,this.cron_task=[],null!=e.cron_task&&""!=e.cron_task)for(var t=e.cron_task.split("|"),i=0;i<t.length;++i)this.cron_task.push(new n(i,t[i]))}},{key:"start",value:function(){for(var e=0;e<this.cron_task.length;++e)this.cron_task[e].parent_scenic_area=this.parent_scenic_area,this.cron_task[e].scenic_area=this.scenic_area,this.cron_task[e].start()}},{key:"stop",value:function(){for(var e=0;e<this.cron_task.length;++e)this.cron_task[e].stop()}}])}();exports.ScenicCronTaskMng=function(){return t((function t(){e(this,t),this.parent_scenic_area=null,this.scenicid2task={},this.scenicid2scenictype={},this.scenicid2scenic={},this.running=!1}),[{key:"init",value:function(e){var t=this;t.parent_scenic_area=e,global.wxRequest.getCronTaskList(t.parent_scenic_area,(function(i){t.scenicid2task={};for(var n=0;n<i.length;++n){var s=new a;s.init(i[n]),t.scenicid2task[s.scenicid]=s}var c=e.children_scenic_area_type;t.scenicid2scenic={},t.scenicid2scenictype={};for(var r=0;r<c.length;++r){t.scenicid2scenictype[c[r].id]=c[r];for(var h=0;h<c[r].items.length;++h){var l=c[r].items[h];t.scenicid2scenic[l.id]=l}}var o=[];for(var u in t.scenicid2task)t.scenicid2scenic.hasOwnProperty(u)||o.push(u);0==o.length?t.start():global.wxRequest.postScenicList(o,(function(e){for(var i=require("./view"),n=0;n<e.length;++n){var a=new i.ScenicArea(e[n]);t.scenicid2scenictype.hasOwnProperty(a.scenic_area_type)&&(t.scenicid2scenic.hasOwnProperty(a.id)||(t.scenicid2scenictype[a.scenic_area_type].items.push(a),t.scenicid2scenic[a.id]=a))}t.start()}))}))}},{key:"start",value:function(){var e=!1;for(var t in this.scenicid2task)this.scenicid2task[t].parent_scenic_area=this.parent_scenic_area,this.scenicid2task[t].scenic_area=this.scenicid2scenic[t],this.scenicid2task[t].start(),e=!0;e&&(this.parent_scenic_area.page.setData({scenicShowControl:!0}),this.running=!0)}},{key:"stop",value:function(){for(var e in this.scenicid2task)this.scenicid2task[e].stop();this.running=!1}}])}();
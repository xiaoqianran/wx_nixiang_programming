var e=require("../../../@babel/runtime/helpers/regeneratorRuntime"),t=require("../../../@babel/runtime/helpers/asyncToGenerator"),n=require("../../../@babel/runtime/helpers/classCallCheck"),r=require("../../../@babel/runtime/helpers/createClass"),a=require("../../../@babel/runtime/helpers/possibleConstructorReturn"),u=require("../../../@babel/runtime/helpers/getPrototypeOf"),o=require("../../../@babel/runtime/helpers/inherits");function c(e,t,n){return t=u(t),a(e,function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){return!1}}()?Reflect.construct(t,n||[],u(e).constructor):t.apply(e,n))}var i=require("./base_biz.js"),s=require("../../helper/cache_helper.js"),l=require("../../helper/cloud_helper.js"),f=require("../../helper/page_helper.js"),p=require("../../helper/helper.js"),g=require("../constants.js"),h=getApp(),d=function(a){function u(){return n(this,u),c(this,u,arguments)}return o(u,i),r(u,null,[{key:"loginSilence",value:(b=t(e().mark((function t(n){return e().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,u.loginCheck(!1,"slience","bar",n);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),t)}))),function(e){return b.apply(this,arguments)})},{key:"loginSilenceMust",value:(v=t(e().mark((function t(n){return e().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,u.loginCheck(!1,"must","bar",n);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),t)}))),function(e){return v.apply(this,arguments)})},{key:"loginMustCancelWin",value:(x=t(e().mark((function t(n){return e().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,u.loginCheck(!0,"cancel","",n);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),t)}))),function(e){return x.apply(this,arguments)})},{key:"loginMustBackWin",value:(k=t(e().mark((function t(n){return e().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,u.loginCheck(!0,"back","",n);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),t)}))),function(e){return k.apply(this,arguments)})},{key:"getToken",value:function(){return s.get(g.CACHE_TOKEN)||null}},{key:"setToken",value:function(e){e&&s.set(g.CACHE_TOKEN,e,g.CACHE_TOKEN_EXPIRE)}},{key:"getUserId",value:function(){var e=s.get(g.CACHE_TOKEN);return e&&e.id||""}},{key:"getUserName",value:function(){var e=s.get(g.CACHE_TOKEN);return e&&e.name||""}},{key:"getStatus",value:function(){return s.get(g.CACHE_TOKEN)&&tokenStatus||-1}},{key:"isLogin",value:function(){return u.getUserId().length>0}},{key:"loginStatusHandler",value:function(e,t){var n="";return 0==t?n="您的注册正在审核中，暂时无法使用此功能！":8==t?n="您的注册审核未通过，暂时无法使用此功能；请在个人中心修改资料，再次提交审核！":9==t&&(n="您的账号已经禁用, 无法使用此功能！"),"cancel"==e?wx.showModal({title:"温馨提示",content:n,confirmText:"取消",showCancel:!1}):"back"==e&&wx.showModal({title:"温馨提示",content:n,confirmText:"返回",showCancel:!1,success:function(e){wx.navigateBack()}}),!1}},{key:"getCode",value:function(){return new Promise((function(e,t){wx.login({success:function(t){console.log("login success",t),h.globalData.WXCode=t.code,e(t)},fail:function(e){t(e)}})}))}},{key:"loginCheck",value:(m=t(e().mark((function t(){var n,r,a,o,c,i,d,m,k=arguments;return e().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=k.length>0&&void 0!==k[0]&&k[0],r=k.length>1&&void 0!==k[1]?k[1]:"back",a=k.length>2&&void 0!==k[2]?k[2]:"",o=k.length>3&&void 0!==k[3]?k[3]:null,!s.get(g.CACHE_TOKEN)||"must"==r){e.next=10;break}return o&&o.setData({isLogin:!0}),e.abrupt("return",!0);case 10:o&&o.setData({isLogin:!1});case 11:return c={title:a||"登录中"},e.next=14,u.getCode();case 14:if((i=e.sent).code){e.next=18;break}return wx.showModal({title:"温馨提示",content:"登录失败",confirmText:"确定"}),e.abrupt("return",!1);case 18:return d={code:i.code,fid:h.indexData.fid},e.next=21,l.callCloudSumbit("user/login",d,c).then((function(e){if(u.clearToken(),e&&p.isDefined(e.data.token)&&e.data.token&&1==e.data.tokenStatus)return u.setToken(e.data),o&&o.setData({isLogin:!0,user:e.data}),!0;if(n&&e&&p.isDefined(e.data.token)&&e.data.token&&(0==e.data.tokenStatus||8==e.data.tokenStatus||9==e.data.tokenStatus)){var t=e.data.tokenStatus;return u.loginStatusHandler(r,t)}return n&&"cancel"==r?(wx.showModal({title:"温馨提示",content:"此功能仅限注册用户",confirmText:"马上注册",cancelText:"取消",success:function(e){if(e.confirm){var t=f.fmtURLByPID("/pages/my/reg/my_reg")+"?retUrl=back";wx.navigateTo({url:t})}else e.cancel}}),!1):n&&"back"==r?(wx.showModal({title:"温馨提示",content:"此功能仅限注册用户",confirmText:"马上注册",cancelText:"返回",success:function(e){if(e.confirm){var t=encodeURIComponent(f.getCurrentPageUrlWithArgs()),n=f.fmtURLByPID("/pages/my/reg/my_reg")+"?retUrl="+t;wx.redirectTo({url:n})}else if(e.cancel)if(1==getCurrentPages().length){var r=f.fmtURLByPID("/pages/default/index/default_index");wx.reLaunch({url:r})}else wx.navigateBack()}}),!1):n&&"back"==r?(wx.showModal({title:"温馨提示",content:"此功能仅限注册用户",confirmText:"马上注册",cancelText:"返回",success:function(e){if(e.confirm){var t=f.fmtURLByPID("/pages/my/reg/my_reg");wx.reLaunch({url:t})}else e.cancel&&wx.navigateBack()}}),!1):void 0})).catch((function(e){return console.log(e),u.clearToken(),!1}));case 21:return m=e.sent,e.abrupt("return",m);case 23:case"end":return e.stop()}}),t)}))),function(){return m.apply(this,arguments)})},{key:"clearToken",value:function(){s.remove(g.CACHE_TOKEN)}},{key:"getPhone",value:(d=t(e().mark((function t(n,r){var a,u,o;return e().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("getPhoneNumber:ok"!=n.detail.errMsg){e.next=8;break}return a=n.detail.cloudID,u={cloudID:a},o={title:"手机验证中"},e.next=6,l.callCloudSumbit("passport/phone",u,o).then((function(e){var t=e.data;!t||t.length<11?wx.showToast({title:"手机号码获取失败，请重新填写手机号码",icon:"none",duration:2e3}):r.setData({formMobile:t})}));case 6:e.next=9;break;case 8:wx.showToast({title:"手机号码获取失败，请重新填写手机号码",icon:"none"});case 9:case"end":return e.stop()}}),t)}))),function(e,t){return d.apply(this,arguments)})}]);var d,m,k,x,v,b}();d.CHECK_FORM={name:"formName|must|string|min:1|max:30|name=昵称",mobile:"formMobile|must|len:11|name=手机",forms:"formForms|array"},module.exports=d;
var t=require("../../@babel/runtime/helpers/interopRequireWildcard"),e=require("../../@babel/runtime/helpers/interopRequireDefault"),r=e(require("../../@babel/runtime/regenerator")),s=require("../../@babel/runtime/helpers/objectSpread2"),a=require("../../@babel/runtime/helpers/slicedToArray"),n=require("../../@babel/runtime/helpers/asyncToGenerator"),i=t(require("../../utils/icon.js")),o=require("../../config/appConfig"),u=e(require("../../utils/systemInfo")),c=require("../../models/RequestAPI"),l=require("../../utils/utils"),d=e(require("../../utils/RequestError")),h=require("../../utils/store"),g=(require("../../libs/runtime"),{"-1000":"网络异常，请稍后重试","-1001":"起终点参数错误","-1005":"云函数返回异常"});Component({properties:{data:{type:Object,observer:function(t){this.start=t.startPoint,this.end=t.endPoint,t.startPoint&&t.endPoint&&this.transit({start:this.start,end:this.end,policy:this.data.currentPolicy})}}},data:{policies:[{name:"时间短优先",value:"LEAST_TIME"},{name:"少步行优先",value:"LEAST_WALKING"},{name:"少换乘优先",value:"LEAST_TRANSFER"}],currentPolicy:"LEAST_TIME",status:null,CDN_PATH:o.CDN_PATH,transitList:[],rtbuses:[],markerPolicy:{LEAST_TIME:"时间短",LEAST_WALKING:"少步行",LEAST_TRANSFER:"少换乘"},bus_icon:"icon-route_ic_bus"},lifetimes:{ready:function(){var t=u.default.globalData.themeColor;this.setData({themeColor:t})},detached:function(){this.rtTimeout&&(clearInterval(this.rtTimeout),this.rtTimeout=null)}},methods:{setTransitPolicy:function(t){var e=t.target.dataset.policy;e&&(this.setData({currentPolicy:e}),this.transit({start:this.start,end:this.end,policy:e}))},transit:function(){var t=arguments,e=this;return n(r.default.mark((function n(){var i,o,u,d,p,f,y,m,T,b;return r.default.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return i=t.length>0&&void 0!==t[0]?t[0]:{},e.destroy(),e.start=i.start,e.end=i.end,e.queryOptions=i,e.setLoading(),r.prev=6,r.next=9,Promise.all([e.handleMyLocation(i.start),e.handleMyLocation(i.end)]);case 9:o=r.sent,u=a(o,2),d=u[0],p=u[1],e.start=d,e.end=p,r.next=24;break;case 17:return r.prev=17,r.t0=r.catch(6),console.log(r.t0),e.setTransitFail(r.t0),e.notifyViewFail(r.t0),h.store.aegis.error({msg:"网络异常",ext2:JSON.stringify({type:"transit",startPoint:e.start,endPoint:e.end,errorStatus:r.t0.status,errorMessage:r.t0.msg||r.t0.message||"网络异常，请稍后重试"})}),r.abrupt("return");case 24:return r.prev=24,e.rtTimeout&&clearInterval(e.rtTimeout),f=[],y="",r.next=30,(0,l.checkNetwork)();case 30:return r.next=32,c.requestAPI.transit({from:"".concat(e.start.latitude,",").concat(e.start.longitude),to:"".concat(e.end.latitude,",").concat(e.end.longitude),policy:i.policy});case 32:return m=r.sent,r.next=35,wx.cloud.callFunction({name:"getTransit",data:{queryOptions:s(s({},i),{},{transitRoutes:m.data}),type:"model",key:c.requestAPI.getKey()}});case 35:0===(T=r.sent).result.status?(f=T.result.result.data,y=T.result.result.status,e.transitResult=T.result.result,c.requestAPI.sendModePv("transit"),f?(b=f,e.setData({transitList:b}),e.setStatus(null)):e.setStatus(y),e.triggerEvent("handlpageerror",{isNetworkError:!1,retry:!1,retryCb:!1})):(e.setTransitFail(T.result),h.store.aegis.error({msg:g[T.result.status+""||"-1000"],ext2:JSON.stringify({type:"transit",startPoint:e.start,endPoint:e.end,errorStatus:T.result.status,errorMessage:T.result.msg||T.result.message||"网络异常，请稍后重试"})})),r.next=44;break;case 39:r.prev=39,r.t1=r.catch(24),-1e3===r.t1.status&&wx.showToast({title:"网络异常请重试",icon:"none",image:"",duration:1500,mask:!1}),h.store.aegis.error({msg:g[r.t1.status+""||"-1005"]||"网络异常",ext2:JSON.stringify({type:"transit",startPoint:e.start,endPoint:e.end,errorStatus:r.t1.status||-1005,errorMessage:r.t1.msg||r.t1})}),e.setTransitFail(r.t1);case 44:case"end":return r.stop()}}),n,null,[[6,17],[24,39]])})))()},handleMyLocation:function(t){var e=this;return n(r.default.mark((function s(){var a;return r.default.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(r.prev=0,"我的位置"!==t.name){r.next=7;break}return r.next=4,e.getLocation();case 4:a=r.sent,t.latitude=a.latitude,t.longitude=a.longitude;case 7:r.next=17;break;case 9:if(r.prev=9,r.t0=r.catch(0),console.log("location error",r.t0),"getLocation:fail auth deny"!==r.t0.errMsg){r.next=16;break}throw new d.default("用户未授权位置服务",-1003);case 16:throw new d.default("GPS信号弱，请稍后再试",-1002);case 17:return r.abrupt("return",t);case 18:case"end":return r.stop()}}),s,null,[[0,9]])})))()},getLocation:function(){return n(r.default.mark((function t(){var e;return r.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,c.requestAPI.getLocation();case 2:return e=t.sent,t.abrupt("return",e);case 4:case"end":return t.stop()}}),t)})))()},setTransitFail:function(t){var e,r=this;switch(console.error("公交方案规划失败",t),t.status){case 8:case-1005:case-1e3:e="loadError",this.triggerEvent("handlpageerror",{isNetworkError:!0,retry:!0,retryCb:function(){r.transit(r.queryOptions)}});break;case-1002:e="locationError",this.setStatus({des:t.message||"网络异常，请稍后重试",iconUrl:i.TRANSIT_ROUTEPLAN_ICON.NETWORK,retry:!0,retryCb:function(){r.transit(r.queryOptions)}});break;case-1003:e="locationAuthError",this.triggerEvent("handlpageerror",{errorType:e});break;default:this.setStatus(null)}},setLoading:function(){this.setStatus({type:"loading",des:"路线加载中...",iconUrl:i.TRANSIT_LOADING})},setStatus:function(t){this.setData({status:t})},handleRetry:function(){this.data.status&&this.data.status.retryCb&&this.data.status.retryCb()},onSelectTransitLine:function(t){var e=JSON.stringify(this.transitResult.start),r=JSON.stringify(this.transitResult.end),s=t.currentTarget.dataset,a=s.lineindex,n=s.policy,i="../../pages/transit-detail/detail?start=".concat(e,"&end=").concat(r,"&index=").concat(a,"&policy=").concat(n);wx.navigateTo({url:i})},_formateRtText:function(t){var e=t.eta,r=t.stop_num,s=t.distance;return s<50?"已经到站":s>50&&0===r?"即将到站":r>=1?"".concat(Math.ceil(e/60),"分钟·").concat(r,"站"):""},notifyViewFail:function(t){this._initMarker(),this.view.setDrivingFail({status:t.status,message:t.message||"网路异常，请稍后重试",meta:{markers:this._startEndMarkerWxJson().reverse()}})},destroy:function(){this.setData({transitList:[]})}}});
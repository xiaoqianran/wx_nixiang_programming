var t=require("../@babel/runtime/helpers/interopRequireWildcard"),e=require("../@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var r=e(require("../@babel/runtime/regenerator")),s=require("../@babel/runtime/helpers/slicedToArray"),a=require("../@babel/runtime/helpers/asyncToGenerator"),i=require("../@babel/runtime/helpers/classCallCheck"),n=require("../@babel/runtime/helpers/createClass"),u=require("../@babel/runtime/helpers/inherits"),l=require("../@babel/runtime/helpers/createSuper"),o=e(require("./BasePresenter")),h=e(require("../utils/MapRenderHelper")),d=require("../models/RequestAPI"),k=t(require("../utils/utils")),c=require("../libs/geometry/geometryLib"),p=require("../utils/store"),g=(require("../libs/runtime"),new c.GeoMetry),m={"-1000":"网络异常，请稍后重试","-1001":"起终点参数错误","-1005":"云函数返回异常"},b=function(t){u(c,t);var e,o=l(c);function c(t){var e;return i(this,c),(e=o.call(this,t)).mapRender=new h.default,e}return n(c,[{key:"walk",value:(e=a(r.default.mark((function t(){var e,a,i,n,u,l,o,h,c,b,f,y=arguments;return r.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e=y.length>0&&void 0!==y[0]?y[0]:{},this.destroy(),t.prev=2,this.start=e.start,this.end=e.end,a=this.notifyWalkFail.bind(this),k.isValidParams(e,a)){t.next=8;break}return t.abrupt("return");case 8:return t.prev=8,t.next=11,Promise.all([this.handleMyLocation(e.start),this.handleMyLocation(e.end)]);case 11:i=t.sent,n=s(i,2),u=n[0],l=n[1],this.start=u,this.end=l,t.next=24;break;case 19:return t.prev=19,t.t0=t.catch(8),this.notifyWalkFail(t.t0),p.store.aegis.error({msg:"网络异常",ext2:JSON.stringify({type:"walking",startPoint:this.start,endPoint:this.end,errorStatus:t.t0.status,errorMessage:t.t0.msg||t.t0.message||"网络异常，请稍后重试"})}),t.abrupt("return");case 24:if(k.isValidStartEndPoints({start:this.start,end:this.end},a)){t.next=26;break}return t.abrupt("return");case 26:return t.next=28,(0,k.checkNetwork)();case 28:if(!((o=g.getLength([parseFloat(this.start.latitude),parseFloat(this.start.longitude)],[parseFloat(this.end.latitude),parseFloat(this.end.longitude)]))>=3e5)){t.next=34;break}return this.notifyWalkFail({status:-1004,message:"步行路线过长，建议采用其他出行方式"}),t.abrupt("return");case 34:if(!(o<20)){t.next=37;break}return this.notifyWalkFail({status:-1004,message:"起终点距离太短"}),t.abrupt("return");case 37:return t.next=39,d.requestAPI.walking({from:this.start.latitude+","+this.start.longitude,to:this.end.latitude+","+this.end.longitude,to_poi:this.end.poiid||""});case 39:return h=t.sent,c=h.data,t.next=43,wx.cloud.callFunction({name:"getWalk",data:{queryOptions:{start:this.start,end:this.end,walkingRoutes:c},key:d.requestAPI.getKey()}});case 43:0===(b=t.sent).result.status?(f=b.result.result,this._initMarker(),this.view.handleNoNetworkError(),this.view.setBounds(f.bounds),this.view.setWalkSuccess(f)):(this.notifyWalkFail(b.result),p.store.aegis.error({msg:m[b.result.status+""||"-1000"],ext2:JSON.stringify({type:"walking",startPoint:this.start,endPoint:this.end,errorStatus:b.result.status,errorMessage:b.result.msg||b.result.message||"数据处理异常"})})),t.next=52;break;case 47:t.prev=47,t.t1=t.catch(2),-1e3===t.t1.status&&wx.showToast({title:"网络异常请重试",icon:"none",image:"",duration:1500,mask:!1}),this.notifyWalkFail(t.t1),p.store.aegis.error({msg:m[t.t1.status+""||"-1005"],ext2:JSON.stringify({type:"walking",startPoint:this.start,endPoint:this.end,errorStatus:t.t1.status||-1005,errorMessage:t.t1.msg||t.t1})});case 52:case"end":return t.stop()}}),t,this,[[2,47],[8,19]])}))),function(){return e.apply(this,arguments)})},{key:"_initMarker",value:function(){this.start&&this.start.latitude&&this.start.longitude&&(this.startMarker=this.mapRender.createStartMarker(this.start,1)),this.end&&this.end.latitude&&this.end.longitude&&(this.endMarker=this.mapRender.createDestMarker(this.end,1))}},{key:"notifyWalkFail",value:function(t){this._initMarker(),this.view.setWalkFail({status:t.status||-1e3,message:t.message,meta:{markers:this._startEndMarkerWxJson().reverse()}})}},{key:"_startEndMarkerWxJson",value:function(){var t=[];return this.startMarker&&t.push(this.startMarker.toJson()),this.endMarker&&t.push(this.endMarker.toJson()),t}},{key:"destroy",value:function(){this.start=null,this.end=null,this.walkRoutePlanEntity=null,this.startMarker=null,this.endMarker=null,this.firstGuideLine=null,this.lastGuideLine=null}}]),c}(o.default);exports.default=b;
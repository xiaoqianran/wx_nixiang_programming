var t=require("../@babel/runtime/helpers/interopRequireWildcard"),e=require("../@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var r=require("../@babel/runtime/helpers/toConsumableArray"),a=require("../@babel/runtime/helpers/slicedToArray"),n=e(require("../@babel/runtime/regenerator")),s=require("../@babel/runtime/helpers/objectSpread2"),i=require("../@babel/runtime/helpers/asyncToGenerator"),u=require("../@babel/runtime/helpers/classCallCheck"),o=require("../@babel/runtime/helpers/createClass"),l=require("../@babel/runtime/helpers/inherits"),c=require("../@babel/runtime/helpers/createSuper"),d=e(require("./BasePresenter.js")),p=require("../utils/utils"),h=t(require("../utils/icon.js")),f=require("../models/RequestAPI"),g=require("../libs/geometry/geometryLib"),y=require("../utils/store"),m=(require("../libs/runtime"),new g.GeoMetry),w={"-1000":"网络异常，请稍后重试","-1001":"起终点参数错误","-1005":"云函数返回异常"},b=function(t){l(x,t);var e,d,g,b=c(x);function x(t){var e,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return u(this,x),(e=b.call(this,t)).viewInterface=["setTransitSuccess","setTransitFail"],e.transitPlanEntity=[],e.currentPlanIndex=r.currentPlanIndex||0,e}return o(x,[{key:"loading",set:function(t){this.view.setLoading(t)}},{key:"transit",value:(g=i(n.default.mark((function t(){var e,r,a,i,u,o=this,l=arguments;return n.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e=l.length>0&&void 0!==l[0]?l[0]:{},this.start=e.start,this.end=e.end,this.view.setLoading(),t.prev=4,wx.showLoading({mask:!0,title:"加载中..."}),t.next=8,(0,p.checkNetwork)();case 8:return t.next=10,f.requestAPI.transit({from:"".concat(this.start.latitude,",").concat(this.start.longitude),to:"".concat(this.end.latitude,",").concat(this.end.longitude),policy:e.policy});case 10:return r=t.sent,t.next=13,wx.cloud.callFunction({name:"getTransit",data:{queryOptions:s(s({},e),{},{index:this.currentPlanIndex,transitRoutes:r.data}),type:"detail",key:f.requestAPI.getKey()}});case 13:if(a=t.sent,wx.hideLoading(),i=a.result.result,u=i.data.transitList,this.routePlanData=i.data,!u){t.next=26;break}return this.transitPlanEntity=u,t.next=22,this.switchPlan(this.currentPlanIndex);case 22:return this.view.setStatus(null),t.abrupt("return");case 26:this.view.setStatus(i.status),y.store.aegis.error({msg:w[i.status+""||"-1000"],ext2:JSON.stringify({type:"transit",startPoint:this.start,endPoint:this.end,errorStatus:i.status,errorMessage:i.msg||i.message||"网络异常，请稍后重试"})});case 28:t.next=37;break;case 30:t.prev=30,t.t0=t.catch(4),console.error(t.t0),wx.hideLoading(),-1e3===t.t0.status&&wx.showToast({title:"网络异常请重试",icon:"none",image:"",duration:1500,mask:!1}),y.store.aegis.error({msg:w[t.t0.status+""||"-1005"]||"网络异常",ext2:JSON.stringify({type:"transit",startPoint:this.start,endPoint:this.end,errorStatus:t.t0.status||-1005,errorMessage:t.t0.msg||t.t0})}),this.view.setStatus({des:t.t0.message||"网络异常，请稍后重试",iconUrl:h.TRANSIT_ROUTEPLAN_ICON.NETWORK,retry:!0,retryCb:function(){o.transit(e)}});case 37:case"end":return t.stop()}}),t,this,[[4,30]])}))),function(){return g.apply(this,arguments)})},{key:"switchPlan",value:(d=i(n.default.mark((function t(e){return n.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.currentPlanEntity=this.routePlanData.transitList[e],this.currentPlanIndex=e,this.view.setTransitSuccess({currentPlanIndex:e}),t.next=5,this.updateIndoorRoute(this.currentPlanEntity);case 5:this.resetTransitData();case 6:case"end":return t.stop()}}),t,this)}))),function(t){return d.apply(this,arguments)})},{key:"updateIndoorRoute",value:(e=i(n.default.mark((function t(e){var s,i,u,o,l=this;return n.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!e.__isIndoorRouteLoaded){t.next=2;break}return t.abrupt("return");case 2:return s=e.firstGeton,i=e.lastGetoff,this.timer=setTimeout((function(){wx.showLoading({mask:!0,title:"加载中..."}),clearTimeout(l.timer),l.timer=null}),500),t.next=7,Promise.all([this.getStartWalk(s),this.getEndWalk(i)]).then((function(t){var n=a(t,2);if(u=n[0],o=n[1],u.polyline&&u.polyline.length){for(var s,i=u.polyline.length-1;i>=0;i--)if(u.polyline[i].dottedLine){u.polyline[i].dottedLine=!1,u.polyline[i].color="#427cff",u.polyline[i].width=8,u.polyline[i].style=1,u.polyline[i].arrowLine=!0;break}(s=e.polyline).push.apply(s,r(u.polyline))}if(u.cardData&&e.steps.length&&!e.steps[0].isShow&&(u.cardData.formatDistance=u.cardData.distance,u.cardData.formatDuration=u.cardData.time,u.cardData.mode="WALKING",u.cardData.isShow=!0,e.steps.unshift(u.cardData)),o.polyline&&o.polyline.length){for(var l,c=0;c<o.polyline.length;c++)if(o.polyline[c].dottedLine){o.polyline[c].dottedLine=!1,o.polyline[c].color="#427cff",o.polyline[c].width=8,o.polyline[c].style=1,o.polyline[c].arrowLine=!0;break}(l=e.polyline).push.apply(l,r(o.polyline))}o.cardData&&e.steps.length&&!e.steps[e.steps.length-1].isShow&&(o.cardData.formatDistance=e.steps.distance,o.cardData.formatDuration=o.cardData.time,o.cardData.mode="WALKING",o.cardData.isShow=!0,e.steps.push(o.cardData))})).catch((function(t){console.error(t)}));case 7:return this.timer&&(clearTimeout(this.timer),this.timer=null),wx.hideLoading(),t.abrupt("return");case 10:case"end":return t.stop()}}),t,this)}))),function(t){return e.apply(this,arguments)})},{key:"resetTransitData",value:function(){this.rtTimeout&&clearInterval(this.rtTimeout);var t=this.routePlanData.bounds;this.parsedTransitList=this.routePlanData.transitList,this.view.setTransitSuccess({bounds:t,transitList:this.parsedTransitList,currentPlan:this.parsedTransitList[this.currentPlanIndex]})}},{key:"getStartWalk",value:function(t){var e=this;return new Promise(function(){var r=i(n.default.mark((function r(a,s){var i,u,o;return n.default.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(!((i=m.getLength([parseFloat(e.start.latitude),parseFloat(e.start.longitude)],[parseFloat(t.latitude),parseFloat(t.longitude)]))>=3e5)){r.next=6;break}return a({}),r.abrupt("return");case 6:if(!(i<20)){r.next=9;break}return a({}),r.abrupt("return");case 9:return r.next=11,f.requestAPI.walking({from:e.start.latitude+","+e.start.longitude,to:t.latitude+","+t.longitude});case 11:u=r.sent,o=u.data,wx.cloud.callFunction({name:"getWalk",data:{queryOptions:{start:e.start,end:{latitude:t.latitude,longitude:t.longitude,name:t.name},walkingRoutes:o},key:f.requestAPI.getKey()}}).then((function(t){a(t.result.result)})).catch((function(t){console.error(t),y.store.aegis.error({msg:w[t.status+""||"-1005"],ext2:JSON.stringify({type:"transit",startPoint:e.start,endPoint:e.end,errorStatus:t.status,errorMessage:t.msg||t.message||"云函数返回异常"})})}));case 14:case"end":return r.stop()}}),r)})));return function(t,e){return r.apply(this,arguments)}}())}},{key:"getEndWalk",value:function(t){var e=this;return new Promise(function(){var r=i(n.default.mark((function r(a,s){var i,u,o;return n.default.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(!((i=m.getLength([parseFloat(t.latitude),parseFloat(t.longitude)],[parseFloat(e.end.latitude),parseFloat(e.end.longitude)]))>=3e5)){r.next=6;break}return a({}),r.abrupt("return");case 6:if(!(i<20)){r.next=9;break}return a({}),r.abrupt("return");case 9:return r.next=11,f.requestAPI.walking({from:t.latitude+","+t.longitude,to:e.end.latitude+","+e.end.longitude});case 11:u=r.sent,o=u.data,wx.cloud.callFunction({name:"getWalk",data:{queryOptions:{start:{latitude:t.latitude,longitude:t.longitude,name:t.name},end:e.end,walkingRoutes:o},key:f.requestAPI.getKey()}}).then((function(t){a(t.result.result)})).catch((function(t){console.error(t),y.store.aegis.error({msg:w[t.status+""||"-1005"],ext2:JSON.stringify({type:"transit",startPoint:e.start,endPoint:e.end,errorStatus:t.status,errorMessage:t.msg||t.message||"云函数返回异常"})})}));case 14:case"end":return r.stop()}}),r)})));return function(t,e){return r.apply(this,arguments)}}())}}]),x}(d.default);exports.default=b;
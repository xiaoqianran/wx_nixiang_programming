var e=require("../@babel/runtime/helpers/interopRequireWildcard"),t=require("../@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var r=require("../@babel/runtime/helpers/objectSpread2"),s=t(require("../@babel/runtime/regenerator")),i=require("../@babel/runtime/helpers/slicedToArray"),n=require("../@babel/runtime/helpers/asyncToGenerator"),a=require("../@babel/runtime/helpers/classCallCheck"),u=require("../@babel/runtime/helpers/createClass"),l=require("../@babel/runtime/helpers/inherits"),o=require("../@babel/runtime/helpers/createSuper"),d=t(require("./BasePresenter.js")),h=require("../libs/geometry/geometryLib"),c=t(require("../utils/MapRenderHelper")),g=require("../models/RequestAPI"),p=e(require("../utils/utils")),v=require("../utils/store"),y=new h.GeoMetry,f=(require("../libs/runtime"),{"-1000":"网络异常","-1001":"起终点参数错误","-1005":"云函数返回异常"}),m=["#9FE3B8","#FED180","#EAABA4","#0000FF40","#EAABA4"],b=["#88C29E","#DAB36D","#C8928C","#0000FFFF","#C8928C"],x=["#11CA53","#FFA300","#E64938","#0000FFFF","#E64938"],k=["#0EAD47","#DB8B00","#C53E30","#0000FFFF","#C53E30"],F=function(e){l(h,e);var t,d=o(h);function h(e){var t;return a(this,h),(t=d.call(this,e)).mapRender=new c.default,t}return u(h,[{key:"destroy",value:function(){this.startMarker=null,this.endMarker=null,this.startWalkRoutePlanEntity=null,this.endWalkRoutePlanEntity=null,this.drivingRoutePlanEntities=[],this.firstGuideLine=null,this.lastGuideLine=null,this.queryOptions=null,this.start=null,this.end=null}},{key:"driving",value:(t=n(s.default.mark((function e(){var t,r,n,a,u,l,o,d,h,c,m,b,x,k,F,M=arguments;return s.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=M.length>0&&void 0!==M[0]?M[0]:{},this.destroy(),t=t||{},this.queryOptions=t,this.start=t.start,this.end=t.end,this.queryOptions.drivingIndex=this.queryOptions.drivingIndex||0,a=this.notifyViewFail.bind(this),p.isValidParams(t,a)){e.next=10;break}return e.abrupt("return");case 10:return e.prev=10,e.next=13,Promise.all([this.handleMyLocation(t.start),this.handleMyLocation(t.end)]);case 13:u=e.sent,l=i(u,2),r=l[0],n=l[1],this.start=r,this.end=n,e.next=26;break;case 21:return e.prev=21,e.t0=e.catch(10),this.notifyViewFail(e.t0),v.store.aegis.error({msg:"网络异常",ext2:JSON.stringify({type:"driving",startPoint:this.start,endPoint:this.end,errorStatus:e.t0.status,errorMessage:e.t0.msg||e.t0.message||"网络异常，请稍后重试"})}),e.abrupt("return");case 26:if(p.isValidStartEndPoints({start:this.start,end:this.end},a)){e.next=28;break}return e.abrupt("return");case 28:if(!(y.getLength([r.latitude,r.longitude],[n.latitude,n.longitude])<200)){e.next=33;break}return this.notifyViewFail({status:-1001,message:"起终点距离太短，请切换到步行路线"}),v.store.aegis.error({msg:"起终点参数错",ext2:JSON.stringify({type:"driving",startPoint:this.start,endPoint:this.end,errorStatus:-1001,errorMessage:"起终点距离太短，请切换到步行路线"})}),e.abrupt("return",!1);case 33:return e.prev=33,e.next=36,p.checkNetwork();case 36:return e.next=38,g.requestAPI.driving({from:this.start.latitude+","+this.start.longitude,to:this.end.latitude+","+this.end.longitude});case 38:return o=e.sent,d=o.data,h={start:this.start,end:this.end,drivingRoutes:d},c=JSON.stringify(h),m=wx.getSystemInfoSync().SDKVersion,b=p.compareVersion(m,"2.19.2"),e.next=46,wx.cloud.callFunction({name:"getDriving",data:{queryOptions:c.length>=92160?wx.cloud.CDN(c):h,key:g.requestAPI.getKey(),isCDN:c.length>=92160,version:b}});case 46:if(!((x=e.sent).result.fileID&&b>=0)){e.next=66;break}return e.prev=48,e.next=51,wx.cloud.downloadFile({fileID:x.result.fileID});case 51:return k=e.sent,e.next=54,wx.getFileSystemManager().readFileSync(k.tempFilePath,"utf-8");case 54:F=e.sent,F=JSON.parse(F),wx.cloud.deleteFile({fileList:[x.result.fileID]}),0===F.status?(x.result=F,v.store.aegis.reportEvent({name:"是否云存储",ext1:"是"})):(this.notifyViewFail({status:-1005}),v.store.aegis.error({msg:f[-1005],ext2:JSON.stringify({type:"driving",startPoint:this.start,endPoint:this.end,errorStatus:-1005,errorMessage:F.msg||F.message||"云函数返回异常"})})),e.next=64;break;case 60:e.prev=60,e.t1=e.catch(48),this.notifyViewFail({status:-1005}),v.store.aegis.error({msg:f[-1005]||"网络异常",ext2:JSON.stringify({type:"driving",startPoint:this.start,endPoint:this.end,errorStatus:-1005,errorMessage:e.t1.msg||e.t1.message||"云函数返回异常"})});case 64:e.next=67;break;case 66:v.store.aegis.reportEvent({name:"是否云存储",ext1:"否"});case 67:0===x.result.status?(this._initMarker(),this.view.setMarkers(this._startEndMarkerWxJson()),this.drivingData=x.result.result,this.selectDriving(t.drivingIndex||0)):(this.notifyViewFail(x.result),v.store.aegis.error({msg:f[x.result.status+""||"-1000"],ext2:JSON.stringify({type:"driving",startPoint:this.start,endPoint:this.end,errorStatus:x.result.status,errorMessage:x.result.msg||x.result.message||"数据处理异常"})})),e.next=77;break;case 70:return e.prev=70,e.t2=e.catch(33),console.error(e.t2),-1e3===e.t2.status&&wx.showToast({title:"网络异常请重试",icon:"none",image:"",duration:1500,mask:!1}),this.notifyViewFail({status:e.t2.status||-1e3}),v.store.aegis.error({msg:f[e.t2.status+""||"-1005"]||"网络异常",ext2:JSON.stringify({type:"driving",startPoint:this.start,endPoint:this.end,errorStatus:e.t2.status||-1005,errorMessage:e.t2.msg||e.t2})}),e.abrupt("return");case 77:case"end":return e.stop()}}),e,this,[[10,21],[33,70],[48,60]])}))),function(){return t.apply(this,arguments)})},{key:"selectDriving",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.routePlanIndex=e;var s=p.deepClone(this.drivingData),n=s.drivingPolyline,a=n.splice(e,1),u=i(a,1),l=u[0];l.forEach((function(e){var t=e._speedLevel;e.color=x[t],e.borderColor=k[t]})),n.forEach((function(e){e.forEach((function(e){var t=e._speedLevel;e.color=m[t],e.borderColor=b[t]})),s.polyline=s.polyline.concat(e)})),s.polyline=s.polyline.concat(l);var o=r({activeIndex:e},s);o.cardData&&o.cardData.length>0&&this.view.setDrivingSuccess(o),t&&this.view.setBounds(o.bounds)}},{key:"notifyViewFail",value:function(e){this._initMarker(),this.view.setDrivingFail({status:e.status,message:-1005!==e.status&&e.message||"网路异常，请稍后重试",meta:{markers:this._startEndMarkerWxJson().reverse()}})}},{key:"_initMarker",value:function(){this.start&&this.start.latitude&&this.start.longitude&&(this.startMarker=this.mapRender.createStartMarker(this.start,1)),this.end&&this.end.latitude&&this.end.longitude&&(this.endMarker=this.mapRender.createDestMarker(this.end,1))}},{key:"_startEndMarkerWxJson",value:function(){var e=[];return this.startMarker&&e.push(this.startMarker.toJson()),this.endMarker&&e.push(this.endMarker.toJson()),e}}]),h}(d.default);exports.default=F;